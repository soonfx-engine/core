import{P as f,F as B,f as o,E as L,B as x,C as E,a as w}from"./index-Biuxv-QS.js";import"./echarts-Bn9PLWWT.js";class D{constructor(){this.playerList=[]}static getInstance(){return this._instance||(this._instance=new D),this._instance}getPlayerInstance(){let t=this._fxData[0],e=new f;e.name=t.name,console.log(e.name);let a=e.getBillboard();return console.log(a),e.parameterInfoArray=t.parameterInfoArray,e}getEnemyInstance(t){let e=this._fxData[t],a=new f;return a.name=e.name,a.parameterInfoArray=e.parameterInfoArray,a}getInstanceByName(t){let e=this._fxData.find(n=>n.name===t);if(!e)return console.warn(`æœªæ‰¾åˆ°åç§°ä¸º "${t}" çš„è§’è‰²é…ç½®`),null;let a=new f;return a.name=e.name,a.parameterInfoArray=e.parameterInfoArray,a}loadConfig(t){new B;var e=t,a=typeof e=="string"?JSON.parse(e):e;a.stage.operationArray;var n=a.library.operationArray;o.createLibraryBody(n,!0),this._fxPlayer=f,this.playerList=[];let h=new o.CallCenter;h.addEventListener(L.SHIFT_ADD_BOARD,r=>{let d=new x(r.name);d.monitored=r.monitored;let l=d;for(var i=0;i<r.operationArray.length;i++){var m=[];o.getLibraryBody(m,o.targetFolder.tree,r.operationArray[i].site),o.clickBody=m[0],l.pushOperationLayer(),o.clickBody=null}for(var i=0;i<r.metadataArray.length;i++){var m=[];o.getLibraryBody(m,o.targetFolder.tree,r.metadataArray[i].site),o.clickBody=m[0];let y=r.metadataArray[i];l.pushMetadata(y.componentType,y.componentMinValue,y.componentMaxValue,y.componentIntervalValue),o.clickBody=null}o.Call.send(o.Eve.ADD_DATABASE_DATA,[l,o.selectBody,r.index]),o.Call.send(o.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[l,o.selectBody])}),h.addEventListener(L.SHIFT_ADD_CHARTS,r=>{var d=new E(r.name);let l=d;for(var i=0;i<r.operationlayer.length;i++){var m=[];o.getLibraryBody(m,o.targetFolder.tree,r.operationlayer[i]),l.operationArray.push(m[0].copy())}var m=[];l.minValue=r.minValue,l.intervalValue=r.intervalValue,l.maxValue=r.maxValue,r.metadataArray||(r.metadataArray=[]),r.metadata&&(r.metadataArray=[{site:r.metadata,intervalValue:l.intervalValue,minValue:l.minValue}],r.metadata=null);for(var i=0;i<r.metadataArray.length;i++){var m=[],u=r.metadataArray[i];o.getLibraryBody(m,o.targetFolder.tree,u.site);var p=m[0].copy();p.intervalValue=u.intervalValue||1,p.minValue=u.minValue||1,l.metadataArray.push(p),l.metadata=p}w.send(o.Eve.ADD_DATABASE_DATA,[l,o.selectBody,r.index]),o.Call.send(o.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[l,o.selectBody]),o.clickBody=null}),o.parseLibraryBody(n,!0),o.recursionSyncBody(o.targetFolder.tree);let s=a.entity.operationArray;this._fxData=s;let g=this.createPlayersFromEntityArray(s);console.log("-------------------"),g.forEach(r=>{let d=r.getFormula("æ”»å‡»"),l=r.getFormula("ç”Ÿå‘½"),i=r.getFormula("é˜²å¾¡");console.log("name",r.name),console.log("attack",d),console.log("hp",l),console.log("defense",i)}),this.playerList=g}getDataByOccuAndLevel(t,e){this._fxPlayer.changePlayerLevelAndOccupation(e,t);let a=this._fxPlayer.getFormula("æ”»å‡»1"),n=this._fxPlayer.getFormula("ç”Ÿå‘½"),h=this._fxPlayer.getFormula("é˜²å¾¡");return{attack:a,hp:n,defense:h}}getInstanceDataByNameAndOccuAndLevel(t,e,a){let n=this.playerList.find(r=>r.name===t);if(!n)throw new Error(`æœªæ‰¾åˆ°åç§°ä¸º "${t}" çš„ç©å®¶`);n.changeLevelAndOccupation(a,e);let h=n.getFormula("æ”»å‡»"),s=n.getFormula("ç”Ÿå‘½"),g=n.getFormula("é˜²å¾¡");return{attack:h,hp:s,defense:g}}createPlayersFromEntityArray(t){let e=[];for(var a=0;a<t.length;a++){let n=t[a],h=this.getInstanceByName(n.name);h?e.push(h):console.warn(`åˆ›å»ºç©å®¶å®ä¾‹å¤±è´¥: ${n.name}`)}return e}getSheetDataByPath(t){var h;let e=t.split("."),a=o.targetFolder,n;for(let s=0;s<e.length;s++){let g;if(a.isFolder){if(g=a.tree.find(r=>r.name==e[s]),!g)throw new Error("getSheetDataByPath - è·¯å¾„æœªæ‰¾åˆ°: "+e[s])}else n=a;a=g,s==e.length-1&&(n=a)}return(h=n==null?void 0:n.sheetData)==null?void 0:h.originData}}window.FxUtil=D;class F{constructor(){this.logs=[],this.battleData=[]}addLog(t){const a=`[${new Date().toLocaleTimeString("zh-CN")}] ${t}`;this.logs.push(a),console.log(a)}addRoundData(t,e){this.battleData.push({round:t,timestamp:new Date().toISOString(),...e})}getLogs(){return[...this.logs]}getBattleData(){return[...this.battleData]}clear(){this.logs=[],this.battleData=[]}generateReport(){let t=`
========== æˆ˜æ–—æŠ¥å‘Š ==========
`;return t+=this.logs.join(`
`),t+=`

========== æˆ˜æ–—æ•°æ®ç»Ÿè®¡ ==========
`,t+=JSON.stringify(this.battleData,null,2),t+=`
================================
`,t}}class v{constructor(t,e,a,n,h=1,s=1){this.name=t,this.maxHp=e,this.currentHp=e,this.attack=a,this.defense=n,this.level=h,this.occupation=s}isAlive(){return this.currentHp>0}takeDamage(t){const e=Math.max(1,t-this.defense);return this.currentHp=Math.max(0,this.currentHp-e),e}getStatus(){return`${this.name} [Lv.${this.level}] HP: ${this.currentHp}/${this.maxHp} | æ”»å‡»: ${this.attack} | é˜²å¾¡: ${this.defense}`}getHpPercentage(){return this.currentHp/this.maxHp*100}}class ${constructor(t,e,a){this.round=0,this.maxRounds=100,this.hero=t,this.enemy=e,this.logger=a}calculateDamage(t,e){let a=t.attack-e.defense;const n=.8+Math.random()*.4;return a=Math.floor(a*n),Math.max(1,a)}executeAttack(t,e){const a=this.calculateDamage(t,e),n=e.takeDamage(a);return this.logger.addLog(`  ${t.name} æ”»å‡» ${e.name}ï¼Œé€ æˆ ${n} ç‚¹ä¼¤å®³ï¼ï¼ˆ${e.name} å‰©ä½™è¡€é‡: ${e.currentHp}/${e.maxHp}ï¼‰`),n}battleRound(){this.round++,this.logger.addLog(`
----- ç¬¬ ${this.round} å›åˆ -----`),this.logger.addLog(`${this.hero.getStatus()}`),this.logger.addLog(`${this.enemy.getStatus()}`);const t={heroHp:this.hero.currentHp,heroHpPercent:this.hero.getHpPercentage(),enemyHp:this.enemy.currentHp,enemyHpPercent:this.enemy.getHpPercentage()},e=this.executeAttack(this.hero,this.enemy),a=()=>{t.enemyHp=this.enemy.currentHp,t.enemyHpPercent=this.enemy.getHpPercentage(),t.heroHp=this.hero.currentHp,t.heroHpPercent=this.hero.getHpPercentage()};if(!this.enemy.isAlive())return a(),this.logger.addLog(`
ğŸ‰ ${this.enemy.name} è¢«å‡»è´¥äº†ï¼`),this.logger.addRoundData(this.round,{...t,heroDamageDealt:e,enemyDamageDealt:0,winner:this.hero.name,battleEnd:!0}),!0;const n=this.executeAttack(this.enemy,this.hero);return this.hero.isAlive()?(a(),this.logger.addRoundData(this.round,{...t,heroDamageDealt:e,enemyDamageDealt:n,battleEnd:!1}),!1):(this.logger.addLog(`
ğŸ’€ ${this.hero.name} è¢«å‡»è´¥äº†ï¼`),a(),this.logger.addRoundData(this.round,{...t,heroDamageDealt:e,enemyDamageDealt:n,winner:this.enemy.name,battleEnd:!0}),!0)}startBattle(){for(this.logger.addLog(`
========================================`),this.logger.addLog("âš”ï¸  æˆ˜æ–—å¼€å§‹ï¼"),this.logger.addLog("========================================"),this.logger.addLog(`${this.hero.getStatus()}`),this.logger.addLog("VS"),this.logger.addLog(`${this.enemy.getStatus()}`),this.logger.addLog(`========================================
`);this.round<this.maxRounds&&!this.battleRound(););this.round>=this.maxRounds&&this.logger.addLog(`
â±ï¸  æˆ˜æ–—è¶…æ—¶ï¼Œå¹³å±€ï¼`);const t=this.hero.isAlive()?this.hero.name:this.enemy.isAlive()?this.enemy.name:"å¹³å±€";return this.logger.addLog(`
========================================`),this.logger.addLog("ğŸ“Š æˆ˜æ–—ç»“æŸç»Ÿè®¡"),this.logger.addLog("========================================"),this.logger.addLog(`èƒœåˆ©è€…: ${t}`),this.logger.addLog(`æ€»å›åˆæ•°: ${this.round}`),this.logger.addLog(`${this.hero.name} æœ€ç»ˆçŠ¶æ€: ${this.hero.getStatus()}`),this.logger.addLog(`${this.enemy.name} æœ€ç»ˆçŠ¶æ€: ${this.enemy.getStatus()}`),this.logger.addLog(`========================================
`),{winner:t,rounds:this.round,battleData:this.logger.getBattleData()}}}let H=!1;async function S(){if(H)return;const c=D.getInstance();try{const e=await(await fetch("./assets/fx.json")).json();c.loadConfig(e),H=!0}catch(t){console.error("Failed to load fx.json",t)}}async function R(c,t=50,e=1){const a=[],n=e+t-1;await S();const h=D.getInstance();for(let s=e;s<=n;s++){await new Promise(g=>requestAnimationFrame(()=>g(!0)));try{const g=new F,r=h.getInstanceDataByNameAndOccuAndLevel("ä¸»è§’1",1,s),d=new v("Hero",r.hp,r.attack,r.defense,s,1),l=h.getInstanceDataByNameAndOccuAndLevel("æ€ªç‰©1",1,s),i=new v("Enemy",l.hp,l.attack,l.defense,s,1),u=new $(d,i,g).startBattle();let p=0,y=0;if(u.battleData&&u.battleData.length>0)for(const A of u.battleData)A.heroDamageDealt!==void 0&&(p+=A.heroDamageDealt,y++);const b=y>0?p/y:0;a.push({level:s,hp:d.currentHp,damage:b,rounds:u.rounds,battleData:u.battleData,heroName:"Hero",enemyName:"Enemy"}),c&&c(a,s,n)}catch(g){console.error(`Level ${s} battle simulation failed:`,g),a.push({level:s,hp:100,damage:20,rounds:10,battleData:[],heroName:"Hero",enemyName:"Enemy"}),c&&c(a,s,n)}}return a}export{R as generatePVEDataRange,S as initFx};
