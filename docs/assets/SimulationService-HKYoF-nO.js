import{P as A,F as E,f as r,E as v,B as b,C as _,a as w}from"./index-DZOXA8aU.js";import{BattleLogger as x}from"./BattleLogger-k-D1IkQQ.js";import{BattleEntity as B}from"./BattleEntity-CWBiIsEU.js";import{BattleSimulator as I}from"./BattleSimulator-BnmtSMI-.js";import"./echarts-Bn9PLWWT.js";class p{constructor(){this.playerList=[]}static getInstance(){return this._instance||(this._instance=new p),this._instance}getPlayerInstance(){let l=this._fxData[0],a=new A;a.name=l.name,console.log(a.name);let t=a.getBillboard();return console.log(t),a.parameterInfoArray=l.parameterInfoArray,a}getEnemyInstance(l){let a=this._fxData[l],t=new A;return t.name=a.name,t.parameterInfoArray=a.parameterInfoArray,t}getInstanceByName(l){let a=this._fxData.find(n=>n.name===l);if(!a)return console.warn(`未找到名称为 "${l}" 的角色配置`),null;let t=new A;return t.name=a.name,t.parameterInfoArray=a.parameterInfoArray,t}loadConfig(l){new E;var a=l,t=typeof a=="string"?JSON.parse(a):a;t.stage.operationArray;var n=t.library.operationArray;r.createLibraryBody(n,!0),this._fxPlayer=A,this.playerList=[];let y=new r.CallCenter;y.addEventListener(v.SHIFT_ADD_BOARD,e=>{let u=new b(e.name);u.monitored=e.monitored;let i=u;for(var s=0;s<e.operationArray.length;s++){var c=[];r.getLibraryBody(c,r.targetFolder.tree,e.operationArray[s].site),r.clickBody=c[0],i.pushOperationLayer(),r.clickBody=null}for(var s=0;s<e.metadataArray.length;s++){var c=[];r.getLibraryBody(c,r.targetFolder.tree,e.metadataArray[s].site),r.clickBody=c[0];let g=e.metadataArray[s];i.pushMetadata(g.componentType,g.componentMinValue,g.componentMaxValue,g.componentIntervalValue),r.clickBody=null}r.Call.send(r.Eve.ADD_DATABASE_DATA,[i,r.selectBody,e.index]),r.Call.send(r.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[i,r.selectBody])}),y.addEventListener(v.SHIFT_ADD_CHARTS,e=>{var u=new _(e.name);let i=u;for(var s=0;s<e.operationlayer.length;s++){var c=[];r.getLibraryBody(c,r.targetFolder.tree,e.operationlayer[s]),i.operationArray.push(c[0].copy())}var c=[];i.minValue=e.minValue,i.intervalValue=e.intervalValue,i.maxValue=e.maxValue,e.metadataArray||(e.metadataArray=[]),e.metadata&&(e.metadataArray=[{site:e.metadata,intervalValue:i.intervalValue,minValue:i.minValue}],e.metadata=null);for(var s=0;s<e.metadataArray.length;s++){var c=[],d=e.metadataArray[s];r.getLibraryBody(c,r.targetFolder.tree,d.site);var f=c[0].copy();f.intervalValue=d.intervalValue||1,f.minValue=d.minValue||1,i.metadataArray.push(f),i.metadata=f}w.send(r.Eve.ADD_DATABASE_DATA,[i,r.selectBody,e.index]),r.Call.send(r.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[i,r.selectBody]),r.clickBody=null}),r.parseLibraryBody(n,!0),r.recursionSyncBody(r.targetFolder.tree);let o=t.entity.operationArray;this._fxData=o;let m=this.createPlayersFromEntityArray(o);console.log("-------------------"),m.forEach(e=>{let u=e.getFormula("攻击"),i=e.getFormula("生命"),s=e.getFormula("防御");console.log("name",e.name),console.log("attack",u),console.log("hp",i),console.log("defense",s)}),this.playerList=m}getDataByOccuAndLevel(l,a){this._fxPlayer.changePlayerLevelAndOccupation(a,l);let t=this._fxPlayer.getFormula("攻击1"),n=this._fxPlayer.getFormula("生命"),y=this._fxPlayer.getFormula("防御");return{attack:t,hp:n,defense:y}}getInstanceDataByNameAndOccuAndLevel(l,a,t){let n=this.playerList.find(e=>e.name===l);if(!n)throw new Error(`未找到名称为 "${l}" 的玩家`);n.changeLevelAndOccupation(t,a);let y=n.getFormula("攻击"),o=n.getFormula("生命"),m=n.getFormula("防御");return{attack:y,hp:o,defense:m}}createPlayersFromEntityArray(l){let a=[];for(var t=0;t<l.length;t++){let n=l[t],y=this.getInstanceByName(n.name);y?a.push(y):console.warn(`创建玩家实例失败: ${n.name}`)}return a}getSheetDataByPath(l){var y;let a=l.split("."),t=r.targetFolder,n;for(let o=0;o<a.length;o++){let m;if(t.isFolder){if(m=t.tree.find(e=>e.name==a[o]),!m)throw new Error("getSheetDataByPath - 路径未找到: "+a[o])}else n=t;t=m,o==a.length-1&&(n=t)}return(y=n==null?void 0:n.sheetData)==null?void 0:y.originData}}window.FxUtil=p;let F=!1;async function V(){if(F)return;const h=p.getInstance();try{const a=await(await fetch("./assets/fx.json")).json();h.loadConfig(a),F=!0}catch(l){console.error("Failed to load fx.json",l)}}async function N(h,l=50,a=1){const t=[],n=a+l-1;await V();const y=p.getInstance();for(let o=a;o<=n;o++){await new Promise(m=>requestAnimationFrame(()=>m(!0)));try{const m=new x,e=y.getInstanceDataByNameAndOccuAndLevel("主角1",1,o),u=new B("Hero",e.hp,e.attack,e.defense,o,1),i=y.getInstanceDataByNameAndOccuAndLevel("怪物1",1,o),s=new B("Enemy",i.hp,i.attack,i.defense,o,1),d=new I(u,s,m).startBattle();let f=0,g=0;if(d.battleData&&d.battleData.length>0)for(const D of d.battleData)D.heroDamageDealt!==void 0&&(f+=D.heroDamageDealt,g++);const L=g>0?f/g:0;t.push({level:o,hp:u.currentHp,damage:L,rounds:d.rounds,battleData:d.battleData,heroName:"Hero",enemyName:"Enemy"}),h&&h(t,o,n)}catch(m){console.error(`Level ${o} battle simulation failed:`,m),t.push({level:o,hp:100,damage:20,rounds:10,battleData:[],heroName:"Hero",enemyName:"Enemy"}),h&&h(t,o,n)}}return t}export{N as generatePVEDataRange,V as initFx};
