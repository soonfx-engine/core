const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SimulationService--Zaiwy68.js","./echarts-Bn9PLWWT.js"])))=>i.map(i=>d[i]);
var E=Object.defineProperty;var O=(n,e,t)=>e in n?E(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>O(n,typeof e!="symbol"?e+"":e,t);import{i as init,L as LinearGradient}from"./echarts-Bn9PLWWT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const L=class L{constructor(){l(this,"eventMessageList",[])}static getInstance(){return L._instance==null&&(L._instance=new L),L._instance}removeEventObject(e){const t=this.eventMessageList.indexOf(e);t!==-1&&this.eventMessageList.splice(t,1)}addEventObject(e){this.eventMessageList.indexOf(e)===-1&&this.eventMessageList.push(e)}};l(L,"_instance",null);let MessageList=L;class Call{constructor(){}static send(e,t,i){t!=null&&(t.Call_Event_type=e);for(let r=0;r<MessageList.getInstance().eventMessageList.length;r++)if(MessageList.getInstance().eventMessageList[r].getEvents(e)){const o=MessageList.getInstance().eventMessageList[r].execute(e,t);i&&i.apply([e],[o])}}}class CallCenter{constructor(){l(this,"eventsList",null);this.eventsList=null,MessageList.getInstance().addEventObject(this)}execute(e,t){return this.eventsList[e].apply([e],[t])}getEvents(e){return this.eventsList==null?!1:this.eventsList[e]!=null}addEventListener(e,t,i,r){this.eventsList==null&&(this.eventsList={}),this.eventsList[e]=t.bind(r)}dispose(){for(const e in this.eventsList)delete this.eventsList[e];this.eventsList=null}removeEventListener(e){this.eventsList!=null&&(this.eventsList[e]=null)}}class EventManager{constructor(){}}l(EventManager,"UP_DATA_PLAYER","UP_DATA_PLAYER"),l(EventManager,"CREATE_FILE_DATA","CREATE_FILE_DATA"),l(EventManager,"CREATE_OPERATION_DATA","CREATE_OPERATION_DATA"),l(EventManager,"CREATE_METADATE_DATA","CREATE_METADATE_DATA"),l(EventManager,"ADD_DATABASE_DATA","ADD_DATABASE_DATA"),l(EventManager,"ADD_OPERAND_DATA","ADD_OPERAND_DATA"),l(EventManager,"SEND_ANCHOR_FORMULA","SEND_ANCHOR_FORMULA"),l(EventManager,"SHIFT_ADD_BOOKMARK","SHIFT_ADD_BOOKMARK"),l(EventManager,"SHIFT_ADD_BOARD","SHIFT_ADD_BOARD"),l(EventManager,"SHIFT_ADD_CHARTS","SHIFT_ADD_CHARTS"),l(EventManager,"SHIFT_ADD_FORMULA","SHIFT_ADD_FORMULA"),l(EventManager,"SHIFT_ADD_FUNCTION","SHIFT_ADD_FUNCTION"),l(EventManager,"SHIFT_ADD_OPERATIONBODY","SHIFT_ADD_OPERATIONBODY"),l(EventManager,"SHIFT_ADD_VARIABLEBODY","SHIFT_ADD_VARIABLEBODY"),l(EventManager,"SHIFT_ADD_SYMBOLBODY","SHIFT_ADD_SYMBOLBODY"),l(EventManager,"SHIFT_SHOW_VIEW","SHIFT_SHOW_VIEW"),l(EventManager,"SHIFT_SHOW_VIEW_ON","SHIFT_SHOW_VIEW_ON"),l(EventManager,"SHIFT_REMOVE_BODY","SHIFT_REMOVE_BODY"),l(EventManager,"SHIFT_ADD_BODY_VIEW","SHIFT_ADD_BODY_VIEW"),l(EventManager,"SHIFT_REFRESH_LIBRARY_COORDINATES","SHIFT_REFRESH_LIBRARY_COORDINATES"),l(EventManager,"IDINDEX",1),l(EventManager,"PLAYER_INSTANCE_LEVEL_UP","PLAYER_INSTANCE_LEVEL_UP");class Folder{constructor(e=null){l(this,"name");l(this,"isFolder",!0);l(this,"isShow",!0);l(this,"isShowChild",!0);l(this,"tree",[]);l(this,"formulaTree",[]);l(this,"minArrowsView",null);l(this,"constructorName","Folder");l(this,"id");this.name=e,this.id=++EventManager.IDINDEX}setName(e){this.name=e}dispose(){this.name=null,this.isFolder=!1,this.isShowChild=!1,this.tree=[],this.formulaTree=[]}getMaxHeight(){let e=1;for(let t=0;t<this.tree.length;t++)this.tree[t].isShow&&(this.tree[t].isFolder?e+=this.tree[t].getMaxHeight():e++);return e}addTest(e){return this.tree.indexOf(e)==-1}spliceChild(e,t){this.addTest(e)&&this.tree.splice(t,0,e)}pushChild(e){this.addTest(e)&&this.tree.push(e)}unshiftChild(e){this.addTest(e)&&this.tree.unshift(e)}removeChild(e){if(!this.addTest(e)){const t=this.tree.indexOf(e);this.tree.splice(t,1)}}}class FXCentre{constructor(){l(this,"callCenter",null);fx.sceneFolder=new Folder("场景根目录"),fx.targetFolder=fx.sceneFolder,this.initEventListener()}initEventListener(){this.callCenter=new CallCenter,this.callCenter.addEventListener(fx.Eve.ADD_DATABASE_DATA,this.addDataBaseFunction,null,this),this.callCenter.addEventListener(fx.Eve.ADD_OPERAND_DATA,this.addOperandFunction.bind(this))}addBody(e,t,i){e!=null&&!e.addTest(t)&&(Call.send(fx.Eve.SHIFT_REMOVE_BODY,[t,!1],null),e.addBody(t),Call.send(fx.Eve.SHIFT_ADD_BODY_VIEW,[e,t,i],null))}addOperandFunction(e){this.addBody(e[0],e[1],e[2])}addDataBaseFunction(e){this.addData(e[0],e[1],e[2])}addData(e,t,i){t!=null&&t.typeView!=null&&(t=null),t!=null&&t.isFolder?(e.parentFolder=t,i!=null?t.spliceChild(e,i):t.pushChild(e)):t==null?(e.parentFolder=fx.targetFolder,i!=null?fx.targetFolder.spliceChild(e,i):fx.targetFolder.pushChild(e)):(e.parentFolder=t.parentFolder,e.parentFolder.spliceChild(e,t.parentFolder.tree.indexOf(t)+1))}}var NodeType=(n=>(n[n.Variable=1]="Variable",n[n.Macro=4]="Macro",n[n.CalculationLayer=5]="CalculationLayer",n.SymbolBody="SymbolBody",n.OperationBody="OperationBody",n.Bookmark="Bookmark",n[n.Sheet=11]="Sheet",n[n.LogicalBasic=12]="LogicalBasic",n[n.LogicalSlider=14]="LogicalSlider",n[n.LogicalBool=16]="LogicalBool",n))(NodeType||{});function getCatchValue(n,e,t,i){let r=0;try{r=n.getValue(e,t,i)}catch(o){console.log(o),r=0}return r}var CommonFunctionTypes=(n=>(n[n.abs=4]="abs",n[n.random=5]="random",n[n.floor=6]="floor",n[n.sqrt=7]="sqrt",n[n.max=8]="max",n[n.min=9]="min",n[n.pow=11]="pow",n[n.log=12]="log",n[n.exp=13]="exp",n[n.cbrt=14]="cbrt",n[n.sign=52]="sign",n[n.imul=53]="imul",n[n.ceil=54]="ceil",n[n.round=55]="round",n))(CommonFunctionTypes||{}),AlgorithmFunctionTypes=(n=>(n[n.length=56]="length",n[n.distance=57]="distance",n[n.dot=58]="dot",n[n.cross=59]="cross",n[n.mix=60]="mix",n))(AlgorithmFunctionTypes||{}),HandleFunctionTypes=(n=>(n[n["1-n"]=1]="1-n",n[n["1/n"]=2]="1/n",n[n["-n"]=3]="-n",n[n["n*2"]=15]="n*2",n[n["n/2"]=16]="n/2",n[n["n*100"]=17]="n*100",n[n["n/100"]=18]="n/100",n[n["n*n"]=19]="n*n",n[n["n/n2"]=20]="n/n2",n[n["n/(n+n2)"]=21]="n/(n+n2)",n[n["n/(n2-n)"]=22]="n/(n2-n)",n[n["(n,e).(n1,e2)."]=23]="(n,e).(n1,e2).",n[n["r(n~n2)"]=10]="r(n~n2)",n))(HandleFunctionTypes||{}),TriangleFunctionTypes=(n=>(n[n["n*pi"]=36]="n*pi",n[n.cos=37]="cos",n[n.sin=38]="sin",n[n.tan=39]="tan",n[n.acos=40]="acos",n[n.asin=41]="asin",n[n.atan=42]="atan",n[n.atan2=43]="atan2",n))(TriangleFunctionTypes||{}),LogicFunctionTypes=(n=>(n[n["if(n1>n2)return{n3!n4}"]=44]="if(n1>n2)return{n3!n4}",n[n["if(n1>=n2)return{n3!n4}"]=45]="if(n1>=n2)return{n3!n4}",n[n["if(n1<n2)return{n3!n4}"]=46]="if(n1<n2)return{n3!n4}",n[n["if(n1<=n2)return{n3!n4}"]=47]="if(n1<=n2)return{n3!n4}",n[n["if(n1==n2)return{n3!n4}"]=48]="if(n1==n2)return{n3!n4}",n[n["if(n1!=n2)return{n3!n4}"]=49]="if(n1!=n2)return{n3!n4}",n[n["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]=50]="for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}",n[n["[n]"]=51]="[n]",n))(LogicFunctionTypes||{}),CommonFormulaTypes=(n=>(n[n["攻击-防御"]=24]="攻击-防御",n[n["攻击*攻击/(攻击-防御)"]=25]="攻击*攻击/(攻击-防御)",n[n["(攻击-防御)*(攻击/防御)"]=26]="(攻击-防御)*(攻击/防御)",n[n["攻击*攻击/防御"]=27]="攻击*攻击/防御",n[n["攻击/防御"]=28]="攻击/防御",n[n["攻击*(1-系数)"]=29]="攻击*(1-系数)",n[n["护甲*系数/(1+护甲*系数)"]=30]="护甲*系数/(1+护甲*系数)",n[n["攻击*受伤率"]=31]="攻击*受伤率",n[n["攻击/(1+防御*系数)"]=32]="攻击/(1+防御*系数)",n[n["攻击/防御*系数"]=33]="攻击/防御*系数",n[n["攻击*系数/防御"]=34]="攻击*系数/防御",n[n["攻击*(系数/防御)"]=35]="攻击*(系数/防御)",n[n["(攻击-防御)*攻击-防御/(攻击/防御)"]=36]="(攻击-防御)*攻击-防御/(攻击/防御)",n))(CommonFormulaTypes||{}),GameFormula1=(n=>(n[n.战斗公式=61]="战斗公式",n))(GameFormula1||{}),GameFormula2=(n=>(n[n.人物生命=62]="人物生命",n[n.近战素质物攻=63]="近战素质物攻",n[n.远程素质物攻=64]="远程素质物攻",n[n.法师素质物攻=65]="法师素质物攻",n[n.物防=66]="物防",n[n.魔防=67]="魔防",n[n.命中=68]="命中",n[n.闪避=69]="闪避",n[n.暴击=70]="暴击",n[n.抗暴=71]="抗暴",n[n.职业素质点成长=72]="职业素质点成长",n[n.最终近战物攻=73]="最终近战物攻",n[n.最终远程物攻=74]="最终远程物攻",n[n.最终魔法攻击=75]="最终魔法攻击",n[n.物理伤害=76]="物理伤害",n[n.魔法伤害=77]="魔法伤害",n[n.命中率=78]="命中率",n[n.暴击率=79]="暴击率",n))(GameFormula2||{}),GameFormula3=(n=>(n[n.成长公式=80]="成长公式",n))(GameFormula3||{});const getGlobalThis=()=>typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof self<"u"?self:{};class VariableValue{constructor(n,e,t=null,i=null){l(this,"name");l(this,"id");l(this,"TID");l(this,"value",0);l(this,"selectedOutputInfo",0);l(this,"type");l(this,"operator",null);l(this,"isAI",!1);l(this,"macros","");l(this,"sheetData",null);l(this,"snNo",1);l(this,"isLogicalOpen",!1);l(this,"isDragging",!1);l(this,"logicalNumberList",[]);l(this,"formulaTextValue");l(this,"currentStep",0);l(this,"minValue",1);l(this,"maxValue",100);l(this,"step",10);l(this,"parent",null);l(this,"childCell");l(this,"childArray",[]);l(this,"childBodyArray",[]);l(this,"logicalChildArray",[]);l(this,"tree",[]);l(this,"cacheValue",null);l(this,"view",null);l(this,"body",null);l(this,"tag",null);l(this,"enemyBody",null);l(this,"enemyFlag",!1);l(this,"isWeight",!0);l(this,"statistics",0);l(this,"absoluteAddress",null);l(this,"site",null);l(this,"source",null);l(this,"captureCrit",!0);l(this,"upDateValue",1);l(this,"demoteValue",0);l(this,"funcType",0);l(this,"historyTarget",null);l(this,"isSystemShow",!1);l(this,"constructorName","VariableValue");this.name=n,this.value=e,this.type=t,this.id=++EventManager.IDINDEX,this.operator=i}setMacros(n){this.macros=n,this.getValue()}setGlobalValue(n){this.source!=null&&this.source.setValue(n)}setValue(n){this.type!==NodeType.Sheet&&(this.value=n,this.upDataChild(),this.type===NodeType.Variable&&fx.code===!1&&this.updateVariableDisplay(n))}updateVariableDisplay(n){var i,r;const e=(i=fx.getDataById)==null?void 0:i.call(fx,this.id),t=(r=fx.getTreeDataById)==null?void 0:r.call(fx,this.id);if(e&&t){const o=getGlobalThis();if(o.window&&!o.window.updatingSheeData){const s=`componentDatas.nodeList.props.tree.props.dataSource.${t.dataPath}.showName`;o.window.set_data(o.window.store,s,`${this.name}=${n}`)}}}addNumberList(){this.logicalNumberList.push({value:""})}changeNumberListItem(n,e){this.logicalNumberList[n].value=e}getIsFunction(){return this.type===NodeType.Macro}getRessSring(n){const e=[];return fx.getStepData(n,e),e.join("")}setEnemyBody(n){this.enemyBody=n}setSheetData(n){this.sheetData=new fx.SheetData(n),this.getValue(),this.upDataChild()}getValue(n,e,t){if(this.type!==NodeType.Variable&&this.enemyFlag&&fx.enemyBody!=null)return this.value=getCatchValue(fx.enemyBody.getPropertyObject(this.source.absoluteAddress)),this.returnFunc(this.value);switch(this.type){case NodeType.Macro:return this.getMacroValue();case NodeType.Sheet:return this.getSheetValue(n,e,t);case NodeType.LogicalNumberList:return this.getLogicalNumberListValue();case NodeType.LogicalSlider:return this.getLogicalSliderValue();case NodeType.LogicalList:case NodeType.LogicalBasic:return this.getLogicalValue();case NodeType.CalculationLayer:return this.getCalculationLayerValue();default:return this.getDefaultValue()}}getMacroValue(){try{if(this.historyTarget=globalThis.target,globalThis.target=this,this.macros==="")return this.value=0,this.returnFunc(this.value);if(fx.code)this.value=new Function(`return ${fx["f_"+this.TID].fun.replace(/[\r\n\s]/g,"")}`)();else try{this.value=eval(this.macros)}catch(n){this.value=0}return globalThis.target=this.historyTarget,isNaN(this.value)||(this.value=fx.double(this.value,4)),this.returnFunc(this.value)}catch(n){return this.value=0,this.value}}getSheetValue(n,e,t){var i,r,o;return this.value=((r=(i=this.source)==null?void 0:i.sheetData)==null?void 0:r.getValue(n,e,t))||((o=this.sheetData)==null?void 0:o.getValue(n,e,t))||0,this.returnFunc(this.value)}getLogicalNumberListValue(){const n=this.getNumberListValue();if(typeof n=="string"&&n.startsWith("[")){const e=JSON.parse(n),t=Math.floor(Math.random()*(e[1]-e[0]+1))+e[0];this.value=t}else this.value=Number(n);return this.returnFunc(this.value)}getNumberListValue(){return typeof this.snNo=="number"&&this.logicalNumberList.length&&this.snNo<=this.logicalNumberList.length&&this.logicalNumberList[this.snNo-1].value||0}getLogicalSliderValue(){const n=this.currentStep*this.step;return this.value=Math.max(this.minValue,Math.min(n,this.maxValue)),this.returnFunc(this.value)}getLogicalValue(){const n=this.logicalChildArray[this.snNo-1];return this.value=n?n.getValue():0,this.returnFunc(this.value)}getCalculationLayerValue(){var t;const n=(t=this.source)==null?void 0:t.body,e=this.body;return n?this.value=getCatchValue(n):e&&(this.value=getCatchValue(e)),isNaN(this.value)||(this.value=Number(fx.double(this.value,4))),this.returnFunc(this.value)}getDefaultValue(){return this.value||(this.value=0),isNaN(this.value)||(this.value=Number(this.value)),this.returnFunc(this.value)}returnFunc(n){return this.funcType===0?n:this.funcType>=HandleFunctionTypes["1-n"]&&this.funcType<=HandleFunctionTypes["(n,e).(n1,e2)."]?this.handleFunction(n):this.funcType>=CommonFormulaTypes["攻击-防御"]&&this.funcType<=35?this.commonFormulaFunction():this.funcType>=TriangleFunctionTypes["n*pi"]&&this.funcType<=TriangleFunctionTypes.atan2?this.triangleFunction(n):this.funcType>=LogicFunctionTypes["if(n1>n2)return{n3!n4}"]&&this.funcType<=LogicFunctionTypes["[n]"]?this.logicFunction():this.funcType>=CommonFunctionTypes.abs&&this.funcType<=CommonFunctionTypes.cbrt||this.funcType>=CommonFunctionTypes.sign&&this.funcType<=CommonFunctionTypes.round?this.commonFunction(n):this.funcType>=AlgorithmFunctionTypes.length&&this.funcType<=60?this.algorithmFunction():this.funcType>=GameFormula1.战斗公式&&this.funcType<=68?this.gameFormulaFunction():n}handleFunction(n){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case HandleFunctionTypes["1-n"]:return 1-n;case HandleFunctionTypes["1/n"]:return 1/n;case HandleFunctionTypes["-n"]:return-n;case HandleFunctionTypes["n*2"]:return n*2;case HandleFunctionTypes["n/2"]:return n/2;case HandleFunctionTypes["n*100"]:return n*100;case HandleFunctionTypes["n/100"]:return n/100;case HandleFunctionTypes["n*n"]:return n*n;case HandleFunctionTypes["n/n2"]:return this.tree.length<2?0:e(0)/e(1);case HandleFunctionTypes["n/(n+n2)"]:return this.tree.length<2?0:e(0)/(e(0)+e(1));case HandleFunctionTypes["n/(n2-n)"]:return this.tree.length<2?0:e(0)/(e(1)-e(0));case HandleFunctionTypes["(n,e).(n1,e2)."]:return this.weightedRandom();case HandleFunctionTypes["r(n~n2)"]:return this.tree.length<2?0:Math.random()*(e(1)-e(0))+e(0);default:return n}}commonFormulaFunction(){const n=e=>getCatchValue(this.tree[e]);switch(this.funcType){case CommonFormulaTypes["攻击-防御"]:return this.tree.length<2?0:n(0)-n(1);case CommonFormulaTypes["攻击*攻击/(攻击-防御)"]:return this.tree.length<2?0:n(0)*n(0)/(n(0)+n(1));case CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]:return this.tree.length<2?0:(n(0)-n(1))*(n(0)/n(1));case CommonFormulaTypes["攻击*攻击/防御"]:return this.tree.length<2?0:n(0)*n(0)/n(1);case CommonFormulaTypes["攻击/防御"]:return this.tree.length<2?0:n(0)/n(1);case CommonFormulaTypes["攻击*(1-系数)"]:return this.tree.length<2?0:n(0)*(1-n(1));case CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]:return this.tree.length<2?0:n(0)*n(1)/(1+n(0)*n(1));case CommonFormulaTypes["攻击*受伤率"]:return this.tree.length<2?0:n(0)*n(1);case CommonFormulaTypes["攻击/(1+防御*系数)"]:return this.tree.length<3?0:n(0)/(1+n(1)*n(2));case CommonFormulaTypes["攻击/防御*系数"]:return this.tree.length<3?0:n(0)/n(1)*n(2);case CommonFormulaTypes["攻击*系数/防御"]:return this.tree.length<3?0:n(0)*n(2)/n(1);case CommonFormulaTypes["攻击*(系数/防御)"]:return this.tree.length<3?0:n(0)*(n(2)/n(1));default:return 0}}triangleFunction(n){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case TriangleFunctionTypes["n*pi"]:return n*Math.PI;case TriangleFunctionTypes.cos:return Math.cos(n);case TriangleFunctionTypes.sin:return Math.sin(n);case TriangleFunctionTypes.tan:return Math.tan(n);case TriangleFunctionTypes.acos:return Math.acos(n);case TriangleFunctionTypes.asin:return Math.asin(n);case TriangleFunctionTypes.atan:return Math.atan(n);case TriangleFunctionTypes.atan2:return this.tree.length<2?0:Math.atan2(e(0),e(1));default:return n}}logicFunction(){const n=e=>getCatchValue(this.tree[e]);if(this.tree.length<4&&this.funcType!==LogicFunctionTypes["[n]"]&&this.funcType!==50)return 0;switch(this.funcType){case LogicFunctionTypes["if(n1>n2)return{n3!n4}"]:return n(0)>n(1)?n(2):n(3);case LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]:return n(0)>=n(1)?n(2):n(3);case LogicFunctionTypes["if(n1<n2)return{n3!n4}"]:return n(0)<n(1)?n(2):n(3);case LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]:return n(0)<=n(1)?n(2):n(3);case LogicFunctionTypes["if(n1==n2)return{n3!n4}"]:return n(0)==n(1)?n(2):n(3);case LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]:return n(0)!=n(1)?n(2):n(3);case LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]:return this.complexForLoop();case LogicFunctionTypes["[n]"]:return this.tree.length>0?n(n(0)):0;default:return 0}}commonFunction(n){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case CommonFunctionTypes.abs:return Math.abs(n);case CommonFunctionTypes.random:return Math.random()*n;case CommonFunctionTypes.floor:return Math.floor(n);case CommonFunctionTypes.sqrt:return Math.sqrt(n);case CommonFunctionTypes.max:return Math.max(...this.tree.map((t,i)=>Number(e(i))));case CommonFunctionTypes.min:return Math.min(...this.tree.map((t,i)=>Number(e(i))));case CommonFunctionTypes.pow:return this.tree.length<2?0:Math.pow(e(0),e(1));case CommonFunctionTypes.log:return Math.log(n);case CommonFunctionTypes.exp:return Math.exp(n);case CommonFunctionTypes.cbrt:return Math.cbrt(n);case CommonFunctionTypes.sign:return Math.sign(n);case CommonFunctionTypes.imul:return Math.imul(n,1);case CommonFunctionTypes.ceil:return Math.ceil(n);case CommonFunctionTypes.round:return Math.round(n);default:return n}}algorithmFunction(){const n=e=>getCatchValue(this.tree[e]);switch(this.funcType){case AlgorithmFunctionTypes.length:return this.tree.length<2?0:fx.length(n(0),n(1));case AlgorithmFunctionTypes.distance:return this.tree.length<4?0:fx.distance(n(0),n(1),n(2),n(3));case AlgorithmFunctionTypes.dot:return this.tree.length<4?0:fx.dot(n(0),n(1),n(2),n(3));case AlgorithmFunctionTypes.cross:return this.tree.length<4?0:fx.cross(n(0),n(1),n(2),n(3));case AlgorithmFunctionTypes.mix:return this.tree.length<3?0:fx.mix(n(0),n(1),n(2));default:return 0}}gameFormulaFunction(){const n=e=>getCatchValue(this.tree[e]);switch(this.funcType){case GameFormula1.战斗公式:return this.tree.length<3?0:n(0)*n(2)*(1-1/(1+n(0)*n(2)/(5*n(1))));case GameFormula2.人物生命:return this.tree.length<4?0:n(0)+n(2)*n(1)+n(3)*(1+n(1))*n(1)/2;case GameFormula2.近战素质物攻:case GameFormula2.远程素质物攻:return this.tree.length<5?0:n(0)*2+Math.pow(n(0)/10,2)+n(1)/5+n(2)/5+n(4)*n(3);case GameFormula2.法师素质物攻:return this.tree.length<1?0:n(0)*2+Math.pow(n(0)/10,2);case GameFormula2.物防:case GameFormula2.魔防:return this.value;case GameFormula2.命中+2:return this.tree.length<2?0:n(0)+n(1);default:return this.value}}weightedRandom(){if(this.tree.length%2!==0)return 0;let n=0;for(let t=1;t<this.tree.length;t+=2)this.tree[t].indexex=getCatchValue(this.tree[t])+n,n+=getCatchValue(this.tree[t]);const e=Math.random()*n;for(let t=1;t<this.tree.length;t+=2){const i=t===1?0:this.tree[t-2].indexex;if(e>=i&&e<this.tree[t].indexex)return getCatchValue(this.tree[t-1])}return 0}complexForLoop(){if(this.tree.length<3)return 0;let n=0,e=0;const t=getCatchValue(this.tree[0]),i=getCatchValue(this.tree[1]),r=getCatchValue(this.tree[2]);for(let o=t;o<=i;o++)o%r===1&&n++,e+=n+2;return e}getFormulaTextValueBody(){return{[HandleFunctionTypes["1-n"]]:`1-(${this.value})`,[HandleFunctionTypes["1/n"]]:`1/(${this.value})`,[HandleFunctionTypes["-n"]]:`-(${this.value})`,[CommonFunctionTypes.abs]:`abs(${this.value})`,[CommonFunctionTypes.random]:`random()*${this.value}`,[CommonFunctionTypes.floor]:`floor(${this.value})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.value})`,[CommonFunctionTypes.log]:`log(${this.value})`,[CommonFunctionTypes.exp]:`exp(${this.value})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.value})`,[HandleFunctionTypes["n*2"]]:`(${this.value})*2`,[HandleFunctionTypes["n/2"]]:`(${this.value})/2`,[HandleFunctionTypes["n*100"]]:`(${this.value})*100`,[HandleFunctionTypes["n/100"]]:`(${this.value})/100`,[HandleFunctionTypes["n*n"]]:`${this.value}*${this.value}`,[TriangleFunctionTypes["n*pi"]]:`${this.value}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.value})`,[TriangleFunctionTypes.sin]:`sin(${this.value})`,[TriangleFunctionTypes.tan]:`tan(${this.value})`,[TriangleFunctionTypes.acos]:`acos(${this.value})`,[TriangleFunctionTypes.asin]:`asin(${this.value})`,[TriangleFunctionTypes.atan]:`atan(${this.value})`,[CommonFunctionTypes.sign]:`sign(${this.value})`,[CommonFunctionTypes.imul]:`imul(${this.value})`,[CommonFunctionTypes.ceil]:`ceil(${this.value})`,[CommonFunctionTypes.round]:`round(${this.value})`}[this.funcType]||this.formulaTextValue||String(this.value)}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){if(this.type===NodeType.CalculationLayer)return this.body?this.body.getFormulaTextCharacter():"";if(this.type===NodeType.Macro)return this.getValue();let n=this.name;return this.type===NodeType.Macro&&(n=`${this.name}_${this.TID}`),{[HandleFunctionTypes["1-n"]]:`1-(${this.name})`,[HandleFunctionTypes["1/n"]]:`1/(${this.name})`,[HandleFunctionTypes["-n"]]:`-${this.name}`,[CommonFunctionTypes.abs]:`abs(${this.name})`,[CommonFunctionTypes.random]:`random()*(${this.name})`,[CommonFunctionTypes.floor]:`floor(${this.name})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.name})`,[CommonFunctionTypes.log]:`log(${this.name})`,[CommonFunctionTypes.exp]:`exp(${this.name})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.name})`,[HandleFunctionTypes["n*2"]]:`${this.name}*2`,[HandleFunctionTypes["n/2"]]:`${this.name}/2`,[HandleFunctionTypes["n*100"]]:`${this.name}*100`,[HandleFunctionTypes["n/100"]]:`${this.name}/100`,[HandleFunctionTypes["n*n"]]:`${this.name}*${this.name}`,[TriangleFunctionTypes["n*pi"]]:`${this.name}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.name})`,[TriangleFunctionTypes.sin]:`sin(${this.name})`,[TriangleFunctionTypes.tan]:`tan(${this.name})`,[TriangleFunctionTypes.acos]:`acos(${this.name})`,[TriangleFunctionTypes.asin]:`asin(${this.name})`,[TriangleFunctionTypes.atan]:`atan(${this.name})`,[CommonFunctionTypes.sign]:`sign(${this.name})`,[CommonFunctionTypes.imul]:`imul(${this.name})`,[CommonFunctionTypes.ceil]:`ceil(${this.name})`,[CommonFunctionTypes.round]:`round(${this.name})`}[this.funcType]||n}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}removeChild(n){const e=this.childArray.indexOf(n);e>-1&&this.childArray.splice(e,1)}dispose(){this.source!=null&&this.source.removeChild(this),this.macros="",this.childArray=[]}setParameter(n,e){this.name=n,this.value=e}upDataChild(){for(const n of this.childArray)n.name=this.name,n.value=this.value,n.body=this.body,n.TID=this.TID}setDataChild(n,e){this.name=n,this.value=e;for(const t of this.childArray)t.setDataChild(n,e)}syncBody(){for(const n of this.childArray)n.body=this.body}copy(){const n=new fx.VariableValue(this.name,this.value,this.type,this.operator);return n.source=this,n.body=this.body,n.TID=this.TID,this.childArray.push(n),n}}class BasicBody{constructor(){l(this,"tree",[]);l(this,"parent",null);l(this,"type","BasicBody");l(this,"isWeight",!1);l(this,"value",null);l(this,"isAdvance",!1);l(this,"isBindingOperation",!1);l(this,"isBindingFormula",!1);l(this,"formulaTextValue","");l(this,"formulaTextCharacter","");l(this,"operationalLogicText","");l(this,"cacheElementValue",null);l(this,"funcType",0);l(this,"constructorName","BasicBody");l(this,"id");l(this,"typetype",null);l(this,"operator",null);l(this,"indexex",0);l(this,"isFunction",!1);l(this,"x",0);l(this,"y",0);this.id=++EventManager.IDINDEX}addTest(e){return this.tree.includes(e)?!0:this.tree.some(t=>t instanceof fx.BasicBody&&t.addTest(e))}replace(e,t){this.tree[t]=e,e.parent=this}deletebody(e){const t=this.tree.indexOf(e);t!==-1&&(this.tree.splice(t,1),e.parent=null)}addBody(e){this.tree.includes(e)||(e.parent=this,this.tree.push(e))}getDeleteBodyTree(e){const t=this.tree.indexOf(e);if(t===-1)return[];const i=this.tree.slice(t);return this.tree.splice(t),i}dispose(){this.tree.forEach(e=>{e&&typeof e.dispose=="function"&&e.dispose()}),this.tree=[],this.value=null,this.parent=null,this.typetype=null,this.cacheElementValue=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.isWeight=!1,this.isAdvance=!1,this.isBindingOperation=!1,this.isBindingFormula=!1,this.isFunction=!1}getMaxHeight(){return this.tree.filter(t=>t instanceof fx.BasicBody).reduce((t,i)=>t+i.getMaxHeight(),0)||1}getValue(e,t,i){if(this.resetValues(),!!this.tree)return this.processTreeValues(),this.calculateFinalValue(),this.value=this.applyFunction(this.value),this.value}resetValues(){this.value=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.cacheElementValue=null}processTreeValues(){for(const e of this.tree){const t=this.getNodeValue(e);this.updateOperationalLogic(e,t),this.updateFormulaTexts(e,t)}}getNodeValue(e){if(e.type===NodeType.Sheet){const{name:t,row:i,col:r}=(e==null?void 0:e.selectedOutputInfo)||{};return getCatchValue(e,t,i,r)}return e.type===NodeType.CalculationLayer,getCatchValue(e)}updateOperationalLogic(e,t){var i;(i=this.cacheElementValue)!=null&&i.operator&&(this.operationalLogicText+=`(${t})`),this.cacheElementValue||(this.cacheElementValue=e,this.operationalLogicText+=`(${t})`),e.operator&&(this.operationalLogicText+=e.operator)}updateFormulaTexts(e,t){[0,NodeType.Variable,2,3,NodeType.Macro,NodeType.CalculationLayer,NodeType.Sheet].includes(e.type)&&(this.formulaTextCharacter+=e.getFormulaTextCharacter(),this.formulaTextValue+=t,e.operator&&(this.formulaTextValue+=e.operator,this.formulaTextCharacter+=e.operator))}calculateFinalValue(){const e=this.formulaTextValue.slice(-1);["+","-","*","/","%",">",">=","<","<=","!="].includes(e)||(this.value=fx.eval(this.operationalLogicText)),isNaN(this.value)?this.value=this.operationalLogicText:this.value=Number(this.value)}applyFunction(e){return this.returnFunc(e)}returnFunc(e){const i=this.getFunctionHandlers()[this.funcType];return i?i(e,this.tree):e}getFunctionHandlers(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>1-e,[HandleFunctionTypes["1/n"]]:e=>1/e,[HandleFunctionTypes["-n"]]:e=>-e,[HandleFunctionTypes["n*2"]]:e=>e*2,[HandleFunctionTypes["n/2"]]:e=>e/2,[HandleFunctionTypes["n*100"]]:e=>e*100,[HandleFunctionTypes["n/100"]]:e=>e/100,[HandleFunctionTypes["n*n"]]:e=>e*e,[CommonFunctionTypes.abs]:e=>Math.abs(e),[CommonFunctionTypes.random]:e=>Math.random()*e,[CommonFunctionTypes.floor]:e=>Math.floor(e),[CommonFunctionTypes.sqrt]:e=>Math.sqrt(e),[CommonFunctionTypes.max]:(e,t)=>this.calculateMax(t),[CommonFunctionTypes.min]:(e,t)=>this.calculateMin(t),[CommonFunctionTypes.pow]:(e,t)=>this.calculatePower(t),[CommonFunctionTypes.log]:e=>Math.log(e),[CommonFunctionTypes.exp]:e=>Math.exp(e),[CommonFunctionTypes.cbrt]:e=>Math.cbrt(e),[CommonFunctionTypes.sign]:e=>Math.sign(e),[CommonFunctionTypes.imul]:e=>Math.imul(e,1),[CommonFunctionTypes.ceil]:e=>Math.ceil(e),[CommonFunctionTypes.round]:e=>Math.round(e),[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.calculateRandom(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.divideValues(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.divideBySum(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.divideByDifference(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.weightedRandom(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.attackMinusDefense(t),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.attackSquaredOverDiff(t),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.diffTimesRatio(t),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.attackSquaredOverDefense(t),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.attackOverDefense(t),[CommonFormulaTypes["攻击*(1-系数)"]]:(e,t)=>this.attackWithCoefficient(t),[CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]]:(e,t)=>this.armorFormula(t),[CommonFormulaTypes["攻击*受伤率"]]:(e,t)=>this.attackWithDamageRate(t),[CommonFormulaTypes["攻击/(1+防御*系数)"]]:(e,t)=>this.attackOverDefenseFormula(t),[CommonFormulaTypes["攻击/防御*系数"]]:(e,t)=>this.attackRatioWithCoef(t),[CommonFormulaTypes["攻击*系数/防御"]]:(e,t)=>this.attackCoefOverDefense(t),[CommonFormulaTypes["攻击*(系数/防御)"]]:(e,t)=>this.attackTimesCoefRatio(t),[TriangleFunctionTypes["n*pi"]]:e=>e*Math.PI,[TriangleFunctionTypes.cos]:e=>Math.cos(e),[TriangleFunctionTypes.sin]:e=>Math.sin(e),[TriangleFunctionTypes.tan]:e=>Math.tan(e),[TriangleFunctionTypes.acos]:e=>Math.acos(e),[TriangleFunctionTypes.asin]:e=>Math.asin(e),[TriangleFunctionTypes.atan]:e=>Math.atan(e),[TriangleFunctionTypes.atan2]:(e,t)=>this.calculateAtan2(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.ifGreater(t),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.ifGreaterEqual(t),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.ifLess(t),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.ifLessEqual(t),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.ifEqual(t),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.ifNotEqual(t),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.forLoop(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.arrayAccess(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.calculateLength(t),[AlgorithmFunctionTypes.distance]:(e,t)=>this.calculateDistance(t),[AlgorithmFunctionTypes.dot]:(e,t)=>this.calculateDot(t),[AlgorithmFunctionTypes.cross]:(e,t)=>this.calculateCross(t),[AlgorithmFunctionTypes.mix]:(e,t)=>this.calculateMix(t),[GameFormula1.战斗公式]:(e,t)=>this.battleFormula(t),[GameFormula2.人物生命]:(e,t)=>this.characterHealth(t),[GameFormula2.近战素质物攻]:(e,t)=>this.meleeAttack(t),[GameFormula2.远程素质物攻]:(e,t)=>this.rangedAttack(t),[GameFormula2.法师素质物攻]:(e,t)=>this.mageAttack(t),[GameFormula2.物防]:(e,t)=>this.physicalDefense(t),[GameFormula2.魔防]:(e,t)=>this.magicDefense(t),[GameFormula2.命中]:(e,t)=>this.hitRate(t),[GameFormula2.闪避]:(e,t)=>this.dodgeRate(t),[GameFormula2.暴击]:e=>1+e/3,[GameFormula2.抗暴]:e=>1+e/5,[GameFormula2.职业素质点成长]:(e,t)=>this.jobPointGrowth(t),[GameFormula2.最终近战物攻]:(e,t)=>this.finalMeleeAttack(t),[GameFormula2.最终远程物攻]:(e,t)=>this.finalRangedAttack(t),[GameFormula2.最终魔法攻击]:(e,t)=>this.finalMagicAttack(t),[GameFormula2.物理伤害]:(e,t)=>this.physicalDamage(t),[GameFormula2.魔法伤害]:(e,t)=>this.magicDamage(t),[GameFormula2.命中率]:(e,t)=>this.hitChance(t),[GameFormula2.暴击率]:(e,t)=>this.critChance(t),[GameFormula3.成长公式]:(e,t)=>this.growthFormula(t)}}getTreeValue(e,t){return e.length>t?Number(getCatchValue(e[t])):0}calculateMax(e){const t=e.map(i=>Number(getCatchValue(i)));return Math.max(...t)}calculateMin(e){const t=e.map(i=>Number(getCatchValue(i)));return Math.min(...t)}calculatePower(e){return e.length<2?0:Math.pow(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateRandom(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return Math.random()*(i-t)+t}divideValues(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}divideBySum(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t/(t+i)}divideByDifference(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t/(i-t)}weightedRandom(e){if(e.length%2!==0)return 0;let t=0;for(let r=1;r<e.length;r+=2){const o=this.getTreeValue(e,r);e[r].indexex=o+t,t+=o}const i=Math.random()*t;for(let r=1;r<e.length;r+=2){const o=r>1&&e[r-2].indexex||0,s=e[r].indexex||0;if(i>=o&&i<s)return this.getTreeValue(e,r-1)}return 0}attackMinusDefense(e){return e.length<2?0:this.getTreeValue(e,0)-this.getTreeValue(e,1)}attackSquaredOverDiff(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t*t/(t+i)}diffTimesRatio(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return(t-i)*(t/i)}attackSquaredOverDefense(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t*t/i}attackOverDefense(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}attackWithCoefficient(e){return e.length<2?0:this.getTreeValue(e,0)*(1-this.getTreeValue(e,1))}armorFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t*i/(1+t*i)}attackWithDamageRate(e){return e.length<2?0:this.getTreeValue(e,0)*this.getTreeValue(e,1)}attackOverDefenseFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2);return t/(1+i*r)}attackRatioWithCoef(e){return e.length<3?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)*this.getTreeValue(e,2)}attackCoefOverDefense(e){return e.length<3?0:this.getTreeValue(e,0)*this.getTreeValue(e,2)/this.getTreeValue(e,1)}attackTimesCoefRatio(e){return e.length<3?0:this.getTreeValue(e,0)*(this.getTreeValue(e,2)/this.getTreeValue(e,1))}calculateAtan2(e){return e.length<2?0:Math.atan2(this.getTreeValue(e,0),this.getTreeValue(e,1))}ifGreater(e){return e.length<4?0:this.getTreeValue(e,0)>this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifGreaterEqual(e){return e.length<4?0:this.getTreeValue(e,0)>=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLess(e){return e.length<4?0:this.getTreeValue(e,0)<this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLessEqual(e){return e.length<4?0:this.getTreeValue(e,0)<=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifEqual(e){return e.length<4?0:this.getTreeValue(e,0)===this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifNotEqual(e){return e.length<4?0:this.getTreeValue(e,0)!==this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}forLoop(e){if(e.length<4)return 0;let t=0,i=0;const r=this.getTreeValue(e,0),o=this.getTreeValue(e,1),s=this.getTreeValue(e,2),u=this.getTreeValue(e,3);for(let c=r;c<=o;c++)c%s===1&&t++,i+=t+u;return i}arrayAccess(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0);return this.getTreeValue(e,t)}calculateLength(e){return e.length<2?0:fx.length(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateDistance(e){return e.length<4?0:fx.distance(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateDot(e){return e.length<4?0:fx.dot(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateCross(e){return e.length<4?0:fx.cross(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateMix(e){return e.length<3?0:fx.mix(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2))}battleFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2);return t*r*(1-1/(1+t*r/(5*i)))}characterHealth(e){if(e.length<4)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3);return t+r*i+o*(1+i)*i/2}meleeAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+i/5+r/5+s*o}rangedAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+i/5+r/5+s*o}mageAttack(e){if(e.length<1)return 0;const t=this.getTreeValue(e,0);return t*2+Math.pow(t/10,2)}physicalDefense(e){return this.value}magicDefense(e){return this.value}hitRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}dodgeRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}jobPointGrowth(e){return e.length<2?0:1+this.getTreeValue(e,0)/this.getTreeValue(e,1)}finalMeleeAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5),c=this.getTreeValue(e,6),d=this.getTreeValue(e,7);return(t*7+t/5+i/5+r/5+o+(o+s)*u)*c*d}finalRangedAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5),c=this.getTreeValue(e,6),d=this.getTreeValue(e,7);return(t*5+t/5+i/5+r/5+o+(o+s)*u)*c*d}finalMagicAttack(e){if(e.length<6)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5);return(t*7+t/5+i+(i+r)*o)*s*u}physicalDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t*(4e3+i)/(4e3+i*10)}magicDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return t*(1e3+i)/(1e3+i*10)}hitChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return(t-i+80)/100}critChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return(t-i)/100}growthFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),i=this.getTreeValue(e,1);return(t-1)*i}getFormulaTextValueBody(){const t=this.getFormulaTextBuilders()[this.funcType];return t?t(this.formulaTextValue,this.tree):this.formulaTextValue}getFormulaTextBuilders(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>`(1-(${e}))`,[HandleFunctionTypes["1/n"]]:e=>`1/(${e})`,[HandleFunctionTypes["-n"]]:e=>`-(${e})`,[HandleFunctionTypes["n*2"]]:e=>`(${e})*2`,[HandleFunctionTypes["n/2"]]:e=>`(${e})/2`,[HandleFunctionTypes["n*100"]]:e=>`(${e})*100`,[HandleFunctionTypes["n/100"]]:e=>`(${e})/100`,[HandleFunctionTypes["n*n"]]:e=>`(${e})*(${e})`,[CommonFunctionTypes.abs]:e=>`abs(${e})`,[CommonFunctionTypes.random]:e=>`random()*(${e})`,[CommonFunctionTypes.floor]:e=>`floor(${e})`,[CommonFunctionTypes.sqrt]:e=>`sqrt(${e})`,[CommonFunctionTypes.max]:(e,t)=>this.buildMaxText(t),[CommonFunctionTypes.min]:(e,t)=>this.buildMinText(t),[CommonFunctionTypes.pow]:(e,t)=>this.buildPowerText(t),[CommonFunctionTypes.log]:e=>`log(${e})`,[CommonFunctionTypes.exp]:e=>`exp(${e})`,[CommonFunctionTypes.cbrt]:e=>`cbrt(${e})`,[CommonFunctionTypes.sign]:e=>`sign(${e})`,[CommonFunctionTypes.imul]:e=>`imul(${e})`,[CommonFunctionTypes.ceil]:e=>`ceil(${e})`,[CommonFunctionTypes.round]:e=>`round(${e})`,[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.buildRandomRangeText(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.buildDivisionText(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.buildDivisionSumText(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.buildDivisionDiffText(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.buildWeightedText(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.buildAttackDefenseText(t,"-"),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.buildComplexAttackText(t,1),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.buildComplexAttackText(t,2),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.buildComplexAttackText(t,3),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.buildAttackDefenseText(t,"/"),[TriangleFunctionTypes["n*pi"]]:e=>`(${e})*PI`,[TriangleFunctionTypes.cos]:e=>`cos(${e})`,[TriangleFunctionTypes.sin]:e=>`sin(${e})`,[TriangleFunctionTypes.tan]:e=>`tan(${e})`,[TriangleFunctionTypes.acos]:e=>`acos(${e})`,[TriangleFunctionTypes.asin]:e=>`asin(${e})`,[TriangleFunctionTypes.atan]:e=>`atan(${e})`,[TriangleFunctionTypes.atan2]:(e,t)=>this.buildAtan2Text(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">"),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">="),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<"),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<="),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"=="),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"!="),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.buildForLoopText(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.buildArrayAccessText(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.buildAlgorithmText(t,"length"),[AlgorithmFunctionTypes.distance]:(e,t)=>this.buildAlgorithmText(t,"distance"),[AlgorithmFunctionTypes.dot]:(e,t)=>this.buildAlgorithmText(t,"dot"),[AlgorithmFunctionTypes.cross]:(e,t)=>this.buildAlgorithmText(t,"cross"),[AlgorithmFunctionTypes.mix]:(e,t)=>this.buildMixText(t),[GameFormula1.战斗公式]:(e,t)=>this.buildBattleFormulaText(t),[GameFormula2.人物生命]:(e,t)=>this.buildCharacterHealthText(t),[GameFormula2.近战素质物攻]:(e,t)=>this.buildMeleeAttackText(t),[GameFormula2.远程素质物攻]:(e,t)=>this.buildRangedAttackText(t),[GameFormula2.法师素质物攻]:(e,t)=>this.buildMageAttackText(t),[GameFormula2.物理伤害]:(e,t)=>this.buildPhysicalDamageText(t),[GameFormula2.魔法伤害]:(e,t)=>this.buildMagicDamageText(t),[GameFormula2.命中率]:(e,t)=>this.buildHitChanceText(t),[GameFormula2.暴击率]:(e,t)=>this.buildCritChanceText(t),[GameFormula3.成长公式]:(e,t)=>this.buildGrowthText(t)}}buildMaxText(e){return`max(${e.map(i=>i.getFormulaTextValue()).join(",")})`}buildMinText(e){return`min(${e.map(i=>i.getFormulaTextValue()).join(",")})`}buildPowerText(e){return e.length<2?"参数不匹配,请输入[值,值]":`pow(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildRandomRangeText(e){if(e.length<2)return"参数不匹配,请输入[最小值,最大值]";const t=e[0].getFormulaTextValue();return`random()*(${e[1].getFormulaTextValue()}-${t})+${t}`}buildDivisionText(e){return e.length<2?"参数不匹配,请输入[值,值]":`(${e[0].getFormulaTextValue()})/(${e[1].getFormulaTextValue()})`}buildDivisionSumText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),i=e[1].getFormulaTextValue();return`${t}/(${t}+${i})`}buildDivisionDiffText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),i=e[1].getFormulaTextValue();return`${t}/(${i}-${t})`}buildWeightedText(e){if(e.length%2!==0)return"参数不匹配,请输入[值,权重]";const t=[];for(let i=0;i<e.length;i+=2)t.push(`[值:${e[i].getFormulaTextValue()},权重:${e[i+1].getFormulaTextValue()}]`);return t.join(",")}buildAttackDefenseText(e,t){return e.length<2?"参数不匹配,请输入[攻击,防御]":`${e[0].getFormulaTextValue()}${t}${e[1].getFormulaTextValue()}`}buildComplexAttackText(e,t){if(e.length<2)return"参数不匹配,请输入[攻击,防御]";const i=e[0].getFormulaTextValue(),r=e[1].getFormulaTextValue();switch(t){case 1:return`${i}*${i}/(${i}+${r})`;case 2:return`(${i}-${r})*(${i}/${r})`;case 3:return`${i}*${i}/${r}`;default:return""}}buildAtan2Text(e){return e.length<2?"参数不匹配,请输入[值,值]":`atan2(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildIfText(e,t){if(e.length<4)return"参数不匹配,请输入[值,值,值,值]";const[i,r,o,s]=e.map(u=>u.getFormulaTextValue());return`if(${i}${t}${r}){return ${o}}else{return ${s}}`}buildForLoopText(e){if(e.length<4)return"参数不匹配,请输入[初始等级,当前等级,间隔值,初始值]";const[t,i,r,o]=e.map(s=>s.getFormulaTextValue());return`for(var i=${t};i<=${i};i++){if(i%${r}==1){a++}c+=a+${o}}`}buildArrayAccessText(e){return e.length<2?"参数不匹配,请输入下标和数组":`[${e[0].getFormulaTextValue()}]`}buildAlgorithmText(e,t){const i=t==="mix"?3:4,r=t==="mix"?"[值1,值2,混合比例]":"[x1,y1,x2,y2]";if(e.length<i)return`参数不匹配,请输入${r}`;const o=e.slice(0,i).map(s=>s.getFormulaTextValue()).join(",");return`${t}(${o})`}buildMixText(e){return e.length<3?"参数不匹配,请输入[值1,值2,混合比例]":`mix(${e.slice(0,3).map(i=>i.getFormulaTextValue()).join(",")})`}buildBattleFormulaText(e){if(e.length<3)return"参数不匹配,请输入[攻击,防御,技能系数]";const[t,i,r]=e.map(o=>o.getFormulaTextValue());return`${t}*${r}*(1-(1/(1+((${t}*${r})/(5*${i})))))`}buildCharacterHealthText(e){if(e.length<4)return"参数不匹配,请输入[基础生命,等级,职业系数A,职业系数B]";const[t,i,r,o]=e.map(s=>s.getFormulaTextValue());return`${t}+${r}*${i}+${o}*(1+${i})*${i}/2`}buildMeleeAttackText(e){if(e.length<5)return"参数不匹配,请输入[力量,灵巧,幸运,等级,职业攻击系数]";const[t,i,r,o,s]=e.map(u=>u.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${i}/5+${r}/5+${s}*${o}`}buildRangedAttackText(e){if(e.length<5)return"参数不匹配,请输入[灵巧,力量,幸运,等级,职业攻击系数]";const[t,i,r,o,s]=e.map(u=>u.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${i}/5+${r}/5+${s}*${o}`}buildMageAttackText(e){if(e.length<1)return"参数不匹配,请输入[力量]";const t=e[0].getFormulaTextValue();return`${t}*2+pow(${t}/10,2)`}buildPhysicalDamageText(e){if(e.length<2)return"参数不匹配,请输入[物攻,物防]";const[t,i]=e.map(r=>r.getFormulaTextValue());return`${t}*(4000+${i})/(4000+(${i}*10))`}buildMagicDamageText(e){if(e.length<2)return"参数不匹配,请输入[魔攻,魔防]";const[t,i]=e.map(r=>r.getFormulaTextValue());return`${t}*(1000+${i})/(1000+(${i}*10))`}buildHitChanceText(e){if(e.length<2)return"参数不匹配,请输入[命中,闪避]";const[t,i]=e.map(r=>r.getFormulaTextValue());return`(${t}-${i}+80)/100`}buildCritChanceText(e){if(e.length<2)return"参数不匹配,请输入[暴击,抗暴]";const[t,i]=e.map(r=>r.getFormulaTextValue());return`(${t}-${i})/100`}buildGrowthText(e){if(e.length<2)return"参数不匹配,请输入[等级,属性成长值]";const[t,i]=e.map(r=>r.getFormulaTextValue());return`(${t}-1)*${i}`}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){return this.formulaTextCharacter}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}}class SymbolBody extends BasicBody{constructor(){super();l(this,"operator",null);l(this,"type","SymbolBody");l(this,"isFunctionId",1);l(this,"funcType",0);l(this,"constructorName","SymbolBody")}copy(){var t=new fx.SymbolBody;return t.operator=this.operator,t.isFunctionId=this.isFunctionId,t.tree=this.tree,t.parent=this.parent,t.value=this.value,t.isWeight=this.isWeight,t.isBindingOperation=this.isBindingOperation,t.isBindingFormula=this.isBindingFormula,t.formulaTextValue=this.formulaTextValue,t.formulaTextCharacter=this.formulaTextCharacter,t.operationalLogicText=this.operationalLogicText,t.cacheElementValue=this.cacheElementValue,t}setFunctionId(t){this.isFunctionId=t}getRunFunctionId(){var t=this.getFunctionLength();return this.isFunctionId++,this.isFunctionId>t&&(this.isFunctionId=1),this.isFunctionId}getFunctionLength(){for(var t=0,i=0;i<this.tree.length;i++)this.tree[i].isFunction&&t++;return t}getFunction(t){for(var i=0,r=0;r<this.tree.length;r++)if(this.tree[r].isFunction&&(i++,i==t))return this.tree[r];return null}getValue(){if((this.operator=="fx"||this.operator=="=")&&this.getFunctionLength()>0){const i=this.getFunction(this.isFunctionId);return i?this.value=this.returnFunc(getCatchValue(i)):this.value=null,this.value}else{this.value=null,this.operationalLogicText="";for(var t=0;t<this.tree.length;t++)t<this.tree.length-1?this.operationalLogicText+=Number(getCatchValue(this.tree[t]))+(this.operator||""):this.operationalLogicText+="("+Number(getCatchValue(this.tree[t]))+")";this.value=fx.eval(this.operationalLogicText)}return isNaN(this.value)?(this.value=this.returnFunc(this.value),this.value):(this.value=this.returnFunc(Number(this.value)),this.value)}getFormulaTextCharacter(){if(this.operator=="="&&this.getFunctionLength()>0){const o=this.getFunction(this.isFunctionId);o?this.formulaTextCharacter="("+o.getFormulaTextCharacter()+")":this.formulaTextCharacter=""}else{this.formulaTextCharacter="";for(var t=0;t<this.tree.length;t++)if(t<this.tree.length-1)this.formulaTextCharacter+="("+this.tree[t].getFormulaTextCharacter()+")"+(this.operator||"");else{var i=this.tree[t].getFormulaTextCharacter();i.indexOf("+")==-1&&i.indexOf("-")==-1&&i.indexOf("*")==-1&&i.indexOf("/")==-1&&i.indexOf("%")==-1&&i.indexOf(">")==-1&&i.indexOf(">=")==-1&&i.indexOf("<")==-1&&i.indexOf("<=")==-1&&i.indexOf("==")==-1?this.formulaTextCharacter+=i:this.formulaTextCharacter+="("+i+")"}}var r=this.formulaTextCharacter;return this.funcType!=0&&(r=this.getFormulaTextCharacterBody()),r}getFormulaTextValue(){if(this.funcType==0){if(this.operator=="="&&this.getFunctionLength()>0){const r=this.getFunction(this.isFunctionId);r?this.formulaTextValue="("+r.getFormulaTextValue()+")":this.formulaTextValue=""}else{this.formulaTextValue="";for(var t=0;t<this.tree.length;t++){var i=this.tree[t].getFormulaTextValue();t<this.tree.length-1?this.formulaTextValue+="("+i+")"+(this.operator||""):i.indexOf("+")==-1&&i.indexOf("-")==-1&&i.indexOf("*")==-1&&i.indexOf("/")==-1&&i.indexOf("%")==-1&&i.indexOf(">")==-1&&i.indexOf(">=")==-1&&i.indexOf("<")==-1&&i.indexOf("<=")==-1&&i.indexOf("==")==-1?this.formulaTextValue+=i:this.formulaTextValue+="("+i+")"}}return this.formulaTextValue}else return this.getFormulaTextValueBody()}dispose(){for(var t=0;t<this.tree.length;t++)this.tree[t].dispose()}}class OperationBody extends BasicBody{constructor(){super();l(this,"type","OperationBody");l(this,"constructorName","OperationBody");l(this,"isFunction",!1)}}class FormulaData{constructor(e,t,i){l(this,"name");l(this,"x");l(this,"y");l(this,"body",null);l(this,"type","Formula");l(this,"cacheTargetStoragePool",null);l(this,"cacheTargetFolder",null);l(this,"constructorName","FormulaData");l(this,"id",0);this.name=e,this.x=t,this.y=i,this.cacheTargetStoragePool=fx.targetStoragePool,this.cacheTargetFolder=fx.targetFolder.formulaTree,this.cacheTargetStoragePool.push(this),this.cacheTargetFolder.push(this),this.id=++EventManager.IDINDEX}getValue(){return this.body!=null?getCatchValue(this.body):0}dispose(){let e=this.cacheTargetStoragePool.indexOf(this);e>=0&&this.cacheTargetStoragePool.splice(e,1),e=this.cacheTargetFolder.indexOf(this),this.cacheTargetFolder.splice(e,1)}}class Player{constructor(){l(this,"name","");l(this,"hp",0);l(this,"maxHp",0);l(this,"maxShield",0);l(this,"shield",0);l(this,"enemyBody",null);l(this,"battlePool",[]);l(this,"valist",[]);l(this,"lflist",[]);l(this,"brlist",[]);l(this,"instantiation",null);l(this,"playerData",null);l(this,"folder",null);l(this,"comboxMaxHp","未设置血量公式");l(this,"combBoxAttack","未设置攻击公式");l(this,"underAttackName","");l(this,"shieldRuptureName","");l(this,"isShieldDetection",!1);l(this,"dieName","");l(this,"isDie",!1);l(this,"delayCustomList",[]);l(this,"callCenter",null);l(this,"tagArray",[]);l(this,"id",0);l(this,"constructorName","Player");l(this,"attackNum",0);l(this,"level",1);l(this,"levelVar","");l(this,"maxLEvel",100);l(this,"exp",0);l(this,"expName","");l(this,"levelUpConfig",{});l(this,"parameterInfoArray",[]);this.name="",this.hp=0,this.maxHp=0,this.maxShield=0,this.shield=0,this.enemyBody=null,this.level=1,this.levelVar="",this.battlePool=[],this.valist=[],this.lflist=[],this.brlist=[],this.instantiation=null,this.playerData=null,this.updatePlayerData(),this.comboxMaxHp="未设置血量公式",this.combBoxAttack="未设置攻击公式",this.underAttackName="",this.shieldRuptureName="",this.isShieldDetection=!1,this.dieName="",this.isDie=!1,this.delayCustomList=[],this.callCenter=new CallCenter,this.callCenter.addEventListener(EventManager.UP_DATA_PLAYER,this.upDataPlayerFunction,null,this),this.tagArray=[],this.id=++EventManager.IDINDEX,this.constructorName="Player",this.attackNum=0}resetTag(){this.tagArray=[]}gesetTagPopulation(e){let t=0;for(let i=0;i<this.tagArray.length;i++)this.tagArray[i].name==e&&t++;return t}gesetTagAll(){return this.tagArray}addTag(e){this.tagArray.push({name:e})}upDataPlayerFunction(e){this.updatePlayerData()}updatePlayerData(){fx.player=this,this.attackNum=0,this.playerData=this.createPlayer()}recursionSet(e,t){fx.player=this;for(let i=0;i<e.length;i++)e[i]instanceof VariableValue?e[i].enemyFlag&&(t==null?e[i].setEnemyBody(null):e[i].setEnemyBody(t.getPropertyObject(e[i].source.absoluteAddress))):this.recursionSet(e[i].tree,t)}getFormula(e){fx.player=this,fx.clearCacheRecursion(this.folder);let t=0;for(let i=0;i<this.playerData.formulaTree.length;i++)if(this.playerData.formulaTree[i].name==e){t=this.playerData.formulaTree[i].body.getValue();break}for(let i=0;i<fx.stageStoragePool.length;i++)fx.stageStoragePool[i]instanceof FormulaData&&fx.stageStoragePool[i].name==e&&(t=fx.stageStoragePool[i].body.getValue());return t}delay(e,t,i,r){const o=e+"次数";this[""+e]==null&&(this[""+e]=0,this.delayCustomList.push(""+e)),this[""+o]==null&&(this[""+o]=0,this.delayCustomList.push(""+o)),this[""+e]++,this[""+e]>=t&&Number(this[""+o])<=Number(i)+1&&(this[""+e]=0,this[""+o]++,r())}hit(e,t,i){this.instantiation!=null}attack(e,t){this.attackNum++,fx.player=this,fx.clearCacheRecursion(this.folder),fx.isCrit=!1;let i=0,r=0;for(let o=0;o<this.playerData.formulaTree.length;o++)if(this.playerData.formulaTree[o].name==e){fx.enemyBody=t,this.enemyBody=t,i=this.playerData.formulaTree[o].body.getValue();const s=t.isDie;t.getShield()!=0?t.minusShield(i):t.minusHp(i),!s&&t.isDie&&r++,fx.enemyBody=null;break}for(let o=0;o<fx.stageStoragePool.length;o++)if(fx.stageStoragePool[o]instanceof FormulaData&&fx.stageStoragePool[o].name==e){fx.enemyBody=t,this.enemyBody=t,i=fx.stageStoragePool[o].body.getValue();const s=t.isDie;t.getShield()!=0?t.minusShield(i):t.minusHp(i),!s&&t.isDie&&r++,fx.enemyBody=null}return r>0&&this.onEnmeyKilled(r),[i,fx.isCrit]}getNeedExp(){return 1}onEnmeyKilled(e){this.exp+=e,this.checkUpdateLevel()}checkUpdateLevel(){const e=this.getNeedExp();this.exp>=e&&this.level<this.maxLEvel&&(this.level++,this.exp=0,fx.Call.send(EventManager.PLAYER_INSTANCE_LEVEL_UP,[this.id,this.level,this.exp]))}setMaxShield(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxShield=0,this.shield=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxShield=this.playerData.formulaTree[t].body.getValue(),this.shield=this.maxShield;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxShield=fx.stageStoragePool[t].body.getValue(),this.shield=this.maxShield);return e=="无"&&(this.maxShield=this.shield=0),this.isShieldDetection=!1,this.maxShield}setMaxHp(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxHp=0,this.hp=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxHp=this.playerData.formulaTree[t].body.getValue(),this.hp=this.maxHp;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxHp=fx.stageStoragePool[t].body.getValue(),this.hp=this.maxHp);e=="无"&&(this.maxHp=this.hp=0),this.isDie=!1;for(let t=0;t<this.delayCustomList.length;t++)this[this.delayCustomList[t]]=null;return this.maxHp}getMaxHp(){return this.maxHp}getMaxShield(){return this.maxShield}getShield(){return this.shield}getHp(){return this.hp}setHp(e){this.hp=e}setShield(e){this.shield=e}underAttack(){this.getFormula(this.underAttackName)}setshieldRupture(e){this.shieldRuptureName=e}setUnderAttack(e){this.underAttackName=e}shieldRupture(){this.getFormula(this.shieldRuptureName),this.isShieldDetection=!0}minusShield(e){return this.shield-=e,this.shield<=0&&this.isShieldDetection==!1&&(this.shield=0,this.shieldRupture()),this.underAttack(),this.shield}setDie(e){this.dieName=e}die(){this.getFormula(this.dieName),this.isDie=!0}minusHp(e){return this.hp-=e,this.hp<=0&&this.isDie==!1&&(this.hp=0,this.die()),this.underAttack(),this.hp}getBillboard(){fx.player=this;const e=[];return fx.recursionGetBillboard(e,this.playerData),e.length==0?fx.billBoardList:e}getPropertyObject(e,t){return fx.player=this,fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t)}setProperty(e,t){fx.player=this;const i=this.getPropertyObject(e);return i!=null?i.setValue(t):console.log("没有找到属性"),t}getProperty(e,t){return fx.player=this,fx.clearCache(),this.getPropertyObject(e)!=null?fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t).getValue():(console.log("没有找到属性"),0)}dispose(){this.callCenter.dispose(),this.playerData.dispose(),this.name="",this.hp=0,this.maxHp=0,this.playerData=null,this.callCenter=null,this.tagArray=[],this.id=0,this.constructorName="",this.attackNum=0}clearCache(){fx.player=this,fx.clearCacheRecursion(this.folder)}createPlayer(){this.attackNum=0,fx.editBody=null,fx.selectBody=null,fx.isBodyView=!1,this.folder=new fx.Folder;const e=[];fx.addLibraryBody(e,fx.targetFolder.tree);const t=e;return fx.targetFolder=this.folder,fx.createLibraryBody(t,!0),fx.parseLibraryBody(t,!0),fx.recursionSyncBody(fx.targetFolder.tree),fx.editBody=null,fx.selectBody=null,fx.targetStoragePool=fx.stageStoragePool,fx.targetFolder=fx.sceneFolder,fx.isBodyView=!0,this.valist=[],this.lflist=[],this.brlist=[],fx.recursiveDataReading(this.folder,this.valist,this.lflist,this.brlist),this.folder}recoveryAttribute(){for(let e=0;e<this.valist.length;e++)this.setProperty(this.valist[e].absoluteAddress,Number(this.valist[e].value))}setParameterInfoArray(e){this.parameterInfoArray=e}getParameterInfoArray(){return this.parameterInfoArray}findParameterInfoByName(e){return this.parameterInfoArray.find(t=>t.parameterInfoname===e)||null}updateParameterValue(e,t,i){const r=this.findParameterInfoByName(e);if(!r)return!1;for(const o of r.parameterInfoArray)for(const s of o.parameter)if(s.path===t)return s.value=i,!0;return!1}getParameterValue(e,t){const i=this.findParameterInfoByName(e);if(!i)return null;for(const r of i.parameterInfoArray)for(const o of r.parameter)if(o.path===t)return o.value;return null}changeLevelAndOccupation(e,t,i={levelPath:"等级",occupationPath:"职业"}){const r=this.findParameterInfoByName(this.name);if(!r){console.warn(`未找到玩家 "${this.name}" 的参数信息`);return}for(const o of r.parameterInfoArray)for(const s of o.parameter)s.path===i.levelPath?s.value=e:s.path===i.occupationPath&&(s.value=t);this.level=e,this.gameManualOverrideParameter(r)}gameManualOverrideParameter(e){const t=this.getBillboard();e.parameterInfoArray.forEach(i=>{i&&t.forEach(r=>{i.name===r.name&&i.parameter.forEach(o=>{const s=o.path;r.metadataArray.forEach(u=>{const c=[];if(fx.getStepData(u.body.source,c),c.toString()===s){const f=u.body.getValue(),p=Number(o.value);f!==p&&u.body.setGlobalValue(p)}})})})})}}class BillboardLayer{constructor(e){l(this,"name","");l(this,"operationArray",[]);l(this,"metadataArray",[]);l(this,"id",0);l(this,"monitored",!0);l(this,"constructorName","BillboardLayer");this.name=e,this.id=++EventManager.IDINDEX}dispose(){this.name=null,this.operationArray=null,this.metadataArray=null,this.monitored=null}pushOperationLayer(){if(fx.clickBody!=null&&fx.clickBody.type==NodeType.CalculationLayer){const e=new fx.OperationLayerData(fx.clickBody);this.operationArray.push(e)}fx.clickBody=null}pushMetadata(e,t,i,r,o){if(fx.clickBody!=null&&fx.clickBody instanceof fx.VariableValue&&fx.clickBody.type!=5){const s=new fx.MetadataData(fx.clickBody);s.type=e,s.presentValue=getCatchValue(s.body),s.minValue=t,s.maxValue=i,s.intervalValue=r,s.list=o&&o.length?o.map(u=>({value:Number(u.value),name:u.name})):[],this.metadataArray.push(s)}fx.clickBody=null}}class ChartsLayer{constructor(e){l(this,"name");l(this,"operationArray",[]);l(this,"metadata",null);l(this,"metadataArray",[]);l(this,"minValue",1);l(this,"maxValue",1);l(this,"intervalValue",1);l(this,"constructorName","ChartsLayer");l(this,"id");this.name=e,this.id=++EventManager.IDINDEX}addMetadataData(){fx.clickBody!=null&&(this.metadata=fx.clickBody.copy(),this.metadataArray[0]=this.metadata)}dispose(){}}class Bookmark{constructor(){l(this,"id",0);l(this,"x",0);l(this,"y",0);l(this,"width",512);l(this,"height",512);l(this,"text","标签");l(this,"view",null);l(this,"type","Bookmark");l(this,"bookmarkView",null)}}class MetadataData{constructor(e){l(this,"body");l(this,"view",null);l(this,"type",0);l(this,"presentValue",0);l(this,"minValue",0);l(this,"maxValue",0);l(this,"intervalValue",0);l(this,"list");this.body=e.copy()}}class SheetData{constructor(e){l(this,"originData");this.originData=e}setData(e){this.originData=e}getValue(e,t,i){var p,V,h;if(!(this!=null&&this.originData)||typeof e>"u"||typeof t>"u"||typeof i>"u")return 0;const s=this.originData.sheets.find(m=>m.name===e),u=s.uniqueInfo.find(m=>m.row===t&&m.col===i),c=(p=s==null?void 0:s.data)==null?void 0:p.get(`${t},${i}`),d=c==null?void 0:c.cellData;let f=d==null?void 0:d.v;return d!=null&&d.type&&(f=(V=c==null?void 0:c.source)!=null&&V.getValue?(h=c.source)==null?void 0:h.getValue():0),(u==null?void 0:u.value)||f||0}}class OperationLayerData{constructor(e){l(this,"body");l(this,"view",null);this.body=e.copy()}}class Message{constructor(){l(this,"userData",null);l(this,"type",null)}}const globalThis_$1=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_$1.target=null;class A{test(){try{console.log("console A")}catch(e){console.error("Error in class A test:",e)}}}class B extends A{constructor(){super()}test(){try{console.log("console B")}catch(e){console.error("Error in class B test:",e)}}}const a=class a{static recursiveDataReading(e,t,i,r){try{if(!e||!e.tree||!Array.isArray(e.tree))throw new Error("Invalid object structure for recursive reading");for(let o=0;o<e.tree.length;o++){const s=e.tree[o];s!=null&&(s.isFolder?this.recursiveDataReading(s,t,i,r):s.type==NodeType.Variable?t.push(s):s.type==NodeType.CalculationLayer?i.push(s):s instanceof a.BillboardLayer&&r.push(s))}}catch(o){console.error("Error in recursive data reading:",o)}}};l(a,"b",new B),l(a,"code",!1),l(a,"isNumber",function(e){try{return!isNaN(Number(e))&&isFinite(Number(e))}catch(t){return console.error("Error checking if value is number:",t),!1}}),l(a,"mix",function(e,t,i){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(i))throw new Error("Invalid parameters for mix function");return e*(1-i)+t*i}catch(r){return console.error("Error in mix function:",r),0}}),l(a,"cross",function(e,t,i,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(i)||!a.isNumber(r))throw new Error("Invalid parameters for cross function");return e*i-t*r}catch(o){return console.error("Error in cross function:",o),0}}),l(a,"dot",function(e,t,i,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(i)||!a.isNumber(r))throw new Error("Invalid parameters for dot function");return e*i+t*r}catch(o){return console.error("Error in dot function:",o),0}}),l(a,"distance",function(e,t,i,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(i)||!a.isNumber(r))throw new Error("Invalid parameters for distance function");const o=Math.abs(e-i),s=Math.abs(t-r);return a.length(o,s)}catch(o){return console.error("Error in distance function:",o),0}}),l(a,"length",function(e,t){try{if(!a.isNumber(e)||!a.isNumber(t))throw new Error("Invalid parameters for length function");return Math.sqrt(e*e+t*t)}catch(i){return console.error("Error in length function:",i),0}}),l(a,"billBoardList",[]),l(a,"functionAddIndex",0),l(a,"visualVersionCompatibility",!1),l(a,"singletonInstance",null),l(a,"isStart",!1),l(a,"FXCentre",FXCentre),l(a,"NodeType",NodeType),l(a,"Folder",Folder),l(a,"Eve",EventManager),l(a,"CallCenter",CallCenter),l(a,"MessageList",MessageList),l(a,"VariableValue",VariableValue),l(a,"Call",Call),l(a,"SymbolBody",SymbolBody),l(a,"BasicBody",BasicBody),l(a,"OperationBody",OperationBody),l(a,"Player",Player),l(a,"BillboardLayer",BillboardLayer),l(a,"ChartsLayer",ChartsLayer),l(a,"Bookmark",Bookmark),l(a,"FormulaData",FormulaData),l(a,"MetadataData",MetadataData),l(a,"SheetData",SheetData),l(a,"OperationLayerData",OperationLayerData),l(a,"Message",Message),l(a,"noCache",!1),l(a,"enemyBody",null),l(a,"sceneFolder",null),l(a,"targetFolder",null),l(a,"isFolderDuplicationOfName",!1),l(a,"isBillboardLayerView",!0),l(a,"isBodyView",!0),l(a,"isGlobalOperations",!1),l(a,"isDragBody",!1),l(a,"stageMaskValue",{}),l(a,"stageGroup",null),l(a,"clickBody",null),l(a,"selectCellBody",null),l(a,"editBody",null),l(a,"selectBody",null),l(a,"stageStoragePool",[]),l(a,"targetStoragePool",a.stageStoragePool),l(a,"player",null),l(a,"isCrit",!1),l(a,"distribute",function(e,t){const i=t.reduce((r,o)=>r+o,0);return t.map(r=>e*r/i)}),l(a,"partitionCurve",function(e,t,i,r,o,s){const u=[],c=[];let d=o,f=s;d==null&&(d=.382),f==null&&(f=.618);let p=0;for(let V=1;V<=t;V++){const h=Math.pow(t,i),y=Math.pow(V,i)/h,g=V*(1e4*d)/t+y*(1e4*f);u.push(g),p+=g}for(let V=0;V<u.length;V++)if(r==null)c.push(u[V]/p*e);else switch(r){case 0:c.push(u[V]/p*e);break;case 1:c.push(Math.floor(u[V]/p*e));break;case 2:c.push(Math.floor(u[V]/p*e));break}return c}),l(a,"eval",function(e){return a.evaluateExpression(e)}),l(a,"recursionLibraryBody",function(e,t,i){if(t.tree==null)return null;for(let r=0;r<t.tree.length;r++){if(t.tree[r].absoluteAddress==i){e.push(t.tree[r]);return}a.recursionLibraryBody(e,t.tree[r],i)}return null}),l(a,"double",function(e,t){switch(t){case 0:return Math.round(e*1)/1;case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4;case 5:return Math.round(e*1e5)/1e5;case 6:return Math.round(e*1e6)/1e6;case 7:return Math.round(e*1e7)/1e7}return 0}),l(a,"getLibraryBody",function(e,t,i){for(let r=0;r<t.length;r++){if(t[r].absoluteAddress==null&&(t[r].absoluteAddress=a.getAbsoluteAddress(t[r])),t[r].absoluteAddress==i){e.push(t[r]);return}t[r].isFolder&&a.getLibraryBody(e,t[r].tree,i)}}),l(a,"mapToJSON",function(e){return e?JSON.stringify([...e].reduce((t,[i,r])=>{const o={...r},s=o.source;if(s){const u=a.createVarData(s.TID,s.name,s.value,s.type,s.macros,s.operator,s.enemyFlag,s.source,s.tag,s.statistics,s.upDateValue,s.demoteValue,s.funcType,s.isLogicalOpen,s.isDragging,s.currentStep,s.snNo,s.minValue,s.maxValue,s.step,s.logicalChildArray,s.selectedOutputInfo);o.source=u}return t[i]=o,t},{})):"{}"}),l(a,"addLibraryBody",function(e,t){var o;for(let s=0;s<t.length;s++){const u=t[s];let c=(o=u.sheetData)==null?void 0:o.originData;if(c&&(c={...c},c.sheets=[...c.sheets.map(d=>({...d,data:a.mapToJSON(d.data)}))]),u instanceof a.VariableValue){var i=a.createOperationLayerData(u.name,u.type,u.value,u,u.tag,u.isSystemShow,u.sheetData?JSON.stringify(c):null,u.childCell);i.id=u.id,e.push(i),a.saveBody(i.operationArray,a.seekSource(u.childBodyArray))}if(u instanceof a.Folder){var i=a.createFolderData(u.name,u.isFolder,u);i.id=u.id,e.push(i),a.addLibraryBody(i.operationArray,u.tree)}if(a.isBillboardLayerView){if(u instanceof a.BillboardLayer){var i=a.createBillboarData(u.name,u,u.monitored);i.id=u.id,e.push(i);for(var r=0;r<u.operationArray.length;r++){const f=u.operationArray[r],p=a.createOperationLayerData(f.body.name,f.body.type,f.body.value,f.body.source,f.body.tag,f.body.isSystemShow,null,null);p.id=f.body.id,i.operationArray.push(p)}for(var r=0;r<u.metadataArray.length;r++){const p=u.metadataArray[r],V=a.createBillboarMetadataData(p.body.name,p.body.type,p.body.value,p.body.source,p);V.id=p.body.id,i.metadataArray.push(V)}}if(u instanceof a.ChartsLayer){var i=a.createChartData(u);i.id=u.id,e.push(i)}}}}),l(a,"parseLibraryBody",function(e,t){for(let r=0;r<e.length;r++){const o=e[r];if(o.type==NodeType.CalculationLayer){var i=[];a.getLibraryBody(i,a.targetFolder.tree,o.site),a.editBody=i[0],a.selectBody=a.editBody,a.targetStoragePool=a.editBody.childBodyArray,a.editBody.isSystemShow=o.isSystemShow,a.parseStageBody(o.operationArray)}else if(o.type==0||o.type==NodeType.Variable||o.type==2||o.type==3){var i=[];a.getLibraryBody(i,a.targetFolder.tree,o.site),a.editBody=i[0],a.selectBody=a.editBody,a.targetStoragePool=a.stageStoragePool,a.parseStageBody(o.operationArray)}else if(o.isFile==!0){var i=[];a.getLibraryBody(i,a.targetFolder.tree,o.site),a.editBody=i[0];const u=i[0];for(let c=0;c<o.operationArray.length;c++){const d=o.operationArray[c];if(d.type==NodeType.CalculationLayer){var i=[];a.getLibraryBody(i,a.targetFolder.tree,d.site),a.editBody=i[0],a.selectBody=i[0],a.targetStoragePool=i[0].childBodyArray,a.parseStageBody(d.operationArray),a.editBody=u,a.editBody.isSystemShow=d.isSystemShow}else d.isBoard==!0?(a.selectBody=a.editBody,d.index=c,a.Call.send(a.Eve.SHIFT_ADD_BOARD,d,null)):d.isXlsx==!0&&(a.selectBody=a.editBody,d.index=c,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,d,null));if(d.isFile==!0){var i=[];a.getLibraryBody(i,a.targetFolder.tree,d.site),a.editBody=i[0],a.parseLibraryBody(d.operationArray,!1)}}a.editBody=null}else o.isBoard==!0?(a.selectBody=a.editBody,a.billBoardList.push(o),a.Call.send(a.Eve.SHIFT_ADD_BOARD,o,null)):o.isXlsx==!0&&(a.selectBody=a.editBody,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,o,null));t&&(a.selectBody=null)}}),l(a,"createLibraryBody",function(e,t,i,r){for(let c=0;c<e.length;c++){const d=e[c];if(d.isFile==!0){var o=new a.Folder(d.name);a.Call.send(a.Eve.CREATE_FILE_DATA,o,null),r!=null?(a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,r],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,r],null)):(a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,a.selectBody],null)),a.selectBody=o,a.selectBody.absoluteAddress=d.site;for(let f=0;f<d.operationArray.length;f++){const p=d.operationArray[f];if(p.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(p.name,null,5),a.editBody.tag=p.name.tag,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=p.site,a.targetStoragePool=a.editBody.childBodyArray;else if(p.type==0||p.type==NodeType.Variable||p.type==2||p.type==3){var s=p.name+"="+p.value,u=new a.VariableValue(s.split("=")[0],s.split("=")[1],1);p.type==NodeType.Variable&&(u.isAI=i||!1),a.editBody=u,a.editBody.tag=p.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,u,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=p.site,a.targetStoragePool=a.editBody.childBodyArray}else if(p.type==NodeType.Sheet){var s=p.name,u=new a.VariableValue(s.split("=")[0],void 0,p.type);u.selectedOutputInfo=p!=null&&p.selectedOutputInfo?JSON.parse(p==null?void 0:p.selectedOutputInfo):null;const m=typeof p.sheetData=="string"?JSON.parse(p.sheetData):p.sheetData;m!=null&&m.sheets&&(m.sheets=m.sheets.map(y=>{const g=JSON.parse(y.data);return Object.values(g).forEach(T=>{if(T!=null&&T.source){const v=T.source,b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(v));const F=b[0];T.source=F.copy()}}),{...y,data:new Map(Object.entries(g))}})),u.setSheetData(m),u.childCell=p.childCell,a.editBody=u,a.editBody.tag=p.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=p.site,a.targetStoragePool=a.editBody.childBodyArray}if(p.isFile==!0){var o=new a.Folder(p.name);a.Call.send(a.Eve.CREATE_FILE_DATA,o,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,a.selectBody],null),a.selectBody=o,a.selectBody.absoluteAddress=p.site,a.createLibraryBody(p.operationArray,!1,!1,o),a.selectBody=o.parentFolder}}a.selectBody=o.parentFolder}if(d.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(d.name,null,5),a.editBody.tag=d.tag,a.editBody.isSystemShow=d.isSystemShow,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray;else if(d.type==0||d.type==NodeType.Variable||d.type==2||d.type==3){var s=d.name+"="+d.value,u=new a.VariableValue(s.split("=")[0],s.split("=")[1],1);d.type==NodeType.Variable&&(u.isAI=i||!1),a.editBody=u,a.editBody.tag=d.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,u,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}else if(d.type==NodeType.Sheet){var s=d.name,u=new a.VariableValue(s.split("=")[0],void 0,d.type);u.selectedOutputInfo=d!=null&&d.selectedOutputInfo?JSON.parse(d==null?void 0:d.selectedOutputInfo):null;const V=typeof d.sheetData=="string"?JSON.parse(d.sheetData):d.sheetData;V!=null&&V.sheets&&(V.sheets=V.sheets.map(h=>{const m=JSON.parse(h.data);return Object.values(m).forEach(y=>{if(y!=null&&y.source){const g=y.source,T=[];a.getLibraryBody(T,a.targetFolder.tree,a.getAbsoluteAddress(g));const v=T[0];y.source=v.copy()}}),{...h,data:new Map(Object.entries(m))}})),u.setSheetData(V),u.childCell=d.childCell,a.editBody=u,a.editBody.tag=d.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}t&&(a.selectBody=null)}}),l(a,"getBody",function(e,t,i){const r=[];return a.recursionLibraryBody(r,e,t),i!=null&&r[0].body.setFunctionId(i),r[0]}),l(a,"evaluateExpression",function(e){const t=a.toRPN(e),i=[];for(const r of t)if(a.isNumber(r))i.push(Number(r));else{const o=i.pop(),s=i.pop();let u;if(s!==void 0&&o!==void 0)switch(r){case"+":u=s+o;break;case"-":u=s-o;break;case"*":u=s*o;break;case"/":u=s/o;break;case"%":u=s%o;break;case"^":u=Math.pow(s,o);break;case">":u=s>o;break;case"<":u=s<o;break;case">=":u=s>=o;break;case"<=":u=s<=o;break;case"==":u=s===o;break;case"!=":u=s!==o;break}i.push(u)}return i.pop()}),l(a,"toRPN",function(e){e=e+"",e=e.replace(/\s+/g,"");const t={"+":1,"-":1,"*":2,"/":2,"%":2,"^":3,">":4,"<":4,">=":4,"<=":4,"==":4,"!=":4},i=[],r=[];function o(f){i.push(f)}function s(){const f=r.pop();f&&o(f)}function u(f){return t.hasOwnProperty(f)}function c(f,p){return f==="-"&&p===0||f==="-"&&!a.isNumber(e[p-1])&&e[p-1]!==")"}for(let f=0;f<e.length;f++){const p=e[f];if(a.isNumber(p)||c(p,f)){let V=p,h=f+1;for(;h<e.length&&(a.isNumber(e[h])||e[h]===".");)V+=e[h],h++;o(V),f=h-1}else if(u(p)){for(var d=r[r.length-1];u(d)&&(t[p]<=t[d]&&p!=="^"||t[p]<t[d]&&p==="^");)s(),d=r[r.length-1];r.push(p)}else if(p==="(")r.push(p);else if(p===")"){for(var d=r[r.length-1];d!=="("&&d!==void 0;)s(),d=r[r.length-1];r.pop()}}for(;r.length>0;)s();return i}),l(a,"Rectangle",class{constructor(t,i){l(this,"width");l(this,"height");this.width=t,this.height=i}calculateArea(){return this.width*this.height}calculatePerimeter(){return 2*(this.width+this.height)}}),l(a,"recursionSyncBody",function(e){for(let t=0;t<e.length;t++)e[t].type==NodeType.CalculationLayer&&e[t].syncBody(),e[t].isFolder&&a.recursionSyncBody(e[t].tree)}),l(a,"clearCache",function(){a.clearCacheRecursion(a.sceneFolder)}),l(a,"clearCacheRecursion",function(e){for(let t=0;t<e.tree.length;t++){const i=e.tree[t];i.type==NodeType.CalculationLayer&&(i.cacheValue=null),i.isFolder==!0&&a.clearCacheRecursion(i)}}),l(a,"initDataBase",function(e){a.isBillboardLayerView=!1,new a.FXCentre,JSON.parse(e).stage.operationArray;const t=JSON.parse(e).library.operationArray;a.editBody=null,a.selectBody=null,a.createLibraryBody(t,!0),a.parseLibraryBody(t,!0)}),l(a,"parseAbsoluteAddress",function(e){return e.replace(/\./g,"")}),l(a,"recursionGetBillboard",function(e,t){if(t.tree==null)return null;for(let i=0;i<t.tree.length;i++)t.tree[i]instanceof a.BillboardLayer&&e.push(t.tree[i]),a.recursionGetBillboard(e,t.tree[i]);return null}),l(a,"saveBody",function(e,t){for(let u=0;u<t.length;u++){const c=t[u];if(c.type==NodeType.OperationBody){var i=0,r=0;c.view!=null&&(i=c.view.getX(),r=c.view.getY());const d=a.createBodyData(c.type,c.isFunction,c.isBindingOperation,i,r,c.isWeight,c.isAdvance,c.funcType);c.isBindingFormula&&(d.isFormula=!0,d.formulaName=c.formulaBody.name,d.formulaX=c.formulaBody.x,d.formulaY=c.formulaBody.y),d.id=c.id,e.push(d);for(var o=0;o<c.tree.length;o++){const f=c.tree[o],p=a.createVarData(f.TID,f.name,f.value,f.type,f.macros,f.operator,f.enemyFlag,f.source,f.tag,f.statistics,f.upDateValue,f.demoteValue,f.funcType,f.isLogicalOpen,f.isDragging,f.currentStep,f.snNo,f.minValue,f.maxValue,f.step,f.logicalChildArray,f.selectedOutputInfo);p.id=f.id,d.tree.push(p)}}else if(c.type==NodeType.SymbolBody){var i=0,r=0;c.view!=null&&(i=c.view.getX(),r=c.view.getY());const p=a.createSymbolData(c.type,c.operator,c.isFunctionId,c.isBindingOperation,i,r,c.isWeight,c.funcType);c.isBindingFormula&&(p.isFormula=!0,p.formulaName=c.formulaBody.name,p.formulaX=c.formulaBody.x,p.formulaY=c.formulaBody.y),p.id=c.id,e.push(p);for(var o=0;o<c.tree.length;o++){const h=c.tree[o];switch(h.type){case"OperationBody":var i=0,r=0;h.view!=null&&(i=h.view.getX(),r=h.view.getY());var s=a.createBodyData(h.type,h.isFunction,h.isBindingOperation,i,r,h.isWeight,h.isAdvance,h.funcType);s.id=h.id,p.tree.push(s);for(let g=0;g<h.tree.length;g++){const T=h.tree[g],v=a.createVarData(T.TID,T.name,T.value,T.type,T.macros,T.operator,T.enemyFlag,T.source,T.tag,T.statistics,T.upDateValue,T.demoteValue,T.funcType,T.isLogicalOpen,T.isDragging,T.currentStep,T.snNo,T.minValue,T.maxValue,T.step,T.logicalChildArray,T.selectedOutputInfo);v.id=T.id,s.tree.push(v)}break;case"SymbolBody":var i=0,r=0;h.view!=null&&(i=h.view.getX(),r=h.view.getY());var s=a.createSymbolData(h.type,h.operator,h.isFunctionId,h.isBindingOperation,i,r,h.isWeight,h.funcType);s.id=h.id,p.tree.push(s),a.recursionSeekBody(s.tree,h.tree);break}}}else if(c.type==NodeType.Bookmark){const d=a.createBookmarkData(c);d.id=c.id,e.push(d)}}}),l(a,"coordinateDetection",function(e){return e!=null?{x:e.getX(),y:e.getY()}:{x:0,y:0}}),l(a,"recursionSeekBody",function(e,t){for(let o=0;o<t.length;o++){const s=t[o];switch(s.type){case"OperationBody":var i=a.coordinateDetection(s.view),r=a.createBodyData(s.type,s.isFunction,s.isBindingOperation,i.x,i.y,s.isWeight,s.isAdvance,s.funcType);e.push(r);for(let u=0;u<s.tree.length;u++){const c=s.tree[u];r.tree.push(a.createVarData(c.TID,c.name,c.value,c.type,c.macros,c.operator,c.enemyFlag,c.source,c.tag,c.statistics,c.upDateValue,c.demoteValue,c.funcType,c.isLogicalOpen,c.isDragging,c.currentStep,c.snNo,c.minValue,c.maxValue,c.step,c.logicalChildArray,c.selectedOutputInfo))}break;case"SymbolBody":var i=a.coordinateDetection(s.view),r=a.createSymbolData(s.type,s.operator,s.isFunctionId,s.isBindingOperation,i.x,i.y,s.isWeight,s.funcType);e.push(r),a.recursionSeekBody(r.tree,s.tree);break}}}),l(a,"getAbsoluteAddress",function(e,t){if(t){var i=[];a.getStepData(e,i,t);for(var r="",o=0;o<i.length;o++)r+=i[o];return r}if(e.site!=null&&e.site!=null)return e.site;if(e.parentFolder==null)return e.source!=null?e.source.absoluteAddress:e.name;var i=[];a.getStepData(e,i,t);for(var r="",o=0;o<i.length;o++)r+=i[o];return r}),l(a,"copyHeadFun",function(e){return e.copyHead?!0:e.parentFolder!=null&&e.parentFolder.name!=null?a.copyHeadFun(e.parentFolder):!1}),l(a,"getStepData",function(e,t,i){t.unshift(e.name),e.parentFolder!=null&&e.parentFolder.name!=null&&a.getStepData(e.parentFolder,t,i)}),l(a,"getStepDataAll",function(e,t){t.unshift(e.name),e.parentFolder.name!=null&&a.getStepDataAll(e.parentFolder,t)}),l(a,"createVarData",function(e,t,i,r,o,s,u,c,d,f,p,V,h,m,y,g,T,v,b,F,D,x){const I={};return a.code,I.TID=e,I.name=t,I.value=i,I.type=r,I.macros=o,I.operator=s,I.enemy=u,I.tag=d,I.site=a.getAbsoluteAddress(c),I.statistics=f,I.upDateValue=p,I.demoteValue=V,I.funcType=h,I.isLogicalOpen=m,I.isDragging=y,I.currentStep=g,I.snNo=T,I.minValue=v,I.maxValue=b,I.step=F,I.logicalChildArray=[],I.selectedOutputInfo=typeof x=="object"?JSON.stringify(x):"",D&&D.length&&D.forEach(C=>{const S=a.createVarData(C.TID,C.name,C.value,C.type,C.macros,C.operator,C.enemyFlag,C.source,C.tag,C.statistics,C.upDateValue,C.demoteValue,C.funcType,C.isLogicalOpen,C.isDragging,C.currentStep,C.snNo,C.minValue,C.maxValue,C.step,C.logicalChildArray);I.logicalChildArray.push(S)}),I}),l(a,"createBodyData",function(e,t,i,r,o,s,u,c){const d={};return d.tree=[],d.type=e,d.isFunction=t,d.isBoundOutput=i,d.x=r,d.y=o,d.isWeight=s,d.isAdvance=u,d.funcType=c,d}),l(a,"createSymbolData",function(e,t,i,r,o,s,u,c){const d={};return d.tree=[],d.type=e,d.operator=t,d.isFunctionId=i,d.isBoundOutput=r,d.x=o,d.y=s,d.isWeight=u,d.funcType=c,d}),l(a,"createBookmarkData",function(e){const t={};return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.text=e.text,t.type=e.type,t}),l(a,"createChartData",function(e){const t={};if(t.name=e.name,t.minValue=e.minValue,t.maxValue=e.maxValue,t.intervalValue=e.intervalValue,t.operationlayer=[],t.metadataArray=[],t.isXlsx=!0,e.operationArray!=null)for(var i=0;i<e.operationArray.length;i++)t.operationlayer.push(a.getAbsoluteAddress(e.operationArray[i].source));(e.body!=null||e.metadata!=null)&&(t.metadata=a.getAbsoluteAddress(e.metadata.source));for(var i=0,r=e.metadataArray.length;i<r;i++){const s=e.metadataArray[i],u=s.source,c={site:a.getAbsoluteAddress(u)};s.minValue!=1&&(c.minValue=s.minValue),s.intervalValue!=1&&(c.intervalValue=s.intervalValue),t.metadataArray.push(c)}return t.site=a.getAbsoluteAddress(e),t}),l(a,"seekSource",function(e){const t=[];for(let i=0;i<e.length;i++){const r=e[i];if(r.parent==null){if(t.length==0)t.push(r);else for(let o=0;o<t.length;o++)if(t[o]!=r){t.push(r);break}}}return t}),l(a,"createBillboarMetadataData",function(e,t,i,r,o){const s={};return s.name=e,s.type=t,s.value=i,s.site=a.getAbsoluteAddress(r),s.componentType=o.type,s.componentValue=o.body.value,s.componentMinValue=o.minValue,s.componentMaxValue=o.maxValue,s.componentIntervalValue=o.intervalValue,s.list=o.list,s}),l(a,"createOperationLayerData",function(e,t,i,r,o,s,u,c){const d={};return d.name=e,d.type=t,d.value=i,d.site=a.getAbsoluteAddress(r),d.tag=o,d.operationArray=[],t===NodeType.Sheet&&u&&(d.sheetData=u,d.childCell=c),d.isSystemShow=s,d}),l(a,"createBillboarData",function(e,t,i){const r={};return r.name=e,r.site=a.getAbsoluteAddress(t),r.isBoard=!0,r.operationArray=[],r.metadataArray=[],r.monitored=i,r}),l(a,"createFolderData",function(e,t,i){const r={};return r.name=e,r.isFile=t,r.operationArray=[],r.site=a.getAbsoluteAddress(i),r}),l(a,"getBout",function(e){if(e.tree.length>1){if(e.tree[0].getValue()!=0&&e.tree[1].getValue()!=0&&Number(e.tree[0].getValue())>Number(e.tree[1].getValue())){let t=Number(e.tree[0].getValue()),i=0;for(let s=1;s<e.tree.length;s++)i+=Number(e.treeItem.getValue());let r=0,o=0;for(;t>=i;)o+=i,t-=i,r++;return[r,o/r]}return[0,0]}return[0,0]}),l(a,"copy",function(e){const t={};for(const i in e)e.hasOwnProperty(i)&&(t[i]=typeof e[i]=="object"?a.copy(e[i]):e[i]);return t}),l(a,"getIsBoundOutput",function(e,t){return t!=null?!1:e.isBoundOutput!=null?e.isBoundOutput:e.isBindingOperation}),l(a,"coordinate",function(e,t){let i=1;return a.visualVersionCompatibility&&(i=.5),e.view!=null?e.parent==null?[0,0]:[e.view.getX()*i,e.view.getY()*i]:[e.x*i,e.y*i]}),l(a,"parseStageBody",function(e,t,i,r){let o=null;for(let V=0;V<e.length;V++){const h=e[V];if(i==null&&h.parent!=null)return;if(h.type==NodeType.OperationBody||h.type=="运算体类"){var s;if(h.isFunction){s=a.createOperationBody(a.coordinate(e[V],i)[0],a.coordinate(e[V],i)[1],1,h.isWeight,h.isAdvance,h.funcType),s.isBindingOperation=a.getIsBoundOutput(e[V],i),a.operationBindBody(s),o==null&&(o=s);for(var u=0;u<h.tree.length;u++){const m=h.tree[u];if(m.type==NodeType.Macro){var c=new a.VariableValue(m.name,null,m.type);c.TID=m.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(s,c);y.setMacros(a.amendMacros(m)),y.enemyFlag=m.enemy,y.funcType=m.funcType,y.funcType==null&&(y.funcType=0),y.statistics=m.statistics,y.upDateValue=m.upDateValue,y.demoteValue=m.demoteValue,a.symbolicLink(y,m.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,m.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(m.type)){var c=new a.VariableValue(m.name,m.value,m.type);c.TID=m.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let g=a.createFunctionBody(s,c);g.enemyFlag=m.enemy,g.funcType=m.funcType,g.funcType==null&&(g.funcType=0),m.type==NodeType.Sheet&&(g.selectedOutputInfo=m.selectedOutputInfo?JSON.parse(m.selectedOutputInfo):""),g.statistics=m.statistics,g.upDateValue=m.upDateValue,g.demoteValue=m.demoteValue,g.isLogicalOpen=m.isLogicalOpen,g.isDragging=m.isDragging,g.snNo=m.snNo,g.logicalNumberList=m.logicalNumberList,g.currentStep=m.currentStep,g.snNo=m.snNo,g.minValue=m.minValue,g.maxValue=m.maxValue,g.step=m.step,g.logicalChildArray=[],m.logicalChildArray.forEach(T=>{const v=[];a.getLibraryBody(v,a.targetFolder.tree,a.getAbsoluteAddress(T));const F=v[0].copy();F.enemyFlag=m.enemy,F.funcType=m.funcType,F.funcType==null&&(F.funcType=0),F.statistics=m.statistics,F.upDateValue=m.upDateValue,F.demoteValue=m.demoteValue,g.logicalChildArray.push(F)}),a.symbolicLink(g,m.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,m.operator,t],null)}else{var d=[];r?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(m.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(m));let y=d[0],g=a.createVariableBody(s,y);g.enemyFlag=m.enemy,g.funcType=m.funcType,g.funcType==null&&(g.funcType=0),m.type==NodeType.Sheet&&(g.selectedOutputInfo=m.selectedOutputInfo?JSON.parse(m.selectedOutputInfo):""),g.statistics=m.statistics,g.upDateValue=m.upDateValue,g.demoteValue=m.demoteValue,a.symbolicLink(g,m.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,m.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else{s=a.createOperationBody(a.coordinate(e[V],i)[0],a.coordinate(e[V],i)[1],0,h.isWeight,h.isAdvance,h.funcType),s.isBindingOperation=a.getIsBoundOutput(e[V],i),a.operationBindBody(s),o==null&&(o=s);for(var u=0;u<h.tree.length;u++){const y=h.tree[u];if(y.type==NodeType.Macro){var c=new a.VariableValue(y.name,null,y.type);c.TID=y.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let T=a.createFunctionBody(s,c);T.setMacros(a.amendMacros(y)),T.enemyFlag=y.enemy,T.funcType=y.funcType,T.funcType==null&&(T.funcType=0),T.statistics=y.statistics,T.upDateValue=y.upDateValue,T.demoteValue=y.demoteValue,a.symbolicLink(T,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[T,y.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(y.type)){var c=new a.VariableValue(y.name,y.value,y.type);c.TID=y.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let T=a.createFunctionBody(s,c);T.enemyFlag=y.enemy,T.funcType=y.funcType,T.funcType==null&&(T.funcType=0),y.type==NodeType.Sheet&&(T.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),T.statistics=y.statistics,T.upDateValue=y.upDateValue,T.demoteValue=y.demoteValue,T.isLogicalOpen=y.isLogicalOpen,T.isDragging=y.isDragging,T.snNo=y.snNo,T.logicalNumberList=y.logicalNumberList,T.currentStep=y.currentStep,T.snNo=y.snNo,T.minValue=y.minValue,T.maxValue=y.maxValue,T.step=y.step,T.logicalChildArray=[],y.logicalChildArray.forEach(v=>{const b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(v));const D=b[0].copy();D.enemyFlag=y.enemy,D.funcType=y.funcType,D.funcType==null&&(D.funcType=0),D.statistics=y.statistics,D.upDateValue=y.upDateValue,D.demoteValue=y.demoteValue,T.logicalChildArray.push(D)}),a.symbolicLink(T,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[T,y.operator,t],null)}else{var d=[];r||y.source?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(y.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(y));let T=d[0],v=a.createVariableBody(s,T);v.enemyFlag=y.enemy,v.funcType=y.funcType,v.funcType==null&&(v.funcType=0),y.type==NodeType.Sheet&&(v.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),v.statistics=y.statistics,v.upDateValue=y.upDateValue,v.demoteValue=y.demoteValue,a.symbolicLink(v,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[v,y.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}if(h.isFormula){var f=new a.FormulaData(h.formulaName,h.formulaX,h.formulaY);f.body=s,f.body.isBindingFormula=!0,s.formulaBody=f,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[f,s.view,t],null)}}else if(h.type==NodeType.SymbolBody||h.type=="符号运算体类"){const m=a.createSymbolBody(null,null,h.operator,h.isFunctionId,h.isWeight,h.funcType);m.isBindingOperation=a.getIsBoundOutput(e[V],i),a.operationBindBody(m),o==null&&(o=m),m.view!=null&&(m.view.setX(a.coordinate(e[V],i)[0]),m.view.setY(a.coordinate(e[V],i)[1]));for(var u=0;u<h.tree.length;u++){const g=h.tree[u];if(g.type==NodeType.OperationBody||g.type=="运算体类")if(g.isFunction){var s=a.createOperationBody(a.coordinate(g,i)[0],a.coordinate(g,i)[1],1,g.isWeight,g.isAdvance,g.funcType);s.isBindingOperation=a.getIsBoundOutput(g,i),a.operationBindBody(s),a.addBody(m,s,!1);for(var p=0;p<g.tree.length;p++){const v=g.tree[p];if(v.type==NodeType.Macro){var c=new a.VariableValue(v.name,null,4);c.TID=v.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let F=a.createFunctionBody(s,c);F.macros=a.amendMacros(v),F.enemyFlag=v.enemy,F.funcType=v.funcType,F.funcType==null&&(F.funcType=0),F.statistics=v.statistics,F.upDateValue=v.upDateValue,F.demoteValue=v.demoteValue,a.symbolicLink(F,v.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[F,v.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(v.type)){var c=new a.VariableValue(g.name,g.value,g.type);c.TID=g.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let F=a.createFunctionBody(s,c);F.enemyFlag=g.enemy,F.funcType=g.funcType,F.funcType==null&&(F.funcType=0),g.type==NodeType.Sheet&&(F.selectedOutputInfo=g.selectedOutputInfo?JSON.parse(g.selectedOutputInfo):""),F.statistics=g.statistics,F.upDateValue=g.upDateValue,F.demoteValue=g.demoteValue,F.isLogicalOpen=g.isLogicalOpen,F.isDragging=g.isDragging,F.snNo=g.snNo,F.logicalNumberList=g.logicalNumberList,F.currentStep=g.currentStep,F.snNo=g.snNo,F.minValue=g.minValue,F.maxValue=g.maxValue,F.step=g.step,F.logicalChildArray=[],g.logicalChildArray.forEach(D=>{const x=[];a.getLibraryBody(x,a.targetFolder.tree,a.getAbsoluteAddress(D));const C=x[0].copy();C.enemyFlag=g.enemy,C.funcType=g.funcType,C.funcType==null&&(C.funcType=0),C.statistics=g.statistics,C.upDateValue=g.upDateValue,C.demoteValue=g.demoteValue,F.logicalChildArray.push(C)}),a.symbolicLink(F,g.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[F,g.operator,t],null)}else{var d=[];r?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(v.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(v));let F=d[0],D=a.createVariableBody(s,F);D.enemyFlag=v.enemy,D.funcType=v.funcType,D.funcType==null&&(D.funcType=0),v.type==NodeType.Sheet&&(D.selectedOutputInfo=v.selectedOutputInfo?JSON.parse(v.selectedOutputInfo):""),D.statistics=v.statistics,D.upDateValue=v.upDateValue,D.demoteValue=v.demoteValue,a.symbolicLink(D,v.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[D,v.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else{var s=a.createOperationBody(a.coordinate(g,i)[0],a.coordinate(g,i)[1],0,g.isWeight,g.isAdvance,g.funcType);if(s.isBindingOperation=a.getIsBoundOutput(g,i),a.operationBindBody(s),a.addBody(m,s,!1),g.tree==null)return null;for(var p=0;p<g.tree.length;p++){const b=g.tree[p];if(b.type==NodeType.Macro){var c=new a.VariableValue(b.name,null,b.type);c.TID=b.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let D=a.createFunctionBody(s,c);D.setMacros(a.amendMacros(b)),D.enemyFlag=b.enemy,D.funcType=b.funcType,D.funcType==null&&(D.funcType=0),D.statistics=b.statistics,D.upDateValue=b.upDateValue,D.demoteValue=b.demoteValue,a.symbolicLink(D,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[D,b.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(b.type)){var c=new a.VariableValue(b.name,b.value,b.type);c.TID=b.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let D=a.createFunctionBody(s,c);D.enemyFlag=b.enemy,D.funcType=b.funcType,D.funcType==null&&(D.funcType=0),b.type==NodeType.Sheet&&(D.selectedOutputInfo=b.selectedOutputInfo?JSON.parse(b.selectedOutputInfo):""),D.statistics=b.statistics,D.upDateValue=b.upDateValue,D.demoteValue=b.demoteValue,D.isLogicalOpen=b.isLogicalOpen,D.isDragging=b.isDragging,D.snNo=b.snNo,D.logicalNumberList=b.logicalNumberList,D.currentStep=b.currentStep,D.snNo=b.snNo,D.minValue=b.minValue,D.maxValue=b.maxValue,D.step=b.step,D.logicalChildArray=[],b.logicalChildArray.forEach(x=>{const I=[];a.getLibraryBody(I,a.targetFolder.tree,a.getAbsoluteAddress(x));const S=I[0].copy();S.enemyFlag=b.enemy,S.funcType=b.funcType,S.funcType==null&&(S.funcType=0),S.statistics=b.statistics,S.upDateValue=b.upDateValue,S.demoteValue=b.demoteValue,D.logicalChildArray.push(S)}),a.symbolicLink(D,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[D,b.operator,t],null)}else{var d=[];r||b.source?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(b.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(b));let D=d[0],x=a.createVariableBody(s,D);x.enemyFlag=b.enemy,x.funcType=b.funcType,x.funcType==null&&(x.funcType=0),b.type==NodeType.Sheet&&(x.selectedOutputInfo=b.selectedOutputInfo?JSON.parse(b.selectedOutputInfo):""),x.statistics=b.statistics,x.upDateValue=b.upDateValue,x.demoteValue=b.demoteValue,a.symbolicLink(x,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[x,b.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else if(g.type==NodeType.SymbolBody||g.type=="符号运算体类"){var s=a.createSymbolBody(null,null,g.operator,g.isFunctionId,g.isWeight,g.funcType);s.isBindingOperation=a.getIsBoundOutput(g,i),a.operationBindBody(s),s.view!=null&&(s.view.setX(a.coordinate(g,i)[0]),s.view.setY(a.coordinate(g,i)[1])),a.loopGenerateBody(s,g.tree,t),a.addBody(m,s,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}}if(a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[m,t],null),h.isFormula){var f=new a.FormulaData(h.formulaName,h.formulaX,h.formulaY);f.body=m,f.body.isBindingFormula=!0,m.formulaBody=f,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[f,m.view,t],null)}}else if(h.type==NodeType.Bookmark){var s=a.createBookmark(h.x,h.y,h.width,h.height,h.text);a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}}return o}),l(a,"amendMacros",function(e){return e.macros==null?e.macro:e.macros}),l(a,"fixedDecimal",function(e,t){switch(t){case 0:return Math.round(e);case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4}return 0}),l(a,"currencyConversion",function(e){const t=e%100,i=parseInt(String(e/100%100));let r=0;return e<1e5?r=parseInt(String(e/100/100%100)):r=parseInt(String(e/100/100)),[r,i,t]}),l(a,"replaceVariableBody",function(e,t,i){const r=t.copy();return e.replace(r,i),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,r],(function(o){}).bind(this)),r}),l(a,"createVariableBody",function(e,t){const i=t.copy();return e.addBody(i),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,i],(function(r){}).bind(this)),i}),l(a,"createFunctionBody",function(e,t){const i=t.copy();return e.addBody(i),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,i],(function(r){}).bind(this)),i}),l(a,"replaceFunctionBody",function(e,t,i){const r=t.copy();return e.replace(r,i),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,r],(function(o){}).bind(this)),r}),l(a,"createOperationBody",function(e,t,i,r,o,s){const u=new a.OperationBody;u.isFunction=!!i,a.targetStoragePool.push(u),u.isWeight=r,u.isAdvance=o,u.funcType=s,(u.funcType==null||u.funcType==null)&&(u.funcType=0),u.x=e,u.y=t;let c=null;return a.Call.send(a.Eve.SHIFT_ADD_OPERATIONBODY,[e,t,i,u],(function(d){c=d,r&&c&&c.openWeight(),o&&c&&c.openAdvance()}).bind(this)),u}),l(a,"createBookmark",function(e,t,i,r,o){const s=new a.Bookmark;return s.x=e,s.y=t,s.width=i,s.id=++EventManager.IDINDEX,s.width==null&&(s.width=256),s.height=r,s.height==null&&(s.height=256),s.text=o,a.targetStoragePool.push(s),a.Call.send(a.Eve.SHIFT_ADD_BOOKMARK,[s],(function(u){}).bind(this)),s}),l(a,"createSymbolBody",function(e,t,i,r,o,s){const u=new a.SymbolBody;return u.isWeight=o,u.isFunctionId=r,u.funcType=s,(u.funcType==null||u.funcType==null)&&(u.funcType=0),u.operator=i,u.isFunctionId==null&&(u.isFunctionId=1),e!=null&&u.addBody(e),t!=null&&u.addBody(t),a.targetStoragePool.push(u),a.Call.send(a.Eve.SHIFT_ADD_SYMBOLBODY,[e,t,i,r,u],null),u}),l(a,"operationBindBody",function(e){e.isBindingOperation&&a.editBody!=null&&(a.editBody.body=e)}),l(a,"addBody",function(e,t,i){a.Call.send(a.Eve.ADD_OPERAND_DATA,[e,t,i],null)}),l(a,"symbolicLink",function(e,t){t!=null&&(t=="删除符号"||t=="删除运算体"||t=="导出公式"||t=="敌方标记"||(e.operator=t))}),l(a,"loopGenerateBody",function(e,t,i){for(let d=0;d<t.length;d++){const f=t[d];switch(f.type){case"OperationBody":if(f.isFunction){var r=a.createOperationBody(a.coordinate(t[d])[0],a.coordinate(t[d])[1],1,f.isWeight,f.isAdvance,f.funcType);r.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(r),a.addBody(e,r,!1);for(var o=0;o<f.tree.length;o++){const p=f.tree[o];if(p.type==NodeType.Macro){var s=new a.VariableValue(p.name,null,p.type);s.TID=p.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let V=a.createFunctionBody(r,s);V.macros=a.amendMacros(p),V.enemyFlag=p.enemy,V.funcType=p.funcType,V.funcType==null&&(V.funcType=0),V.statistics=p.statistics,V.upDateValue=p.upDateValue,V.demoteValue=p.demoteValue,a.symbolicLink(V,p.operator),a.clickBody=V,a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,p.operator,i],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(p.type)){var s=new a.VariableValue(p.name,p.value,p.type);s.TID=p.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let h=a.createFunctionBody(r,s);h.enemyFlag=p.enemy,h.funcType=p.funcType,h.funcType==null&&(h.funcType=0),p.type==NodeType.Sheet&&(h.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),h.statistics=p.statistics,h.upDateValue=p.upDateValue,h.demoteValue=p.demoteValue,h.isLogicalOpen=p.isLogicalOpen,h.isDragging=p.isDragging,h.snNo=p.snNo,h.logicalNumberList=p.logicalNumberList,h.currentStep=p.currentStep,h.snNo=p.snNo,h.minValue=p.minValue,h.maxValue=p.maxValue,h.step=p.step,h.logicalChildArray=[],p.logicalChildArray.forEach(m=>{const y=[];a.getLibraryBody(y,a.targetFolder.tree,a.getAbsoluteAddress(m));const T=y[0].copy();T.enemyFlag=p.enemy,T.funcType=p.funcType,T.funcType==null&&(T.funcType=0),T.statistics=p.statistics,T.upDateValue=p.upDateValue,T.demoteValue=p.demoteValue,h.logicalChildArray.push(T)}),a.symbolicLink(h,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[h,p.operator,i],null)}else{var u=[];a.getLibraryBody(u,a.targetFolder.tree,a.getAbsoluteAddress(p));let V=u[0],h=a.createVariableBody(r,V);h.enemyFlag=p.enemy,h.funcType=p.funcType,h.funcType==null&&(h.funcType=0),p.type==NodeType.Sheet&&(h.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),h.statistics=p.statistics,h.upDateValue=p.upDateValue,h.demoteValue=p.demoteValue,a.symbolicLink(h,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[h,p.operator,i],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,i],null)}else{var r=a.createOperationBody(a.coordinate(t[d])[0],a.coordinate(t[d])[1],0,f.isWeight,f.isAdvance,f.funcType);r.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(r),a.addBody(e,r,!1);for(var o=0;o<f.tree.length;o++){const h=f.tree[o];if(h.type==NodeType.Macro){var s=new a.VariableValue(h.name,null,h.type);s.TID=h.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(r,s);y.setMacros(a.amendMacros(h)),y.enemyFlag=h.enemy,y.funcType=h.funcType,y.funcType==null&&(y.funcType=0),y.statistics=h.statistics,y.upDateValue=h.upDateValue,y.demoteValue=h.demoteValue,a.symbolicLink(y,h.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,h.operator,i],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(h.type)){var s=new a.VariableValue(h.name,h.value,h.type);s.TID=h.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(r,s);y.enemyFlag=h.enemy,y.funcType=h.funcType,y.funcType==null&&(y.funcType=0),h.type==NodeType.Sheet&&(y.selectedOutputInfo=h.selectedOutputInfo?JSON.parse(h.selectedOutputInfo):""),y.statistics=h.statistics,y.upDateValue=h.upDateValue,y.demoteValue=h.demoteValue,y.isLogicalOpen=h.isLogicalOpen,y.isDragging=h.isDragging,y.snNo=h.snNo,y.logicalNumberList=h.logicalNumberList,y.currentStep=h.currentStep,y.snNo=h.snNo,y.minValue=h.minValue,y.maxValue=h.maxValue,y.step=h.step,y.logicalChildArray=[],h.logicalChildArray.forEach(g=>{const T=[];a.getLibraryBody(T,a.targetFolder.tree,a.getAbsoluteAddress(g));const b=T[0].copy();b.enemyFlag=h.enemy,b.funcType=h.funcType,b.funcType==null&&(b.funcType=0),b.statistics=h.statistics,b.upDateValue=h.upDateValue,b.demoteValue=h.demoteValue,y.logicalChildArray.push(b)}),a.symbolicLink(y,h.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,h.operator,i],null)}else{var u=[];a.getLibraryBody(u,a.targetFolder.tree,a.getAbsoluteAddress(h));let y=u[0],g=a.createVariableBody(r,y);g.enemyFlag=h.enemy,g.funcType=h.funcType,g.funcType==null&&(g.funcType=0),h.type==NodeType.Sheet&&(g.selectedOutputInfo=h.selectedOutputInfo?JSON.parse(h.selectedOutputInfo):""),g.statistics=h.statistics,g.upDateValue=h.upDateValue,g.demoteValue=h.demoteValue,a.symbolicLink(g,h.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,h.operator,i],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,i],null)}break;case"SymbolBody":var c=a.createSymbolBody(null,null,f.operator,f.isFunctionId,f.isWeight,f.funcType);c.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(c),c.view!=null&&(c.view.setX(a.coordinate(t[d])[0]),c.view.setY(a.coordinate(t[d])[1])),a.loopGenerateBody(c,f.tree,i),a.addBody(e,c,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[c,i],null);break}}}),l(a,"saveFXTree",function(e,t){if(e!=null)for(let i=0;i<e.length;i++){const r=e[i];if(r.type==NodeType.Macro){const o={TID:r.TID,name:r.name,code:r.macros};t.push(o)}else a.saveFXTree(r.tree,t)}}),l(a,"recursiveStorage",function(e,t){if(e.operationArray!=null)for(let i=0;i<e.operationArray.length;i++){const r=e.operationArray[i];if(r.tree!=null)for(let o=0;o<r.tree.length;o++){const s=r.tree[o];if(s.type==NodeType.Macro){const u={TID:s.TID,name:s.name,code:s.macros};t.push(u)}else a.saveFXTree(s.tree,t)}r.operationArray!=null&&a.recursiveStorage(r,t)}}),l(a,"init",function(){try{a.isStart===!1&&(a.isStart=!0,a.code=!0,new a.FXCentre)}catch(e){console.error("Error initializing FX system:",e),a.isStart=!1,a.code=!1}});let fx=a;const globalThis_=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_.fx=fx;globalThis_.seer=fx;const scriptRel="modulepreload",assetsURL=function(n,e){return new URL(n,e).href},seen={},__vitePreload=function n(e,t,i){let r=Promise.resolve();if(t&&t.length>0){const s=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),c=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));r=Promise.allSettled(t.map(d=>{if(d=assetsURL(d,i),d in seen)return;seen[d]=!0;const f=d.endsWith(".css"),p=f?'[rel="stylesheet"]':"";if(!!i)for(let m=s.length-1;m>=0;m--){const y=s[m];if(y.href===d&&(!f||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${p}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":scriptRel,f||(h.as="script"),h.crossOrigin="",h.href=d,c&&h.setAttribute("nonce",c),document.head.appendChild(h),f)return new Promise((m,y)=>{h.addEventListener("load",m),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(s){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=s,window.dispatchEvent(u),!u.defaultPrevented)throw s}return r.then(s=>{for(const u of s||[])u.status==="rejected"&&o(u.reason);return e().catch(o)})},en={meta:{title:"SoonFx Engine - Interactive Battle Demo"},header:{title:"⚔️ Interactive Battle Simulation",subtitle:"Real-time combat data visualization and analysis powered by SoonFx Engine",langSwitch:"中文"},scenarios:{title:"🎮 Battle Scenarios",pve:{label:"📈 Level Progression (1-50)",desc:"Watch how stats scale across levels"},newbie:{label:"🌱 Newbie Village (Lv 1-10)",desc:"First steps in the adventure"},midgame:{label:"⚔️ Mid-Game Challenge (Lv 20-30)",desc:"Intermediate difficulty battles"},tip:{label:"💡 Tip:",text:"Click on any data point in the charts to see detailed battle information for that level."}},charts:{hp:"❤️ Health Points (HP) by Level",damage:"💥 Attack Damage by Level",rounds:"⏱️ Battle Duration (Rounds) by Level",loading:"Running simulations...",details:{title:"📋 Battle Details",hpChange:"HP Change Over Rounds",damageStats:"Damage Statistics",waiting:"Waiting for simulation..."}},story:{pveGrowth:{title:"📊 Level Progression Analysis",desc:"Simulating 50 battles to show how character stats evolve from novice to master..."},newbie:{title:"🌱 The First Adventure",desc:"A young hero takes their first steps, facing level 1-10 slimes in the Newbie Village..."},midGame:{title:"⚔️ Rising Challenge",desc:"The hero has grown stronger (Lv 20-30) and now faces tougher enemies in the Dark Forest..."}},status:{running:"🔄 Running {scenario} simulation...",simulating:"🔄 Simulating battles... {current}/{total} ({percent}%)",success:"✅ Simulation complete! Click on any chart point to see detailed battle data.",error:"❌ Simulation failed: {message}",battleDetails:{header:"========== Level {level} Battle Details ==========",duration:"Battle Duration: {rounds} rounds",hp:"Hero Final HP: {hp}",damage:"Average Damage: {damage}",footer:"========================================"}}},zhCN={meta:{title:"SoonFx 引擎 - 交互式战斗演示"},header:{title:"⚔️ 交互式战斗模拟",subtitle:"基于 SoonFx 引擎的实时战斗数据可视化与分析",langSwitch:"English"},scenarios:{title:"🎮 战斗场景",pve:{label:"📈 等级成长 (1-50)",desc:"观察属性如何随等级提升而变化"},newbie:{label:"🌱 新手村 (Lv 1-10)",desc:"冒险旅程的第一步"},midgame:{label:"⚔️ 中期挑战 (Lv 20-30)",desc:"面对更强大的敌人"},tip:{label:"💡 提示:",text:"点击图表中的任意数据点查看该等级的详细战斗信息。"}},charts:{hp:"❤️ 生命值 (HP) 随等级变化",damage:"💥 攻击伤害随等级变化",rounds:"⏱️ 战斗回合数随等级变化",loading:"正在运行模拟...",details:{title:"📋 战斗详情",hpChange:"回合生命值变化",damageStats:"伤害统计",waiting:"等待模拟..."}},story:{pveGrowth:{title:"📊 等级成长分析",desc:"模拟 50 场战斗，展示角色属性如何从新手成长为大师..."},newbie:{title:"🌱 初次冒险",desc:"年轻的英雄迈出了第一步，在新手村面对 1-10 级的史莱姆..."},midGame:{title:"⚔️ 挑战升级",desc:"英雄变强了 (Lv 20-30)，现在要在黑暗森林中面对更棘手的敌人..."}},status:{running:"🔄 正在运行 {scenario} 模拟...",simulating:"🔄 正在模拟战斗... {current}/{total} ({percent}%)",success:"✅ 模拟完成！点击图表上的任意点查看详细战斗数据。",error:"❌ 模拟失败: {message}",battleDetails:{header:"========== 等级 {level} 战斗详情 ==========",duration:"战斗持续: {rounds} 回合",hp:"英雄最终 HP: {hp}",damage:"平均伤害: {damage}",footer:"========================================"}}};class I18nService{constructor(){this.currentLocale="en",this.messages={en,"zh-CN":zhCN},this.listeners=[];const t=new URLSearchParams(window.location.search).get("lang");t==="zh-CN"||t==="zh"?this.currentLocale="zh-CN":t==="en"?this.currentLocale="en":this.currentLocale="en"}get locale(){return this.currentLocale}setLocale(e){this.currentLocale!==e&&(this.currentLocale=e,this.updateURL(),this.notifyListeners(),this.updatePage())}toggleLocale(){this.setLocale(this.currentLocale==="en"?"zh-CN":"en")}t(e,t){const i=e.split(".");let r=this.messages[this.currentLocale];for(const o of i)if(r&&typeof r=="object"&&o in r)r=r[o];else return e;return typeof r!="string"?e:t?Object.entries(t).reduce((o,[s,u])=>o.replace(`{${s}}`,String(u)),r):r}subscribe(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>e())}updateURL(){const e=new URL(window.location.href);e.searchParams.set("lang",this.currentLocale),window.history.replaceState({},"",e.toString())}updatePage(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=this.t(t))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=this.t(t))}),document.title=this.t("meta.title"),document.documentElement.lang=this.currentLocale}}const i18n=new I18nService;class ChartController{constructor(e){this.chartInstances={},this.pveBattleData=null,this.onPointClick=e,window.addEventListener("resize",()=>{Object.values(this.chartInstances).forEach(t=>{t.resize()})}),i18n.subscribe(()=>{this.pveBattleData&&this.updateChartTitles()})}async initCharts(){return Promise.resolve()}updateChartTitles(){}updateCharts(e,t){var c,d,f;if(!e||e.length===0)return;this.pveBattleData=e;const i=e.map(p=>`Lv ${p.level}`),r=e.map(p=>p.hp),o=e.map(p=>p.damage),s=e.map(p=>p.rounds),u=t!==null?e.findIndex(p=>p.level===t):-1;this.chartInstances.hpChart||((c=document.getElementById("hpPlaceholder"))==null||c.classList.add("hidden"),this.chartInstances.hpChart=this.createLineChart("hpChart","Health Points","rgb(75, 192, 192)")),this.updateChartData(this.chartInstances.hpChart,i,r,u,"rgb(75, 192, 192)",!1,i18n.t("charts.hp")),this.chartInstances.damageChart||((d=document.getElementById("damagePlaceholder"))==null||d.classList.add("hidden"),this.chartInstances.damageChart=this.createLineChart("damageChart","Attack Damage","rgb(255, 99, 132)")),this.updateChartData(this.chartInstances.damageChart,i,o,u,"rgb(255, 99, 132)",!1,i18n.t("charts.damage")),this.chartInstances.roundsChart||((f=document.getElementById("roundsPlaceholder"))==null||f.classList.add("hidden"),this.chartInstances.roundsChart=this.createLineChart("roundsChart","Battle Duration","rgb(153, 102, 255)")),this.updateChartData(this.chartInstances.roundsChart,i,s,u,"rgb(153, 102, 255)",!0,i18n.t("charts.rounds"))}clearCharts(){Object.values(this.chartInstances).forEach(e=>{e.dispose()}),this.chartInstances={}}createDetailCharts(e,t,i){this.createDetailHpChart(e,t,i),this.createDetailDamageChart(e,t,i)}createLineChart(e,t,i){const r=document.getElementById(e);if(!r)throw new Error(`Canvas container ${e} not found`);const o=init(r);return o.getZr().on("click",s=>{if(!this.pveBattleData)return;const u=[s.offsetX,s.offsetY];if(o.containPixel({seriesIndex:0},u)){const c=o.convertFromPixel({seriesIndex:0},u);if(c){const d=c[0];d>=0&&d<this.pveBattleData.length&&this.onPointClick(d)}}}),o}updateChartData(e,t,i,r,o,s=!1,u){const c={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"},borderColor:o},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",scale:s,minInterval:s?1:0,splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:u||"Value",type:"line",data:i.map((d,f)=>({value:d,itemStyle:{color:f===r?"rgb(255, 200, 0)":o,borderColor:f===r?"rgb(255, 200, 0)":o},symbolSize:f===r?8:3})),smooth:.3,lineStyle:{color:o,width:2},areaStyle:{color:new LinearGradient(0,0,0,1,[{offset:0,color:o.replace("rgb","rgba").replace(")",", 0.5)")},{offset:1,color:o.replace("rgb","rgba").replace(")",", 0.0)")}])}}]};e.setOption(c)}createDetailHpChart(e,t,i){const r=document.getElementById("detailHpChart");if(!r)return;this.chartInstances.detailHpChart&&this.chartInstances.detailHpChart.dispose();const o=e.map(f=>`R${f.round}`),s=e.map(f=>f.heroHp),u=e.map(f=>f.enemyHp),c=init(r);this.chartInstances.detailHpChart=c;const d={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[`${t} HP`,`${i} HP`],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:o,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:`${t} HP`,type:"line",data:s,smooth:.3,lineStyle:{color:"rgb(75, 192, 192)"},itemStyle:{color:"rgb(75, 192, 192)"},areaStyle:{color:"rgba(75, 192, 192, 0.2)"}},{name:`${i} HP`,type:"line",data:u,smooth:.3,lineStyle:{color:"rgb(255, 99, 132)"},itemStyle:{color:"rgb(255, 99, 132)"},areaStyle:{color:"rgba(255, 99, 132, 0.2)"}}]};c.setOption(d)}createDetailDamageChart(e,t,i){const r=document.getElementById("detailDamageChart");if(!r)return;this.chartInstances.detailDamageChart&&this.chartInstances.detailDamageChart.dispose();const o=e.reduce((p,V)=>p+(V.heroDamageDealt||0),0),s=e.reduce((p,V)=>p+(V.enemyDamageDealt||0),0),u=parseFloat((o/e.length).toFixed(1)),c=parseFloat((s/e.length).toFixed(1)),d=init(r);this.chartInstances.detailDamageChart=d;const f={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[t,i],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:["Total Damage","Avg Damage/Round"],axisLine:{show:!1},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:t,type:"bar",data:[o,u],itemStyle:{color:"rgba(75, 192, 192, 0.8)"}},{name:i,type:"bar",data:[s,c],itemStyle:{color:"rgba(255, 99, 132, 0.8)"}}]};d.setOption(f)}}const SCENARIO_KEYS={"pve-growth":{title:"story.pveGrowth.title",desc:"story.pveGrowth.desc"},newbie:{title:"story.newbie.title",desc:"story.newbie.desc"},"mid-game":{title:"story.midGame.title",desc:"story.midGame.desc"}};class DemoApp{constructor(){this.currentScenario="pve-growth",this.pveBattleData=null,this.currentLevel=null,this.chartController=new ChartController(e=>this.showBattleDetail(e))}async init(){console.log("Battle simulation system initialized"),i18n.updatePage(),this.bindEvents(),this.redirectConsole(),await this.chartController.initCharts(),await this.selectScenario("pve-growth"),i18n.subscribe(()=>{this.updateStoryHeader(this.currentScenario),this.pveBattleData&&this.currentLevel})}bindEvents(){document.querySelectorAll(".scenario-btn").forEach(t=>{t.addEventListener("click",i=>{const o=i.currentTarget.dataset.scenario;o&&this.selectScenario(o)})});const e=document.getElementById("langSwitch");e&&e.addEventListener("click",()=>{i18n.toggleLocale()})}redirectConsole(){const e=console.log;console.log=(...t)=>{e.apply(console,t),document.getElementById("output")}}updateStoryHeader(e){const t=SCENARIO_KEYS[e];if(t){const i=document.getElementById("storyTitle"),r=document.getElementById("storyDesc");i&&(i.textContent=i18n.t(t.title)),r&&(r.textContent=i18n.t(t.desc))}}async selectScenario(e){var t,i,r;document.querySelectorAll(".scenario-btn").forEach(o=>{o.classList.remove("active"),o.dataset.scenario===e&&o.classList.add("active")}),this.currentScenario=e,this.updateStoryHeader(e),this.clearOutput(),this.chartController.clearCharts(),(t=document.getElementById("hpPlaceholder"))==null||t.classList.remove("hidden"),(i=document.getElementById("damagePlaceholder"))==null||i.classList.remove("hidden"),(r=document.getElementById("roundsPlaceholder"))==null||r.classList.remove("hidden"),await this.runScenario(e)}async runScenario(e){this.setStatus("loading",i18n.t("status.running",{scenario:e}));try{switch(e){case"pve-growth":await this.showPVEGrowthCurve(50);break;case"newbie":await this.showPVEGrowthCurve(10,1);break;case"mid-game":await this.showPVEGrowthCurve(30,20);break}this.setStatus("success",i18n.t("status.success"))}catch(t){console.error("Simulation error:",t),this.setStatus("error",i18n.t("status.error",{message:t.message}))}}async showPVEGrowthCurve(e,t=1){this.currentLevel=null;const i=document.getElementById("detailChartsContainer");i&&(i.style.display="none");const{generatePVEDataRange:r}=await __vitePreload(async()=>{const{generatePVEDataRange:s}=await import("./SimulationService--Zaiwy68.js");return{generatePVEDataRange:s}},__vite__mapDeps([0,1]),import.meta.url),o=await r((s,u,c)=>{this.chartController.updateCharts(s,this.currentLevel),this.pveBattleData=s;const d=Math.round(u/c*100);this.setStatus("loading",i18n.t("status.simulating",{current:u,total:c,percent:d})),u===t&&s.length>0&&setTimeout(()=>{s[0]&&s[0].battleData&&this.showBattleDetail(0)},500)},e-t+1,t);this.pveBattleData=o,console.log(`Growth curve generated with ${o.length} data points`)}showBattleDetail(e){if(!this.pveBattleData||!this.pveBattleData[e]){console.error("Battle data not found for index:",e);return}const t=this.pveBattleData[e];if(!t.battleData||t.battleData.length===0){console.error("No detailed battle data available");return}this.currentLevel=t.level,this.chartController.updateCharts(this.pveBattleData,this.currentLevel);const i=document.getElementById("detailChartsContainer");i&&(i.style.display="block"),this.chartController.createDetailCharts(t.battleData,t.heroName||"Hero",t.enemyName||"Enemy");const r=document.getElementById("output");if(r){r.textContent="";const o=`
${i18n.t("status.battleDetails.header",{level:t.level})}
${i18n.t("status.battleDetails.duration",{rounds:t.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(t.hp)})}
${i18n.t("status.battleDetails.damage",{damage:Math.round(t.damage)})}
${i18n.t("status.battleDetails.footer")}
`;r.textContent=o}}setStatus(e,t){const i=document.getElementById("status");i&&(i.className=`status ${e}`,i.textContent=t)}clearOutput(){const e=document.getElementById("output");e&&(e.textContent="",e.setAttribute("data-placeholder",i18n.t("charts.details.waiting"))),this.setStatus("","")}}const app=new DemoApp;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>app.init()):app.init();export{BillboardLayer as B,ChartsLayer as C,EventManager as E,FXCentre as F,Player as P,Call as a,fx as f};
