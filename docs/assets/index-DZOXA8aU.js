const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SimulationService-HKYoF-nO.js","./BattleLogger-k-D1IkQQ.js","./BattleEntity-CWBiIsEU.js","./BattleSimulator-BnmtSMI-.js","./echarts-Bn9PLWWT.js"])))=>i.map(i=>d[i]);
var P=Object.defineProperty;var W=(i,e,t)=>e in i?P(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var l=(i,e,t)=>W(i,typeof e!="symbol"?e+"":e,t);import{i as init,L as LinearGradient}from"./echarts-Bn9PLWWT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const L=class L{constructor(){l(this,"eventMessageList",[])}static getInstance(){return L._instance==null&&(L._instance=new L),L._instance}removeEventObject(e){const t=this.eventMessageList.indexOf(e);t!==-1&&this.eventMessageList.splice(t,1)}addEventObject(e){this.eventMessageList.indexOf(e)===-1&&this.eventMessageList.push(e)}};l(L,"_instance",null);let MessageList=L;class Call{constructor(){}static send(e,t,n){t!=null&&(t.Call_Event_type=e);for(let r=0;r<MessageList.getInstance().eventMessageList.length;r++)if(MessageList.getInstance().eventMessageList[r].getEvents(e)){const o=MessageList.getInstance().eventMessageList[r].execute(e,t);n&&n.apply([e],[o])}}}class CallCenter{constructor(){l(this,"eventsList",null);this.eventsList=null,MessageList.getInstance().addEventObject(this)}execute(e,t){return this.eventsList[e].apply([e],[t])}getEvents(e){return this.eventsList==null?!1:this.eventsList[e]!=null}addEventListener(e,t,n,r){this.eventsList==null&&(this.eventsList={}),this.eventsList[e]=t.bind(r)}dispose(){for(const e in this.eventsList)delete this.eventsList[e];this.eventsList=null}removeEventListener(e){this.eventsList!=null&&(this.eventsList[e]=null)}}class EventManager{constructor(){}}l(EventManager,"UP_DATA_PLAYER","UP_DATA_PLAYER"),l(EventManager,"CREATE_FILE_DATA","CREATE_FILE_DATA"),l(EventManager,"CREATE_OPERATION_DATA","CREATE_OPERATION_DATA"),l(EventManager,"CREATE_METADATE_DATA","CREATE_METADATE_DATA"),l(EventManager,"ADD_DATABASE_DATA","ADD_DATABASE_DATA"),l(EventManager,"ADD_OPERAND_DATA","ADD_OPERAND_DATA"),l(EventManager,"SEND_ANCHOR_FORMULA","SEND_ANCHOR_FORMULA"),l(EventManager,"SHIFT_ADD_BOOKMARK","SHIFT_ADD_BOOKMARK"),l(EventManager,"SHIFT_ADD_BOARD","SHIFT_ADD_BOARD"),l(EventManager,"SHIFT_ADD_CHARTS","SHIFT_ADD_CHARTS"),l(EventManager,"SHIFT_ADD_FORMULA","SHIFT_ADD_FORMULA"),l(EventManager,"SHIFT_ADD_FUNCTION","SHIFT_ADD_FUNCTION"),l(EventManager,"SHIFT_ADD_OPERATIONBODY","SHIFT_ADD_OPERATIONBODY"),l(EventManager,"SHIFT_ADD_VARIABLEBODY","SHIFT_ADD_VARIABLEBODY"),l(EventManager,"SHIFT_ADD_SYMBOLBODY","SHIFT_ADD_SYMBOLBODY"),l(EventManager,"SHIFT_SHOW_VIEW","SHIFT_SHOW_VIEW"),l(EventManager,"SHIFT_SHOW_VIEW_ON","SHIFT_SHOW_VIEW_ON"),l(EventManager,"SHIFT_REMOVE_BODY","SHIFT_REMOVE_BODY"),l(EventManager,"SHIFT_ADD_BODY_VIEW","SHIFT_ADD_BODY_VIEW"),l(EventManager,"SHIFT_REFRESH_LIBRARY_COORDINATES","SHIFT_REFRESH_LIBRARY_COORDINATES"),l(EventManager,"IDINDEX",1),l(EventManager,"PLAYER_INSTANCE_LEVEL_UP","PLAYER_INSTANCE_LEVEL_UP");class Folder{constructor(e=null){l(this,"name");l(this,"isFolder",!0);l(this,"isShow",!0);l(this,"isShowChild",!0);l(this,"tree",[]);l(this,"formulaTree",[]);l(this,"minArrowsView",null);l(this,"constructorName","Folder");l(this,"id");this.name=e,this.id=++EventManager.IDINDEX}setName(e){this.name=e}dispose(){this.name=null,this.isFolder=!1,this.isShowChild=!1,this.tree=[],this.formulaTree=[]}getMaxHeight(){let e=1;for(let t=0;t<this.tree.length;t++)this.tree[t].isShow&&(this.tree[t].isFolder?e+=this.tree[t].getMaxHeight():e++);return e}addTest(e){return this.tree.indexOf(e)==-1}spliceChild(e,t){this.addTest(e)&&this.tree.splice(t,0,e)}pushChild(e){this.addTest(e)&&this.tree.push(e)}unshiftChild(e){this.addTest(e)&&this.tree.unshift(e)}removeChild(e){if(!this.addTest(e)){const t=this.tree.indexOf(e);this.tree.splice(t,1)}}}class FXCentre{constructor(){l(this,"callCenter",null);fx.sceneFolder=new Folder("场景根目录"),fx.targetFolder=fx.sceneFolder,this.initEventListener()}initEventListener(){this.callCenter=new CallCenter,this.callCenter.addEventListener(fx.Eve.ADD_DATABASE_DATA,this.addDataBaseFunction,null,this),this.callCenter.addEventListener(fx.Eve.ADD_OPERAND_DATA,this.addOperandFunction.bind(this))}addBody(e,t,n){e!=null&&!e.addTest(t)&&(Call.send(fx.Eve.SHIFT_REMOVE_BODY,[t,!1],null),e.addBody(t),Call.send(fx.Eve.SHIFT_ADD_BODY_VIEW,[e,t,n],null))}addOperandFunction(e){this.addBody(e[0],e[1],e[2])}addDataBaseFunction(e){this.addData(e[0],e[1],e[2])}addData(e,t,n){t!=null&&t.typeView!=null&&(t=null),t!=null&&t.isFolder?(e.parentFolder=t,n!=null?t.spliceChild(e,n):t.pushChild(e)):t==null?(e.parentFolder=fx.targetFolder,n!=null?fx.targetFolder.spliceChild(e,n):fx.targetFolder.pushChild(e)):(e.parentFolder=t.parentFolder,e.parentFolder.spliceChild(e,t.parentFolder.tree.indexOf(t)+1))}}var NodeType=(i=>(i[i.Variable=1]="Variable",i[i.Macro=4]="Macro",i[i.CalculationLayer=5]="CalculationLayer",i.SymbolBody="SymbolBody",i.OperationBody="OperationBody",i.Bookmark="Bookmark",i[i.Sheet=11]="Sheet",i[i.LogicalBasic=12]="LogicalBasic",i[i.LogicalSlider=14]="LogicalSlider",i[i.LogicalBool=16]="LogicalBool",i))(NodeType||{});function getCatchValue(i,e,t,n){let r=0;try{r=i.getValue(e,t,n)}catch(o){console.log(o),r=0}return r}var CommonFunctionTypes=(i=>(i[i.abs=4]="abs",i[i.random=5]="random",i[i.floor=6]="floor",i[i.sqrt=7]="sqrt",i[i.max=8]="max",i[i.min=9]="min",i[i.pow=11]="pow",i[i.log=12]="log",i[i.exp=13]="exp",i[i.cbrt=14]="cbrt",i[i.sign=52]="sign",i[i.imul=53]="imul",i[i.ceil=54]="ceil",i[i.round=55]="round",i))(CommonFunctionTypes||{}),AlgorithmFunctionTypes=(i=>(i[i.length=56]="length",i[i.distance=57]="distance",i[i.dot=58]="dot",i[i.cross=59]="cross",i[i.mix=60]="mix",i))(AlgorithmFunctionTypes||{}),HandleFunctionTypes=(i=>(i[i["1-n"]=1]="1-n",i[i["1/n"]=2]="1/n",i[i["-n"]=3]="-n",i[i["n*2"]=15]="n*2",i[i["n/2"]=16]="n/2",i[i["n*100"]=17]="n*100",i[i["n/100"]=18]="n/100",i[i["n*n"]=19]="n*n",i[i["n/n2"]=20]="n/n2",i[i["n/(n+n2)"]=21]="n/(n+n2)",i[i["n/(n2-n)"]=22]="n/(n2-n)",i[i["(n,e).(n1,e2)."]=23]="(n,e).(n1,e2).",i[i["r(n~n2)"]=10]="r(n~n2)",i))(HandleFunctionTypes||{}),TriangleFunctionTypes=(i=>(i[i["n*pi"]=36]="n*pi",i[i.cos=37]="cos",i[i.sin=38]="sin",i[i.tan=39]="tan",i[i.acos=40]="acos",i[i.asin=41]="asin",i[i.atan=42]="atan",i[i.atan2=43]="atan2",i))(TriangleFunctionTypes||{}),LogicFunctionTypes=(i=>(i[i["if(n1>n2)return{n3!n4}"]=44]="if(n1>n2)return{n3!n4}",i[i["if(n1>=n2)return{n3!n4}"]=45]="if(n1>=n2)return{n3!n4}",i[i["if(n1<n2)return{n3!n4}"]=46]="if(n1<n2)return{n3!n4}",i[i["if(n1<=n2)return{n3!n4}"]=47]="if(n1<=n2)return{n3!n4}",i[i["if(n1==n2)return{n3!n4}"]=48]="if(n1==n2)return{n3!n4}",i[i["if(n1!=n2)return{n3!n4}"]=49]="if(n1!=n2)return{n3!n4}",i[i["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]=50]="for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}",i[i["[n]"]=51]="[n]",i))(LogicFunctionTypes||{}),CommonFormulaTypes=(i=>(i[i["攻击-防御"]=24]="攻击-防御",i[i["攻击*攻击/(攻击-防御)"]=25]="攻击*攻击/(攻击-防御)",i[i["(攻击-防御)*(攻击/防御)"]=26]="(攻击-防御)*(攻击/防御)",i[i["攻击*攻击/防御"]=27]="攻击*攻击/防御",i[i["攻击/防御"]=28]="攻击/防御",i[i["攻击*(1-系数)"]=29]="攻击*(1-系数)",i[i["护甲*系数/(1+护甲*系数)"]=30]="护甲*系数/(1+护甲*系数)",i[i["攻击*受伤率"]=31]="攻击*受伤率",i[i["攻击/(1+防御*系数)"]=32]="攻击/(1+防御*系数)",i[i["攻击/防御*系数"]=33]="攻击/防御*系数",i[i["攻击*系数/防御"]=34]="攻击*系数/防御",i[i["攻击*(系数/防御)"]=35]="攻击*(系数/防御)",i[i["(攻击-防御)*攻击-防御/(攻击/防御)"]=36]="(攻击-防御)*攻击-防御/(攻击/防御)",i))(CommonFormulaTypes||{}),GameFormula1=(i=>(i[i.战斗公式=61]="战斗公式",i))(GameFormula1||{}),GameFormula2=(i=>(i[i.人物生命=62]="人物生命",i[i.近战素质物攻=63]="近战素质物攻",i[i.远程素质物攻=64]="远程素质物攻",i[i.法师素质物攻=65]="法师素质物攻",i[i.物防=66]="物防",i[i.魔防=67]="魔防",i[i.命中=68]="命中",i[i.闪避=69]="闪避",i[i.暴击=70]="暴击",i[i.抗暴=71]="抗暴",i[i.职业素质点成长=72]="职业素质点成长",i[i.最终近战物攻=73]="最终近战物攻",i[i.最终远程物攻=74]="最终远程物攻",i[i.最终魔法攻击=75]="最终魔法攻击",i[i.物理伤害=76]="物理伤害",i[i.魔法伤害=77]="魔法伤害",i[i.命中率=78]="命中率",i[i.暴击率=79]="暴击率",i))(GameFormula2||{}),GameFormula3=(i=>(i[i.成长公式=80]="成长公式",i))(GameFormula3||{});const getGlobalThis=()=>typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof self<"u"?self:{};class VariableValue{constructor(i,e,t=null,n=null){l(this,"name");l(this,"id");l(this,"TID");l(this,"value",0);l(this,"selectedOutputInfo",0);l(this,"type");l(this,"operator",null);l(this,"isAI",!1);l(this,"macros","");l(this,"sheetData",null);l(this,"snNo",1);l(this,"isLogicalOpen",!1);l(this,"isDragging",!1);l(this,"logicalNumberList",[]);l(this,"formulaTextValue");l(this,"currentStep",0);l(this,"minValue",1);l(this,"maxValue",100);l(this,"step",10);l(this,"parent",null);l(this,"childCell");l(this,"childArray",[]);l(this,"childBodyArray",[]);l(this,"logicalChildArray",[]);l(this,"tree",[]);l(this,"cacheValue",null);l(this,"view",null);l(this,"body",null);l(this,"tag",null);l(this,"enemyBody",null);l(this,"enemyFlag",!1);l(this,"isWeight",!0);l(this,"statistics",0);l(this,"absoluteAddress",null);l(this,"site",null);l(this,"source",null);l(this,"captureCrit",!0);l(this,"upDateValue",1);l(this,"demoteValue",0);l(this,"funcType",0);l(this,"historyTarget",null);l(this,"isSystemShow",!1);l(this,"constructorName","VariableValue");this.name=i,this.value=e,this.type=t,this.id=++EventManager.IDINDEX,this.operator=n}setMacros(i){this.macros=i,this.getValue()}setGlobalValue(i){this.source!=null&&this.source.setValue(i)}setValue(i){this.type!==NodeType.Sheet&&(this.value=i,this.upDataChild(),this.type===NodeType.Variable&&fx.code===!1&&this.updateVariableDisplay(i))}updateVariableDisplay(i){var n,r;const e=(n=fx.getDataById)==null?void 0:n.call(fx,this.id),t=(r=fx.getTreeDataById)==null?void 0:r.call(fx,this.id);if(e&&t){const o=getGlobalThis();if(o.window&&!o.window.updatingSheeData){const s=`componentDatas.nodeList.props.tree.props.dataSource.${t.dataPath}.showName`;o.window.set_data(o.window.store,s,`${this.name}=${i}`)}}}addNumberList(){this.logicalNumberList.push({value:""})}changeNumberListItem(i,e){this.logicalNumberList[i].value=e}getIsFunction(){return this.type===NodeType.Macro}getRessSring(i){const e=[];return fx.getStepData(i,e),e.join("")}setEnemyBody(i){this.enemyBody=i}setSheetData(i){this.sheetData=new fx.SheetData(i),this.getValue(),this.upDataChild()}getValue(i,e,t){if(this.type!==NodeType.Variable&&this.enemyFlag&&fx.enemyBody!=null)return this.value=getCatchValue(fx.enemyBody.getPropertyObject(this.source.absoluteAddress)),this.returnFunc(this.value);switch(this.type){case NodeType.Macro:return this.getMacroValue();case NodeType.Sheet:return this.getSheetValue(i,e,t);case NodeType.LogicalNumberList:return this.getLogicalNumberListValue();case NodeType.LogicalSlider:return this.getLogicalSliderValue();case NodeType.LogicalList:case NodeType.LogicalBasic:return this.getLogicalValue();case NodeType.CalculationLayer:return this.getCalculationLayerValue();default:return this.getDefaultValue()}}getMacroValue(){try{if(this.historyTarget=globalThis.target,globalThis.target=this,this.macros==="")return this.value=0,this.returnFunc(this.value);if(fx.code)this.value=new Function(`return ${fx["f_"+this.TID].fun.replace(/[\r\n\s]/g,"")}`)();else try{this.value=eval(this.macros)}catch(i){this.value=0}return globalThis.target=this.historyTarget,isNaN(this.value)||(this.value=fx.double(this.value,4)),this.returnFunc(this.value)}catch(i){return this.value=0,this.value}}getSheetValue(i,e,t){var n,r,o;return this.value=((r=(n=this.source)==null?void 0:n.sheetData)==null?void 0:r.getValue(i,e,t))||((o=this.sheetData)==null?void 0:o.getValue(i,e,t))||0,this.returnFunc(this.value)}getLogicalNumberListValue(){const i=this.getNumberListValue();if(typeof i=="string"&&i.startsWith("[")){const e=JSON.parse(i),t=Math.floor(Math.random()*(e[1]-e[0]+1))+e[0];this.value=t}else this.value=Number(i);return this.returnFunc(this.value)}getNumberListValue(){return typeof this.snNo=="number"&&this.logicalNumberList.length&&this.snNo<=this.logicalNumberList.length&&this.logicalNumberList[this.snNo-1].value||0}getLogicalSliderValue(){const i=this.currentStep*this.step;return this.value=Math.max(this.minValue,Math.min(i,this.maxValue)),this.returnFunc(this.value)}getLogicalValue(){const i=this.logicalChildArray[this.snNo-1];return this.value=i?i.getValue():0,this.returnFunc(this.value)}getCalculationLayerValue(){var t;const i=(t=this.source)==null?void 0:t.body,e=this.body;return i?this.value=getCatchValue(i):e&&(this.value=getCatchValue(e)),isNaN(this.value)||(this.value=Number(fx.double(this.value,4))),this.returnFunc(this.value)}getDefaultValue(){return this.value||(this.value=0),isNaN(this.value)||(this.value=Number(this.value)),this.returnFunc(this.value)}returnFunc(i){return this.funcType===0?i:this.funcType>=HandleFunctionTypes["1-n"]&&this.funcType<=HandleFunctionTypes["(n,e).(n1,e2)."]?this.handleFunction(i):this.funcType>=CommonFormulaTypes["攻击-防御"]&&this.funcType<=35?this.commonFormulaFunction():this.funcType>=TriangleFunctionTypes["n*pi"]&&this.funcType<=TriangleFunctionTypes.atan2?this.triangleFunction(i):this.funcType>=LogicFunctionTypes["if(n1>n2)return{n3!n4}"]&&this.funcType<=LogicFunctionTypes["[n]"]?this.logicFunction():this.funcType>=CommonFunctionTypes.abs&&this.funcType<=CommonFunctionTypes.cbrt||this.funcType>=CommonFunctionTypes.sign&&this.funcType<=CommonFunctionTypes.round?this.commonFunction(i):this.funcType>=AlgorithmFunctionTypes.length&&this.funcType<=60?this.algorithmFunction():this.funcType>=GameFormula1.战斗公式&&this.funcType<=68?this.gameFormulaFunction():i}handleFunction(i){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case HandleFunctionTypes["1-n"]:return 1-i;case HandleFunctionTypes["1/n"]:return 1/i;case HandleFunctionTypes["-n"]:return-i;case HandleFunctionTypes["n*2"]:return i*2;case HandleFunctionTypes["n/2"]:return i/2;case HandleFunctionTypes["n*100"]:return i*100;case HandleFunctionTypes["n/100"]:return i/100;case HandleFunctionTypes["n*n"]:return i*i;case HandleFunctionTypes["n/n2"]:return this.tree.length<2?0:e(0)/e(1);case HandleFunctionTypes["n/(n+n2)"]:return this.tree.length<2?0:e(0)/(e(0)+e(1));case HandleFunctionTypes["n/(n2-n)"]:return this.tree.length<2?0:e(0)/(e(1)-e(0));case HandleFunctionTypes["(n,e).(n1,e2)."]:return this.weightedRandom();case HandleFunctionTypes["r(n~n2)"]:return this.tree.length<2?0:Math.random()*(e(1)-e(0))+e(0);default:return i}}commonFormulaFunction(){const i=e=>getCatchValue(this.tree[e]);switch(this.funcType){case CommonFormulaTypes["攻击-防御"]:return this.tree.length<2?0:i(0)-i(1);case CommonFormulaTypes["攻击*攻击/(攻击-防御)"]:return this.tree.length<2?0:i(0)*i(0)/(i(0)+i(1));case CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]:return this.tree.length<2?0:(i(0)-i(1))*(i(0)/i(1));case CommonFormulaTypes["攻击*攻击/防御"]:return this.tree.length<2?0:i(0)*i(0)/i(1);case CommonFormulaTypes["攻击/防御"]:return this.tree.length<2?0:i(0)/i(1);case CommonFormulaTypes["攻击*(1-系数)"]:return this.tree.length<2?0:i(0)*(1-i(1));case CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]:return this.tree.length<2?0:i(0)*i(1)/(1+i(0)*i(1));case CommonFormulaTypes["攻击*受伤率"]:return this.tree.length<2?0:i(0)*i(1);case CommonFormulaTypes["攻击/(1+防御*系数)"]:return this.tree.length<3?0:i(0)/(1+i(1)*i(2));case CommonFormulaTypes["攻击/防御*系数"]:return this.tree.length<3?0:i(0)/i(1)*i(2);case CommonFormulaTypes["攻击*系数/防御"]:return this.tree.length<3?0:i(0)*i(2)/i(1);case CommonFormulaTypes["攻击*(系数/防御)"]:return this.tree.length<3?0:i(0)*(i(2)/i(1));default:return 0}}triangleFunction(i){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case TriangleFunctionTypes["n*pi"]:return i*Math.PI;case TriangleFunctionTypes.cos:return Math.cos(i);case TriangleFunctionTypes.sin:return Math.sin(i);case TriangleFunctionTypes.tan:return Math.tan(i);case TriangleFunctionTypes.acos:return Math.acos(i);case TriangleFunctionTypes.asin:return Math.asin(i);case TriangleFunctionTypes.atan:return Math.atan(i);case TriangleFunctionTypes.atan2:return this.tree.length<2?0:Math.atan2(e(0),e(1));default:return i}}logicFunction(){const i=e=>getCatchValue(this.tree[e]);if(this.tree.length<4&&this.funcType!==LogicFunctionTypes["[n]"]&&this.funcType!==50)return 0;switch(this.funcType){case LogicFunctionTypes["if(n1>n2)return{n3!n4}"]:return i(0)>i(1)?i(2):i(3);case LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]:return i(0)>=i(1)?i(2):i(3);case LogicFunctionTypes["if(n1<n2)return{n3!n4}"]:return i(0)<i(1)?i(2):i(3);case LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]:return i(0)<=i(1)?i(2):i(3);case LogicFunctionTypes["if(n1==n2)return{n3!n4}"]:return i(0)==i(1)?i(2):i(3);case LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]:return i(0)!=i(1)?i(2):i(3);case LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]:return this.complexForLoop();case LogicFunctionTypes["[n]"]:return this.tree.length>0?i(i(0)):0;default:return 0}}commonFunction(i){const e=t=>getCatchValue(this.tree[t]);switch(this.funcType){case CommonFunctionTypes.abs:return Math.abs(i);case CommonFunctionTypes.random:return Math.random()*i;case CommonFunctionTypes.floor:return Math.floor(i);case CommonFunctionTypes.sqrt:return Math.sqrt(i);case CommonFunctionTypes.max:return Math.max(...this.tree.map((t,n)=>Number(e(n))));case CommonFunctionTypes.min:return Math.min(...this.tree.map((t,n)=>Number(e(n))));case CommonFunctionTypes.pow:return this.tree.length<2?0:Math.pow(e(0),e(1));case CommonFunctionTypes.log:return Math.log(i);case CommonFunctionTypes.exp:return Math.exp(i);case CommonFunctionTypes.cbrt:return Math.cbrt(i);case CommonFunctionTypes.sign:return Math.sign(i);case CommonFunctionTypes.imul:return Math.imul(i,1);case CommonFunctionTypes.ceil:return Math.ceil(i);case CommonFunctionTypes.round:return Math.round(i);default:return i}}algorithmFunction(){const i=e=>getCatchValue(this.tree[e]);switch(this.funcType){case AlgorithmFunctionTypes.length:return this.tree.length<2?0:fx.length(i(0),i(1));case AlgorithmFunctionTypes.distance:return this.tree.length<4?0:fx.distance(i(0),i(1),i(2),i(3));case AlgorithmFunctionTypes.dot:return this.tree.length<4?0:fx.dot(i(0),i(1),i(2),i(3));case AlgorithmFunctionTypes.cross:return this.tree.length<4?0:fx.cross(i(0),i(1),i(2),i(3));case AlgorithmFunctionTypes.mix:return this.tree.length<3?0:fx.mix(i(0),i(1),i(2));default:return 0}}gameFormulaFunction(){const i=e=>getCatchValue(this.tree[e]);switch(this.funcType){case GameFormula1.战斗公式:return this.tree.length<3?0:i(0)*i(2)*(1-1/(1+i(0)*i(2)/(5*i(1))));case GameFormula2.人物生命:return this.tree.length<4?0:i(0)+i(2)*i(1)+i(3)*(1+i(1))*i(1)/2;case GameFormula2.近战素质物攻:case GameFormula2.远程素质物攻:return this.tree.length<5?0:i(0)*2+Math.pow(i(0)/10,2)+i(1)/5+i(2)/5+i(4)*i(3);case GameFormula2.法师素质物攻:return this.tree.length<1?0:i(0)*2+Math.pow(i(0)/10,2);case GameFormula2.物防:case GameFormula2.魔防:return this.value;case GameFormula2.命中+2:return this.tree.length<2?0:i(0)+i(1);default:return this.value}}weightedRandom(){if(this.tree.length%2!==0)return 0;let i=0;for(let t=1;t<this.tree.length;t+=2)this.tree[t].indexex=getCatchValue(this.tree[t])+i,i+=getCatchValue(this.tree[t]);const e=Math.random()*i;for(let t=1;t<this.tree.length;t+=2){const n=t===1?0:this.tree[t-2].indexex;if(e>=n&&e<this.tree[t].indexex)return getCatchValue(this.tree[t-1])}return 0}complexForLoop(){if(this.tree.length<3)return 0;let i=0,e=0;const t=getCatchValue(this.tree[0]),n=getCatchValue(this.tree[1]),r=getCatchValue(this.tree[2]);for(let o=t;o<=n;o++)o%r===1&&i++,e+=i+2;return e}getFormulaTextValueBody(){return{[HandleFunctionTypes["1-n"]]:`1-(${this.value})`,[HandleFunctionTypes["1/n"]]:`1/(${this.value})`,[HandleFunctionTypes["-n"]]:`-(${this.value})`,[CommonFunctionTypes.abs]:`abs(${this.value})`,[CommonFunctionTypes.random]:`random()*${this.value}`,[CommonFunctionTypes.floor]:`floor(${this.value})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.value})`,[CommonFunctionTypes.log]:`log(${this.value})`,[CommonFunctionTypes.exp]:`exp(${this.value})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.value})`,[HandleFunctionTypes["n*2"]]:`(${this.value})*2`,[HandleFunctionTypes["n/2"]]:`(${this.value})/2`,[HandleFunctionTypes["n*100"]]:`(${this.value})*100`,[HandleFunctionTypes["n/100"]]:`(${this.value})/100`,[HandleFunctionTypes["n*n"]]:`${this.value}*${this.value}`,[TriangleFunctionTypes["n*pi"]]:`${this.value}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.value})`,[TriangleFunctionTypes.sin]:`sin(${this.value})`,[TriangleFunctionTypes.tan]:`tan(${this.value})`,[TriangleFunctionTypes.acos]:`acos(${this.value})`,[TriangleFunctionTypes.asin]:`asin(${this.value})`,[TriangleFunctionTypes.atan]:`atan(${this.value})`,[CommonFunctionTypes.sign]:`sign(${this.value})`,[CommonFunctionTypes.imul]:`imul(${this.value})`,[CommonFunctionTypes.ceil]:`ceil(${this.value})`,[CommonFunctionTypes.round]:`round(${this.value})`}[this.funcType]||this.formulaTextValue||String(this.value)}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){if(this.type===NodeType.CalculationLayer)return this.body?this.body.getFormulaTextCharacter():"";if(this.type===NodeType.Macro)return this.getValue();let i=this.name;return this.type===NodeType.Macro&&(i=`${this.name}_${this.TID}`),{[HandleFunctionTypes["1-n"]]:`1-(${this.name})`,[HandleFunctionTypes["1/n"]]:`1/(${this.name})`,[HandleFunctionTypes["-n"]]:`-${this.name}`,[CommonFunctionTypes.abs]:`abs(${this.name})`,[CommonFunctionTypes.random]:`random()*(${this.name})`,[CommonFunctionTypes.floor]:`floor(${this.name})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.name})`,[CommonFunctionTypes.log]:`log(${this.name})`,[CommonFunctionTypes.exp]:`exp(${this.name})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.name})`,[HandleFunctionTypes["n*2"]]:`${this.name}*2`,[HandleFunctionTypes["n/2"]]:`${this.name}/2`,[HandleFunctionTypes["n*100"]]:`${this.name}*100`,[HandleFunctionTypes["n/100"]]:`${this.name}/100`,[HandleFunctionTypes["n*n"]]:`${this.name}*${this.name}`,[TriangleFunctionTypes["n*pi"]]:`${this.name}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.name})`,[TriangleFunctionTypes.sin]:`sin(${this.name})`,[TriangleFunctionTypes.tan]:`tan(${this.name})`,[TriangleFunctionTypes.acos]:`acos(${this.name})`,[TriangleFunctionTypes.asin]:`asin(${this.name})`,[TriangleFunctionTypes.atan]:`atan(${this.name})`,[CommonFunctionTypes.sign]:`sign(${this.name})`,[CommonFunctionTypes.imul]:`imul(${this.name})`,[CommonFunctionTypes.ceil]:`ceil(${this.name})`,[CommonFunctionTypes.round]:`round(${this.name})`}[this.funcType]||i}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}removeChild(i){const e=this.childArray.indexOf(i);e>-1&&this.childArray.splice(e,1)}dispose(){this.source!=null&&this.source.removeChild(this),this.macros="",this.childArray=[]}setParameter(i,e){this.name=i,this.value=e}upDataChild(){for(const i of this.childArray)i.name=this.name,i.value=this.value,i.body=this.body,i.TID=this.TID}setDataChild(i,e){this.name=i,this.value=e;for(const t of this.childArray)t.setDataChild(i,e)}syncBody(){for(const i of this.childArray)i.body=this.body}copy(){const i=new fx.VariableValue(this.name,this.value,this.type,this.operator);return i.source=this,i.body=this.body,i.TID=this.TID,this.childArray.push(i),i}}class BasicBody{constructor(){l(this,"tree",[]);l(this,"parent",null);l(this,"type","BasicBody");l(this,"isWeight",!1);l(this,"value",null);l(this,"isAdvance",!1);l(this,"isBindingOperation",!1);l(this,"isBindingFormula",!1);l(this,"formulaTextValue","");l(this,"formulaTextCharacter","");l(this,"operationalLogicText","");l(this,"cacheElementValue",null);l(this,"funcType",0);l(this,"constructorName","BasicBody");l(this,"id");l(this,"typetype",null);l(this,"operator",null);l(this,"indexex",0);l(this,"isFunction",!1);l(this,"x",0);l(this,"y",0);this.id=++EventManager.IDINDEX}addTest(e){return this.tree.includes(e)?!0:this.tree.some(t=>t instanceof fx.BasicBody&&t.addTest(e))}replace(e,t){this.tree[t]=e,e.parent=this}deletebody(e){const t=this.tree.indexOf(e);t!==-1&&(this.tree.splice(t,1),e.parent=null)}addBody(e){this.tree.includes(e)||(e.parent=this,this.tree.push(e))}getDeleteBodyTree(e){const t=this.tree.indexOf(e);if(t===-1)return[];const n=this.tree.slice(t);return this.tree.splice(t),n}dispose(){this.tree.forEach(e=>{e&&typeof e.dispose=="function"&&e.dispose()}),this.tree=[],this.value=null,this.parent=null,this.typetype=null,this.cacheElementValue=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.isWeight=!1,this.isAdvance=!1,this.isBindingOperation=!1,this.isBindingFormula=!1,this.isFunction=!1}getMaxHeight(){return this.tree.filter(t=>t instanceof fx.BasicBody).reduce((t,n)=>t+n.getMaxHeight(),0)||1}getValue(e,t,n){if(this.resetValues(),!!this.tree)return this.processTreeValues(),this.calculateFinalValue(),this.value=this.applyFunction(this.value),this.value}resetValues(){this.value=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.cacheElementValue=null}processTreeValues(){for(const e of this.tree){const t=this.getNodeValue(e);this.updateOperationalLogic(e,t),this.updateFormulaTexts(e,t)}}getNodeValue(e){if(e.type===NodeType.Sheet){const{name:t,row:n,col:r}=(e==null?void 0:e.selectedOutputInfo)||{};return getCatchValue(e,t,n,r)}return e.type===NodeType.CalculationLayer,getCatchValue(e)}updateOperationalLogic(e,t){var n;(n=this.cacheElementValue)!=null&&n.operator&&(this.operationalLogicText+=`(${t})`),this.cacheElementValue||(this.cacheElementValue=e,this.operationalLogicText+=`(${t})`),e.operator&&(this.operationalLogicText+=e.operator)}updateFormulaTexts(e,t){[0,NodeType.Variable,2,3,NodeType.Macro,NodeType.CalculationLayer,NodeType.Sheet].includes(e.type)&&(this.formulaTextCharacter+=e.getFormulaTextCharacter(),this.formulaTextValue+=t,e.operator&&(this.formulaTextValue+=e.operator,this.formulaTextCharacter+=e.operator))}calculateFinalValue(){const e=this.formulaTextValue.slice(-1);["+","-","*","/","%",">",">=","<","<=","!="].includes(e)||(this.value=fx.eval(this.operationalLogicText)),isNaN(this.value)?this.value=this.operationalLogicText:this.value=Number(this.value)}applyFunction(e){return this.returnFunc(e)}returnFunc(e){const n=this.getFunctionHandlers()[this.funcType];return n?n(e,this.tree):e}getFunctionHandlers(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>1-e,[HandleFunctionTypes["1/n"]]:e=>1/e,[HandleFunctionTypes["-n"]]:e=>-e,[HandleFunctionTypes["n*2"]]:e=>e*2,[HandleFunctionTypes["n/2"]]:e=>e/2,[HandleFunctionTypes["n*100"]]:e=>e*100,[HandleFunctionTypes["n/100"]]:e=>e/100,[HandleFunctionTypes["n*n"]]:e=>e*e,[CommonFunctionTypes.abs]:e=>Math.abs(e),[CommonFunctionTypes.random]:e=>Math.random()*e,[CommonFunctionTypes.floor]:e=>Math.floor(e),[CommonFunctionTypes.sqrt]:e=>Math.sqrt(e),[CommonFunctionTypes.max]:(e,t)=>this.calculateMax(t),[CommonFunctionTypes.min]:(e,t)=>this.calculateMin(t),[CommonFunctionTypes.pow]:(e,t)=>this.calculatePower(t),[CommonFunctionTypes.log]:e=>Math.log(e),[CommonFunctionTypes.exp]:e=>Math.exp(e),[CommonFunctionTypes.cbrt]:e=>Math.cbrt(e),[CommonFunctionTypes.sign]:e=>Math.sign(e),[CommonFunctionTypes.imul]:e=>Math.imul(e,1),[CommonFunctionTypes.ceil]:e=>Math.ceil(e),[CommonFunctionTypes.round]:e=>Math.round(e),[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.calculateRandom(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.divideValues(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.divideBySum(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.divideByDifference(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.weightedRandom(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.attackMinusDefense(t),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.attackSquaredOverDiff(t),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.diffTimesRatio(t),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.attackSquaredOverDefense(t),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.attackOverDefense(t),[CommonFormulaTypes["攻击*(1-系数)"]]:(e,t)=>this.attackWithCoefficient(t),[CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]]:(e,t)=>this.armorFormula(t),[CommonFormulaTypes["攻击*受伤率"]]:(e,t)=>this.attackWithDamageRate(t),[CommonFormulaTypes["攻击/(1+防御*系数)"]]:(e,t)=>this.attackOverDefenseFormula(t),[CommonFormulaTypes["攻击/防御*系数"]]:(e,t)=>this.attackRatioWithCoef(t),[CommonFormulaTypes["攻击*系数/防御"]]:(e,t)=>this.attackCoefOverDefense(t),[CommonFormulaTypes["攻击*(系数/防御)"]]:(e,t)=>this.attackTimesCoefRatio(t),[TriangleFunctionTypes["n*pi"]]:e=>e*Math.PI,[TriangleFunctionTypes.cos]:e=>Math.cos(e),[TriangleFunctionTypes.sin]:e=>Math.sin(e),[TriangleFunctionTypes.tan]:e=>Math.tan(e),[TriangleFunctionTypes.acos]:e=>Math.acos(e),[TriangleFunctionTypes.asin]:e=>Math.asin(e),[TriangleFunctionTypes.atan]:e=>Math.atan(e),[TriangleFunctionTypes.atan2]:(e,t)=>this.calculateAtan2(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.ifGreater(t),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.ifGreaterEqual(t),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.ifLess(t),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.ifLessEqual(t),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.ifEqual(t),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.ifNotEqual(t),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.forLoop(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.arrayAccess(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.calculateLength(t),[AlgorithmFunctionTypes.distance]:(e,t)=>this.calculateDistance(t),[AlgorithmFunctionTypes.dot]:(e,t)=>this.calculateDot(t),[AlgorithmFunctionTypes.cross]:(e,t)=>this.calculateCross(t),[AlgorithmFunctionTypes.mix]:(e,t)=>this.calculateMix(t),[GameFormula1.战斗公式]:(e,t)=>this.battleFormula(t),[GameFormula2.人物生命]:(e,t)=>this.characterHealth(t),[GameFormula2.近战素质物攻]:(e,t)=>this.meleeAttack(t),[GameFormula2.远程素质物攻]:(e,t)=>this.rangedAttack(t),[GameFormula2.法师素质物攻]:(e,t)=>this.mageAttack(t),[GameFormula2.物防]:(e,t)=>this.physicalDefense(t),[GameFormula2.魔防]:(e,t)=>this.magicDefense(t),[GameFormula2.命中]:(e,t)=>this.hitRate(t),[GameFormula2.闪避]:(e,t)=>this.dodgeRate(t),[GameFormula2.暴击]:e=>1+e/3,[GameFormula2.抗暴]:e=>1+e/5,[GameFormula2.职业素质点成长]:(e,t)=>this.jobPointGrowth(t),[GameFormula2.最终近战物攻]:(e,t)=>this.finalMeleeAttack(t),[GameFormula2.最终远程物攻]:(e,t)=>this.finalRangedAttack(t),[GameFormula2.最终魔法攻击]:(e,t)=>this.finalMagicAttack(t),[GameFormula2.物理伤害]:(e,t)=>this.physicalDamage(t),[GameFormula2.魔法伤害]:(e,t)=>this.magicDamage(t),[GameFormula2.命中率]:(e,t)=>this.hitChance(t),[GameFormula2.暴击率]:(e,t)=>this.critChance(t),[GameFormula3.成长公式]:(e,t)=>this.growthFormula(t)}}getTreeValue(e,t){return e.length>t?Number(getCatchValue(e[t])):0}calculateMax(e){const t=e.map(n=>Number(getCatchValue(n)));return Math.max(...t)}calculateMin(e){const t=e.map(n=>Number(getCatchValue(n)));return Math.min(...t)}calculatePower(e){return e.length<2?0:Math.pow(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateRandom(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return Math.random()*(n-t)+t}divideValues(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}divideBySum(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t/(t+n)}divideByDifference(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t/(n-t)}weightedRandom(e){if(e.length%2!==0)return 0;let t=0;for(let r=1;r<e.length;r+=2){const o=this.getTreeValue(e,r);e[r].indexex=o+t,t+=o}const n=Math.random()*t;for(let r=1;r<e.length;r+=2){const o=r>1&&e[r-2].indexex||0,s=e[r].indexex||0;if(n>=o&&n<s)return this.getTreeValue(e,r-1)}return 0}attackMinusDefense(e){return e.length<2?0:this.getTreeValue(e,0)-this.getTreeValue(e,1)}attackSquaredOverDiff(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*t/(t+n)}diffTimesRatio(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n)*(t/n)}attackSquaredOverDefense(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*t/n}attackOverDefense(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}attackWithCoefficient(e){return e.length<2?0:this.getTreeValue(e,0)*(1-this.getTreeValue(e,1))}armorFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*n/(1+t*n)}attackWithDamageRate(e){return e.length<2?0:this.getTreeValue(e,0)*this.getTreeValue(e,1)}attackOverDefenseFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2);return t/(1+n*r)}attackRatioWithCoef(e){return e.length<3?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)*this.getTreeValue(e,2)}attackCoefOverDefense(e){return e.length<3?0:this.getTreeValue(e,0)*this.getTreeValue(e,2)/this.getTreeValue(e,1)}attackTimesCoefRatio(e){return e.length<3?0:this.getTreeValue(e,0)*(this.getTreeValue(e,2)/this.getTreeValue(e,1))}calculateAtan2(e){return e.length<2?0:Math.atan2(this.getTreeValue(e,0),this.getTreeValue(e,1))}ifGreater(e){return e.length<4?0:this.getTreeValue(e,0)>this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifGreaterEqual(e){return e.length<4?0:this.getTreeValue(e,0)>=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLess(e){return e.length<4?0:this.getTreeValue(e,0)<this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLessEqual(e){return e.length<4?0:this.getTreeValue(e,0)<=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifEqual(e){return e.length<4?0:this.getTreeValue(e,0)===this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifNotEqual(e){return e.length<4?0:this.getTreeValue(e,0)!==this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}forLoop(e){if(e.length<4)return 0;let t=0,n=0;const r=this.getTreeValue(e,0),o=this.getTreeValue(e,1),s=this.getTreeValue(e,2),u=this.getTreeValue(e,3);for(let c=r;c<=o;c++)c%s===1&&t++,n+=t+u;return n}arrayAccess(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0);return this.getTreeValue(e,t)}calculateLength(e){return e.length<2?0:fx.length(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateDistance(e){return e.length<4?0:fx.distance(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateDot(e){return e.length<4?0:fx.dot(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateCross(e){return e.length<4?0:fx.cross(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateMix(e){return e.length<3?0:fx.mix(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2))}battleFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2);return t*r*(1-1/(1+t*r/(5*n)))}characterHealth(e){if(e.length<4)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3);return t+r*n+o*(1+n)*n/2}meleeAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+n/5+r/5+s*o}rangedAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+n/5+r/5+s*o}mageAttack(e){if(e.length<1)return 0;const t=this.getTreeValue(e,0);return t*2+Math.pow(t/10,2)}physicalDefense(e){return this.value}magicDefense(e){return this.value}hitRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}dodgeRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}jobPointGrowth(e){return e.length<2?0:1+this.getTreeValue(e,0)/this.getTreeValue(e,1)}finalMeleeAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5),c=this.getTreeValue(e,6),d=this.getTreeValue(e,7);return(t*7+t/5+n/5+r/5+o+(o+s)*u)*c*d}finalRangedAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5),c=this.getTreeValue(e,6),d=this.getTreeValue(e,7);return(t*5+t/5+n/5+r/5+o+(o+s)*u)*c*d}finalMagicAttack(e){if(e.length<6)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),r=this.getTreeValue(e,2),o=this.getTreeValue(e,3),s=this.getTreeValue(e,4),u=this.getTreeValue(e,5);return(t*7+t/5+n+(n+r)*o)*s*u}physicalDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*(4e3+n)/(4e3+n*10)}magicDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*(1e3+n)/(1e3+n*10)}hitChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n+80)/100}critChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n)/100}growthFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-1)*n}getFormulaTextValueBody(){const t=this.getFormulaTextBuilders()[this.funcType];return t?t(this.formulaTextValue,this.tree):this.formulaTextValue}getFormulaTextBuilders(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>`(1-(${e}))`,[HandleFunctionTypes["1/n"]]:e=>`1/(${e})`,[HandleFunctionTypes["-n"]]:e=>`-(${e})`,[HandleFunctionTypes["n*2"]]:e=>`(${e})*2`,[HandleFunctionTypes["n/2"]]:e=>`(${e})/2`,[HandleFunctionTypes["n*100"]]:e=>`(${e})*100`,[HandleFunctionTypes["n/100"]]:e=>`(${e})/100`,[HandleFunctionTypes["n*n"]]:e=>`(${e})*(${e})`,[CommonFunctionTypes.abs]:e=>`abs(${e})`,[CommonFunctionTypes.random]:e=>`random()*(${e})`,[CommonFunctionTypes.floor]:e=>`floor(${e})`,[CommonFunctionTypes.sqrt]:e=>`sqrt(${e})`,[CommonFunctionTypes.max]:(e,t)=>this.buildMaxText(t),[CommonFunctionTypes.min]:(e,t)=>this.buildMinText(t),[CommonFunctionTypes.pow]:(e,t)=>this.buildPowerText(t),[CommonFunctionTypes.log]:e=>`log(${e})`,[CommonFunctionTypes.exp]:e=>`exp(${e})`,[CommonFunctionTypes.cbrt]:e=>`cbrt(${e})`,[CommonFunctionTypes.sign]:e=>`sign(${e})`,[CommonFunctionTypes.imul]:e=>`imul(${e})`,[CommonFunctionTypes.ceil]:e=>`ceil(${e})`,[CommonFunctionTypes.round]:e=>`round(${e})`,[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.buildRandomRangeText(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.buildDivisionText(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.buildDivisionSumText(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.buildDivisionDiffText(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.buildWeightedText(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.buildAttackDefenseText(t,"-"),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.buildComplexAttackText(t,1),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.buildComplexAttackText(t,2),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.buildComplexAttackText(t,3),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.buildAttackDefenseText(t,"/"),[TriangleFunctionTypes["n*pi"]]:e=>`(${e})*PI`,[TriangleFunctionTypes.cos]:e=>`cos(${e})`,[TriangleFunctionTypes.sin]:e=>`sin(${e})`,[TriangleFunctionTypes.tan]:e=>`tan(${e})`,[TriangleFunctionTypes.acos]:e=>`acos(${e})`,[TriangleFunctionTypes.asin]:e=>`asin(${e})`,[TriangleFunctionTypes.atan]:e=>`atan(${e})`,[TriangleFunctionTypes.atan2]:(e,t)=>this.buildAtan2Text(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">"),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">="),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<"),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<="),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"=="),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"!="),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.buildForLoopText(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.buildArrayAccessText(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.buildAlgorithmText(t,"length"),[AlgorithmFunctionTypes.distance]:(e,t)=>this.buildAlgorithmText(t,"distance"),[AlgorithmFunctionTypes.dot]:(e,t)=>this.buildAlgorithmText(t,"dot"),[AlgorithmFunctionTypes.cross]:(e,t)=>this.buildAlgorithmText(t,"cross"),[AlgorithmFunctionTypes.mix]:(e,t)=>this.buildMixText(t),[GameFormula1.战斗公式]:(e,t)=>this.buildBattleFormulaText(t),[GameFormula2.人物生命]:(e,t)=>this.buildCharacterHealthText(t),[GameFormula2.近战素质物攻]:(e,t)=>this.buildMeleeAttackText(t),[GameFormula2.远程素质物攻]:(e,t)=>this.buildRangedAttackText(t),[GameFormula2.法师素质物攻]:(e,t)=>this.buildMageAttackText(t),[GameFormula2.物理伤害]:(e,t)=>this.buildPhysicalDamageText(t),[GameFormula2.魔法伤害]:(e,t)=>this.buildMagicDamageText(t),[GameFormula2.命中率]:(e,t)=>this.buildHitChanceText(t),[GameFormula2.暴击率]:(e,t)=>this.buildCritChanceText(t),[GameFormula3.成长公式]:(e,t)=>this.buildGrowthText(t)}}buildMaxText(e){return`max(${e.map(n=>n.getFormulaTextValue()).join(",")})`}buildMinText(e){return`min(${e.map(n=>n.getFormulaTextValue()).join(",")})`}buildPowerText(e){return e.length<2?"参数不匹配,请输入[值,值]":`pow(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildRandomRangeText(e){if(e.length<2)return"参数不匹配,请输入[最小值,最大值]";const t=e[0].getFormulaTextValue();return`random()*(${e[1].getFormulaTextValue()}-${t})+${t}`}buildDivisionText(e){return e.length<2?"参数不匹配,请输入[值,值]":`(${e[0].getFormulaTextValue()})/(${e[1].getFormulaTextValue()})`}buildDivisionSumText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),n=e[1].getFormulaTextValue();return`${t}/(${t}+${n})`}buildDivisionDiffText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),n=e[1].getFormulaTextValue();return`${t}/(${n}-${t})`}buildWeightedText(e){if(e.length%2!==0)return"参数不匹配,请输入[值,权重]";const t=[];for(let n=0;n<e.length;n+=2)t.push(`[值:${e[n].getFormulaTextValue()},权重:${e[n+1].getFormulaTextValue()}]`);return t.join(",")}buildAttackDefenseText(e,t){return e.length<2?"参数不匹配,请输入[攻击,防御]":`${e[0].getFormulaTextValue()}${t}${e[1].getFormulaTextValue()}`}buildComplexAttackText(e,t){if(e.length<2)return"参数不匹配,请输入[攻击,防御]";const n=e[0].getFormulaTextValue(),r=e[1].getFormulaTextValue();switch(t){case 1:return`${n}*${n}/(${n}+${r})`;case 2:return`(${n}-${r})*(${n}/${r})`;case 3:return`${n}*${n}/${r}`;default:return""}}buildAtan2Text(e){return e.length<2?"参数不匹配,请输入[值,值]":`atan2(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildIfText(e,t){if(e.length<4)return"参数不匹配,请输入[值,值,值,值]";const[n,r,o,s]=e.map(u=>u.getFormulaTextValue());return`if(${n}${t}${r}){return ${o}}else{return ${s}}`}buildForLoopText(e){if(e.length<4)return"参数不匹配,请输入[初始等级,当前等级,间隔值,初始值]";const[t,n,r,o]=e.map(s=>s.getFormulaTextValue());return`for(var i=${t};i<=${n};i++){if(i%${r}==1){a++}c+=a+${o}}`}buildArrayAccessText(e){return e.length<2?"参数不匹配,请输入下标和数组":`[${e[0].getFormulaTextValue()}]`}buildAlgorithmText(e,t){const n=t==="mix"?3:4,r=t==="mix"?"[值1,值2,混合比例]":"[x1,y1,x2,y2]";if(e.length<n)return`参数不匹配,请输入${r}`;const o=e.slice(0,n).map(s=>s.getFormulaTextValue()).join(",");return`${t}(${o})`}buildMixText(e){return e.length<3?"参数不匹配,请输入[值1,值2,混合比例]":`mix(${e.slice(0,3).map(n=>n.getFormulaTextValue()).join(",")})`}buildBattleFormulaText(e){if(e.length<3)return"参数不匹配,请输入[攻击,防御,技能系数]";const[t,n,r]=e.map(o=>o.getFormulaTextValue());return`${t}*${r}*(1-(1/(1+((${t}*${r})/(5*${n})))))`}buildCharacterHealthText(e){if(e.length<4)return"参数不匹配,请输入[基础生命,等级,职业系数A,职业系数B]";const[t,n,r,o]=e.map(s=>s.getFormulaTextValue());return`${t}+${r}*${n}+${o}*(1+${n})*${n}/2`}buildMeleeAttackText(e){if(e.length<5)return"参数不匹配,请输入[力量,灵巧,幸运,等级,职业攻击系数]";const[t,n,r,o,s]=e.map(u=>u.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${n}/5+${r}/5+${s}*${o}`}buildRangedAttackText(e){if(e.length<5)return"参数不匹配,请输入[灵巧,力量,幸运,等级,职业攻击系数]";const[t,n,r,o,s]=e.map(u=>u.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${n}/5+${r}/5+${s}*${o}`}buildMageAttackText(e){if(e.length<1)return"参数不匹配,请输入[力量]";const t=e[0].getFormulaTextValue();return`${t}*2+pow(${t}/10,2)`}buildPhysicalDamageText(e){if(e.length<2)return"参数不匹配,请输入[物攻,物防]";const[t,n]=e.map(r=>r.getFormulaTextValue());return`${t}*(4000+${n})/(4000+(${n}*10))`}buildMagicDamageText(e){if(e.length<2)return"参数不匹配,请输入[魔攻,魔防]";const[t,n]=e.map(r=>r.getFormulaTextValue());return`${t}*(1000+${n})/(1000+(${n}*10))`}buildHitChanceText(e){if(e.length<2)return"参数不匹配,请输入[命中,闪避]";const[t,n]=e.map(r=>r.getFormulaTextValue());return`(${t}-${n}+80)/100`}buildCritChanceText(e){if(e.length<2)return"参数不匹配,请输入[暴击,抗暴]";const[t,n]=e.map(r=>r.getFormulaTextValue());return`(${t}-${n})/100`}buildGrowthText(e){if(e.length<2)return"参数不匹配,请输入[等级,属性成长值]";const[t,n]=e.map(r=>r.getFormulaTextValue());return`(${t}-1)*${n}`}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){return this.formulaTextCharacter}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}}class SymbolBody extends BasicBody{constructor(){super();l(this,"operator",null);l(this,"type","SymbolBody");l(this,"isFunctionId",1);l(this,"funcType",0);l(this,"constructorName","SymbolBody")}copy(){var t=new fx.SymbolBody;return t.operator=this.operator,t.isFunctionId=this.isFunctionId,t.tree=this.tree,t.parent=this.parent,t.value=this.value,t.isWeight=this.isWeight,t.isBindingOperation=this.isBindingOperation,t.isBindingFormula=this.isBindingFormula,t.formulaTextValue=this.formulaTextValue,t.formulaTextCharacter=this.formulaTextCharacter,t.operationalLogicText=this.operationalLogicText,t.cacheElementValue=this.cacheElementValue,t}setFunctionId(t){this.isFunctionId=t}getRunFunctionId(){var t=this.getFunctionLength();return this.isFunctionId++,this.isFunctionId>t&&(this.isFunctionId=1),this.isFunctionId}getFunctionLength(){for(var t=0,n=0;n<this.tree.length;n++)this.tree[n].isFunction&&t++;return t}getFunction(t){for(var n=0,r=0;r<this.tree.length;r++)if(this.tree[r].isFunction&&(n++,n==t))return this.tree[r];return null}getValue(){if((this.operator=="fx"||this.operator=="=")&&this.getFunctionLength()>0){const n=this.getFunction(this.isFunctionId);return n?this.value=this.returnFunc(getCatchValue(n)):this.value=null,this.value}else{this.value=null,this.operationalLogicText="";for(var t=0;t<this.tree.length;t++)t<this.tree.length-1?this.operationalLogicText+=Number(getCatchValue(this.tree[t]))+(this.operator||""):this.operationalLogicText+="("+Number(getCatchValue(this.tree[t]))+")";this.value=fx.eval(this.operationalLogicText)}return isNaN(this.value)?(this.value=this.returnFunc(this.value),this.value):(this.value=this.returnFunc(Number(this.value)),this.value)}getFormulaTextCharacter(){if(this.operator=="="&&this.getFunctionLength()>0){const o=this.getFunction(this.isFunctionId);o?this.formulaTextCharacter="("+o.getFormulaTextCharacter()+")":this.formulaTextCharacter=""}else{this.formulaTextCharacter="";for(var t=0;t<this.tree.length;t++)if(t<this.tree.length-1)this.formulaTextCharacter+="("+this.tree[t].getFormulaTextCharacter()+")"+(this.operator||"");else{var n=this.tree[t].getFormulaTextCharacter();n.indexOf("+")==-1&&n.indexOf("-")==-1&&n.indexOf("*")==-1&&n.indexOf("/")==-1&&n.indexOf("%")==-1&&n.indexOf(">")==-1&&n.indexOf(">=")==-1&&n.indexOf("<")==-1&&n.indexOf("<=")==-1&&n.indexOf("==")==-1?this.formulaTextCharacter+=n:this.formulaTextCharacter+="("+n+")"}}var r=this.formulaTextCharacter;return this.funcType!=0&&(r=this.getFormulaTextCharacterBody()),r}getFormulaTextValue(){if(this.funcType==0){if(this.operator=="="&&this.getFunctionLength()>0){const r=this.getFunction(this.isFunctionId);r?this.formulaTextValue="("+r.getFormulaTextValue()+")":this.formulaTextValue=""}else{this.formulaTextValue="";for(var t=0;t<this.tree.length;t++){var n=this.tree[t].getFormulaTextValue();t<this.tree.length-1?this.formulaTextValue+="("+n+")"+(this.operator||""):n.indexOf("+")==-1&&n.indexOf("-")==-1&&n.indexOf("*")==-1&&n.indexOf("/")==-1&&n.indexOf("%")==-1&&n.indexOf(">")==-1&&n.indexOf(">=")==-1&&n.indexOf("<")==-1&&n.indexOf("<=")==-1&&n.indexOf("==")==-1?this.formulaTextValue+=n:this.formulaTextValue+="("+n+")"}}return this.formulaTextValue}else return this.getFormulaTextValueBody()}dispose(){for(var t=0;t<this.tree.length;t++)this.tree[t].dispose()}}class OperationBody extends BasicBody{constructor(){super();l(this,"type","OperationBody");l(this,"constructorName","OperationBody");l(this,"isFunction",!1)}}class FormulaData{constructor(e,t,n){l(this,"name");l(this,"x");l(this,"y");l(this,"body",null);l(this,"type","Formula");l(this,"cacheTargetStoragePool",null);l(this,"cacheTargetFolder",null);l(this,"constructorName","FormulaData");l(this,"id",0);this.name=e,this.x=t,this.y=n,this.cacheTargetStoragePool=fx.targetStoragePool,this.cacheTargetFolder=fx.targetFolder.formulaTree,this.cacheTargetStoragePool.push(this),this.cacheTargetFolder.push(this),this.id=++EventManager.IDINDEX}getValue(){return this.body!=null?getCatchValue(this.body):0}dispose(){let e=this.cacheTargetStoragePool.indexOf(this);e>=0&&this.cacheTargetStoragePool.splice(e,1),e=this.cacheTargetFolder.indexOf(this),this.cacheTargetFolder.splice(e,1)}}class Player{constructor(){l(this,"name","");l(this,"hp",0);l(this,"maxHp",0);l(this,"maxShield",0);l(this,"shield",0);l(this,"enemyBody",null);l(this,"battlePool",[]);l(this,"valist",[]);l(this,"lflist",[]);l(this,"brlist",[]);l(this,"instantiation",null);l(this,"playerData",null);l(this,"folder",null);l(this,"comboxMaxHp","未设置血量公式");l(this,"combBoxAttack","未设置攻击公式");l(this,"underAttackName","");l(this,"shieldRuptureName","");l(this,"isShieldDetection",!1);l(this,"dieName","");l(this,"isDie",!1);l(this,"delayCustomList",[]);l(this,"callCenter",null);l(this,"tagArray",[]);l(this,"id",0);l(this,"constructorName","Player");l(this,"attackNum",0);l(this,"level",1);l(this,"levelVar","");l(this,"maxLEvel",100);l(this,"exp",0);l(this,"expName","");l(this,"levelUpConfig",{});l(this,"parameterInfoArray",[]);this.name="",this.hp=0,this.maxHp=0,this.maxShield=0,this.shield=0,this.enemyBody=null,this.level=1,this.levelVar="",this.battlePool=[],this.valist=[],this.lflist=[],this.brlist=[],this.instantiation=null,this.playerData=null,this.updatePlayerData(),this.comboxMaxHp="未设置血量公式",this.combBoxAttack="未设置攻击公式",this.underAttackName="",this.shieldRuptureName="",this.isShieldDetection=!1,this.dieName="",this.isDie=!1,this.delayCustomList=[],this.callCenter=new CallCenter,this.callCenter.addEventListener(EventManager.UP_DATA_PLAYER,this.upDataPlayerFunction,null,this),this.tagArray=[],this.id=++EventManager.IDINDEX,this.constructorName="Player",this.attackNum=0}resetTag(){this.tagArray=[]}gesetTagPopulation(e){let t=0;for(let n=0;n<this.tagArray.length;n++)this.tagArray[n].name==e&&t++;return t}gesetTagAll(){return this.tagArray}addTag(e){this.tagArray.push({name:e})}upDataPlayerFunction(e){this.updatePlayerData()}updatePlayerData(){fx.player=this,this.attackNum=0,this.playerData=this.createPlayer()}recursionSet(e,t){fx.player=this;for(let n=0;n<e.length;n++)e[n]instanceof VariableValue?e[n].enemyFlag&&(t==null?e[n].setEnemyBody(null):e[n].setEnemyBody(t.getPropertyObject(e[n].source.absoluteAddress))):this.recursionSet(e[n].tree,t)}getFormula(e){fx.player=this,fx.clearCacheRecursion(this.folder);let t=0;for(let n=0;n<this.playerData.formulaTree.length;n++)if(this.playerData.formulaTree[n].name==e){t=this.playerData.formulaTree[n].body.getValue();break}for(let n=0;n<fx.stageStoragePool.length;n++)fx.stageStoragePool[n]instanceof FormulaData&&fx.stageStoragePool[n].name==e&&(t=fx.stageStoragePool[n].body.getValue());return t}delay(e,t,n,r){const o=e+"次数";this[""+e]==null&&(this[""+e]=0,this.delayCustomList.push(""+e)),this[""+o]==null&&(this[""+o]=0,this.delayCustomList.push(""+o)),this[""+e]++,this[""+e]>=t&&Number(this[""+o])<=Number(n)+1&&(this[""+e]=0,this[""+o]++,r())}hit(e,t,n){this.instantiation!=null}attack(e,t){this.attackNum++,fx.player=this,fx.clearCacheRecursion(this.folder),fx.isCrit=!1;let n=0,r=0;for(let o=0;o<this.playerData.formulaTree.length;o++)if(this.playerData.formulaTree[o].name==e){fx.enemyBody=t,this.enemyBody=t,n=this.playerData.formulaTree[o].body.getValue();const s=t.isDie;t.getShield()!=0?t.minusShield(n):t.minusHp(n),!s&&t.isDie&&r++,fx.enemyBody=null;break}for(let o=0;o<fx.stageStoragePool.length;o++)if(fx.stageStoragePool[o]instanceof FormulaData&&fx.stageStoragePool[o].name==e){fx.enemyBody=t,this.enemyBody=t,n=fx.stageStoragePool[o].body.getValue();const s=t.isDie;t.getShield()!=0?t.minusShield(n):t.minusHp(n),!s&&t.isDie&&r++,fx.enemyBody=null}return r>0&&this.onEnmeyKilled(r),[n,fx.isCrit]}getNeedExp(){return 1}onEnmeyKilled(e){this.exp+=e,this.checkUpdateLevel()}checkUpdateLevel(){const e=this.getNeedExp();this.exp>=e&&this.level<this.maxLEvel&&(this.level++,this.exp=0,fx.Call.send(EventManager.PLAYER_INSTANCE_LEVEL_UP,[this.id,this.level,this.exp]))}setMaxShield(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxShield=0,this.shield=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxShield=this.playerData.formulaTree[t].body.getValue(),this.shield=this.maxShield;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxShield=fx.stageStoragePool[t].body.getValue(),this.shield=this.maxShield);return e=="无"&&(this.maxShield=this.shield=0),this.isShieldDetection=!1,this.maxShield}setMaxHp(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxHp=0,this.hp=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxHp=this.playerData.formulaTree[t].body.getValue(),this.hp=this.maxHp;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxHp=fx.stageStoragePool[t].body.getValue(),this.hp=this.maxHp);e=="无"&&(this.maxHp=this.hp=0),this.isDie=!1;for(let t=0;t<this.delayCustomList.length;t++)this[this.delayCustomList[t]]=null;return this.maxHp}getMaxHp(){return this.maxHp}getMaxShield(){return this.maxShield}getShield(){return this.shield}getHp(){return this.hp}setHp(e){this.hp=e}setShield(e){this.shield=e}underAttack(){this.getFormula(this.underAttackName)}setshieldRupture(e){this.shieldRuptureName=e}setUnderAttack(e){this.underAttackName=e}shieldRupture(){this.getFormula(this.shieldRuptureName),this.isShieldDetection=!0}minusShield(e){return this.shield-=e,this.shield<=0&&this.isShieldDetection==!1&&(this.shield=0,this.shieldRupture()),this.underAttack(),this.shield}setDie(e){this.dieName=e}die(){this.getFormula(this.dieName),this.isDie=!0}minusHp(e){return this.hp-=e,this.hp<=0&&this.isDie==!1&&(this.hp=0,this.die()),this.underAttack(),this.hp}getBillboard(){fx.player=this;const e=[];return fx.recursionGetBillboard(e,this.playerData),e.length==0?fx.billBoardList:e}getPropertyObject(e,t){return fx.player=this,fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t)}setProperty(e,t){fx.player=this;const n=this.getPropertyObject(e);return n!=null?n.setValue(t):console.log("没有找到属性"),t}getProperty(e,t){return fx.player=this,fx.clearCache(),this.getPropertyObject(e)!=null?fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t).getValue():(console.log("没有找到属性"),0)}dispose(){this.callCenter.dispose(),this.playerData.dispose(),this.name="",this.hp=0,this.maxHp=0,this.playerData=null,this.callCenter=null,this.tagArray=[],this.id=0,this.constructorName="",this.attackNum=0}clearCache(){fx.player=this,fx.clearCacheRecursion(this.folder)}createPlayer(){this.attackNum=0,fx.editBody=null,fx.selectBody=null,fx.isBodyView=!1,this.folder=new fx.Folder;const e=[];fx.addLibraryBody(e,fx.targetFolder.tree);const t=e;return fx.targetFolder=this.folder,fx.createLibraryBody(t,!0),fx.parseLibraryBody(t,!0),fx.recursionSyncBody(fx.targetFolder.tree),fx.editBody=null,fx.selectBody=null,fx.targetStoragePool=fx.stageStoragePool,fx.targetFolder=fx.sceneFolder,fx.isBodyView=!0,this.valist=[],this.lflist=[],this.brlist=[],fx.recursiveDataReading(this.folder,this.valist,this.lflist,this.brlist),this.folder}recoveryAttribute(){for(let e=0;e<this.valist.length;e++)this.setProperty(this.valist[e].absoluteAddress,Number(this.valist[e].value))}setParameterInfoArray(e){this.parameterInfoArray=e}getParameterInfoArray(){return this.parameterInfoArray}findParameterInfoByName(e){return this.parameterInfoArray.find(t=>t.parameterInfoname===e)||null}updateParameterValue(e,t,n){const r=this.findParameterInfoByName(e);if(!r)return!1;for(const o of r.parameterInfoArray)for(const s of o.parameter)if(s.path===t)return s.value=n,!0;return!1}getParameterValue(e,t){const n=this.findParameterInfoByName(e);if(!n)return null;for(const r of n.parameterInfoArray)for(const o of r.parameter)if(o.path===t)return o.value;return null}changeLevelAndOccupation(e,t,n={levelPath:"等级",occupationPath:"职业"}){const r=this.findParameterInfoByName(this.name);if(!r){console.warn(`未找到玩家 "${this.name}" 的参数信息`);return}for(const o of r.parameterInfoArray)for(const s of o.parameter)s.path===n.levelPath?s.value=e:s.path===n.occupationPath&&(s.value=t);this.level=e,this.gameManualOverrideParameter(r)}gameManualOverrideParameter(e){const t=this.getBillboard();e.parameterInfoArray.forEach(n=>{n&&t.forEach(r=>{n.name===r.name&&n.parameter.forEach(o=>{const s=o.path;r.metadataArray.forEach(u=>{const c=[];if(fx.getStepData(u.body.source,c),c.toString()===s){const m=u.body.getValue(),h=Number(o.value);m!==h&&u.body.setGlobalValue(h)}})})})})}}class BillboardLayer{constructor(e){l(this,"name","");l(this,"operationArray",[]);l(this,"metadataArray",[]);l(this,"id",0);l(this,"monitored",!0);l(this,"constructorName","BillboardLayer");this.name=e,this.id=++EventManager.IDINDEX}dispose(){this.name=null,this.operationArray=null,this.metadataArray=null,this.monitored=null}pushOperationLayer(){if(fx.clickBody!=null&&fx.clickBody.type==NodeType.CalculationLayer){const e=new fx.OperationLayerData(fx.clickBody);this.operationArray.push(e)}fx.clickBody=null}pushMetadata(e,t,n,r,o){if(fx.clickBody!=null&&fx.clickBody instanceof fx.VariableValue&&fx.clickBody.type!=5){const s=new fx.MetadataData(fx.clickBody);s.type=e,s.presentValue=getCatchValue(s.body),s.minValue=t,s.maxValue=n,s.intervalValue=r,s.list=o&&o.length?o.map(u=>({value:Number(u.value),name:u.name})):[],this.metadataArray.push(s)}fx.clickBody=null}}class ChartsLayer{constructor(e){l(this,"name");l(this,"operationArray",[]);l(this,"metadata",null);l(this,"metadataArray",[]);l(this,"minValue",1);l(this,"maxValue",1);l(this,"intervalValue",1);l(this,"constructorName","ChartsLayer");l(this,"id");this.name=e,this.id=++EventManager.IDINDEX}addMetadataData(){fx.clickBody!=null&&(this.metadata=fx.clickBody.copy(),this.metadataArray[0]=this.metadata)}dispose(){}}class Bookmark{constructor(){l(this,"id",0);l(this,"x",0);l(this,"y",0);l(this,"width",512);l(this,"height",512);l(this,"text","标签");l(this,"view",null);l(this,"type","Bookmark");l(this,"bookmarkView",null)}}class MetadataData{constructor(e){l(this,"body");l(this,"view",null);l(this,"type",0);l(this,"presentValue",0);l(this,"minValue",0);l(this,"maxValue",0);l(this,"intervalValue",0);l(this,"list");this.body=e.copy()}}class SheetData{constructor(e){l(this,"originData");this.originData=e}setData(e){this.originData=e}getValue(e,t,n){var h,v,p;if(!(this!=null&&this.originData)||typeof e>"u"||typeof t>"u"||typeof n>"u")return 0;const s=this.originData.sheets.find(f=>f.name===e),u=s.uniqueInfo.find(f=>f.row===t&&f.col===n),c=(h=s==null?void 0:s.data)==null?void 0:h.get(`${t},${n}`),d=c==null?void 0:c.cellData;let m=d==null?void 0:d.v;return d!=null&&d.type&&(m=(v=c==null?void 0:c.source)!=null&&v.getValue?(p=c.source)==null?void 0:p.getValue():0),(u==null?void 0:u.value)||m||0}}class OperationLayerData{constructor(e){l(this,"body");l(this,"view",null);this.body=e.copy()}}class Message{constructor(){l(this,"userData",null);l(this,"type",null)}}const globalThis_$1=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_$1.target=null;class A{test(){try{console.log("console A")}catch(e){console.error("Error in class A test:",e)}}}class B extends A{constructor(){super()}test(){try{console.log("console B")}catch(e){console.error("Error in class B test:",e)}}}const a=class a{static recursiveDataReading(e,t,n,r){try{if(!e||!e.tree||!Array.isArray(e.tree))throw new Error("Invalid object structure for recursive reading");for(let o=0;o<e.tree.length;o++){const s=e.tree[o];s!=null&&(s.isFolder?this.recursiveDataReading(s,t,n,r):s.type==NodeType.Variable?t.push(s):s.type==NodeType.CalculationLayer?n.push(s):s instanceof a.BillboardLayer&&r.push(s))}}catch(o){console.error("Error in recursive data reading:",o)}}};l(a,"b",new B),l(a,"code",!1),l(a,"isNumber",function(e){try{return!isNaN(Number(e))&&isFinite(Number(e))}catch(t){return console.error("Error checking if value is number:",t),!1}}),l(a,"mix",function(e,t,n){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(n))throw new Error("Invalid parameters for mix function");return e*(1-n)+t*n}catch(r){return console.error("Error in mix function:",r),0}}),l(a,"cross",function(e,t,n,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(n)||!a.isNumber(r))throw new Error("Invalid parameters for cross function");return e*n-t*r}catch(o){return console.error("Error in cross function:",o),0}}),l(a,"dot",function(e,t,n,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(n)||!a.isNumber(r))throw new Error("Invalid parameters for dot function");return e*n+t*r}catch(o){return console.error("Error in dot function:",o),0}}),l(a,"distance",function(e,t,n,r){try{if(!a.isNumber(e)||!a.isNumber(t)||!a.isNumber(n)||!a.isNumber(r))throw new Error("Invalid parameters for distance function");const o=Math.abs(e-n),s=Math.abs(t-r);return a.length(o,s)}catch(o){return console.error("Error in distance function:",o),0}}),l(a,"length",function(e,t){try{if(!a.isNumber(e)||!a.isNumber(t))throw new Error("Invalid parameters for length function");return Math.sqrt(e*e+t*t)}catch(n){return console.error("Error in length function:",n),0}}),l(a,"billBoardList",[]),l(a,"functionAddIndex",0),l(a,"visualVersionCompatibility",!1),l(a,"singletonInstance",null),l(a,"isStart",!1),l(a,"FXCentre",FXCentre),l(a,"NodeType",NodeType),l(a,"Folder",Folder),l(a,"Eve",EventManager),l(a,"CallCenter",CallCenter),l(a,"MessageList",MessageList),l(a,"VariableValue",VariableValue),l(a,"Call",Call),l(a,"SymbolBody",SymbolBody),l(a,"BasicBody",BasicBody),l(a,"OperationBody",OperationBody),l(a,"Player",Player),l(a,"BillboardLayer",BillboardLayer),l(a,"ChartsLayer",ChartsLayer),l(a,"Bookmark",Bookmark),l(a,"FormulaData",FormulaData),l(a,"MetadataData",MetadataData),l(a,"SheetData",SheetData),l(a,"OperationLayerData",OperationLayerData),l(a,"Message",Message),l(a,"noCache",!1),l(a,"enemyBody",null),l(a,"sceneFolder",null),l(a,"targetFolder",null),l(a,"isFolderDuplicationOfName",!1),l(a,"isBillboardLayerView",!0),l(a,"isBodyView",!0),l(a,"isGlobalOperations",!1),l(a,"isDragBody",!1),l(a,"stageMaskValue",{}),l(a,"stageGroup",null),l(a,"clickBody",null),l(a,"selectCellBody",null),l(a,"editBody",null),l(a,"selectBody",null),l(a,"stageStoragePool",[]),l(a,"targetStoragePool",a.stageStoragePool),l(a,"player",null),l(a,"isCrit",!1),l(a,"distribute",function(e,t){const n=t.reduce((r,o)=>r+o,0);return t.map(r=>e*r/n)}),l(a,"partitionCurve",function(e,t,n,r,o,s){const u=[],c=[];let d=o,m=s;d==null&&(d=.382),m==null&&(m=.618);let h=0;for(let v=1;v<=t;v++){const p=Math.pow(t,n),y=Math.pow(v,n)/p,g=v*(1e4*d)/t+y*(1e4*m);u.push(g),h+=g}for(let v=0;v<u.length;v++)if(r==null)c.push(u[v]/h*e);else switch(r){case 0:c.push(u[v]/h*e);break;case 1:c.push(Math.floor(u[v]/h*e));break;case 2:c.push(Math.floor(u[v]/h*e));break}return c}),l(a,"eval",function(e){return a.evaluateExpression(e)}),l(a,"recursionLibraryBody",function(e,t,n){if(t.tree==null)return null;for(let r=0;r<t.tree.length;r++){if(t.tree[r].absoluteAddress==n){e.push(t.tree[r]);return}a.recursionLibraryBody(e,t.tree[r],n)}return null}),l(a,"double",function(e,t){switch(t){case 0:return Math.round(e*1)/1;case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4;case 5:return Math.round(e*1e5)/1e5;case 6:return Math.round(e*1e6)/1e6;case 7:return Math.round(e*1e7)/1e7}return 0}),l(a,"getLibraryBody",function(e,t,n){for(let r=0;r<t.length;r++){if(t[r].absoluteAddress==null&&(t[r].absoluteAddress=a.getAbsoluteAddress(t[r])),t[r].absoluteAddress==n){e.push(t[r]);return}t[r].isFolder&&a.getLibraryBody(e,t[r].tree,n)}}),l(a,"mapToJSON",function(e){return e?JSON.stringify([...e].reduce((t,[n,r])=>{const o={...r},s=o.source;if(s){const u=a.createVarData(s.TID,s.name,s.value,s.type,s.macros,s.operator,s.enemyFlag,s.source,s.tag,s.statistics,s.upDateValue,s.demoteValue,s.funcType,s.isLogicalOpen,s.isDragging,s.currentStep,s.snNo,s.minValue,s.maxValue,s.step,s.logicalChildArray,s.selectedOutputInfo);o.source=u}return t[n]=o,t},{})):"{}"}),l(a,"addLibraryBody",function(e,t){var o;for(let s=0;s<t.length;s++){const u=t[s];let c=(o=u.sheetData)==null?void 0:o.originData;if(c&&(c={...c},c.sheets=[...c.sheets.map(d=>({...d,data:a.mapToJSON(d.data)}))]),u instanceof a.VariableValue){var n=a.createOperationLayerData(u.name,u.type,u.value,u,u.tag,u.isSystemShow,u.sheetData?JSON.stringify(c):null,u.childCell);n.id=u.id,e.push(n),a.saveBody(n.operationArray,a.seekSource(u.childBodyArray))}if(u instanceof a.Folder){var n=a.createFolderData(u.name,u.isFolder,u);n.id=u.id,e.push(n),a.addLibraryBody(n.operationArray,u.tree)}if(a.isBillboardLayerView){if(u instanceof a.BillboardLayer){var n=a.createBillboarData(u.name,u,u.monitored);n.id=u.id,e.push(n);for(var r=0;r<u.operationArray.length;r++){const m=u.operationArray[r],h=a.createOperationLayerData(m.body.name,m.body.type,m.body.value,m.body.source,m.body.tag,m.body.isSystemShow,null,null);h.id=m.body.id,n.operationArray.push(h)}for(var r=0;r<u.metadataArray.length;r++){const h=u.metadataArray[r],v=a.createBillboarMetadataData(h.body.name,h.body.type,h.body.value,h.body.source,h);v.id=h.body.id,n.metadataArray.push(v)}}if(u instanceof a.ChartsLayer){var n=a.createChartData(u);n.id=u.id,e.push(n)}}}}),l(a,"parseLibraryBody",function(e,t){for(let r=0;r<e.length;r++){const o=e[r];if(o.type==NodeType.CalculationLayer){var n=[];a.getLibraryBody(n,a.targetFolder.tree,o.site),a.editBody=n[0],a.selectBody=a.editBody,a.targetStoragePool=a.editBody.childBodyArray,a.editBody.isSystemShow=o.isSystemShow,a.parseStageBody(o.operationArray)}else if(o.type==0||o.type==NodeType.Variable||o.type==2||o.type==3){var n=[];a.getLibraryBody(n,a.targetFolder.tree,o.site),a.editBody=n[0],a.selectBody=a.editBody,a.targetStoragePool=a.stageStoragePool,a.parseStageBody(o.operationArray)}else if(o.isFile==!0){var n=[];a.getLibraryBody(n,a.targetFolder.tree,o.site),a.editBody=n[0];const u=n[0];for(let c=0;c<o.operationArray.length;c++){const d=o.operationArray[c];if(d.type==NodeType.CalculationLayer){var n=[];a.getLibraryBody(n,a.targetFolder.tree,d.site),a.editBody=n[0],a.selectBody=n[0],a.targetStoragePool=n[0].childBodyArray,a.parseStageBody(d.operationArray),a.editBody=u,a.editBody.isSystemShow=d.isSystemShow}else d.isBoard==!0?(a.selectBody=a.editBody,d.index=c,a.Call.send(a.Eve.SHIFT_ADD_BOARD,d,null)):d.isXlsx==!0&&(a.selectBody=a.editBody,d.index=c,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,d,null));if(d.isFile==!0){var n=[];a.getLibraryBody(n,a.targetFolder.tree,d.site),a.editBody=n[0],a.parseLibraryBody(d.operationArray,!1)}}a.editBody=null}else o.isBoard==!0?(a.selectBody=a.editBody,a.billBoardList.push(o),a.Call.send(a.Eve.SHIFT_ADD_BOARD,o,null)):o.isXlsx==!0&&(a.selectBody=a.editBody,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,o,null));t&&(a.selectBody=null)}}),l(a,"createLibraryBody",function(e,t,n,r){for(let c=0;c<e.length;c++){const d=e[c];if(d.isFile==!0){var o=new a.Folder(d.name);a.Call.send(a.Eve.CREATE_FILE_DATA,o,null),r!=null?(a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,r],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,r],null)):(a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,a.selectBody],null)),a.selectBody=o,a.selectBody.absoluteAddress=d.site;for(let m=0;m<d.operationArray.length;m++){const h=d.operationArray[m];if(h.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(h.name,null,5),a.editBody.tag=h.name.tag,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray;else if(h.type==0||h.type==NodeType.Variable||h.type==2||h.type==3){var s=h.name+"="+h.value,u=new a.VariableValue(s.split("=")[0],s.split("=")[1],1);h.type==NodeType.Variable&&(u.isAI=n||!1),a.editBody=u,a.editBody.tag=h.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,u,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray}else if(h.type==NodeType.Sheet){var s=h.name,u=new a.VariableValue(s.split("=")[0],void 0,h.type);u.selectedOutputInfo=h!=null&&h.selectedOutputInfo?JSON.parse(h==null?void 0:h.selectedOutputInfo):null;const f=typeof h.sheetData=="string"?JSON.parse(h.sheetData):h.sheetData;f!=null&&f.sheets&&(f.sheets=f.sheets.map(y=>{const g=JSON.parse(y.data);return Object.values(g).forEach(T=>{if(T!=null&&T.source){const D=T.source,b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(D));const F=b[0];T.source=F.copy()}}),{...y,data:new Map(Object.entries(g))}})),u.setSheetData(f),u.childCell=h.childCell,a.editBody=u,a.editBody.tag=h.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray}if(h.isFile==!0){var o=new a.Folder(h.name);a.Call.send(a.Eve.CREATE_FILE_DATA,o,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[o,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[o,a.selectBody],null),a.selectBody=o,a.selectBody.absoluteAddress=h.site,a.createLibraryBody(h.operationArray,!1,!1,o),a.selectBody=o.parentFolder}}a.selectBody=o.parentFolder}if(d.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(d.name,null,5),a.editBody.tag=d.tag,a.editBody.isSystemShow=d.isSystemShow,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray;else if(d.type==0||d.type==NodeType.Variable||d.type==2||d.type==3){var s=d.name+"="+d.value,u=new a.VariableValue(s.split("=")[0],s.split("=")[1],1);d.type==NodeType.Variable&&(u.isAI=n||!1),a.editBody=u,a.editBody.tag=d.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,u,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}else if(d.type==NodeType.Sheet){var s=d.name,u=new a.VariableValue(s.split("=")[0],void 0,d.type);u.selectedOutputInfo=d!=null&&d.selectedOutputInfo?JSON.parse(d==null?void 0:d.selectedOutputInfo):null;const v=typeof d.sheetData=="string"?JSON.parse(d.sheetData):d.sheetData;v!=null&&v.sheets&&(v.sheets=v.sheets.map(p=>{const f=JSON.parse(p.data);return Object.values(f).forEach(y=>{if(y!=null&&y.source){const g=y.source,T=[];a.getLibraryBody(T,a.targetFolder.tree,a.getAbsoluteAddress(g));const D=T[0];y.source=D.copy()}}),{...p,data:new Map(Object.entries(f))}})),u.setSheetData(v),u.childCell=d.childCell,a.editBody=u,a.editBody.tag=d.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}t&&(a.selectBody=null)}}),l(a,"getBody",function(e,t,n){const r=[];return a.recursionLibraryBody(r,e,t),n!=null&&r[0].body.setFunctionId(n),r[0]}),l(a,"evaluateExpression",function(e){const t=a.toRPN(e),n=[];for(const r of t)if(a.isNumber(r))n.push(Number(r));else{const o=n.pop(),s=n.pop();let u;if(s!==void 0&&o!==void 0)switch(r){case"+":u=s+o;break;case"-":u=s-o;break;case"*":u=s*o;break;case"/":u=s/o;break;case"%":u=s%o;break;case"^":u=Math.pow(s,o);break;case">":u=s>o;break;case"<":u=s<o;break;case">=":u=s>=o;break;case"<=":u=s<=o;break;case"==":u=s===o;break;case"!=":u=s!==o;break}n.push(u)}return n.pop()}),l(a,"toRPN",function(e){e=e+"",e=e.replace(/\s+/g,"");const t={"+":1,"-":1,"*":2,"/":2,"%":2,"^":3,">":4,"<":4,">=":4,"<=":4,"==":4,"!=":4},n=[],r=[];function o(m){n.push(m)}function s(){const m=r.pop();m&&o(m)}function u(m){return t.hasOwnProperty(m)}function c(m,h){return m==="-"&&h===0||m==="-"&&!a.isNumber(e[h-1])&&e[h-1]!==")"}for(let m=0;m<e.length;m++){const h=e[m];if(a.isNumber(h)||c(h,m)){let v=h,p=m+1;for(;p<e.length&&(a.isNumber(e[p])||e[p]===".");)v+=e[p],p++;o(v),m=p-1}else if(u(h)){for(var d=r[r.length-1];u(d)&&(t[h]<=t[d]&&h!=="^"||t[h]<t[d]&&h==="^");)s(),d=r[r.length-1];r.push(h)}else if(h==="(")r.push(h);else if(h===")"){for(var d=r[r.length-1];d!=="("&&d!==void 0;)s(),d=r[r.length-1];r.pop()}}for(;r.length>0;)s();return n}),l(a,"Rectangle",class{constructor(t,n){l(this,"width");l(this,"height");this.width=t,this.height=n}calculateArea(){return this.width*this.height}calculatePerimeter(){return 2*(this.width+this.height)}}),l(a,"recursionSyncBody",function(e){for(let t=0;t<e.length;t++)e[t].type==NodeType.CalculationLayer&&e[t].syncBody(),e[t].isFolder&&a.recursionSyncBody(e[t].tree)}),l(a,"clearCache",function(){a.clearCacheRecursion(a.sceneFolder)}),l(a,"clearCacheRecursion",function(e){for(let t=0;t<e.tree.length;t++){const n=e.tree[t];n.type==NodeType.CalculationLayer&&(n.cacheValue=null),n.isFolder==!0&&a.clearCacheRecursion(n)}}),l(a,"initDataBase",function(e){a.isBillboardLayerView=!1,new a.FXCentre,JSON.parse(e).stage.operationArray;const t=JSON.parse(e).library.operationArray;a.editBody=null,a.selectBody=null,a.createLibraryBody(t,!0),a.parseLibraryBody(t,!0)}),l(a,"parseAbsoluteAddress",function(e){return e.replace(/\./g,"")}),l(a,"recursionGetBillboard",function(e,t){if(t.tree==null)return null;for(let n=0;n<t.tree.length;n++)t.tree[n]instanceof a.BillboardLayer&&e.push(t.tree[n]),a.recursionGetBillboard(e,t.tree[n]);return null}),l(a,"saveBody",function(e,t){for(let u=0;u<t.length;u++){const c=t[u];if(c.type==NodeType.OperationBody){var n=0,r=0;c.view!=null&&(n=c.view.getX(),r=c.view.getY());const d=a.createBodyData(c.type,c.isFunction,c.isBindingOperation,n,r,c.isWeight,c.isAdvance,c.funcType);c.isBindingFormula&&(d.isFormula=!0,d.formulaName=c.formulaBody.name,d.formulaX=c.formulaBody.x,d.formulaY=c.formulaBody.y),d.id=c.id,e.push(d);for(var o=0;o<c.tree.length;o++){const m=c.tree[o],h=a.createVarData(m.TID,m.name,m.value,m.type,m.macros,m.operator,m.enemyFlag,m.source,m.tag,m.statistics,m.upDateValue,m.demoteValue,m.funcType,m.isLogicalOpen,m.isDragging,m.currentStep,m.snNo,m.minValue,m.maxValue,m.step,m.logicalChildArray,m.selectedOutputInfo);h.id=m.id,d.tree.push(h)}}else if(c.type==NodeType.SymbolBody){var n=0,r=0;c.view!=null&&(n=c.view.getX(),r=c.view.getY());const h=a.createSymbolData(c.type,c.operator,c.isFunctionId,c.isBindingOperation,n,r,c.isWeight,c.funcType);c.isBindingFormula&&(h.isFormula=!0,h.formulaName=c.formulaBody.name,h.formulaX=c.formulaBody.x,h.formulaY=c.formulaBody.y),h.id=c.id,e.push(h);for(var o=0;o<c.tree.length;o++){const p=c.tree[o];switch(p.type){case"OperationBody":var n=0,r=0;p.view!=null&&(n=p.view.getX(),r=p.view.getY());var s=a.createBodyData(p.type,p.isFunction,p.isBindingOperation,n,r,p.isWeight,p.isAdvance,p.funcType);s.id=p.id,h.tree.push(s);for(let g=0;g<p.tree.length;g++){const T=p.tree[g],D=a.createVarData(T.TID,T.name,T.value,T.type,T.macros,T.operator,T.enemyFlag,T.source,T.tag,T.statistics,T.upDateValue,T.demoteValue,T.funcType,T.isLogicalOpen,T.isDragging,T.currentStep,T.snNo,T.minValue,T.maxValue,T.step,T.logicalChildArray,T.selectedOutputInfo);D.id=T.id,s.tree.push(D)}break;case"SymbolBody":var n=0,r=0;p.view!=null&&(n=p.view.getX(),r=p.view.getY());var s=a.createSymbolData(p.type,p.operator,p.isFunctionId,p.isBindingOperation,n,r,p.isWeight,p.funcType);s.id=p.id,h.tree.push(s),a.recursionSeekBody(s.tree,p.tree);break}}}else if(c.type==NodeType.Bookmark){const d=a.createBookmarkData(c);d.id=c.id,e.push(d)}}}),l(a,"coordinateDetection",function(e){return e!=null?{x:e.getX(),y:e.getY()}:{x:0,y:0}}),l(a,"recursionSeekBody",function(e,t){for(let o=0;o<t.length;o++){const s=t[o];switch(s.type){case"OperationBody":var n=a.coordinateDetection(s.view),r=a.createBodyData(s.type,s.isFunction,s.isBindingOperation,n.x,n.y,s.isWeight,s.isAdvance,s.funcType);e.push(r);for(let u=0;u<s.tree.length;u++){const c=s.tree[u];r.tree.push(a.createVarData(c.TID,c.name,c.value,c.type,c.macros,c.operator,c.enemyFlag,c.source,c.tag,c.statistics,c.upDateValue,c.demoteValue,c.funcType,c.isLogicalOpen,c.isDragging,c.currentStep,c.snNo,c.minValue,c.maxValue,c.step,c.logicalChildArray,c.selectedOutputInfo))}break;case"SymbolBody":var n=a.coordinateDetection(s.view),r=a.createSymbolData(s.type,s.operator,s.isFunctionId,s.isBindingOperation,n.x,n.y,s.isWeight,s.funcType);e.push(r),a.recursionSeekBody(r.tree,s.tree);break}}}),l(a,"getAbsoluteAddress",function(e,t){if(t){var n=[];a.getStepData(e,n,t);for(var r="",o=0;o<n.length;o++)r+=n[o];return r}if(e.site!=null&&e.site!=null)return e.site;if(e.parentFolder==null)return e.source!=null?e.source.absoluteAddress:e.name;var n=[];a.getStepData(e,n,t);for(var r="",o=0;o<n.length;o++)r+=n[o];return r}),l(a,"copyHeadFun",function(e){return e.copyHead?!0:e.parentFolder!=null&&e.parentFolder.name!=null?a.copyHeadFun(e.parentFolder):!1}),l(a,"getStepData",function(e,t,n){t.unshift(e.name),e.parentFolder!=null&&e.parentFolder.name!=null&&a.getStepData(e.parentFolder,t,n)}),l(a,"getStepDataAll",function(e,t){t.unshift(e.name),e.parentFolder.name!=null&&a.getStepDataAll(e.parentFolder,t)}),l(a,"createVarData",function(e,t,n,r,o,s,u,c,d,m,h,v,p,f,y,g,T,D,b,F,V,x){const E={};return a.code,E.TID=e,E.name=t,E.value=n,E.type=r,E.macros=o,E.operator=s,E.enemy=u,E.tag=d,E.site=a.getAbsoluteAddress(c),E.statistics=m,E.upDateValue=h,E.demoteValue=v,E.funcType=p,E.isLogicalOpen=f,E.isDragging=y,E.currentStep=g,E.snNo=T,E.minValue=D,E.maxValue=b,E.step=F,E.logicalChildArray=[],E.selectedOutputInfo=typeof x=="object"?JSON.stringify(x):"",V&&V.length&&V.forEach(C=>{const I=a.createVarData(C.TID,C.name,C.value,C.type,C.macros,C.operator,C.enemyFlag,C.source,C.tag,C.statistics,C.upDateValue,C.demoteValue,C.funcType,C.isLogicalOpen,C.isDragging,C.currentStep,C.snNo,C.minValue,C.maxValue,C.step,C.logicalChildArray);E.logicalChildArray.push(I)}),E}),l(a,"createBodyData",function(e,t,n,r,o,s,u,c){const d={};return d.tree=[],d.type=e,d.isFunction=t,d.isBoundOutput=n,d.x=r,d.y=o,d.isWeight=s,d.isAdvance=u,d.funcType=c,d}),l(a,"createSymbolData",function(e,t,n,r,o,s,u,c){const d={};return d.tree=[],d.type=e,d.operator=t,d.isFunctionId=n,d.isBoundOutput=r,d.x=o,d.y=s,d.isWeight=u,d.funcType=c,d}),l(a,"createBookmarkData",function(e){const t={};return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.text=e.text,t.type=e.type,t}),l(a,"createChartData",function(e){const t={};if(t.name=e.name,t.minValue=e.minValue,t.maxValue=e.maxValue,t.intervalValue=e.intervalValue,t.operationlayer=[],t.metadataArray=[],t.isXlsx=!0,e.operationArray!=null)for(var n=0;n<e.operationArray.length;n++)t.operationlayer.push(a.getAbsoluteAddress(e.operationArray[n].source));(e.body!=null||e.metadata!=null)&&(t.metadata=a.getAbsoluteAddress(e.metadata.source));for(var n=0,r=e.metadataArray.length;n<r;n++){const s=e.metadataArray[n],u=s.source,c={site:a.getAbsoluteAddress(u)};s.minValue!=1&&(c.minValue=s.minValue),s.intervalValue!=1&&(c.intervalValue=s.intervalValue),t.metadataArray.push(c)}return t.site=a.getAbsoluteAddress(e),t}),l(a,"seekSource",function(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];if(r.parent==null){if(t.length==0)t.push(r);else for(let o=0;o<t.length;o++)if(t[o]!=r){t.push(r);break}}}return t}),l(a,"createBillboarMetadataData",function(e,t,n,r,o){const s={};return s.name=e,s.type=t,s.value=n,s.site=a.getAbsoluteAddress(r),s.componentType=o.type,s.componentValue=o.body.value,s.componentMinValue=o.minValue,s.componentMaxValue=o.maxValue,s.componentIntervalValue=o.intervalValue,s.list=o.list,s}),l(a,"createOperationLayerData",function(e,t,n,r,o,s,u,c){const d={};return d.name=e,d.type=t,d.value=n,d.site=a.getAbsoluteAddress(r),d.tag=o,d.operationArray=[],t===NodeType.Sheet&&u&&(d.sheetData=u,d.childCell=c),d.isSystemShow=s,d}),l(a,"createBillboarData",function(e,t,n){const r={};return r.name=e,r.site=a.getAbsoluteAddress(t),r.isBoard=!0,r.operationArray=[],r.metadataArray=[],r.monitored=n,r}),l(a,"createFolderData",function(e,t,n){const r={};return r.name=e,r.isFile=t,r.operationArray=[],r.site=a.getAbsoluteAddress(n),r}),l(a,"getBout",function(e){if(e.tree.length>1){if(e.tree[0].getValue()!=0&&e.tree[1].getValue()!=0&&Number(e.tree[0].getValue())>Number(e.tree[1].getValue())){let t=Number(e.tree[0].getValue()),n=0;for(let s=1;s<e.tree.length;s++)n+=Number(e.treeItem.getValue());let r=0,o=0;for(;t>=n;)o+=n,t-=n,r++;return[r,o/r]}return[0,0]}return[0,0]}),l(a,"copy",function(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=typeof e[n]=="object"?a.copy(e[n]):e[n]);return t}),l(a,"getIsBoundOutput",function(e,t){return t!=null?!1:e.isBoundOutput!=null?e.isBoundOutput:e.isBindingOperation}),l(a,"coordinate",function(e,t){let n=1;return a.visualVersionCompatibility&&(n=.5),e.view!=null?e.parent==null?[0,0]:[e.view.getX()*n,e.view.getY()*n]:[e.x*n,e.y*n]}),l(a,"parseStageBody",function(e,t,n,r){let o=null;for(let v=0;v<e.length;v++){const p=e[v];if(n==null&&p.parent!=null)return;if(p.type==NodeType.OperationBody||p.type=="运算体类"){var s;if(p.isFunction){s=a.createOperationBody(a.coordinate(e[v],n)[0],a.coordinate(e[v],n)[1],1,p.isWeight,p.isAdvance,p.funcType),s.isBindingOperation=a.getIsBoundOutput(e[v],n),a.operationBindBody(s),o==null&&(o=s);for(var u=0;u<p.tree.length;u++){const f=p.tree[u];if(f.type==NodeType.Macro){var c=new a.VariableValue(f.name,null,f.type);c.TID=f.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(s,c);y.setMacros(a.amendMacros(f)),y.enemyFlag=f.enemy,y.funcType=f.funcType,y.funcType==null&&(y.funcType=0),y.statistics=f.statistics,y.upDateValue=f.upDateValue,y.demoteValue=f.demoteValue,a.symbolicLink(y,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,f.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(f.type)){var c=new a.VariableValue(f.name,f.value,f.type);c.TID=f.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let g=a.createFunctionBody(s,c);g.enemyFlag=f.enemy,g.funcType=f.funcType,g.funcType==null&&(g.funcType=0),f.type==NodeType.Sheet&&(g.selectedOutputInfo=f.selectedOutputInfo?JSON.parse(f.selectedOutputInfo):""),g.statistics=f.statistics,g.upDateValue=f.upDateValue,g.demoteValue=f.demoteValue,g.isLogicalOpen=f.isLogicalOpen,g.isDragging=f.isDragging,g.snNo=f.snNo,g.logicalNumberList=f.logicalNumberList,g.currentStep=f.currentStep,g.snNo=f.snNo,g.minValue=f.minValue,g.maxValue=f.maxValue,g.step=f.step,g.logicalChildArray=[],f.logicalChildArray.forEach(T=>{const D=[];a.getLibraryBody(D,a.targetFolder.tree,a.getAbsoluteAddress(T));const F=D[0].copy();F.enemyFlag=f.enemy,F.funcType=f.funcType,F.funcType==null&&(F.funcType=0),F.statistics=f.statistics,F.upDateValue=f.upDateValue,F.demoteValue=f.demoteValue,g.logicalChildArray.push(F)}),a.symbolicLink(g,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,f.operator,t],null)}else{var d=[];r?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(f.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(f));let y=d[0],g=a.createVariableBody(s,y);g.enemyFlag=f.enemy,g.funcType=f.funcType,g.funcType==null&&(g.funcType=0),f.type==NodeType.Sheet&&(g.selectedOutputInfo=f.selectedOutputInfo?JSON.parse(f.selectedOutputInfo):""),g.statistics=f.statistics,g.upDateValue=f.upDateValue,g.demoteValue=f.demoteValue,a.symbolicLink(g,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,f.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else{s=a.createOperationBody(a.coordinate(e[v],n)[0],a.coordinate(e[v],n)[1],0,p.isWeight,p.isAdvance,p.funcType),s.isBindingOperation=a.getIsBoundOutput(e[v],n),a.operationBindBody(s),o==null&&(o=s);for(var u=0;u<p.tree.length;u++){const y=p.tree[u];if(y.type==NodeType.Macro){var c=new a.VariableValue(y.name,null,y.type);c.TID=y.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let T=a.createFunctionBody(s,c);T.setMacros(a.amendMacros(y)),T.enemyFlag=y.enemy,T.funcType=y.funcType,T.funcType==null&&(T.funcType=0),T.statistics=y.statistics,T.upDateValue=y.upDateValue,T.demoteValue=y.demoteValue,a.symbolicLink(T,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[T,y.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(y.type)){var c=new a.VariableValue(y.name,y.value,y.type);c.TID=y.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let T=a.createFunctionBody(s,c);T.enemyFlag=y.enemy,T.funcType=y.funcType,T.funcType==null&&(T.funcType=0),y.type==NodeType.Sheet&&(T.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),T.statistics=y.statistics,T.upDateValue=y.upDateValue,T.demoteValue=y.demoteValue,T.isLogicalOpen=y.isLogicalOpen,T.isDragging=y.isDragging,T.snNo=y.snNo,T.logicalNumberList=y.logicalNumberList,T.currentStep=y.currentStep,T.snNo=y.snNo,T.minValue=y.minValue,T.maxValue=y.maxValue,T.step=y.step,T.logicalChildArray=[],y.logicalChildArray.forEach(D=>{const b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(D));const V=b[0].copy();V.enemyFlag=y.enemy,V.funcType=y.funcType,V.funcType==null&&(V.funcType=0),V.statistics=y.statistics,V.upDateValue=y.upDateValue,V.demoteValue=y.demoteValue,T.logicalChildArray.push(V)}),a.symbolicLink(T,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[T,y.operator,t],null)}else{var d=[];r||y.source?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(y.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(y));let T=d[0],D=a.createVariableBody(s,T);D.enemyFlag=y.enemy,D.funcType=y.funcType,D.funcType==null&&(D.funcType=0),y.type==NodeType.Sheet&&(D.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),D.statistics=y.statistics,D.upDateValue=y.upDateValue,D.demoteValue=y.demoteValue,a.symbolicLink(D,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[D,y.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}if(p.isFormula){var m=new a.FormulaData(p.formulaName,p.formulaX,p.formulaY);m.body=s,m.body.isBindingFormula=!0,s.formulaBody=m,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[m,s.view,t],null)}}else if(p.type==NodeType.SymbolBody||p.type=="符号运算体类"){const f=a.createSymbolBody(null,null,p.operator,p.isFunctionId,p.isWeight,p.funcType);f.isBindingOperation=a.getIsBoundOutput(e[v],n),a.operationBindBody(f),o==null&&(o=f),f.view!=null&&(f.view.setX(a.coordinate(e[v],n)[0]),f.view.setY(a.coordinate(e[v],n)[1]));for(var u=0;u<p.tree.length;u++){const g=p.tree[u];if(g.type==NodeType.OperationBody||g.type=="运算体类")if(g.isFunction){var s=a.createOperationBody(a.coordinate(g,n)[0],a.coordinate(g,n)[1],1,g.isWeight,g.isAdvance,g.funcType);s.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(s),a.addBody(f,s,!1);for(var h=0;h<g.tree.length;h++){const D=g.tree[h];if(D.type==NodeType.Macro){var c=new a.VariableValue(D.name,null,4);c.TID=D.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let F=a.createFunctionBody(s,c);F.macros=a.amendMacros(D),F.enemyFlag=D.enemy,F.funcType=D.funcType,F.funcType==null&&(F.funcType=0),F.statistics=D.statistics,F.upDateValue=D.upDateValue,F.demoteValue=D.demoteValue,a.symbolicLink(F,D.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[F,D.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(D.type)){var c=new a.VariableValue(g.name,g.value,g.type);c.TID=g.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let F=a.createFunctionBody(s,c);F.enemyFlag=g.enemy,F.funcType=g.funcType,F.funcType==null&&(F.funcType=0),g.type==NodeType.Sheet&&(F.selectedOutputInfo=g.selectedOutputInfo?JSON.parse(g.selectedOutputInfo):""),F.statistics=g.statistics,F.upDateValue=g.upDateValue,F.demoteValue=g.demoteValue,F.isLogicalOpen=g.isLogicalOpen,F.isDragging=g.isDragging,F.snNo=g.snNo,F.logicalNumberList=g.logicalNumberList,F.currentStep=g.currentStep,F.snNo=g.snNo,F.minValue=g.minValue,F.maxValue=g.maxValue,F.step=g.step,F.logicalChildArray=[],g.logicalChildArray.forEach(V=>{const x=[];a.getLibraryBody(x,a.targetFolder.tree,a.getAbsoluteAddress(V));const C=x[0].copy();C.enemyFlag=g.enemy,C.funcType=g.funcType,C.funcType==null&&(C.funcType=0),C.statistics=g.statistics,C.upDateValue=g.upDateValue,C.demoteValue=g.demoteValue,F.logicalChildArray.push(C)}),a.symbolicLink(F,g.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[F,g.operator,t],null)}else{var d=[];r?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(D.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(D));let F=d[0],V=a.createVariableBody(s,F);V.enemyFlag=D.enemy,V.funcType=D.funcType,V.funcType==null&&(V.funcType=0),D.type==NodeType.Sheet&&(V.selectedOutputInfo=D.selectedOutputInfo?JSON.parse(D.selectedOutputInfo):""),V.statistics=D.statistics,V.upDateValue=D.upDateValue,V.demoteValue=D.demoteValue,a.symbolicLink(V,D.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,D.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else{var s=a.createOperationBody(a.coordinate(g,n)[0],a.coordinate(g,n)[1],0,g.isWeight,g.isAdvance,g.funcType);if(s.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(s),a.addBody(f,s,!1),g.tree==null)return null;for(var h=0;h<g.tree.length;h++){const b=g.tree[h];if(b.type==NodeType.Macro){var c=new a.VariableValue(b.name,null,b.type);c.TID=b.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let V=a.createFunctionBody(s,c);V.setMacros(a.amendMacros(b)),V.enemyFlag=b.enemy,V.funcType=b.funcType,V.funcType==null&&(V.funcType=0),V.statistics=b.statistics,V.upDateValue=b.upDateValue,V.demoteValue=b.demoteValue,a.symbolicLink(V,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,b.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(b.type)){var c=new a.VariableValue(b.name,b.value,b.type);c.TID=b.TID,c.TID==null&&(c.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let V=a.createFunctionBody(s,c);V.enemyFlag=b.enemy,V.funcType=b.funcType,V.funcType==null&&(V.funcType=0),b.type==NodeType.Sheet&&(V.selectedOutputInfo=b.selectedOutputInfo?JSON.parse(b.selectedOutputInfo):""),V.statistics=b.statistics,V.upDateValue=b.upDateValue,V.demoteValue=b.demoteValue,V.isLogicalOpen=b.isLogicalOpen,V.isDragging=b.isDragging,V.snNo=b.snNo,V.logicalNumberList=b.logicalNumberList,V.currentStep=b.currentStep,V.snNo=b.snNo,V.minValue=b.minValue,V.maxValue=b.maxValue,V.step=b.step,V.logicalChildArray=[],b.logicalChildArray.forEach(x=>{const E=[];a.getLibraryBody(E,a.targetFolder.tree,a.getAbsoluteAddress(x));const I=E[0].copy();I.enemyFlag=b.enemy,I.funcType=b.funcType,I.funcType==null&&(I.funcType=0),I.statistics=b.statistics,I.upDateValue=b.upDateValue,I.demoteValue=b.demoteValue,V.logicalChildArray.push(I)}),a.symbolicLink(V,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,b.operator,t],null)}else{var d=[];r||b.source?a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(b.source)):a.getLibraryBody(d,a.targetFolder.tree,a.getAbsoluteAddress(b));let V=d[0],x=a.createVariableBody(s,V);x.enemyFlag=b.enemy,x.funcType=b.funcType,x.funcType==null&&(x.funcType=0),b.type==NodeType.Sheet&&(x.selectedOutputInfo=b.selectedOutputInfo?JSON.parse(b.selectedOutputInfo):""),x.statistics=b.statistics,x.upDateValue=b.upDateValue,x.demoteValue=b.demoteValue,a.symbolicLink(x,b.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[x,b.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}else if(g.type==NodeType.SymbolBody||g.type=="符号运算体类"){var s=a.createSymbolBody(null,null,g.operator,g.isFunctionId,g.isWeight,g.funcType);s.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(s),s.view!=null&&(s.view.setX(a.coordinate(g,n)[0]),s.view.setY(a.coordinate(g,n)[1])),a.loopGenerateBody(s,g.tree,t),a.addBody(f,s,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}}if(a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[f,t],null),p.isFormula){var m=new a.FormulaData(p.formulaName,p.formulaX,p.formulaY);m.body=f,m.body.isBindingFormula=!0,f.formulaBody=m,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[m,f.view,t],null)}}else if(p.type==NodeType.Bookmark){var s=a.createBookmark(p.x,p.y,p.width,p.height,p.text);a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[s,t],null)}}return o}),l(a,"amendMacros",function(e){return e.macros==null?e.macro:e.macros}),l(a,"fixedDecimal",function(e,t){switch(t){case 0:return Math.round(e);case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4}return 0}),l(a,"currencyConversion",function(e){const t=e%100,n=parseInt(String(e/100%100));let r=0;return e<1e5?r=parseInt(String(e/100/100%100)):r=parseInt(String(e/100/100)),[r,n,t]}),l(a,"replaceVariableBody",function(e,t,n){const r=t.copy();return e.replace(r,n),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,r],(function(o){}).bind(this)),r}),l(a,"createVariableBody",function(e,t){const n=t.copy();return e.addBody(n),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,n],(function(r){}).bind(this)),n}),l(a,"createFunctionBody",function(e,t){const n=t.copy();return e.addBody(n),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,n],(function(r){}).bind(this)),n}),l(a,"replaceFunctionBody",function(e,t,n){const r=t.copy();return e.replace(r,n),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,r],(function(o){}).bind(this)),r}),l(a,"createOperationBody",function(e,t,n,r,o,s){const u=new a.OperationBody;u.isFunction=!!n,a.targetStoragePool.push(u),u.isWeight=r,u.isAdvance=o,u.funcType=s,(u.funcType==null||u.funcType==null)&&(u.funcType=0),u.x=e,u.y=t;let c=null;return a.Call.send(a.Eve.SHIFT_ADD_OPERATIONBODY,[e,t,n,u],(function(d){c=d,r&&c&&c.openWeight(),o&&c&&c.openAdvance()}).bind(this)),u}),l(a,"createBookmark",function(e,t,n,r,o){const s=new a.Bookmark;return s.x=e,s.y=t,s.width=n,s.id=++EventManager.IDINDEX,s.width==null&&(s.width=256),s.height=r,s.height==null&&(s.height=256),s.text=o,a.targetStoragePool.push(s),a.Call.send(a.Eve.SHIFT_ADD_BOOKMARK,[s],(function(u){}).bind(this)),s}),l(a,"createSymbolBody",function(e,t,n,r,o,s){const u=new a.SymbolBody;return u.isWeight=o,u.isFunctionId=r,u.funcType=s,(u.funcType==null||u.funcType==null)&&(u.funcType=0),u.operator=n,u.isFunctionId==null&&(u.isFunctionId=1),e!=null&&u.addBody(e),t!=null&&u.addBody(t),a.targetStoragePool.push(u),a.Call.send(a.Eve.SHIFT_ADD_SYMBOLBODY,[e,t,n,r,u],null),u}),l(a,"operationBindBody",function(e){e.isBindingOperation&&a.editBody!=null&&(a.editBody.body=e)}),l(a,"addBody",function(e,t,n){a.Call.send(a.Eve.ADD_OPERAND_DATA,[e,t,n],null)}),l(a,"symbolicLink",function(e,t){t!=null&&(t=="删除符号"||t=="删除运算体"||t=="导出公式"||t=="敌方标记"||(e.operator=t))}),l(a,"loopGenerateBody",function(e,t,n){for(let d=0;d<t.length;d++){const m=t[d];switch(m.type){case"OperationBody":if(m.isFunction){var r=a.createOperationBody(a.coordinate(t[d])[0],a.coordinate(t[d])[1],1,m.isWeight,m.isAdvance,m.funcType);r.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(r),a.addBody(e,r,!1);for(var o=0;o<m.tree.length;o++){const h=m.tree[o];if(h.type==NodeType.Macro){var s=new a.VariableValue(h.name,null,h.type);s.TID=h.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let v=a.createFunctionBody(r,s);v.macros=a.amendMacros(h),v.enemyFlag=h.enemy,v.funcType=h.funcType,v.funcType==null&&(v.funcType=0),v.statistics=h.statistics,v.upDateValue=h.upDateValue,v.demoteValue=h.demoteValue,a.symbolicLink(v,h.operator),a.clickBody=v,a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[v,h.operator,n],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(h.type)){var s=new a.VariableValue(h.name,h.value,h.type);s.TID=h.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let p=a.createFunctionBody(r,s);p.enemyFlag=h.enemy,p.funcType=h.funcType,p.funcType==null&&(p.funcType=0),h.type==NodeType.Sheet&&(p.selectedOutputInfo=h.selectedOutputInfo?JSON.parse(h.selectedOutputInfo):""),p.statistics=h.statistics,p.upDateValue=h.upDateValue,p.demoteValue=h.demoteValue,p.isLogicalOpen=h.isLogicalOpen,p.isDragging=h.isDragging,p.snNo=h.snNo,p.logicalNumberList=h.logicalNumberList,p.currentStep=h.currentStep,p.snNo=h.snNo,p.minValue=h.minValue,p.maxValue=h.maxValue,p.step=h.step,p.logicalChildArray=[],h.logicalChildArray.forEach(f=>{const y=[];a.getLibraryBody(y,a.targetFolder.tree,a.getAbsoluteAddress(f));const T=y[0].copy();T.enemyFlag=h.enemy,T.funcType=h.funcType,T.funcType==null&&(T.funcType=0),T.statistics=h.statistics,T.upDateValue=h.upDateValue,T.demoteValue=h.demoteValue,p.logicalChildArray.push(T)}),a.symbolicLink(p,h.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[p,h.operator,n],null)}else{var u=[];a.getLibraryBody(u,a.targetFolder.tree,a.getAbsoluteAddress(h));let v=u[0],p=a.createVariableBody(r,v);p.enemyFlag=h.enemy,p.funcType=h.funcType,p.funcType==null&&(p.funcType=0),h.type==NodeType.Sheet&&(p.selectedOutputInfo=h.selectedOutputInfo?JSON.parse(h.selectedOutputInfo):""),p.statistics=h.statistics,p.upDateValue=h.upDateValue,p.demoteValue=h.demoteValue,a.symbolicLink(p,h.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[p,h.operator,n],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,n],null)}else{var r=a.createOperationBody(a.coordinate(t[d])[0],a.coordinate(t[d])[1],0,m.isWeight,m.isAdvance,m.funcType);r.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(r),a.addBody(e,r,!1);for(var o=0;o<m.tree.length;o++){const p=m.tree[o];if(p.type==NodeType.Macro){var s=new a.VariableValue(p.name,null,p.type);s.TID=p.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(r,s);y.setMacros(a.amendMacros(p)),y.enemyFlag=p.enemy,y.funcType=p.funcType,y.funcType==null&&(y.funcType=0),y.statistics=p.statistics,y.upDateValue=p.upDateValue,y.demoteValue=p.demoteValue,a.symbolicLink(y,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,p.operator,n],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(p.type)){var s=new a.VariableValue(p.name,p.value,p.type);s.TID=p.TID,s.TID==null&&(s.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(r,s);y.enemyFlag=p.enemy,y.funcType=p.funcType,y.funcType==null&&(y.funcType=0),p.type==NodeType.Sheet&&(y.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),y.statistics=p.statistics,y.upDateValue=p.upDateValue,y.demoteValue=p.demoteValue,y.isLogicalOpen=p.isLogicalOpen,y.isDragging=p.isDragging,y.snNo=p.snNo,y.logicalNumberList=p.logicalNumberList,y.currentStep=p.currentStep,y.snNo=p.snNo,y.minValue=p.minValue,y.maxValue=p.maxValue,y.step=p.step,y.logicalChildArray=[],p.logicalChildArray.forEach(g=>{const T=[];a.getLibraryBody(T,a.targetFolder.tree,a.getAbsoluteAddress(g));const b=T[0].copy();b.enemyFlag=p.enemy,b.funcType=p.funcType,b.funcType==null&&(b.funcType=0),b.statistics=p.statistics,b.upDateValue=p.upDateValue,b.demoteValue=p.demoteValue,y.logicalChildArray.push(b)}),a.symbolicLink(y,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,p.operator,n],null)}else{var u=[];a.getLibraryBody(u,a.targetFolder.tree,a.getAbsoluteAddress(p));let y=u[0],g=a.createVariableBody(r,y);g.enemyFlag=p.enemy,g.funcType=p.funcType,g.funcType==null&&(g.funcType=0),p.type==NodeType.Sheet&&(g.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),g.statistics=p.statistics,g.upDateValue=p.upDateValue,g.demoteValue=p.demoteValue,a.symbolicLink(g,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,p.operator,n],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,n],null)}break;case"SymbolBody":var c=a.createSymbolBody(null,null,m.operator,m.isFunctionId,m.isWeight,m.funcType);c.isBindingOperation=a.getIsBoundOutput(t[d]),a.operationBindBody(c),c.view!=null&&(c.view.setX(a.coordinate(t[d])[0]),c.view.setY(a.coordinate(t[d])[1])),a.loopGenerateBody(c,m.tree,n),a.addBody(e,c,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[c,n],null);break}}}),l(a,"saveFXTree",function(e,t){if(e!=null)for(let n=0;n<e.length;n++){const r=e[n];if(r.type==NodeType.Macro){const o={TID:r.TID,name:r.name,code:r.macros};t.push(o)}else a.saveFXTree(r.tree,t)}}),l(a,"recursiveStorage",function(e,t){if(e.operationArray!=null)for(let n=0;n<e.operationArray.length;n++){const r=e.operationArray[n];if(r.tree!=null)for(let o=0;o<r.tree.length;o++){const s=r.tree[o];if(s.type==NodeType.Macro){const u={TID:s.TID,name:s.name,code:s.macros};t.push(u)}else a.saveFXTree(s.tree,t)}r.operationArray!=null&&a.recursiveStorage(r,t)}}),l(a,"init",function(){try{a.isStart===!1&&(a.isStart=!0,a.code=!0,new a.FXCentre)}catch(e){console.error("Error initializing FX system:",e),a.isStart=!1,a.code=!1}});let fx=a;const globalThis_=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_.fx=fx;globalThis_.seer=fx;const scriptRel="modulepreload",assetsURL=function(i,e){return new URL(i,e).href},seen={},__vitePreload=function i(e,t,n){let r=Promise.resolve();if(t&&t.length>0){const s=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),c=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));r=Promise.allSettled(t.map(d=>{if(d=assetsURL(d,n),d in seen)return;seen[d]=!0;const m=d.endsWith(".css"),h=m?'[rel="stylesheet"]':"";if(!!n)for(let f=s.length-1;f>=0;f--){const y=s[f];if(y.href===d&&(!m||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const p=document.createElement("link");if(p.rel=m?"stylesheet":scriptRel,m||(p.as="script"),p.crossOrigin="",p.href=d,c&&p.setAttribute("nonce",c),document.head.appendChild(p),m)return new Promise((f,y)=>{p.addEventListener("load",f),p.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(s){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=s,window.dispatchEvent(u),!u.defaultPrevented)throw s}return r.then(s=>{for(const u of s||[])u.status==="rejected"&&o(u.reason);return e().catch(o)})},en={meta:{title:"SoonFx Engine - Interactive Battle Demo"},header:{title:"⚔️ Interactive Battle Simulation",subtitle:"Real-time combat data visualization and analysis powered by SoonFx Engine",langSwitch:"中文"},scenarios:{title:"🎮 Battle Scenarios",pve:{label:"📈 Level Progression (1-50)",desc:"Watch how stats scale across levels"},newbie:{label:"🌱 Newbie Village (Lv 1-10)",desc:"First steps in the adventure"},midgame:{label:"⚔️ Mid-Game Challenge (Lv 20-30)",desc:"Intermediate difficulty battles"},custom:{label:"🔧 Custom Simulation",desc:"Adjust stats and fight!"},tip:{label:"💡 Tip:",text:"Click on any data point in the charts to see detailed battle information for that level."}},charts:{hpByLevel:"❤️ Health Points (HP) by Level",damageByLevel:"💥 Attack Damage by Level",roundsByLevel:"⏱️ Battle Duration (Rounds) by Level",hpByRound:"❤️ Health Points (HP) by Round",damageByRound:"💥 Damage by Round",loading:"Running simulations...",details:{title:"📋 Battle Details",hpChange:"HP Change Over Rounds",damageStats:"Damage Statistics",waiting:"Waiting for simulation..."}},story:{pveGrowth:{title:"📊 Level Progression Analysis",desc:"Simulating 50 battles to show how character stats evolve from novice to master..."},newbie:{title:"🌱 The First Adventure",desc:"A young hero takes their first steps, facing level 1-10 slimes in the Newbie Village..."},midGame:{title:"⚔️ Rising Challenge",desc:"The hero has grown stronger (Lv 20-30) and now faces tougher enemies in the Dark Forest..."},custom:{title:"🔧 Custom Battle Simulation",desc:"Manually configure hero and enemy attributes to test specific combat scenarios."}},custom:{title:"⚙️ Battle Configuration",start:"⚔️ Start Battle",simCount:"Simulations:",hero:"🦸 Hero",enemy:"👹 Enemy",level:"Level",hp:"HP",attack:"Attack",defense:"Defense",presets:{balanced:"⚖️ Balanced",heroStrong:"💪 Strong Hero",enemyStrong:"👹 Strong Enemy",tank:"🛡️ Tank Build",glass:"🗡️ Glass Cannon"},report:{title:"📊 Batch Simulation Report ({count} runs)",winRate:"Win Rate: {rate}%",avgRounds:"Avg Rounds: {rounds}",avgHeroHp:"Avg Hero Remaining HP: {hp}",losses:"Losses: {count}",minRounds:"Min Rounds: {rounds}",maxRounds:"Max Rounds: {rounds}"}},status:{running:"🔄 Running {scenario} simulation...",simulating:"🔄 Simulating battles... {current}/{total} ({percent}%)",success:"✅ Simulation complete! Click on any chart point to see detailed battle data.",error:"❌ Simulation failed: {message}",battleDetails:{header:"========== Level {level} Battle Details ==========",duration:"Battle Duration: {rounds} rounds",hp:"Hero Final HP: {hp}",damage:"Average Damage: {damage}",footer:"========================================"}}},zhCN={meta:{title:"SoonFx 引擎 - 交互式战斗演示"},header:{title:"⚔️ 交互式战斗模拟",subtitle:"基于 SoonFx 引擎的实时战斗数据可视化与分析",langSwitch:"English"},scenarios:{title:"🎮 战斗场景",pve:{label:"📈 等级成长 (1-50)",desc:"观察属性如何随等级提升而变化"},newbie:{label:"🌱 新手村 (Lv 1-10)",desc:"冒险旅程的第一步"},midgame:{label:"⚔️ 中期挑战 (Lv 20-30)",desc:"面对更强大的敌人"},custom:{label:"🔧 自定义模拟",desc:"调整属性并战斗！"},tip:{label:"💡 提示:",text:"点击图表中的任意数据点查看该等级的详细战斗信息。"}},charts:{hpByLevel:"❤️ 生命值 (HP) 随等级变化",damageByLevel:"💥 攻击伤害随等级变化",roundsByLevel:"⏱️ 战斗回合数随等级变化",hpByRound:"❤️ 生命值 (HP) 随回合变化",damageByRound:"💥 伤害随回合变化",loading:"正在运行模拟...",details:{title:"📋 战斗详情",hpChange:"回合生命值变化",damageStats:"伤害统计",waiting:"等待模拟..."}},story:{pveGrowth:{title:"📊 等级成长分析",desc:"模拟 50 场战斗，展示角色属性如何从新手成长为大师..."},newbie:{title:"🌱 初次冒险",desc:"年轻的英雄迈出了第一步，在新手村面对 1-10 级的史莱姆..."},midGame:{title:"⚔️ 挑战升级",desc:"英雄变强了 (Lv 20-30)，现在要在黑暗森林中面对更棘手的敌人..."},custom:{title:"🔧 自定义战斗模拟",desc:"手动配置英雄和敌人的属性以测试特定的战斗场景。"}},custom:{title:"⚙️ 战斗配置",start:"⚔️ 开始战斗",simCount:"模拟次数:",hero:"🦸 英雄",enemy:"👹 敌人",level:"等级",hp:"生命值",attack:"攻击力",defense:"防御力",presets:{balanced:"⚖️ 平衡",heroStrong:"💪 英雄强",enemyStrong:"👹 敌人强",tank:"🛡️ 坦克型",glass:"🗡️ 玻璃炮"},report:{title:"📊 批量模拟报告 (运行 {count} 次)",winRate:"胜率: {rate}%",avgRounds:"平均回合: {rounds}",avgHeroHp:"平均英雄剩余HP: {hp}",losses:"失败次数: {count}",minRounds:"最少回合: {rounds}",maxRounds:"最多回合: {rounds}"}},status:{running:"🔄 正在运行 {scenario} 模拟...",simulating:"🔄 正在模拟战斗... {current}/{total} ({percent}%)",success:"✅ 模拟完成！点击图表上的任意点查看详细战斗数据。",error:"❌ 模拟失败: {message}",battleDetails:{header:"========== 等级 {level} 战斗详情 ==========",duration:"战斗持续: {rounds} 回合",hp:"英雄最终 HP: {hp}",damage:"平均伤害: {damage}",footer:"========================================"}}};class I18nService{constructor(){this.currentLocale="en",this.messages={en,"zh-CN":zhCN},this.listeners=[];const t=new URLSearchParams(window.location.search).get("lang");t==="zh-CN"||t==="zh"?this.currentLocale="zh-CN":t==="en"?this.currentLocale="en":this.currentLocale="en"}get locale(){return this.currentLocale}setLocale(e){this.currentLocale!==e&&(this.currentLocale=e,this.updateURL(),this.notifyListeners(),this.updatePage())}toggleLocale(){this.setLocale(this.currentLocale==="en"?"zh-CN":"en")}t(e,t){const n=e.split(".");let r=this.messages[this.currentLocale];for(const o of n)if(r&&typeof r=="object"&&o in r)r=r[o];else return e;return typeof r!="string"?e:t?Object.entries(t).reduce((o,[s,u])=>o.replace(`{${s}}`,String(u)),r):r}subscribe(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>e())}updateURL(){const e=new URL(window.location.href);e.searchParams.set("lang",this.currentLocale),window.history.replaceState({},"",e.toString())}updatePage(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=this.t(t))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=this.t(t))}),document.title=this.t("meta.title"),document.documentElement.lang=this.currentLocale}}const i18n=new I18nService;class ChartController{constructor(e){this.chartInstances={},this.pveBattleData=null,this.onPointClick=e,window.addEventListener("resize",()=>{Object.values(this.chartInstances).forEach(t=>{t.resize()})}),i18n.subscribe(()=>{this.pveBattleData&&this.updateChartTitles()})}async initCharts(){return Promise.resolve()}updateChartTitles(){}updateCharts(e,t){var c,d,m;if(!e||e.length===0)return;this.pveBattleData=e;const n=e.map(h=>`Lv ${h.level}`),r=e.map(h=>h.hp),o=e.map(h=>h.damage),s=e.map(h=>h.rounds),u=t!==null?e.findIndex(h=>h.level===t):-1;this.chartInstances.hpChart||((c=document.getElementById("hpPlaceholder"))==null||c.classList.add("hidden"),this.chartInstances.hpChart=this.createLineChart("hpChart","Health Points","rgb(75, 192, 192)")),this.updateChartData(this.chartInstances.hpChart,n,r,u,"rgb(75, 192, 192)",!1,i18n.t("charts.hpByLevel")),this.chartInstances.damageChart||((d=document.getElementById("damagePlaceholder"))==null||d.classList.add("hidden"),this.chartInstances.damageChart=this.createLineChart("damageChart","Attack Damage","rgb(255, 99, 132)")),this.updateChartData(this.chartInstances.damageChart,n,o,u,"rgb(255, 99, 132)",!1,i18n.t("charts.damageByLevel")),this.chartInstances.roundsChart||((m=document.getElementById("roundsPlaceholder"))==null||m.classList.add("hidden"),this.chartInstances.roundsChart=this.createLineChart("roundsChart","Battle Duration","rgb(153, 102, 255)")),this.updateChartData(this.chartInstances.roundsChart,n,s,u,"rgb(153, 102, 255)",!0,i18n.t("charts.roundsByLevel"))}clearCharts(){Object.values(this.chartInstances).forEach(e=>{e.dispose()}),this.chartInstances={}}updateChartsWithBattleRounds(e,t,n){var d,m;if(!e||e.length===0)return;const r=e.map(h=>`R${h.round}`),o=e.map(h=>h.heroHp),s=e.map(h=>h.enemyHp),u=e.map(h=>h.heroDamageDealt||0),c=e.map(h=>h.enemyDamageDealt||0);e.map(h=>h.heroHpPercent||0),e.map(h=>h.enemyHpPercent||0),(d=document.getElementById("hpPlaceholder"))==null||d.classList.add("hidden"),this.chartInstances.hpChart||(this.chartInstances.hpChart=this.createLineChart("hpChart","HP","rgb(75, 192, 192)")),this.updateDualLineChart(this.chartInstances.hpChart,r,o,s,t,n,"rgb(45, 105, 105)","rgb(255, 99, 132)"),(m=document.getElementById("damagePlaceholder"))==null||m.classList.add("hidden"),this.chartInstances.damageChart||(this.chartInstances.damageChart=this.createLineChart("damageChart","Damage","rgb(255, 99, 132)")),this.updateDualBarChart(this.chartInstances.damageChart,r,u,c,t,n)}updateDualLineChart(e,t,n,r,o,s,u,c){const d=e.getOption();if(d&&d.series&&d.series.length===2&&d.series[0].name===o&&d.series[1].name===s&&d.series[0].type==="line")e.setOption({xAxis:{data:t},series:[{data:n},{data:r}]});else{const h={animation:!0,animationDuration:300,animationEasing:"cubicOut",tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[o,s],textStyle:{color:"#f1f5f9",fontSize:10},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8",fontSize:10}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:o,type:"line",data:n,smooth:.3,lineStyle:{color:u,width:2},itemStyle:{color:u},areaStyle:{color:u.replace("rgb","rgba").replace(")",", 0.2)")},animation:!0,animationDuration:300,animationEasing:"cubicOut"},{name:s,type:"line",data:r,smooth:.3,lineStyle:{color:c,width:2},itemStyle:{color:c},areaStyle:{color:c.replace("rgb","rgba").replace(")",", 0.2)")},animation:!0,animationDuration:300,animationEasing:"cubicOut"}]};e.setOption(h)}}updateDualBarChart(e,t,n,r,o,s){const u=e.getOption();if(u&&u.series&&u.series.length===2&&u.series[0].name===o&&u.series[1].name===s&&u.series[0].type==="bar")e.setOption({xAxis:{data:t},series:[{data:n},{data:r}]});else{const d={animation:!0,animationDuration:300,animationEasing:"cubicOut",tooltip:{trigger:"axis",axisPointer:{type:"shadow"},confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[o,s],textStyle:{color:"#f1f5f9",fontSize:10},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8",fontSize:10}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:o,type:"bar",data:n,itemStyle:{color:"rgba(75, 192, 192, 0.8)"},animation:!0,animationDuration:300,animationEasing:"cubicOut"},{name:s,type:"bar",data:r,itemStyle:{color:"rgba(255, 99, 132, 0.8)"},animation:!0,animationDuration:300,animationEasing:"cubicOut"}]};e.setOption(d)}}createDetailCharts(e,t,n){this.createDetailHpChart(e,t,n),this.createDetailDamageChart(e,t,n)}createLineChart(e,t,n){const r=document.getElementById(e);if(!r)throw new Error(`Canvas container ${e} not found`);const o=init(r);return o.getZr().on("click",s=>{if(!this.pveBattleData)return;const u=[s.offsetX,s.offsetY];if(o.containPixel({seriesIndex:0},u)){const c=o.convertFromPixel({seriesIndex:0},u);if(c){const d=c[0];d>=0&&d<this.pveBattleData.length&&this.onPointClick(d)}}}),o}updateChartData(e,t,n,r,o,s=!1,u){const c={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"},borderColor:o},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",scale:s,minInterval:s?1:0,splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:u||"Value",type:"line",data:n.map((d,m)=>({value:d,itemStyle:{color:m===r?"rgb(255, 200, 0)":o,borderColor:m===r?"rgb(255, 200, 0)":o},symbolSize:m===r?8:3})),smooth:.3,lineStyle:{color:o,width:2},areaStyle:{color:new LinearGradient(0,0,0,1,[{offset:0,color:o.replace("rgb","rgba").replace(")",", 0.5)")},{offset:1,color:o.replace("rgb","rgba").replace(")",", 0.0)")}])}}]};e.setOption(c)}createDetailHpChart(e,t,n){const r=document.getElementById("detailHpChart");if(!r)return;this.chartInstances.detailHpChart&&this.chartInstances.detailHpChart.dispose();const o=e.map(m=>`R${m.round}`),s=e.map(m=>m.heroHp),u=e.map(m=>m.enemyHp),c=init(r);this.chartInstances.detailHpChart=c;const d={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[`${t} HP`,`${n} HP`],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:o,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:`${t} HP`,type:"line",data:s,smooth:.3,lineStyle:{color:"rgb(75, 192, 192)"},itemStyle:{color:"rgb(75, 192, 192)"},areaStyle:{color:"rgba(75, 192, 192, 0.2)"}},{name:`${n} HP`,type:"line",data:u,smooth:.3,lineStyle:{color:"rgb(255, 99, 132)"},itemStyle:{color:"rgb(255, 99, 132)"},areaStyle:{color:"rgba(255, 99, 132, 0.2)"}}]};c.setOption(d)}createDetailDamageChart(e,t,n){const r=document.getElementById("detailDamageChart");if(!r)return;this.chartInstances.detailDamageChart&&this.chartInstances.detailDamageChart.dispose();const o=e.reduce((h,v)=>h+(v.heroDamageDealt||0),0),s=e.reduce((h,v)=>h+(v.enemyDamageDealt||0),0),u=parseFloat((o/e.length).toFixed(1)),c=parseFloat((s/e.length).toFixed(1)),d=init(r);this.chartInstances.detailDamageChart=d;const m={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[t,n],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:["Total Damage","Avg Damage/Round"],axisLine:{show:!1},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:t,type:"bar",data:[o,u],itemStyle:{color:"rgba(75, 192, 192, 0.8)"}},{name:n,type:"bar",data:[s,c],itemStyle:{color:"rgba(255, 99, 132, 0.8)"}}]};d.setOption(m)}}class CharacterView{constructor(e){this.heroElement=null,this.enemyElement=null,this.heroHpBar=null,this.enemyHpBar=null,this.heroHpText=null,this.enemyHpText=null;const t=document.getElementById(e);if(!t)throw new Error(`Container with id "${e}" not found`);this.container=t}init(){this.container.innerHTML=`
            <div class="battle-arena">
                <div class="character-view hero-view" id="heroView">
                    <div class="character-sprite" id="heroSprite">
                        <div class="character-avatar">🦸</div>
                    </div>
                    <div class="character-info">
                        <div class="character-name" id="heroName">Hero</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar" id="heroHpBar">
                                <div class="hp-fill" id="heroHpFill"></div>
                            </div>
                            <div class="hp-text" id="heroHpText">1000/1000</div>
                        </div>
                        <div class="character-stats" id="heroStats">
                            <span>Lv.10</span>
                            <span>ATK: 100</span>
                            <span>DEF: 20</span>
                        </div>
                    </div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="character-view enemy-view" id="enemyView">
                    <div class="character-sprite" id="enemySprite">
                        <div class="character-avatar">👹</div>
                    </div>
                    <div class="character-info">
                        <div class="character-name" id="enemyName">Enemy</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar" id="enemyHpBar">
                                <div class="hp-fill" id="enemyHpFill"></div>
                            </div>
                            <div class="hp-text" id="enemyHpText">1000/1000</div>
                        </div>
                        <div class="character-stats" id="enemyStats">
                            <span>Lv.10</span>
                            <span>ATK: 90</span>
                            <span>DEF: 15</span>
                        </div>
                    </div>
                </div>
            </div>
        `,this.heroElement=document.getElementById("heroView"),this.enemyElement=document.getElementById("enemyView"),this.heroHpBar=document.getElementById("heroHpFill"),this.enemyHpBar=document.getElementById("enemyHpFill"),this.heroHpText=document.getElementById("heroHpText"),this.enemyHpText=document.getElementById("enemyHpText")}updateCharacters(e,t){const n=document.getElementById("heroName"),r=document.getElementById("enemyName"),o=document.getElementById("heroStats"),s=document.getElementById("enemyStats");n&&(n.textContent=e.name||"Hero"),r&&(r.textContent=t.name||"Enemy"),o&&(o.innerHTML=`
                <span>Lv.${e.level||1}</span>
                <span>ATK: ${e.attack||0}</span>
                <span>DEF: ${e.defense||0}</span>
            `),s&&(s.innerHTML=`
                <span>Lv.${t.level||1}</span>
                <span>ATK: ${t.attack||0}</span>
                <span>DEF: ${t.defense||0}</span>
            `),this.updateHp(e.maxHp||e.hp,e.maxHp||e.hp,"hero"),this.updateHp(t.maxHp||t.hp,t.maxHp||t.hp,"enemy")}updateHp(e,t,n){const r=n==="hero"?this.heroHpBar:this.enemyHpBar,o=n==="hero"?this.heroHpText:this.enemyHpText;if(r){const s=Math.max(0,Math.min(100,e/t*100));r.style.width=`${s}%`,s>60?r.style.backgroundColor="#10b981":s>30?r.style.backgroundColor="#f59e0b":r.style.backgroundColor="#ef4444"}o&&(o.textContent=`${Math.max(0,Math.round(e))}/${t}`)}async playLandingAnimation(){return new Promise(e=>{var t,n;this.heroElement&&(this.heroElement.style.opacity="0",this.heroElement.style.transform="translateY(-100px) scale(0.5)",this.heroElement.style.transition="none"),this.enemyElement&&(this.enemyElement.style.opacity="0",this.enemyElement.style.transform="translateY(-100px) scale(0.5)",this.enemyElement.style.transition="none"),(t=this.heroElement)==null||t.offsetHeight,(n=this.enemyElement)==null||n.offsetHeight,this.heroElement&&(this.heroElement.style.transition="all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)",this.heroElement.style.opacity="1",this.heroElement.style.transform="translateY(0) scale(1)"),setTimeout(()=>{this.enemyElement&&(this.enemyElement.style.transition="all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)",this.enemyElement.style.opacity="1",this.enemyElement.style.transform="translateY(0) scale(1)")},150),setTimeout(()=>{e()},800)})}async playAttackAnimation(e){return new Promise(t=>{const n=e==="hero"?this.heroElement:this.enemyElement,r=e==="hero"?this.enemyElement:this.heroElement;if(!n||!r){t();return}const o=n.querySelector(".character-sprite");if(!o){t();return}const s=o.style.transform||"";o.style.transition="transform 0.3s ease-out",o.style.transform=e==="hero"?"translateX(30px) scale(1.1)":"translateX(-30px) scale(1.1)",r.style.transition="all 0.1s",r.style.filter="brightness(1.5)",r.style.transform="scale(0.95)",setTimeout(()=>{o.style.transform=s,r.style.filter="",r.style.transform="",setTimeout(()=>{t()},300)},300)})}async playHitAnimation(e,t){const n=e==="hero"?this.heroElement:this.enemyElement;if(!n)return;const r=document.createElement("div");r.className="damage-number",r.textContent=`-${Math.round(t)}`,r.style.position="absolute",r.style.color="#ef4444",r.style.fontSize="18px",r.style.fontWeight="bold",r.style.pointerEvents="none",r.style.zIndex="1000",r.style.textShadow="2px 2px 4px rgba(0,0,0,0.8)";const o=n.querySelector(".character-sprite");if(o){const s=o.getBoundingClientRect();r.style.left=`${s.left+s.width/2}px`,r.style.top=`${s.top}px`,document.body.appendChild(r),r.style.transition="all 0.8s ease-out",r.style.transform="translateY(-50px)",r.style.opacity="0",setTimeout(()=>{document.body.removeChild(r)},800)}n.style.transition="filter 0.2s",n.style.filter="brightness(1.5)",setTimeout(()=>{n.style.filter=""},200)}playVictoryAnimation(e){const t=e==="hero"?this.heroElement:this.enemyElement,n=e==="hero"?this.enemyElement:this.heroElement;t&&(t.style.transition="all 0.5s",t.style.transform="scale(1.1)",t.style.filter="brightness(1.2) drop-shadow(0 0 20px rgba(16, 185, 129, 0.8))"),n&&(n.style.transition="all 0.5s",n.style.opacity="0.5",n.style.filter="grayscale(100%)")}reset(){this.heroElement&&(this.heroElement.style.transform="",this.heroElement.style.opacity="",this.heroElement.style.filter=""),this.enemyElement&&(this.enemyElement.style.transform="",this.enemyElement.style.opacity="",this.enemyElement.style.filter="")}setVisible(e){this.container.style.display=e?"block":"none"}}const SCENARIO_KEYS={"pve-growth":{title:"story.pveGrowth.title",desc:"story.pveGrowth.desc"},newbie:{title:"story.newbie.title",desc:"story.newbie.desc"},"mid-game":{title:"story.midGame.title",desc:"story.midGame.desc"},"custom-battle":{title:"story.custom.title",desc:"story.custom.desc"}},w=class w{constructor(){this.characterView=null,this.currentScenario="pve-growth",this.pveBattleData=null,this.currentLevel=null,this.isRunning=!1,this.chartUpdateTimer=null,this.chartController=new ChartController(e=>this.showBattleDetail(e));try{this.characterView=new CharacterView("characterViewContainer"),this.characterView.init()}catch{console.warn("CharacterView container not found, character view disabled")}}async init(){console.log("Battle simulation system initialized"),i18n.updatePage(),this.bindEvents(),this.redirectConsole(),await this.chartController.initCharts(),await this.selectScenario("pve-growth"),i18n.subscribe(()=>{this.updateStoryHeader(this.currentScenario),this.pveBattleData&&this.currentLevel})}bindEvents(){document.querySelectorAll(".scenario-btn").forEach(n=>{n.addEventListener("click",r=>{const s=r.currentTarget.dataset.scenario;s&&this.selectScenario(s)})});const e=document.getElementById("startCustomBattle");e&&e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),console.log("Start Custom Battle clicked"),this.isRunning||this.runCustomBattle()}),document.querySelectorAll(".preset-btn").forEach(n=>{n.addEventListener("click",r=>{const o=r.currentTarget,s=o.dataset.preset;s&&w.PRESETS[s]&&(this.applyPreset(s),document.querySelectorAll(".preset-btn").forEach(u=>u.classList.remove("active")),o.classList.add("active"))})});const t=document.getElementById("langSwitch");t&&t.addEventListener("click",()=>{i18n.toggleLocale()})}redirectConsole(){const e=console.log;console.log=(...t)=>{e.apply(console,t),document.getElementById("output")}}updateStoryHeader(e){const t=SCENARIO_KEYS[e];if(t){const n=document.getElementById("storyTitle"),r=document.getElementById("storyDesc");n&&(n.textContent=i18n.t(t.title)),r&&(r.textContent=i18n.t(t.desc))}}async selectScenario(e){var u,c,d,m,h,v;document.querySelectorAll(".scenario-btn").forEach(p=>{p.classList.remove("active"),p.dataset.scenario===e&&p.classList.add("active")}),this.currentScenario=e,this.updateStoryHeader(e);const t=document.getElementById("hpChartTitle"),n=document.getElementById("damageChartTitle"),r=document.getElementById("roundsChartTitle"),o=r==null?void 0:r.closest(".chart-card");e==="custom-battle"?(t&&t.setAttribute("data-i18n","charts.hpByRound"),n&&n.setAttribute("data-i18n","charts.damageByRound"),o&&(o.style.display="none")):(t&&t.setAttribute("data-i18n","charts.hpByLevel"),n&&n.setAttribute("data-i18n","charts.damageByLevel"),r&&r.setAttribute("data-i18n","charts.roundsByLevel"),o&&(o.style.display="block")),i18n.updatePage(),this.clearOutput(),this.chartController.clearCharts(),(u=document.getElementById("hpPlaceholder"))==null||u.classList.remove("hidden"),(c=document.getElementById("damagePlaceholder"))==null||c.classList.remove("hidden"),(d=document.getElementById("roundsPlaceholder"))==null||d.classList.remove("hidden");const s=document.getElementById("customConfigPanel");if(e==="custom-battle"){if(s&&(s.style.display="block"),(m=document.getElementById("hpPlaceholder"))==null||m.classList.add("hidden"),(h=document.getElementById("damagePlaceholder"))==null||h.classList.add("hidden"),(v=document.getElementById("roundsPlaceholder"))==null||v.classList.add("hidden"),this.characterView){this.characterView.setVisible(!0);const p=document.getElementById("characterViewContainer");p&&(p.style.display="block")}}else{if(s&&(s.style.display="none"),this.characterView){this.characterView.setVisible(!1);const p=document.getElementById("characterViewContainer");p&&(p.style.display="none")}await this.runScenario(e)}}async runScenario(e){if(e!=="custom-battle"){this.setStatus("loading",i18n.t("status.running",{scenario:e}));try{switch(e){case"pve-growth":await this.showPVEGrowthCurve(50);break;case"newbie":await this.showPVEGrowthCurve(10,1);break;case"mid-game":await this.showPVEGrowthCurve(30,20);break}this.setStatus("success",i18n.t("status.success"))}catch(t){console.error("Simulation error:",t),this.setStatus("error",i18n.t("status.error",{message:t.message}))}}}applyPreset(e){const t=w.PRESETS[e];if(!t)return;const n=(r,o)=>{const s=document.getElementById(r);s&&(s.value=String(o))};n("heroLevel",t.hero.level),n("heroHp",t.hero.hp),n("heroAtk",t.hero.atk),n("heroDef",t.hero.def),n("enemyLevel",t.enemy.level),n("enemyHp",t.enemy.hp),n("enemyAtk",t.enemy.atk),n("enemyDef",t.enemy.def),this.characterView&&this.currentScenario==="custom-battle"&&this.characterView.updateCharacters({name:"Hero",level:t.hero.level,hp:t.hero.hp,maxHp:t.hero.hp,attack:t.hero.atk,defense:t.hero.def},{name:"Enemy Boss",level:t.enemy.level,hp:t.enemy.hp,maxHp:t.enemy.hp,attack:t.enemy.atk,defense:t.enemy.def})}async runCustomBattle(){if(console.log("runCustomBattle called, isRunning:",this.isRunning),this.isRunning)return;const e=f=>{const y=document.getElementById(f),g=parseInt(y==null?void 0:y.value)||0,T=parseInt(y==null?void 0:y.min)||0,D=parseInt(y==null?void 0:y.max)||999999;return Math.max(T,Math.min(D,g))},t=e("heroLevel"),n=e("heroHp"),r=e("heroAtk"),o=e("heroDef"),s=e("enemyLevel"),u=e("enemyHp"),c=e("enemyAtk"),d=e("enemyDef"),m=Math.max(1,Math.min(1e3,e("simCount")||1));if(console.log("Custom Battle Config:",{heroLevel:t,heroHp:n,heroAtk:r,heroDef:o,enemyLevel:s,enemyHp:u,enemyAtk:c,enemyDef:d,simCount:m}),n<=0||r<=0||u<=0||c<=0){this.setStatus("error","Invalid stats: HP and Attack must be > 0");return}if(this.isRunning=!0,this.setStatus("loading",i18n.t("status.running",{scenario:"Custom"})),this.clearOutput(),this.characterView){this.characterView.setVisible(!0);const f=document.getElementById("characterViewContainer");f&&(f.style.display="block"),this.characterView.updateCharacters({name:"Hero",level:t,hp:n,maxHp:n,attack:r,defense:o},{name:"Enemy Boss",level:s,hp:u,maxHp:u,attack:c,defense:d}),this.characterView.reset(),await this.characterView.playLandingAnimation()}const h=document.getElementById("customProgress"),v=document.getElementById("progressBar"),p=document.getElementById("progressText");m>1&&h&&(h.style.display="block");try{const{BattleEntity:f}=await __vitePreload(async()=>{const{BattleEntity:I}=await import("./BattleEntity-CWBiIsEU.js");return{BattleEntity:I}},[],import.meta.url),{BattleSimulator:y}=await __vitePreload(async()=>{const{BattleSimulator:I}=await import("./BattleSimulator-BnmtSMI-.js");return{BattleSimulator:I}},[],import.meta.url),{BattleLogger:g}=await __vitePreload(async()=>{const{BattleLogger:I}=await import("./BattleLogger-k-D1IkQQ.js");return{BattleLogger:I}},[],import.meta.url);let T=0,D=0,b=0,F=1/0,V=0,x=null;const E=50;for(let I=0;I<m;I++){if(I>0&&I%E===0&&(await new Promise(M=>requestAnimationFrame(M)),v&&p)){const M=Math.round(I/m*100);v.style.width=`${M}%`,p.textContent=`${I} / ${m} (${M}%)`}const O=I===m-1,R=new g(!O),H=new f("Hero",n,r,o,t),N=new f("Enemy Boss",u,c,d,s),k=new y(H,N,R);let S;m===1&&this.characterView?S=await this.playAnimatedBattle(H,N,k):S=k.startBattle(),S.winner==="Hero"&&T++,D+=S.rounds,F=Math.min(F,S.rounds),V=Math.max(V,S.rounds);const $=S.battleData[S.battleData.length-1];b+=$?$.heroHp:0,O&&(x=S)}if(!x)throw new Error("Simulation failed");if(h&&(h.style.display="none",v&&(v.style.width="0%")),m>1){const I=document.getElementById("output");if(I){I.textContent="";const O=(T/m*100).toFixed(1),R=(D/m).toFixed(1),H=(b/m).toFixed(0),N=m-T,k=`
${i18n.t("custom.report.title",{count:m})}
────────────────────────────────
${i18n.t("custom.report.winRate",{rate:O})}
${i18n.t("custom.report.losses",{count:N})}
${i18n.t("custom.report.avgRounds",{rounds:R})}
${i18n.t("custom.report.minRounds",{rounds:F})}
${i18n.t("custom.report.maxRounds",{rounds:V})}
${i18n.t("custom.report.avgHeroHp",{hp:H})}
────────────────────────────────

${i18n.t("status.battleDetails.header",{level:t})}
${i18n.t("status.battleDetails.duration",{rounds:x.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(x.battleData[x.battleData.length-1].heroHp)})}
`;I.textContent=k}}const C={level:t,hp:x.battleData[x.battleData.length-1].heroHp,damage:x.battleData.reduce((I,O)=>I+O.heroDamageDealt,0)/x.rounds,rounds:x.rounds,battleData:x.battleData,heroName:"Hero",enemyName:"Enemy Boss"};if(this.pveBattleData=[C],this.chartController.updateChartsWithBattleRounds(x.battleData,C.heroName,C.enemyName),this.showCustomBattleDetail(C),this.characterView&&x){const I=x.battleData[x.battleData.length-1];I&&(this.characterView.updateHp(I.heroHp,n,"hero"),this.characterView.updateHp(I.enemyHp,u,"enemy"))}this.setStatus("success",i18n.t("status.success"))}catch(f){this.setStatus("error",f.message),h&&(h.style.display="none")}finally{this.isRunning=!1}}async playAnimatedBattle(e,t,n){if(!this.characterView)return n.startBattle();const r=[];let o=0;const s=100;this.characterView.updateHp(e.currentHp,e.maxHp,"hero"),this.characterView.updateHp(t.currentHp,t.maxHp,"enemy");const u=document.getElementById("detailChartsContainer");for(u&&(u.style.display="block");o<s;){o++;const d=Math.floor(e.attack*(.8+Math.random()*.4)),m=t.takeDamage(d);if(await this.characterView.playAttackAnimation("hero"),await this.characterView.playHitAnimation("enemy",m),this.characterView.updateHp(t.currentHp,t.maxHp,"enemy"),await new Promise(p=>setTimeout(p,200)),!t.isAlive()){r.push({round:o,heroHp:e.currentHp,heroHpPercent:e.currentHp/e.maxHp*100,enemyHp:0,enemyHpPercent:0,heroDamageDealt:m,enemyDamageDealt:0,winner:e.name,battleEnd:!0}),this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),this.chartController.updateChartsWithBattleRounds(r,"Hero","Enemy Boss"),this.characterView.playVictoryAnimation("hero");break}const h=Math.floor(t.attack*(.8+Math.random()*.4)),v=e.takeDamage(h);if(await this.characterView.playAttackAnimation("enemy"),await this.characterView.playHitAnimation("hero",v),this.characterView.updateHp(e.currentHp,e.maxHp,"hero"),await new Promise(p=>setTimeout(p,200)),!e.isAlive()){r.push({round:o,heroHp:0,heroHpPercent:0,enemyHp:t.currentHp,enemyHpPercent:t.currentHp/t.maxHp*100,heroDamageDealt:m,enemyDamageDealt:v,winner:t.name,battleEnd:!0}),this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),this.chartController.updateChartsWithBattleRounds(r,"Hero","Enemy Boss"),this.characterView.playVictoryAnimation("enemy");break}r.push({round:o,heroHp:e.currentHp,heroHpPercent:e.currentHp/e.maxHp*100,enemyHp:t.currentHp,enemyHpPercent:t.currentHp/t.maxHp*100,heroDamageDealt:m,enemyDamageDealt:v,battleEnd:!1}),this.chartUpdateTimer!==null&&clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=window.setTimeout(()=>{this.chartController.updateChartsWithBattleRounds(r,"Hero","Enemy Boss"),this.chartUpdateTimer=null},50)}return this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),{winner:e.isAlive()?e.name:t.isAlive()?t.name:"平局",rounds:o,battleData:r}}showCustomBattleDetail(e){var r;if(!e.battleData||e.battleData.length===0){console.error("No detailed battle data available");return}this.currentLevel=e.level;const t=document.getElementById("detailChartsContainer");t&&(t.style.display="block"),this.chartController.createDetailCharts(e.battleData,e.heroName||"Hero",e.enemyName||"Enemy");const n=document.getElementById("output");if(n&&!((r=n.textContent)!=null&&r.includes("────"))){n.textContent="";const o=`
${i18n.t("status.battleDetails.header",{level:e.level})}
${i18n.t("status.battleDetails.duration",{rounds:e.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(e.hp)})}
${i18n.t("status.battleDetails.damage",{damage:Math.round(e.damage)})}
${i18n.t("status.battleDetails.footer")}
`;n.textContent=o}}async showPVEGrowthCurve(e,t=1){this.currentLevel=null;const n=document.getElementById("detailChartsContainer");n&&(n.style.display="none");const{generatePVEDataRange:r}=await __vitePreload(async()=>{const{generatePVEDataRange:s}=await import("./SimulationService-HKYoF-nO.js");return{generatePVEDataRange:s}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),o=await r((s,u,c)=>{this.chartController.updateCharts(s,this.currentLevel),this.pveBattleData=s;const d=Math.round(u/c*100);this.setStatus("loading",i18n.t("status.simulating",{current:u,total:c,percent:d})),u===t&&s.length>0&&setTimeout(()=>{s[0]&&s[0].battleData&&this.showBattleDetail(0)},500)},e-t+1,t);this.pveBattleData=o,console.log(`Growth curve generated with ${o.length} data points`)}showBattleDetail(e){if(!this.pveBattleData||!this.pveBattleData[e]){console.error("Battle data not found for index:",e);return}const t=this.pveBattleData[e];if(!t.battleData||t.battleData.length===0){console.error("No detailed battle data available");return}this.currentLevel=t.level,this.chartController.updateCharts(this.pveBattleData,this.currentLevel);const n=document.getElementById("detailChartsContainer");n&&(n.style.display="block"),this.chartController.createDetailCharts(t.battleData,t.heroName||"Hero",t.enemyName||"Enemy");const r=document.getElementById("output");if(r){r.textContent="";const o=`
${i18n.t("status.battleDetails.header",{level:t.level})}
${i18n.t("status.battleDetails.duration",{rounds:t.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(t.hp)})}
${i18n.t("status.battleDetails.damage",{damage:Math.round(t.damage)})}
${i18n.t("status.battleDetails.footer")}
`;r.textContent=o}}setStatus(e,t){const n=document.getElementById("status");n&&(n.className=`status ${e}`,n.textContent=t)}clearOutput(){const e=document.getElementById("output");e&&(e.textContent="",e.setAttribute("data-placeholder",i18n.t("charts.details.waiting"))),this.setStatus("","")}};w.PRESETS={balanced:{hero:{level:10,hp:1e3,atk:100,def:20},enemy:{level:10,hp:1e3,atk:100,def:20}},heroStrong:{hero:{level:15,hp:1500,atk:150,def:30},enemy:{level:10,hp:800,atk:80,def:15}},enemyStrong:{hero:{level:10,hp:800,atk:80,def:15},enemy:{level:15,hp:1500,atk:150,def:30}},tank:{hero:{level:10,hp:2e3,atk:60,def:50},enemy:{level:10,hp:800,atk:120,def:10}},glass:{hero:{level:10,hp:500,atk:200,def:5},enemy:{level:10,hp:1200,atk:80,def:25}}};let DemoApp=w;const app=new DemoApp;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>app.init()):app.init();export{BillboardLayer as B,ChartsLayer as C,EventManager as E,FXCentre as F,Player as P,Call as a,fx as f};
