import{P as A,F as b,f as r,E as B,B as _,C as w,a as x}from"./index-DcBCjvam.js";import{BattleLogger as I}from"./BattleLogger-k-D1IkQQ.js";import{BattleEntity as F}from"./BattleEntity-CWBiIsEU.js";import{BattleSimulator as V}from"./BattleSimulator-BnmtSMI-.js";import"./echarts-Bn9PLWWT.js";class h{constructor(){this.playerList=[]}static getInstance(){return this._instance||(this._instance=new h),this._instance}getPlayerInstance(){let l=this._fxData[0],a=new A;a.name=l.name,console.log(a.name);let t=a.getBillboard();return console.log(t),a.parameterInfoArray=l.parameterInfoArray,a}getEnemyInstance(l){let a=this._fxData[l],t=new A;return t.name=a.name,t.parameterInfoArray=a.parameterInfoArray,t}getInstanceByName(l){let a=this._fxData.find(n=>n.name===l);if(!a)return console.warn(`未找到名称为 "${l}" 的角色配置`),null;let t=new A;return t.name=a.name,t.parameterInfoArray=a.parameterInfoArray,t}loadConfig(l){new b;var a=l,t=typeof a=="string"?JSON.parse(a):a;t.stage.operationArray;var n=t.library.operationArray;r.createLibraryBody(n,!0),this._fxPlayer=A,this.playerList=[];let y=new r.CallCenter;y.addEventListener(B.SHIFT_ADD_BOARD,e=>{let u=new _(e.name);u.monitored=e.monitored;let s=u;for(var o=0;o<e.operationArray.length;o++){var m=[];r.getLibraryBody(m,r.targetFolder.tree,e.operationArray[o].site),r.clickBody=m[0],s.pushOperationLayer(),r.clickBody=null}for(var o=0;o<e.metadataArray.length;o++){var m=[];r.getLibraryBody(m,r.targetFolder.tree,e.metadataArray[o].site),r.clickBody=m[0];let g=e.metadataArray[o];s.pushMetadata(g.componentType,g.componentMinValue,g.componentMaxValue,g.componentIntervalValue),r.clickBody=null}r.Call.send(r.Eve.ADD_DATABASE_DATA,[s,r.selectBody,e.index]),r.Call.send(r.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[s,r.selectBody])}),y.addEventListener(B.SHIFT_ADD_CHARTS,e=>{var u=new w(e.name);let s=u;for(var o=0;o<e.operationlayer.length;o++){var m=[];r.getLibraryBody(m,r.targetFolder.tree,e.operationlayer[o]),s.operationArray.push(m[0].copy())}var m=[];s.minValue=e.minValue,s.intervalValue=e.intervalValue,s.maxValue=e.maxValue,e.metadataArray||(e.metadataArray=[]),e.metadata&&(e.metadataArray=[{site:e.metadata,intervalValue:s.intervalValue,minValue:s.minValue}],e.metadata=null);for(var o=0;o<e.metadataArray.length;o++){var m=[],p=e.metadataArray[o];r.getLibraryBody(m,r.targetFolder.tree,p.site);var d=m[0].copy();d.intervalValue=p.intervalValue||1,d.minValue=p.minValue||1,s.metadataArray.push(d),s.metadata=d}x.send(r.Eve.ADD_DATABASE_DATA,[s,r.selectBody,e.index]),r.Call.send(r.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[s,r.selectBody]),r.clickBody=null}),r.parseLibraryBody(n,!0),r.recursionSyncBody(r.targetFolder.tree);let c=t.entity.operationArray;this._fxData=c;let i=this.createPlayersFromEntityArray(c);console.log("-------------------"),i.forEach(e=>{let u=e.getFormula("攻击"),s=e.getFormula("生命"),o=e.getFormula("防御");console.log("name",e.name),console.log("attack",u),console.log("hp",s),console.log("defense",o)}),this.playerList=i}getDataByOccuAndLevel(l,a){this._fxPlayer.changePlayerLevelAndOccupation(a,l);let t=this._fxPlayer.getFormula("攻击1"),n=this._fxPlayer.getFormula("生命"),y=this._fxPlayer.getFormula("防御");return{attack:t,hp:n,defense:y}}getInstanceDataByNameAndOccuAndLevel(l,a,t){let n=this.playerList.find(e=>e.name===l);if(!n)throw new Error(`未找到名称为 "${l}" 的玩家`);n.changeLevelAndOccupation(t,a);let y=n.getFormula("攻击"),c=n.getFormula("生命"),i=n.getFormula("防御");return{attack:y,hp:c,defense:i}}createPlayersFromEntityArray(l){let a=[];for(var t=0;t<l.length;t++){let n=l[t],y=this.getInstanceByName(n.name);y?a.push(y):console.warn(`创建玩家实例失败: ${n.name}`)}return a}getSheetDataByPath(l){var y;let a=l.split("."),t=r.targetFolder,n;for(let c=0;c<a.length;c++){let i;if(t.isFolder){if(i=t.tree.find(e=>e.name==a[c]),!i)throw new Error("getSheetDataByPath - 路径未找到: "+a[c])}else n=t;t=i,c==a.length-1&&(n=t)}return(y=n==null?void 0:n.sheetData)==null?void 0:y.originData}}window.FxUtil=h;let L=!1;async function C(){if(L)return;const f=h.getInstance();try{const a=await(await fetch("./assets/fx.json")).json();f.loadConfig(a),L=!0}catch(l){console.error("Failed to load fx.json",l)}}async function N(f,l=50,a=1,t){const n=[],y=a+l-1;await C();const c=h.getInstance();for(let i=a;i<=y;i++){if(t&&t())return console.log("PVE simulation stopped by user"),n;await new Promise(e=>requestAnimationFrame(()=>e(!0)));try{const e=new I,u=c.getInstanceDataByNameAndOccuAndLevel("主角1",1,i),s=new F("Hero",u.hp,u.attack,u.defense,i,1),o=c.getInstanceDataByNameAndOccuAndLevel("怪物1",1,i),m=new F("Enemy",o.hp,o.attack,o.defense,i,1),d=new V(s,m,e).startBattle();let g=0,D=0;if(d.battleData&&d.battleData.length>0)for(const v of d.battleData)v.heroDamageDealt!==void 0&&(g+=v.heroDamageDealt,D++);const E=D>0?g/D:0;n.push({level:i,hp:s.currentHp,damage:E,rounds:d.rounds,battleData:d.battleData,heroName:"Hero",enemyName:"Enemy"}),f&&f(n,i,y)}catch(e){console.error(`Level ${i} battle simulation failed:`,e),n.push({level:i,hp:100,damage:20,rounds:10,battleData:[],heroName:"Hero",enemyName:"Enemy"}),f&&f(n,i,y)}}return n}export{N as generatePVEDataRange,C as initFx};
