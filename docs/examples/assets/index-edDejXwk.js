var q=Object.defineProperty;var j=(u,e,t)=>e in u?q(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var o=(u,e,t)=>j(u,typeof e!="symbol"?e+"":e,t);import{i as init,L as LinearGradient}from"./echarts-Bn9PLWWT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const O=class O{constructor(){o(this,"eventMessageList",[])}static getInstance(){return O._instance==null&&(O._instance=new O),O._instance}removeEventObject(e){const t=this.eventMessageList.indexOf(e);t!==-1&&this.eventMessageList.splice(t,1)}addEventObject(e){this.eventMessageList.indexOf(e)===-1&&this.eventMessageList.push(e)}};o(O,"_instance",null);let MessageList=O;class Call{constructor(){}static send(e,t,n){t!=null&&(t.Call_Event_type=e);for(let i=0;i<MessageList.getInstance().eventMessageList.length;i++)if(MessageList.getInstance().eventMessageList[i].getEvents(e)){const s=MessageList.getInstance().eventMessageList[i].execute(e,t);n&&n.apply([e],[s])}}}class CallCenter{constructor(){o(this,"eventsList",null);this.eventsList=null,MessageList.getInstance().addEventObject(this)}execute(e,t){return this.eventsList[e].apply([e],[t])}getEvents(e){return this.eventsList==null?!1:this.eventsList[e]!=null}addEventListener(e,t,n,i){this.eventsList==null&&(this.eventsList={}),this.eventsList[e]=t.bind(i)}dispose(){for(const e in this.eventsList)delete this.eventsList[e];this.eventsList=null}removeEventListener(e){this.eventsList!=null&&(this.eventsList[e]=null)}}class EventManager{constructor(){}}o(EventManager,"UP_DATA_PLAYER","UP_DATA_PLAYER"),o(EventManager,"CREATE_FILE_DATA","CREATE_FILE_DATA"),o(EventManager,"CREATE_OPERATION_DATA","CREATE_OPERATION_DATA"),o(EventManager,"CREATE_METADATE_DATA","CREATE_METADATE_DATA"),o(EventManager,"ADD_DATABASE_DATA","ADD_DATABASE_DATA"),o(EventManager,"ADD_OPERAND_DATA","ADD_OPERAND_DATA"),o(EventManager,"SEND_ANCHOR_FORMULA","SEND_ANCHOR_FORMULA"),o(EventManager,"SHIFT_ADD_BOOKMARK","SHIFT_ADD_BOOKMARK"),o(EventManager,"SHIFT_ADD_BOARD","SHIFT_ADD_BOARD"),o(EventManager,"SHIFT_ADD_CHARTS","SHIFT_ADD_CHARTS"),o(EventManager,"SHIFT_ADD_FORMULA","SHIFT_ADD_FORMULA"),o(EventManager,"SHIFT_ADD_FUNCTION","SHIFT_ADD_FUNCTION"),o(EventManager,"SHIFT_ADD_OPERATIONBODY","SHIFT_ADD_OPERATIONBODY"),o(EventManager,"SHIFT_ADD_VARIABLEBODY","SHIFT_ADD_VARIABLEBODY"),o(EventManager,"SHIFT_ADD_SYMBOLBODY","SHIFT_ADD_SYMBOLBODY"),o(EventManager,"SHIFT_SHOW_VIEW","SHIFT_SHOW_VIEW"),o(EventManager,"SHIFT_SHOW_VIEW_ON","SHIFT_SHOW_VIEW_ON"),o(EventManager,"SHIFT_REMOVE_BODY","SHIFT_REMOVE_BODY"),o(EventManager,"SHIFT_ADD_BODY_VIEW","SHIFT_ADD_BODY_VIEW"),o(EventManager,"SHIFT_REFRESH_LIBRARY_COORDINATES","SHIFT_REFRESH_LIBRARY_COORDINATES"),o(EventManager,"IDINDEX",1),o(EventManager,"PLAYER_INSTANCE_LEVEL_UP","PLAYER_INSTANCE_LEVEL_UP");class Folder{constructor(e=null){o(this,"name");o(this,"isFolder",!0);o(this,"isShow",!0);o(this,"isShowChild",!0);o(this,"tree",[]);o(this,"formulaTree",[]);o(this,"minArrowsView",null);o(this,"constructorName","Folder");o(this,"id");this.name=e,this.id=++EventManager.IDINDEX}setName(e){this.name=e}dispose(){this.name=null,this.isFolder=!1,this.isShowChild=!1,this.tree=[],this.formulaTree=[]}getMaxHeight(){let e=1;for(let t=0;t<this.tree.length;t++)this.tree[t].isShow&&(this.tree[t].isFolder?e+=this.tree[t].getMaxHeight():e++);return e}addTest(e){return this.tree.indexOf(e)==-1}spliceChild(e,t){this.addTest(e)&&this.tree.splice(t,0,e)}pushChild(e){this.addTest(e)&&this.tree.push(e)}unshiftChild(e){this.addTest(e)&&this.tree.unshift(e)}removeChild(e){if(!this.addTest(e)){const t=this.tree.indexOf(e);this.tree.splice(t,1)}}}class FXCentre{constructor(){o(this,"callCenter",null);fx.sceneFolder=new Folder("场景根目录"),fx.targetFolder=fx.sceneFolder,this.initEventListener()}initEventListener(){this.callCenter=new CallCenter,this.callCenter.addEventListener(fx.Eve.ADD_DATABASE_DATA,this.addDataBaseFunction,null,this),this.callCenter.addEventListener(fx.Eve.ADD_OPERAND_DATA,this.addOperandFunction.bind(this))}addBody(e,t,n){e!=null&&!e.addTest(t)&&(Call.send(fx.Eve.SHIFT_REMOVE_BODY,[t,!1],null),e.addBody(t),Call.send(fx.Eve.SHIFT_ADD_BODY_VIEW,[e,t,n],null))}addOperandFunction(e){this.addBody(e[0],e[1],e[2])}addDataBaseFunction(e){this.addData(e[0],e[1],e[2])}addData(e,t,n){t!=null&&t.typeView!=null&&(t=null),t!=null&&t.isFolder?(e.parentFolder=t,n!=null?t.spliceChild(e,n):t.pushChild(e)):t==null?(e.parentFolder=fx.targetFolder,n!=null?fx.targetFolder.spliceChild(e,n):fx.targetFolder.pushChild(e)):(e.parentFolder=t.parentFolder,e.parentFolder.spliceChild(e,t.parentFolder.tree.indexOf(t)+1))}}var NodeType=(u=>(u[u.Variable=1]="Variable",u[u.Macro=4]="Macro",u[u.CalculationLayer=5]="CalculationLayer",u.SymbolBody="SymbolBody",u.OperationBody="OperationBody",u.Bookmark="Bookmark",u[u.Sheet=11]="Sheet",u[u.LogicalBasic=12]="LogicalBasic",u[u.LogicalSlider=14]="LogicalSlider",u[u.LogicalBool=16]="LogicalBool",u))(NodeType||{});function isNumber(u){try{return!isNaN(Number(u))&&isFinite(Number(u))}catch(e){return console.error("Error checking if value is number:",e),!1}}function mix(u,e,t){try{if(!isNumber(u)||!isNumber(e)||!isNumber(t))throw new Error("Invalid parameters for mix function");return u*(1-t)+e*t}catch(n){return console.error("Error in mix function:",n),0}}const lerp=mix;function cross(u,e,t,n){try{if(!isNumber(u)||!isNumber(e)||!isNumber(t)||!isNumber(n))throw new Error("Invalid parameters for cross function");return u*t-e*n}catch(i){return console.error("Error in cross function:",i),0}}function dot(u,e,t,n){try{if(!isNumber(u)||!isNumber(e)||!isNumber(t)||!isNumber(n))throw new Error("Invalid parameters for dot function");return u*t+e*n}catch(i){return console.error("Error in dot function:",i),0}}function length(u,e){try{if(!isNumber(u)||!isNumber(e))throw new Error("Invalid parameters for length function");return Math.sqrt(u*u+e*e)}catch(t){return console.error("Error in length function:",t),0}}function distance(u,e,t,n){try{if(!isNumber(u)||!isNumber(e)||!isNumber(t)||!isNumber(n))throw new Error("Invalid parameters for distance function");const i=Math.abs(u-t),s=Math.abs(e-n);return length(i,s)}catch(i){return console.error("Error in distance function:",i),0}}function clamp(u,e,t){try{if(!isNumber(u)||!isNumber(e)||!isNumber(t))throw new Error("Invalid parameters for clamp function");return Math.max(e,Math.min(t,u))}catch(n){return console.error("Error in clamp function:",n),u}}function normalize(u,e){try{if(!isNumber(u)||!isNumber(e))throw new Error("Invalid parameters for normalize function");const t=length(u,e);return t===0?[0,0]:[u/t,e/t]}catch(t){return console.error("Error in normalize function:",t),[0,0]}}const MathUtils={isNumber,mix,lerp,cross,dot,length,distance,clamp,normalize};function getCatchValue(u,e,t,n){let i=0;try{i=u.getValue(e,t,n)}catch(s){console.log(s),i=0}return i}var CommonFunctionTypes=(u=>(u[u.abs=4]="abs",u[u.random=5]="random",u[u.floor=6]="floor",u[u.sqrt=7]="sqrt",u[u.max=8]="max",u[u.min=9]="min",u[u.pow=11]="pow",u[u.log=12]="log",u[u.exp=13]="exp",u[u.cbrt=14]="cbrt",u[u.sign=52]="sign",u[u.imul=53]="imul",u[u.ceil=54]="ceil",u[u.round=55]="round",u))(CommonFunctionTypes||{}),AlgorithmFunctionTypes=(u=>(u[u.length=56]="length",u[u.distance=57]="distance",u[u.dot=58]="dot",u[u.cross=59]="cross",u[u.mix=60]="mix",u))(AlgorithmFunctionTypes||{}),HandleFunctionTypes=(u=>(u[u["1-n"]=1]="1-n",u[u["1/n"]=2]="1/n",u[u["-n"]=3]="-n",u[u["n*2"]=15]="n*2",u[u["n/2"]=16]="n/2",u[u["n*100"]=17]="n*100",u[u["n/100"]=18]="n/100",u[u["n*n"]=19]="n*n",u[u["n/n2"]=20]="n/n2",u[u["n/(n+n2)"]=21]="n/(n+n2)",u[u["n/(n2-n)"]=22]="n/(n2-n)",u[u["(n,e).(n1,e2)."]=23]="(n,e).(n1,e2).",u[u["r(n~n2)"]=10]="r(n~n2)",u))(HandleFunctionTypes||{}),TriangleFunctionTypes=(u=>(u[u["n*pi"]=36]="n*pi",u[u.cos=37]="cos",u[u.sin=38]="sin",u[u.tan=39]="tan",u[u.acos=40]="acos",u[u.asin=41]="asin",u[u.atan=42]="atan",u[u.atan2=43]="atan2",u))(TriangleFunctionTypes||{}),LogicFunctionTypes=(u=>(u[u["if(n1>n2)return{n3!n4}"]=44]="if(n1>n2)return{n3!n4}",u[u["if(n1>=n2)return{n3!n4}"]=45]="if(n1>=n2)return{n3!n4}",u[u["if(n1<n2)return{n3!n4}"]=46]="if(n1<n2)return{n3!n4}",u[u["if(n1<=n2)return{n3!n4}"]=47]="if(n1<=n2)return{n3!n4}",u[u["if(n1==n2)return{n3!n4}"]=48]="if(n1==n2)return{n3!n4}",u[u["if(n1!=n2)return{n3!n4}"]=49]="if(n1!=n2)return{n3!n4}",u[u["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]=50]="for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}",u[u["[n]"]=51]="[n]",u))(LogicFunctionTypes||{}),CommonFormulaTypes=(u=>(u[u["攻击-防御"]=24]="攻击-防御",u[u["攻击*攻击/(攻击-防御)"]=25]="攻击*攻击/(攻击-防御)",u[u["(攻击-防御)*(攻击/防御)"]=26]="(攻击-防御)*(攻击/防御)",u[u["攻击*攻击/防御"]=27]="攻击*攻击/防御",u[u["攻击/防御"]=28]="攻击/防御",u[u["攻击*(1-系数)"]=29]="攻击*(1-系数)",u[u["护甲*系数/(1+护甲*系数)"]=30]="护甲*系数/(1+护甲*系数)",u[u["攻击*受伤率"]=31]="攻击*受伤率",u[u["攻击/(1+防御*系数)"]=32]="攻击/(1+防御*系数)",u[u["攻击/防御*系数"]=33]="攻击/防御*系数",u[u["攻击*系数/防御"]=34]="攻击*系数/防御",u[u["攻击*(系数/防御)"]=35]="攻击*(系数/防御)",u[u["(攻击-防御)*攻击-防御/(攻击/防御)"]=36]="(攻击-防御)*攻击-防御/(攻击/防御)",u))(CommonFormulaTypes||{}),GameFormula1=(u=>(u[u.战斗公式=61]="战斗公式",u))(GameFormula1||{}),GameFormula2=(u=>(u[u.人物生命=62]="人物生命",u[u.近战素质物攻=63]="近战素质物攻",u[u.远程素质物攻=64]="远程素质物攻",u[u.法师素质物攻=65]="法师素质物攻",u[u.物防=66]="物防",u[u.魔防=67]="魔防",u[u.命中=68]="命中",u[u.闪避=69]="闪避",u[u.暴击=70]="暴击",u[u.抗暴=71]="抗暴",u[u.职业素质点成长=72]="职业素质点成长",u[u.最终近战物攻=73]="最终近战物攻",u[u.最终远程物攻=74]="最终远程物攻",u[u.最终魔法攻击=75]="最终魔法攻击",u[u.物理伤害=76]="物理伤害",u[u.魔法伤害=77]="魔法伤害",u[u.命中率=78]="命中率",u[u.暴击率=79]="暴击率",u))(GameFormula2||{}),GameFormula3=(u=>(u[u.成长公式=80]="成长公式",u))(GameFormula3||{});class BasicBody{constructor(){o(this,"tree",[]);o(this,"parent",null);o(this,"type","BasicBody");o(this,"isWeight",!1);o(this,"value",null);o(this,"isAdvance",!1);o(this,"isBindingOperation",!1);o(this,"isBindingFormula",!1);o(this,"formulaTextValue","");o(this,"formulaTextCharacter","");o(this,"operationalLogicText","");o(this,"cacheElementValue",null);o(this,"funcType",0);o(this,"constructorName","BasicBody");o(this,"id");o(this,"typetype",null);o(this,"operator",null);o(this,"indexex",0);o(this,"isFunction",!1);o(this,"x",0);o(this,"y",0);this.id=++EventManager.IDINDEX}addTest(e){return this.tree.includes(e)?!0:this.tree.some(t=>t instanceof fx.BasicBody&&t.addTest(e))}replace(e,t){this.tree[t]=e,e.parent=this}deletebody(e){const t=this.tree.indexOf(e);t!==-1&&(this.tree.splice(t,1),e.parent=null)}addBody(e){this.tree.includes(e)||(e.parent=this,this.tree.push(e))}getDeleteBodyTree(e){const t=this.tree.indexOf(e);if(t===-1)return[];const n=this.tree.slice(t);return this.tree.splice(t),n}dispose(){this.tree.forEach(e=>{e&&typeof e.dispose=="function"&&e.dispose()}),this.tree=[],this.value=null,this.parent=null,this.typetype=null,this.cacheElementValue=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.isWeight=!1,this.isAdvance=!1,this.isBindingOperation=!1,this.isBindingFormula=!1,this.isFunction=!1}getMaxHeight(){return this.tree.filter(t=>t instanceof fx.BasicBody).reduce((t,n)=>t+n.getMaxHeight(),0)||1}getValue(e,t,n){if(this.resetValues(),!!this.tree)return this.processTreeValues(),this.calculateFinalValue(),this.value=this.applyFunction(this.value),this.value}resetValues(){this.value=null,this.formulaTextValue="",this.formulaTextCharacter="",this.operationalLogicText="",this.cacheElementValue=null}processTreeValues(){for(const e of this.tree){const t=this.getNodeValue(e);this.updateOperationalLogic(e,t),this.updateFormulaTexts(e,t)}}getNodeValue(e){if(e.type===NodeType.Sheet){const{name:t,row:n,col:i}=(e==null?void 0:e.selectedOutputInfo)||{};return getCatchValue(e,t,n,i)}return e.type===NodeType.CalculationLayer,getCatchValue(e)}updateOperationalLogic(e,t){var n;(n=this.cacheElementValue)!=null&&n.operator&&(this.operationalLogicText+=`(${t})`),this.cacheElementValue||(this.cacheElementValue=e,this.operationalLogicText+=`(${t})`),e.operator&&(this.operationalLogicText+=e.operator)}updateFormulaTexts(e,t){[0,NodeType.Variable,2,3,NodeType.Macro,NodeType.CalculationLayer,NodeType.Sheet].includes(e.type)&&(this.formulaTextCharacter+=e.getFormulaTextCharacter(),this.formulaTextValue+=t,e.operator&&(this.formulaTextValue+=e.operator,this.formulaTextCharacter+=e.operator))}calculateFinalValue(){const e=this.formulaTextValue.slice(-1);["+","-","*","/","%",">",">=","<","<=","!="].includes(e)||(this.value=fx.eval(this.operationalLogicText)),isNaN(this.value)?this.value=this.operationalLogicText:this.value=Number(this.value)}applyFunction(e){return this.returnFunc(e)}returnFunc(e){const n=this.getFunctionHandlers()[this.funcType];return n?n(e,this.tree):e}getFunctionHandlers(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>1-e,[HandleFunctionTypes["1/n"]]:e=>1/e,[HandleFunctionTypes["-n"]]:e=>-e,[HandleFunctionTypes["n*2"]]:e=>e*2,[HandleFunctionTypes["n/2"]]:e=>e/2,[HandleFunctionTypes["n*100"]]:e=>e*100,[HandleFunctionTypes["n/100"]]:e=>e/100,[HandleFunctionTypes["n*n"]]:e=>e*e,[CommonFunctionTypes.abs]:e=>Math.abs(e),[CommonFunctionTypes.random]:e=>Math.random()*e,[CommonFunctionTypes.floor]:e=>Math.floor(e),[CommonFunctionTypes.sqrt]:e=>Math.sqrt(e),[CommonFunctionTypes.max]:(e,t)=>this.calculateMax(t),[CommonFunctionTypes.min]:(e,t)=>this.calculateMin(t),[CommonFunctionTypes.pow]:(e,t)=>this.calculatePower(t),[CommonFunctionTypes.log]:e=>Math.log(e),[CommonFunctionTypes.exp]:e=>Math.exp(e),[CommonFunctionTypes.cbrt]:e=>Math.cbrt(e),[CommonFunctionTypes.sign]:e=>Math.sign(e),[CommonFunctionTypes.imul]:e=>Math.imul(e,1),[CommonFunctionTypes.ceil]:e=>Math.ceil(e),[CommonFunctionTypes.round]:e=>Math.round(e),[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.calculateRandom(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.divideValues(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.divideBySum(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.divideByDifference(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.weightedRandom(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.attackMinusDefense(t),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.attackSquaredOverDiff(t),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.diffTimesRatio(t),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.attackSquaredOverDefense(t),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.attackOverDefense(t),[CommonFormulaTypes["攻击*(1-系数)"]]:(e,t)=>this.attackWithCoefficient(t),[CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]]:(e,t)=>this.armorFormula(t),[CommonFormulaTypes["攻击*受伤率"]]:(e,t)=>this.attackWithDamageRate(t),[CommonFormulaTypes["攻击/(1+防御*系数)"]]:(e,t)=>this.attackOverDefenseFormula(t),[CommonFormulaTypes["攻击/防御*系数"]]:(e,t)=>this.attackRatioWithCoef(t),[CommonFormulaTypes["攻击*系数/防御"]]:(e,t)=>this.attackCoefOverDefense(t),[CommonFormulaTypes["攻击*(系数/防御)"]]:(e,t)=>this.attackTimesCoefRatio(t),[TriangleFunctionTypes["n*pi"]]:e=>e*Math.PI,[TriangleFunctionTypes.cos]:e=>Math.cos(e),[TriangleFunctionTypes.sin]:e=>Math.sin(e),[TriangleFunctionTypes.tan]:e=>Math.tan(e),[TriangleFunctionTypes.acos]:e=>Math.acos(e),[TriangleFunctionTypes.asin]:e=>Math.asin(e),[TriangleFunctionTypes.atan]:e=>Math.atan(e),[TriangleFunctionTypes.atan2]:(e,t)=>this.calculateAtan2(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.ifGreater(t),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.ifGreaterEqual(t),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.ifLess(t),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.ifLessEqual(t),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.ifEqual(t),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.ifNotEqual(t),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.forLoop(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.arrayAccess(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.calculateLength(t),[AlgorithmFunctionTypes.distance]:(e,t)=>this.calculateDistance(t),[AlgorithmFunctionTypes.dot]:(e,t)=>this.calculateDot(t),[AlgorithmFunctionTypes.cross]:(e,t)=>this.calculateCross(t),[AlgorithmFunctionTypes.mix]:(e,t)=>this.calculateMix(t),[GameFormula1.战斗公式]:(e,t)=>this.battleFormula(t),[GameFormula2.人物生命]:(e,t)=>this.characterHealth(t),[GameFormula2.近战素质物攻]:(e,t)=>this.meleeAttack(t),[GameFormula2.远程素质物攻]:(e,t)=>this.rangedAttack(t),[GameFormula2.法师素质物攻]:(e,t)=>this.mageAttack(t),[GameFormula2.物防]:(e,t)=>this.physicalDefense(t),[GameFormula2.魔防]:(e,t)=>this.magicDefense(t),[GameFormula2.命中]:(e,t)=>this.hitRate(t),[GameFormula2.闪避]:(e,t)=>this.dodgeRate(t),[GameFormula2.暴击]:e=>1+e/3,[GameFormula2.抗暴]:e=>1+e/5,[GameFormula2.职业素质点成长]:(e,t)=>this.jobPointGrowth(t),[GameFormula2.最终近战物攻]:(e,t)=>this.finalMeleeAttack(t),[GameFormula2.最终远程物攻]:(e,t)=>this.finalRangedAttack(t),[GameFormula2.最终魔法攻击]:(e,t)=>this.finalMagicAttack(t),[GameFormula2.物理伤害]:(e,t)=>this.physicalDamage(t),[GameFormula2.魔法伤害]:(e,t)=>this.magicDamage(t),[GameFormula2.命中率]:(e,t)=>this.hitChance(t),[GameFormula2.暴击率]:(e,t)=>this.critChance(t),[GameFormula3.成长公式]:(e,t)=>this.growthFormula(t)}}getTreeValue(e,t){return e.length>t?Number(getCatchValue(e[t])):0}calculateMax(e){const t=e.map(n=>Number(getCatchValue(n)));return Math.max(...t)}calculateMin(e){const t=e.map(n=>Number(getCatchValue(n)));return Math.min(...t)}calculatePower(e){return e.length<2?0:Math.pow(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateRandom(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return Math.random()*(n-t)+t}divideValues(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}divideBySum(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t/(t+n)}divideByDifference(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t/(n-t)}weightedRandom(e){if(e.length%2!==0)return 0;let t=0;for(let i=1;i<e.length;i+=2){const s=this.getTreeValue(e,i);e[i].indexex=s+t,t+=s}const n=Math.random()*t;for(let i=1;i<e.length;i+=2){const s=i>1&&e[i-2].indexex||0,r=e[i].indexex||0;if(n>=s&&n<r)return this.getTreeValue(e,i-1)}return 0}attackMinusDefense(e){return e.length<2?0:this.getTreeValue(e,0)-this.getTreeValue(e,1)}attackSquaredOverDiff(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*t/(t+n)}diffTimesRatio(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n)*(t/n)}attackSquaredOverDefense(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*t/n}attackOverDefense(e){return e.length<2?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)}attackWithCoefficient(e){return e.length<2?0:this.getTreeValue(e,0)*(1-this.getTreeValue(e,1))}armorFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*n/(1+t*n)}attackWithDamageRate(e){return e.length<2?0:this.getTreeValue(e,0)*this.getTreeValue(e,1)}attackOverDefenseFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2);return t/(1+n*i)}attackRatioWithCoef(e){return e.length<3?0:this.getTreeValue(e,0)/this.getTreeValue(e,1)*this.getTreeValue(e,2)}attackCoefOverDefense(e){return e.length<3?0:this.getTreeValue(e,0)*this.getTreeValue(e,2)/this.getTreeValue(e,1)}attackTimesCoefRatio(e){return e.length<3?0:this.getTreeValue(e,0)*(this.getTreeValue(e,2)/this.getTreeValue(e,1))}calculateAtan2(e){return e.length<2?0:Math.atan2(this.getTreeValue(e,0),this.getTreeValue(e,1))}ifGreater(e){return e.length<4?0:this.getTreeValue(e,0)>this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifGreaterEqual(e){return e.length<4?0:this.getTreeValue(e,0)>=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLess(e){return e.length<4?0:this.getTreeValue(e,0)<this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifLessEqual(e){return e.length<4?0:this.getTreeValue(e,0)<=this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifEqual(e){return e.length<4?0:this.getTreeValue(e,0)===this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}ifNotEqual(e){return e.length<4?0:this.getTreeValue(e,0)!==this.getTreeValue(e,1)?this.getTreeValue(e,2):this.getTreeValue(e,3)}forLoop(e){if(e.length<4)return 0;let t=0,n=0;const i=this.getTreeValue(e,0),s=this.getTreeValue(e,1),r=this.getTreeValue(e,2),c=this.getTreeValue(e,3);for(let l=i;l<=s;l++)l%r===1&&t++,n+=t+c;return n}arrayAccess(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0);return this.getTreeValue(e,t)}calculateLength(e){return e.length<2?0:fx.length(this.getTreeValue(e,0),this.getTreeValue(e,1))}calculateDistance(e){return e.length<4?0:fx.distance(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateDot(e){return e.length<4?0:fx.dot(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateCross(e){return e.length<4?0:fx.cross(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2),this.getTreeValue(e,3))}calculateMix(e){return e.length<3?0:fx.mix(this.getTreeValue(e,0),this.getTreeValue(e,1),this.getTreeValue(e,2))}battleFormula(e){if(e.length<3)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2);return t*i*(1-1/(1+t*i/(5*n)))}characterHealth(e){if(e.length<4)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3);return t+i*n+s*(1+n)*n/2}meleeAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3),r=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+n/5+i/5+r*s}rangedAttack(e){if(e.length<5)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3),r=this.getTreeValue(e,4);return t*2+Math.pow(t/10,2)+n/5+i/5+r*s}mageAttack(e){if(e.length<1)return 0;const t=this.getTreeValue(e,0);return t*2+Math.pow(t/10,2)}physicalDefense(e){return this.value}magicDefense(e){return this.value}hitRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}dodgeRate(e){return e.length<2?0:this.getTreeValue(e,0)+this.getTreeValue(e,1)}jobPointGrowth(e){return e.length<2?0:1+this.getTreeValue(e,0)/this.getTreeValue(e,1)}finalMeleeAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3),r=this.getTreeValue(e,4),c=this.getTreeValue(e,5),l=this.getTreeValue(e,6),h=this.getTreeValue(e,7);return(t*7+t/5+n/5+i/5+s+(s+r)*c)*l*h}finalRangedAttack(e){if(e.length<8)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3),r=this.getTreeValue(e,4),c=this.getTreeValue(e,5),l=this.getTreeValue(e,6),h=this.getTreeValue(e,7);return(t*5+t/5+n/5+i/5+s+(s+r)*c)*l*h}finalMagicAttack(e){if(e.length<6)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1),i=this.getTreeValue(e,2),s=this.getTreeValue(e,3),r=this.getTreeValue(e,4),c=this.getTreeValue(e,5);return(t*7+t/5+n+(n+i)*s)*r*c}physicalDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*(4e3+n)/(4e3+n*10)}magicDamage(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return t*(1e3+n)/(1e3+n*10)}hitChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n+80)/100}critChance(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-n)/100}growthFormula(e){if(e.length<2)return 0;const t=this.getTreeValue(e,0),n=this.getTreeValue(e,1);return(t-1)*n}getFormulaTextValueBody(){const t=this.getFormulaTextBuilders()[this.funcType];return t?t(this.formulaTextValue,this.tree):this.formulaTextValue}getFormulaTextBuilders(){return{0:e=>e,[HandleFunctionTypes["1-n"]]:e=>`(1-(${e}))`,[HandleFunctionTypes["1/n"]]:e=>`1/(${e})`,[HandleFunctionTypes["-n"]]:e=>`-(${e})`,[HandleFunctionTypes["n*2"]]:e=>`(${e})*2`,[HandleFunctionTypes["n/2"]]:e=>`(${e})/2`,[HandleFunctionTypes["n*100"]]:e=>`(${e})*100`,[HandleFunctionTypes["n/100"]]:e=>`(${e})/100`,[HandleFunctionTypes["n*n"]]:e=>`(${e})*(${e})`,[CommonFunctionTypes.abs]:e=>`abs(${e})`,[CommonFunctionTypes.random]:e=>`random()*(${e})`,[CommonFunctionTypes.floor]:e=>`floor(${e})`,[CommonFunctionTypes.sqrt]:e=>`sqrt(${e})`,[CommonFunctionTypes.max]:(e,t)=>this.buildMaxText(t),[CommonFunctionTypes.min]:(e,t)=>this.buildMinText(t),[CommonFunctionTypes.pow]:(e,t)=>this.buildPowerText(t),[CommonFunctionTypes.log]:e=>`log(${e})`,[CommonFunctionTypes.exp]:e=>`exp(${e})`,[CommonFunctionTypes.cbrt]:e=>`cbrt(${e})`,[CommonFunctionTypes.sign]:e=>`sign(${e})`,[CommonFunctionTypes.imul]:e=>`imul(${e})`,[CommonFunctionTypes.ceil]:e=>`ceil(${e})`,[CommonFunctionTypes.round]:e=>`round(${e})`,[HandleFunctionTypes["r(n~n2)"]]:(e,t)=>this.buildRandomRangeText(t),[HandleFunctionTypes["n/n2"]]:(e,t)=>this.buildDivisionText(t),[HandleFunctionTypes["n/(n+n2)"]]:(e,t)=>this.buildDivisionSumText(t),[HandleFunctionTypes["n/(n2-n)"]]:(e,t)=>this.buildDivisionDiffText(t),[HandleFunctionTypes["(n,e).(n1,e2)."]]:(e,t)=>this.buildWeightedText(t),[CommonFormulaTypes["攻击-防御"]]:(e,t)=>this.buildAttackDefenseText(t,"-"),[CommonFormulaTypes["攻击*攻击/(攻击-防御)"]]:(e,t)=>this.buildComplexAttackText(t,1),[CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]]:(e,t)=>this.buildComplexAttackText(t,2),[CommonFormulaTypes["攻击*攻击/防御"]]:(e,t)=>this.buildComplexAttackText(t,3),[CommonFormulaTypes["攻击/防御"]]:(e,t)=>this.buildAttackDefenseText(t,"/"),[TriangleFunctionTypes["n*pi"]]:e=>`(${e})*PI`,[TriangleFunctionTypes.cos]:e=>`cos(${e})`,[TriangleFunctionTypes.sin]:e=>`sin(${e})`,[TriangleFunctionTypes.tan]:e=>`tan(${e})`,[TriangleFunctionTypes.acos]:e=>`acos(${e})`,[TriangleFunctionTypes.asin]:e=>`asin(${e})`,[TriangleFunctionTypes.atan]:e=>`atan(${e})`,[TriangleFunctionTypes.atan2]:(e,t)=>this.buildAtan2Text(t),[LogicFunctionTypes["if(n1>n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">"),[LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,">="),[LogicFunctionTypes["if(n1<n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<"),[LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"<="),[LogicFunctionTypes["if(n1==n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"=="),[LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]]:(e,t)=>this.buildIfText(t,"!="),[LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]]:(e,t)=>this.buildForLoopText(t),[LogicFunctionTypes["[n]"]]:(e,t)=>this.buildArrayAccessText(t),[AlgorithmFunctionTypes.length]:(e,t)=>this.buildAlgorithmText(t,"length"),[AlgorithmFunctionTypes.distance]:(e,t)=>this.buildAlgorithmText(t,"distance"),[AlgorithmFunctionTypes.dot]:(e,t)=>this.buildAlgorithmText(t,"dot"),[AlgorithmFunctionTypes.cross]:(e,t)=>this.buildAlgorithmText(t,"cross"),[AlgorithmFunctionTypes.mix]:(e,t)=>this.buildMixText(t),[GameFormula1.战斗公式]:(e,t)=>this.buildBattleFormulaText(t),[GameFormula2.人物生命]:(e,t)=>this.buildCharacterHealthText(t),[GameFormula2.近战素质物攻]:(e,t)=>this.buildMeleeAttackText(t),[GameFormula2.远程素质物攻]:(e,t)=>this.buildRangedAttackText(t),[GameFormula2.法师素质物攻]:(e,t)=>this.buildMageAttackText(t),[GameFormula2.物理伤害]:(e,t)=>this.buildPhysicalDamageText(t),[GameFormula2.魔法伤害]:(e,t)=>this.buildMagicDamageText(t),[GameFormula2.命中率]:(e,t)=>this.buildHitChanceText(t),[GameFormula2.暴击率]:(e,t)=>this.buildCritChanceText(t),[GameFormula3.成长公式]:(e,t)=>this.buildGrowthText(t)}}buildMaxText(e){return`max(${e.map(n=>n.getFormulaTextValue()).join(",")})`}buildMinText(e){return`min(${e.map(n=>n.getFormulaTextValue()).join(",")})`}buildPowerText(e){return e.length<2?"参数不匹配,请输入[值,值]":`pow(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildRandomRangeText(e){if(e.length<2)return"参数不匹配,请输入[最小值,最大值]";const t=e[0].getFormulaTextValue();return`random()*(${e[1].getFormulaTextValue()}-${t})+${t}`}buildDivisionText(e){return e.length<2?"参数不匹配,请输入[值,值]":`(${e[0].getFormulaTextValue()})/(${e[1].getFormulaTextValue()})`}buildDivisionSumText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),n=e[1].getFormulaTextValue();return`${t}/(${t}+${n})`}buildDivisionDiffText(e){if(e.length<2)return"参数不匹配,请输入[值,值]";const t=e[0].getFormulaTextValue(),n=e[1].getFormulaTextValue();return`${t}/(${n}-${t})`}buildWeightedText(e){if(e.length%2!==0)return"参数不匹配,请输入[值,权重]";const t=[];for(let n=0;n<e.length;n+=2)t.push(`[值:${e[n].getFormulaTextValue()},权重:${e[n+1].getFormulaTextValue()}]`);return t.join(",")}buildAttackDefenseText(e,t){return e.length<2?"参数不匹配,请输入[攻击,防御]":`${e[0].getFormulaTextValue()}${t}${e[1].getFormulaTextValue()}`}buildComplexAttackText(e,t){if(e.length<2)return"参数不匹配,请输入[攻击,防御]";const n=e[0].getFormulaTextValue(),i=e[1].getFormulaTextValue();switch(t){case 1:return`${n}*${n}/(${n}+${i})`;case 2:return`(${n}-${i})*(${n}/${i})`;case 3:return`${n}*${n}/${i}`;default:return""}}buildAtan2Text(e){return e.length<2?"参数不匹配,请输入[值,值]":`atan2(${e[0].getFormulaTextValue()},${e[1].getFormulaTextValue()})`}buildIfText(e,t){if(e.length<4)return"参数不匹配,请输入[值,值,值,值]";const[n,i,s,r]=e.map(c=>c.getFormulaTextValue());return`if(${n}${t}${i}){return ${s}}else{return ${r}}`}buildForLoopText(e){if(e.length<4)return"参数不匹配,请输入[初始等级,当前等级,间隔值,初始值]";const[t,n,i,s]=e.map(r=>r.getFormulaTextValue());return`for(var i=${t};i<=${n};i++){if(i%${i}==1){a++}c+=a+${s}}`}buildArrayAccessText(e){return e.length<2?"参数不匹配,请输入下标和数组":`[${e[0].getFormulaTextValue()}]`}buildAlgorithmText(e,t){const n=t==="mix"?3:4,i=t==="mix"?"[值1,值2,混合比例]":"[x1,y1,x2,y2]";if(e.length<n)return`参数不匹配,请输入${i}`;const s=e.slice(0,n).map(r=>r.getFormulaTextValue()).join(",");return`${t}(${s})`}buildMixText(e){return e.length<3?"参数不匹配,请输入[值1,值2,混合比例]":`mix(${e.slice(0,3).map(n=>n.getFormulaTextValue()).join(",")})`}buildBattleFormulaText(e){if(e.length<3)return"参数不匹配,请输入[攻击,防御,技能系数]";const[t,n,i]=e.map(s=>s.getFormulaTextValue());return`${t}*${i}*(1-(1/(1+((${t}*${i})/(5*${n})))))`}buildCharacterHealthText(e){if(e.length<4)return"参数不匹配,请输入[基础生命,等级,职业系数A,职业系数B]";const[t,n,i,s]=e.map(r=>r.getFormulaTextValue());return`${t}+${i}*${n}+${s}*(1+${n})*${n}/2`}buildMeleeAttackText(e){if(e.length<5)return"参数不匹配,请输入[力量,灵巧,幸运,等级,职业攻击系数]";const[t,n,i,s,r]=e.map(c=>c.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${n}/5+${i}/5+${r}*${s}`}buildRangedAttackText(e){if(e.length<5)return"参数不匹配,请输入[灵巧,力量,幸运,等级,职业攻击系数]";const[t,n,i,s,r]=e.map(c=>c.getFormulaTextValue());return`${t}*2+pow((${t}/10),2)+${n}/5+${i}/5+${r}*${s}`}buildMageAttackText(e){if(e.length<1)return"参数不匹配,请输入[力量]";const t=e[0].getFormulaTextValue();return`${t}*2+pow(${t}/10,2)`}buildPhysicalDamageText(e){if(e.length<2)return"参数不匹配,请输入[物攻,物防]";const[t,n]=e.map(i=>i.getFormulaTextValue());return`${t}*(4000+${n})/(4000+(${n}*10))`}buildMagicDamageText(e){if(e.length<2)return"参数不匹配,请输入[魔攻,魔防]";const[t,n]=e.map(i=>i.getFormulaTextValue());return`${t}*(1000+${n})/(1000+(${n}*10))`}buildHitChanceText(e){if(e.length<2)return"参数不匹配,请输入[命中,闪避]";const[t,n]=e.map(i=>i.getFormulaTextValue());return`(${t}-${n}+80)/100`}buildCritChanceText(e){if(e.length<2)return"参数不匹配,请输入[暴击,抗暴]";const[t,n]=e.map(i=>i.getFormulaTextValue());return`(${t}-${n})/100`}buildGrowthText(e){if(e.length<2)return"参数不匹配,请输入[等级,属性成长值]";const[t,n]=e.map(i=>i.getFormulaTextValue());return`(${t}-1)*${n}`}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){return this.formulaTextCharacter}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}}const getGlobalThis=()=>typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof self<"u"?self:{};class VariableValue extends BasicBody{constructor(e,t,n=null,i=null){super();o(this,"name");o(this,"TID");o(this,"value",0);o(this,"selectedOutputInfo",0);o(this,"type");o(this,"isAI",!1);o(this,"macros","");o(this,"sheetData",null);o(this,"snNo",1);o(this,"isLogicalOpen",!1);o(this,"isDragging",!1);o(this,"logicalNumberList",[]);o(this,"currentStep",0);o(this,"minValue",1);o(this,"maxValue",100);o(this,"step",10);o(this,"childCell");o(this,"childArray",[]);o(this,"childBodyArray",[]);o(this,"logicalChildArray",[]);o(this,"view",null);o(this,"body",null);o(this,"tag",null);o(this,"enemyBody",null);o(this,"enemyFlag",!1);o(this,"statistics",0);o(this,"absoluteAddress",null);o(this,"site",null);o(this,"source",null);o(this,"captureCrit",!0);o(this,"upDateValue",1);o(this,"demoteValue",0);o(this,"historyTarget",null);o(this,"isSystemShow",!1);o(this,"constructorName","VariableValue");this.name=e,this.value=t,this.type=n,this.id=++EventManager.IDINDEX,this.operator=i}setMacros(e){this.macros=e,this.getValue()}setGlobalValue(e){this.source!=null&&this.source.setValue(e)}setValue(e){this.type!==NodeType.Sheet&&(this.value=e,this.upDataChild(),this.type===NodeType.Variable&&fx.code===!1&&this.updateVariableDisplay(e))}updateVariableDisplay(e){var i,s;const t=(i=fx.getDataById)==null?void 0:i.call(fx,this.id),n=(s=fx.getTreeDataById)==null?void 0:s.call(fx,this.id);if(t&&n){const r=getGlobalThis();if(r.window&&!r.window.updatingSheeData){const c=`componentDatas.nodeList.props.tree.props.dataSource.${n.dataPath}.showName`;r.window.set_data(r.window.store,c,`${this.name}=${e}`)}}}addNumberList(){this.logicalNumberList.push({value:""})}changeNumberListItem(e,t){this.logicalNumberList[e].value=t}getIsFunction(){return this.type===NodeType.Macro}getRessSring(e){const t=[];return fx.getStepData(e,t),t.join("")}setEnemyBody(e){this.enemyBody=e}setSheetData(e){this.sheetData=new fx.SheetData(e),this.getValue(),this.upDataChild()}getValue(e,t,n){if(this.type!==NodeType.Variable&&this.enemyFlag&&fx.enemyBody!=null)return this.value=getCatchValue(fx.enemyBody.getPropertyObject(this.source.absoluteAddress)),this.returnFunc(this.value);switch(this.type){case NodeType.Macro:return this.getMacroValue();case NodeType.Sheet:return this.getSheetValue(e,t,n);case NodeType.LogicalNumberList:return this.getLogicalNumberListValue();case NodeType.LogicalSlider:return this.getLogicalSliderValue();case NodeType.LogicalList:case NodeType.LogicalBasic:return this.getLogicalValue();case NodeType.CalculationLayer:return this.getCalculationLayerValue();default:return this.getDefaultValue()}}getMacroValue(){try{if(this.historyTarget=globalThis.target,globalThis.target=this,this.macros==="")return this.value=0,this.returnFunc(this.value);if(fx.code)this.value=new Function(`return ${fx["f_"+this.TID].fun.replace(/[\r\n\s]/g,"")}`)();else try{this.value=eval(this.macros)}catch(e){this.value=0}return globalThis.target=this.historyTarget,isNaN(this.value)||(this.value=fx.double(this.value,4)),this.returnFunc(this.value)}catch(e){return this.value=0,this.value}}getSheetValue(e,t,n){var i,s,r;return this.value=((s=(i=this.source)==null?void 0:i.sheetData)==null?void 0:s.getValue(e,t,n))||((r=this.sheetData)==null?void 0:r.getValue(e,t,n))||0,this.returnFunc(this.value)}getLogicalNumberListValue(){const e=this.getNumberListValue();if(typeof e=="string"&&e.startsWith("[")){const t=JSON.parse(e),n=Math.floor(Math.random()*(t[1]-t[0]+1))+t[0];this.value=n}else this.value=Number(e);return this.returnFunc(this.value)}getNumberListValue(){return typeof this.snNo=="number"&&this.logicalNumberList.length&&this.snNo<=this.logicalNumberList.length&&this.logicalNumberList[this.snNo-1].value||0}getLogicalSliderValue(){const e=this.currentStep*this.step;return this.value=Math.max(this.minValue,Math.min(e,this.maxValue)),this.returnFunc(this.value)}getLogicalValue(){const e=this.logicalChildArray[this.snNo-1];return this.value=e?e.getValue():0,this.returnFunc(this.value)}getCalculationLayerValue(){var n;const e=(n=this.source)==null?void 0:n.body,t=this.body;return e?this.value=getCatchValue(e):t&&(this.value=getCatchValue(t)),isNaN(this.value)||(this.value=Number(fx.double(this.value,4))),this.returnFunc(this.value)}getDefaultValue(){return this.value||(this.value=0),isNaN(this.value)||(this.value=Number(this.value)),this.returnFunc(this.value)}returnFunc(e){return this.funcType===0?e:this.funcType>=HandleFunctionTypes["1-n"]&&this.funcType<=HandleFunctionTypes["(n,e).(n1,e2)."]?this.handleFunction(e):this.funcType>=CommonFormulaTypes["攻击-防御"]&&this.funcType<=35?this.commonFormulaFunction():this.funcType>=TriangleFunctionTypes["n*pi"]&&this.funcType<=TriangleFunctionTypes.atan2?this.triangleFunction(e):this.funcType>=LogicFunctionTypes["if(n1>n2)return{n3!n4}"]&&this.funcType<=LogicFunctionTypes["[n]"]?this.logicFunction():this.funcType>=CommonFunctionTypes.abs&&this.funcType<=CommonFunctionTypes.cbrt||this.funcType>=CommonFunctionTypes.sign&&this.funcType<=CommonFunctionTypes.round?this.commonFunction(e):this.funcType>=AlgorithmFunctionTypes.length&&this.funcType<=60?this.algorithmFunction():this.funcType>=GameFormula1.战斗公式&&this.funcType<=68?this.gameFormulaFunction():e}handleFunction(e){switch(this.funcType){case HandleFunctionTypes["1-n"]:return 1-e;case HandleFunctionTypes["1/n"]:return 1/e;case HandleFunctionTypes["-n"]:return-e;case HandleFunctionTypes["n*2"]:return e*2;case HandleFunctionTypes["n/2"]:return e/2;case HandleFunctionTypes["n*100"]:return e*100;case HandleFunctionTypes["n/100"]:return e/100;case HandleFunctionTypes["n*n"]:return e*e;case HandleFunctionTypes["n/n2"]:return this.divideValues(this.tree);case HandleFunctionTypes["n/(n+n2)"]:return this.divideBySum(this.tree);case HandleFunctionTypes["n/(n2-n)"]:return this.divideByDifference(this.tree);case HandleFunctionTypes["(n,e).(n1,e2)."]:return this.weightedRandom(this.tree);case HandleFunctionTypes["r(n~n2)"]:return this.calculateRandom(this.tree);default:return e}}commonFormulaFunction(){switch(this.funcType){case CommonFormulaTypes["攻击-防御"]:return this.attackMinusDefense(this.tree);case CommonFormulaTypes["攻击*攻击/(攻击-防御)"]:return this.attackSquaredOverDiff(this.tree);case CommonFormulaTypes["(攻击-防御)*(攻击/防御)"]:return this.diffTimesRatio(this.tree);case CommonFormulaTypes["攻击*攻击/防御"]:return this.attackSquaredOverDefense(this.tree);case CommonFormulaTypes["攻击/防御"]:return this.attackOverDefense(this.tree);case CommonFormulaTypes["攻击*(1-系数)"]:return this.attackWithCoefficient(this.tree);case CommonFormulaTypes["护甲*系数/(1+护甲*系数)"]:return this.armorFormula(this.tree);case CommonFormulaTypes["攻击*受伤率"]:return this.attackWithDamageRate(this.tree);case CommonFormulaTypes["攻击/(1+防御*系数)"]:return this.attackOverDefenseFormula(this.tree);case CommonFormulaTypes["攻击/防御*系数"]:return this.attackRatioWithCoef(this.tree);case CommonFormulaTypes["攻击*系数/防御"]:return this.attackCoefOverDefense(this.tree);case CommonFormulaTypes["攻击*(系数/防御)"]:return this.attackTimesCoefRatio(this.tree);default:return 0}}triangleFunction(e){switch(this.funcType){case TriangleFunctionTypes["n*pi"]:return e*Math.PI;case TriangleFunctionTypes.cos:return Math.cos(e);case TriangleFunctionTypes.sin:return Math.sin(e);case TriangleFunctionTypes.tan:return Math.tan(e);case TriangleFunctionTypes.acos:return Math.acos(e);case TriangleFunctionTypes.asin:return Math.asin(e);case TriangleFunctionTypes.atan:return Math.atan(e);case TriangleFunctionTypes.atan2:return this.calculateAtan2(this.tree);default:return e}}logicFunction(){if(this.tree.length<4&&this.funcType!==LogicFunctionTypes["[n]"]&&this.funcType!==50)return 0;switch(this.funcType){case LogicFunctionTypes["if(n1>n2)return{n3!n4}"]:return this.ifGreater(this.tree);case LogicFunctionTypes["if(n1>=n2)return{n3!n4}"]:return this.ifGreaterEqual(this.tree);case LogicFunctionTypes["if(n1<n2)return{n3!n4}"]:return this.ifLess(this.tree);case LogicFunctionTypes["if(n1<=n2)return{n3!n4}"]:return this.ifLessEqual(this.tree);case LogicFunctionTypes["if(n1==n2)return{n3!n4}"]:return this.ifEqual(this.tree);case LogicFunctionTypes["if(n1!=n2)return{n3!n4}"]:return this.ifNotEqual(this.tree);case LogicFunctionTypes["for(var i=n;i<=n2;i++){if(i%n3==1){a++}c+=a+n4}"]:return this.forLoop(this.tree);case LogicFunctionTypes["[n]"]:return this.arrayAccess(this.tree);default:return 0}}commonFunction(e){switch(this.funcType){case CommonFunctionTypes.abs:return Math.abs(e);case CommonFunctionTypes.random:return Math.random()*e;case CommonFunctionTypes.floor:return Math.floor(e);case CommonFunctionTypes.sqrt:return Math.sqrt(e);case CommonFunctionTypes.max:return this.calculateMax(this.tree);case CommonFunctionTypes.min:return this.calculateMin(this.tree);case CommonFunctionTypes.pow:return this.calculatePower(this.tree);case CommonFunctionTypes.log:return Math.log(e);case CommonFunctionTypes.exp:return Math.exp(e);case CommonFunctionTypes.cbrt:return Math.cbrt(e);case CommonFunctionTypes.sign:return Math.sign(e);case CommonFunctionTypes.imul:return Math.imul(e,1);case CommonFunctionTypes.ceil:return Math.ceil(e);case CommonFunctionTypes.round:return Math.round(e);default:return e}}algorithmFunction(){switch(this.funcType){case AlgorithmFunctionTypes.length:return this.calculateLength(this.tree);case AlgorithmFunctionTypes.distance:return this.calculateDistance(this.tree);case AlgorithmFunctionTypes.dot:return this.calculateDot(this.tree);case AlgorithmFunctionTypes.cross:return this.calculateCross(this.tree);case AlgorithmFunctionTypes.mix:return this.calculateMix(this.tree);default:return 0}}gameFormulaFunction(){switch(this.funcType){case GameFormula1.战斗公式:return this.battleFormula(this.tree);case GameFormula2.人物生命:return this.characterHealth(this.tree);case GameFormula2.近战素质物攻:return this.meleeAttack(this.tree);case GameFormula2.远程素质物攻:return this.rangedAttack(this.tree);case GameFormula2.法师素质物攻:return this.mageAttack(this.tree);case GameFormula2.物防:return this.physicalDefense(this.tree);case GameFormula2.魔防:return this.magicDefense(this.tree);case GameFormula2.命中+2:return this.hitRate(this.tree);default:return this.value}}getFormulaTextValueBody(){return{[HandleFunctionTypes["1-n"]]:`1-(${this.value})`,[HandleFunctionTypes["1/n"]]:`1/(${this.value})`,[HandleFunctionTypes["-n"]]:`-(${this.value})`,[CommonFunctionTypes.abs]:`abs(${this.value})`,[CommonFunctionTypes.random]:`random()*${this.value}`,[CommonFunctionTypes.floor]:`floor(${this.value})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.value})`,[CommonFunctionTypes.log]:`log(${this.value})`,[CommonFunctionTypes.exp]:`exp(${this.value})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.value})`,[HandleFunctionTypes["n*2"]]:`(${this.value})*2`,[HandleFunctionTypes["n/2"]]:`(${this.value})/2`,[HandleFunctionTypes["n*100"]]:`(${this.value})*100`,[HandleFunctionTypes["n/100"]]:`(${this.value})/100`,[HandleFunctionTypes["n*n"]]:`${this.value}*${this.value}`,[TriangleFunctionTypes["n*pi"]]:`${this.value}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.value})`,[TriangleFunctionTypes.sin]:`sin(${this.value})`,[TriangleFunctionTypes.tan]:`tan(${this.value})`,[TriangleFunctionTypes.acos]:`acos(${this.value})`,[TriangleFunctionTypes.asin]:`asin(${this.value})`,[TriangleFunctionTypes.atan]:`atan(${this.value})`,[CommonFunctionTypes.sign]:`sign(${this.value})`,[CommonFunctionTypes.imul]:`imul(${this.value})`,[CommonFunctionTypes.ceil]:`ceil(${this.value})`,[CommonFunctionTypes.round]:`round(${this.value})`}[this.funcType]||this.formulaTextValue||String(this.value)}getFormulaTextValue(){return this.getFormulaTextValueBody()}getFormulaTextCharacterBody(){if(this.type===NodeType.CalculationLayer)return this.body?this.body.getFormulaTextCharacter():"";if(this.type===NodeType.Macro)return this.getValue();let e=this.name;return this.type===NodeType.Macro&&(e=`${this.name}_${this.TID}`),{[HandleFunctionTypes["1-n"]]:`1-(${this.name})`,[HandleFunctionTypes["1/n"]]:`1/(${this.name})`,[HandleFunctionTypes["-n"]]:`-${this.name}`,[CommonFunctionTypes.abs]:`abs(${this.name})`,[CommonFunctionTypes.random]:`random()*(${this.name})`,[CommonFunctionTypes.floor]:`floor(${this.name})`,[CommonFunctionTypes.sqrt]:`sqrt(${this.name})`,[CommonFunctionTypes.log]:`log(${this.name})`,[CommonFunctionTypes.exp]:`exp(${this.name})`,[CommonFunctionTypes.cbrt]:`cbrt(${this.name})`,[HandleFunctionTypes["n*2"]]:`${this.name}*2`,[HandleFunctionTypes["n/2"]]:`${this.name}/2`,[HandleFunctionTypes["n*100"]]:`${this.name}*100`,[HandleFunctionTypes["n/100"]]:`${this.name}/100`,[HandleFunctionTypes["n*n"]]:`${this.name}*${this.name}`,[TriangleFunctionTypes["n*pi"]]:`${this.name}*PI`,[TriangleFunctionTypes.cos]:`cos(${this.name})`,[TriangleFunctionTypes.sin]:`sin(${this.name})`,[TriangleFunctionTypes.tan]:`tan(${this.name})`,[TriangleFunctionTypes.acos]:`acos(${this.name})`,[TriangleFunctionTypes.asin]:`asin(${this.name})`,[TriangleFunctionTypes.atan]:`atan(${this.name})`,[CommonFunctionTypes.sign]:`sign(${this.name})`,[CommonFunctionTypes.imul]:`imul(${this.name})`,[CommonFunctionTypes.ceil]:`ceil(${this.name})`,[CommonFunctionTypes.round]:`round(${this.name})`}[this.funcType]||e}getFormulaTextCharacter(){return this.getFormulaTextCharacterBody()}removeChild(e){const t=this.childArray.indexOf(e);t>-1&&this.childArray.splice(t,1)}dispose(){this.source!=null&&this.source.removeChild(this),this.macros="",this.childArray=[]}setParameter(e,t){this.name=e,this.value=t}upDataChild(){for(const e of this.childArray)e.name=this.name,e.value=this.value,e.body=this.body,e.TID=this.TID}setDataChild(e,t){this.name=e,this.value=t;for(const n of this.childArray)n.setDataChild(e,t)}syncBody(){for(const e of this.childArray)e.body=this.body}copy(){const e=new fx.VariableValue(this.name,this.value,this.type,this.operator);return e.source=this,e.body=this.body,e.TID=this.TID,this.childArray.push(e),e}}class SymbolBody extends BasicBody{constructor(){super();o(this,"operator",null);o(this,"type","SymbolBody");o(this,"isFunctionId",1);o(this,"funcType",0);o(this,"constructorName","SymbolBody")}copy(){var t=new fx.SymbolBody;return t.operator=this.operator,t.isFunctionId=this.isFunctionId,t.tree=this.tree,t.parent=this.parent,t.value=this.value,t.isWeight=this.isWeight,t.isBindingOperation=this.isBindingOperation,t.isBindingFormula=this.isBindingFormula,t.formulaTextValue=this.formulaTextValue,t.formulaTextCharacter=this.formulaTextCharacter,t.operationalLogicText=this.operationalLogicText,t.cacheElementValue=this.cacheElementValue,t}setFunctionId(t){this.isFunctionId=t}getRunFunctionId(){var t=this.getFunctionLength();return this.isFunctionId++,this.isFunctionId>t&&(this.isFunctionId=1),this.isFunctionId}getFunctionLength(){for(var t=0,n=0;n<this.tree.length;n++)this.tree[n].isFunction&&t++;return t}getFunction(t){for(var n=0,i=0;i<this.tree.length;i++)if(this.tree[i].isFunction&&(n++,n==t))return this.tree[i];return null}getValue(){if((this.operator=="fx"||this.operator=="=")&&this.getFunctionLength()>0){const n=this.getFunction(this.isFunctionId);return n?this.value=this.returnFunc(getCatchValue(n)):this.value=null,this.value}else{this.value=null,this.operationalLogicText="";for(var t=0;t<this.tree.length;t++)t<this.tree.length-1?this.operationalLogicText+=Number(getCatchValue(this.tree[t]))+(this.operator||""):this.operationalLogicText+="("+Number(getCatchValue(this.tree[t]))+")";this.value=fx.eval(this.operationalLogicText)}return isNaN(this.value)?(this.value=this.returnFunc(this.value),this.value):(this.value=this.returnFunc(Number(this.value)),this.value)}getFormulaTextCharacter(){if(this.operator=="="&&this.getFunctionLength()>0){const s=this.getFunction(this.isFunctionId);s?this.formulaTextCharacter="("+s.getFormulaTextCharacter()+")":this.formulaTextCharacter=""}else{this.formulaTextCharacter="";for(var t=0;t<this.tree.length;t++)if(t<this.tree.length-1)this.formulaTextCharacter+="("+this.tree[t].getFormulaTextCharacter()+")"+(this.operator||"");else{var n=this.tree[t].getFormulaTextCharacter();n.indexOf("+")==-1&&n.indexOf("-")==-1&&n.indexOf("*")==-1&&n.indexOf("/")==-1&&n.indexOf("%")==-1&&n.indexOf(">")==-1&&n.indexOf(">=")==-1&&n.indexOf("<")==-1&&n.indexOf("<=")==-1&&n.indexOf("==")==-1?this.formulaTextCharacter+=n:this.formulaTextCharacter+="("+n+")"}}var i=this.formulaTextCharacter;return this.funcType!=0&&(i=this.getFormulaTextCharacterBody()),i}getFormulaTextValue(){if(this.funcType==0){if(this.operator=="="&&this.getFunctionLength()>0){const i=this.getFunction(this.isFunctionId);i?this.formulaTextValue="("+i.getFormulaTextValue()+")":this.formulaTextValue=""}else{this.formulaTextValue="";for(var t=0;t<this.tree.length;t++){var n=this.tree[t].getFormulaTextValue();t<this.tree.length-1?this.formulaTextValue+="("+n+")"+(this.operator||""):n.indexOf("+")==-1&&n.indexOf("-")==-1&&n.indexOf("*")==-1&&n.indexOf("/")==-1&&n.indexOf("%")==-1&&n.indexOf(">")==-1&&n.indexOf(">=")==-1&&n.indexOf("<")==-1&&n.indexOf("<=")==-1&&n.indexOf("==")==-1?this.formulaTextValue+=n:this.formulaTextValue+="("+n+")"}}return this.formulaTextValue}else return this.getFormulaTextValueBody()}dispose(){for(var t=0;t<this.tree.length;t++)this.tree[t].dispose()}}class OperationBody extends BasicBody{constructor(){super();o(this,"type","OperationBody");o(this,"constructorName","OperationBody");o(this,"isFunction",!1)}}class FormulaData{constructor(e,t,n){o(this,"name");o(this,"x");o(this,"y");o(this,"body",null);o(this,"type","Formula");o(this,"cacheTargetStoragePool",null);o(this,"cacheTargetFolder",null);o(this,"constructorName","FormulaData");o(this,"id",0);this.name=e,this.x=t,this.y=n,this.cacheTargetStoragePool=fx.targetStoragePool,this.cacheTargetFolder=fx.targetFolder.formulaTree,this.cacheTargetStoragePool.push(this),this.cacheTargetFolder.push(this),this.id=++EventManager.IDINDEX}getValue(){return this.body!=null?getCatchValue(this.body):0}dispose(){let e=this.cacheTargetStoragePool.indexOf(this);e>=0&&this.cacheTargetStoragePool.splice(e,1),e=this.cacheTargetFolder.indexOf(this),this.cacheTargetFolder.splice(e,1)}}class Player{constructor(){o(this,"name","");o(this,"hp",0);o(this,"maxHp",0);o(this,"maxShield",0);o(this,"shield",0);o(this,"enemyBody",null);o(this,"battlePool",[]);o(this,"valist",[]);o(this,"lflist",[]);o(this,"brlist",[]);o(this,"instantiation",null);o(this,"playerData",null);o(this,"folder",null);o(this,"comboxMaxHp","未设置血量公式");o(this,"combBoxAttack","未设置攻击公式");o(this,"underAttackName","");o(this,"shieldRuptureName","");o(this,"isShieldDetection",!1);o(this,"dieName","");o(this,"isDie",!1);o(this,"delayCustomList",[]);o(this,"callCenter",null);o(this,"tagArray",[]);o(this,"id",0);o(this,"constructorName","Player");o(this,"attackNum",0);o(this,"level",1);o(this,"levelVar","");o(this,"maxLEvel",100);o(this,"exp",0);o(this,"expName","");o(this,"levelUpConfig",{});o(this,"parameterInfoArray",[]);this.name="",this.hp=0,this.maxHp=0,this.maxShield=0,this.shield=0,this.enemyBody=null,this.level=1,this.levelVar="",this.battlePool=[],this.valist=[],this.lflist=[],this.brlist=[],this.instantiation=null,this.playerData=null,this.updatePlayerData(),this.comboxMaxHp="未设置血量公式",this.combBoxAttack="未设置攻击公式",this.underAttackName="",this.shieldRuptureName="",this.isShieldDetection=!1,this.dieName="",this.isDie=!1,this.delayCustomList=[],this.callCenter=new CallCenter,this.callCenter.addEventListener(EventManager.UP_DATA_PLAYER,this.upDataPlayerFunction,null,this),this.tagArray=[],this.id=++EventManager.IDINDEX,this.constructorName="Player",this.attackNum=0}resetTag(){this.tagArray=[]}gesetTagPopulation(e){let t=0;for(let n=0;n<this.tagArray.length;n++)this.tagArray[n].name==e&&t++;return t}gesetTagAll(){return this.tagArray}addTag(e){this.tagArray.push({name:e})}upDataPlayerFunction(e){this.updatePlayerData()}updatePlayerData(){fx.player=this,this.attackNum=0,this.playerData=this.createPlayer()}recursionSet(e,t){fx.player=this;for(let n=0;n<e.length;n++)e[n]instanceof VariableValue?e[n].enemyFlag&&(t==null?e[n].setEnemyBody(null):e[n].setEnemyBody(t.getPropertyObject(e[n].source.absoluteAddress))):this.recursionSet(e[n].tree,t)}getFormula(e){fx.player=this,fx.clearCacheRecursion(this.folder);let t=0;for(let n=0;n<this.playerData.formulaTree.length;n++)if(this.playerData.formulaTree[n].name==e){t=this.playerData.formulaTree[n].body.getValue();break}for(let n=0;n<fx.stageStoragePool.length;n++)fx.stageStoragePool[n]instanceof FormulaData&&fx.stageStoragePool[n].name==e&&(t=fx.stageStoragePool[n].body.getValue());return t}delay(e,t,n,i){const s=e+"次数";this[""+e]==null&&(this[""+e]=0,this.delayCustomList.push(""+e)),this[""+s]==null&&(this[""+s]=0,this.delayCustomList.push(""+s)),this[""+e]++,this[""+e]>=t&&Number(this[""+s])<=Number(n)+1&&(this[""+e]=0,this[""+s]++,i())}hit(e,t,n){this.instantiation!=null}attack(e,t){this.attackNum++,fx.player=this,fx.clearCacheRecursion(this.folder),fx.isCrit=!1;let n=0,i=0;for(let s=0;s<this.playerData.formulaTree.length;s++)if(this.playerData.formulaTree[s].name==e){fx.enemyBody=t,this.enemyBody=t,n=this.playerData.formulaTree[s].body.getValue();const r=t.isDie;t.getShield()!=0?t.minusShield(n):t.minusHp(n),!r&&t.isDie&&i++,fx.enemyBody=null;break}for(let s=0;s<fx.stageStoragePool.length;s++)if(fx.stageStoragePool[s]instanceof FormulaData&&fx.stageStoragePool[s].name==e){fx.enemyBody=t,this.enemyBody=t,n=fx.stageStoragePool[s].body.getValue();const r=t.isDie;t.getShield()!=0?t.minusShield(n):t.minusHp(n),!r&&t.isDie&&i++,fx.enemyBody=null}return i>0&&this.onEnmeyKilled(i),[n,fx.isCrit]}getNeedExp(){return 1}onEnmeyKilled(e){this.exp+=e,this.checkUpdateLevel()}checkUpdateLevel(){const e=this.getNeedExp();this.exp>=e&&this.level<this.maxLEvel&&(this.level++,this.exp=0,fx.Call.send(EventManager.PLAYER_INSTANCE_LEVEL_UP,[this.id,this.level,this.exp]))}setMaxShield(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxShield=0,this.shield=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxShield=this.playerData.formulaTree[t].body.getValue(),this.shield=this.maxShield;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxShield=fx.stageStoragePool[t].body.getValue(),this.shield=this.maxShield);return e=="无"&&(this.maxShield=this.shield=0),this.isShieldDetection=!1,this.maxShield}setMaxHp(e){fx.player=this,fx.clearCacheRecursion(this.folder),this.maxHp=0,this.hp=0;for(let t=0;t<this.playerData.formulaTree.length;t++)if(this.playerData.formulaTree[t].name==e){this.maxHp=this.playerData.formulaTree[t].body.getValue(),this.hp=this.maxHp;break}for(let t=0;t<fx.stageStoragePool.length;t++)fx.stageStoragePool[t]instanceof FormulaData&&fx.stageStoragePool[t].name==e&&(this.maxHp=fx.stageStoragePool[t].body.getValue(),this.hp=this.maxHp);e=="无"&&(this.maxHp=this.hp=0),this.isDie=!1;for(let t=0;t<this.delayCustomList.length;t++)this[this.delayCustomList[t]]=null;return this.maxHp}getMaxHp(){return this.maxHp}getMaxShield(){return this.maxShield}getShield(){return this.shield}getHp(){return this.hp}setHp(e){this.hp=e}setShield(e){this.shield=e}underAttack(){this.getFormula(this.underAttackName)}setshieldRupture(e){this.shieldRuptureName=e}setUnderAttack(e){this.underAttackName=e}shieldRupture(){this.getFormula(this.shieldRuptureName),this.isShieldDetection=!0}minusShield(e){return this.shield-=e,this.shield<=0&&this.isShieldDetection==!1&&(this.shield=0,this.shieldRupture()),this.underAttack(),this.shield}setDie(e){this.dieName=e}die(){this.getFormula(this.dieName),this.isDie=!0}minusHp(e){return this.hp-=e,this.hp<=0&&this.isDie==!1&&(this.hp=0,this.die()),this.underAttack(),this.hp}getBillboard(){fx.player=this;const e=[];return fx.recursionGetBillboard(e,this.playerData),e.length==0?fx.billBoardList:e}getPropertyObject(e,t){return fx.player=this,fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t)}setProperty(e,t){fx.player=this;const n=this.getPropertyObject(e);return n!=null?n.setValue(t):console.log("没有找到属性"),t}getProperty(e,t){return fx.player=this,fx.clearCache(),this.getPropertyObject(e)!=null?fx.getBody(this.playerData,fx.parseAbsoluteAddress(e),t).getValue():(console.log("没有找到属性"),0)}dispose(){this.callCenter.dispose(),this.playerData.dispose(),this.name="",this.hp=0,this.maxHp=0,this.playerData=null,this.callCenter=null,this.tagArray=[],this.id=0,this.constructorName="",this.attackNum=0}clearCache(){fx.player=this,fx.clearCacheRecursion(this.folder)}createPlayer(){this.attackNum=0,fx.editBody=null,fx.selectBody=null,fx.isBodyView=!1,this.folder=new fx.Folder;const e=[];fx.addLibraryBody(e,fx.targetFolder.tree);const t=e;return fx.targetFolder=this.folder,fx.createLibraryBody(t,!0),fx.parseLibraryBody(t,!0),fx.recursionSyncBody(fx.targetFolder.tree),fx.editBody=null,fx.selectBody=null,fx.targetStoragePool=fx.stageStoragePool,fx.targetFolder=fx.sceneFolder,fx.isBodyView=!0,this.valist=[],this.lflist=[],this.brlist=[],fx.recursiveDataReading(this.folder,this.valist,this.lflist,this.brlist),this.folder}recoveryAttribute(){for(let e=0;e<this.valist.length;e++)this.setProperty(this.valist[e].absoluteAddress,Number(this.valist[e].value))}setParameterInfoArray(e){this.parameterInfoArray=e}getParameterInfoArray(){return this.parameterInfoArray}findParameterInfoByName(e){return this.parameterInfoArray.find(t=>t.parameterInfoname===e)||null}updateParameterValue(e,t,n){const i=this.findParameterInfoByName(e);if(!i)return!1;for(const s of i.parameterInfoArray)for(const r of s.parameter)if(r.path===t)return r.value=n,!0;return!1}getParameterValue(e,t){const n=this.findParameterInfoByName(e);if(!n)return null;for(const i of n.parameterInfoArray)for(const s of i.parameter)if(s.path===t)return s.value;return null}changeLevelAndOccupation(e,t,n={levelPath:"等级",occupationPath:"职业"}){const i=this.findParameterInfoByName(this.name);if(!i){console.warn(`未找到玩家 "${this.name}" 的参数信息`);return}for(const s of i.parameterInfoArray)for(const r of s.parameter)r.path===n.levelPath?r.value=e:r.path===n.occupationPath&&(r.value=t);this.level=e,this.gameManualOverrideParameter(i)}gameManualOverrideParameter(e){const t=this.getBillboard();e.parameterInfoArray.forEach(n=>{n&&t.forEach(i=>{n.name===i.name&&n.parameter.forEach(s=>{const r=s.path;i.metadataArray.forEach(c=>{const l=[];if(fx.getStepData(c.body.source,l),l.toString()===r){const m=c.body.getValue(),d=Number(s.value);m!==d&&c.body.setGlobalValue(d)}})})})})}}class BillboardLayer{constructor(e){o(this,"name","");o(this,"operationArray",[]);o(this,"metadataArray",[]);o(this,"id",0);o(this,"monitored",!0);o(this,"constructorName","BillboardLayer");this.name=e,this.id=++EventManager.IDINDEX}dispose(){this.name=null,this.operationArray=null,this.metadataArray=null,this.monitored=null}pushOperationLayer(){if(fx.clickBody!=null&&fx.clickBody.type==NodeType.CalculationLayer){const e=new fx.OperationLayerData(fx.clickBody);this.operationArray.push(e)}fx.clickBody=null}pushMetadata(e,t,n,i,s){if(fx.clickBody!=null&&fx.clickBody instanceof fx.VariableValue&&fx.clickBody.type!=5){const r=new fx.MetadataData(fx.clickBody);r.type=e,r.presentValue=getCatchValue(r.body),r.minValue=t,r.maxValue=n,r.intervalValue=i,r.list=s&&s.length?s.map(c=>({value:Number(c.value),name:c.name})):[],this.metadataArray.push(r)}fx.clickBody=null}}class ChartsLayer{constructor(e){o(this,"name");o(this,"operationArray",[]);o(this,"metadata",null);o(this,"metadataArray",[]);o(this,"minValue",1);o(this,"maxValue",1);o(this,"intervalValue",1);o(this,"constructorName","ChartsLayer");o(this,"id");this.name=e,this.id=++EventManager.IDINDEX}addMetadataData(){fx.clickBody!=null&&(this.metadata=fx.clickBody.copy(),this.metadataArray[0]=this.metadata)}dispose(){}}class Bookmark{constructor(){o(this,"id",0);o(this,"x",0);o(this,"y",0);o(this,"width",512);o(this,"height",512);o(this,"text","标签");o(this,"view",null);o(this,"type","Bookmark");o(this,"bookmarkView",null)}}class MetadataData{constructor(e){o(this,"body");o(this,"view",null);o(this,"type",0);o(this,"presentValue",0);o(this,"minValue",0);o(this,"maxValue",0);o(this,"intervalValue",0);o(this,"list",[]);this.body=e.copy()}}class SheetData{constructor(e){o(this,"originData");this.originData=e}setData(e){this.originData=e}getValue(e,t,n){var d,T,p;if(!(this!=null&&this.originData)||typeof e>"u"||typeof t>"u"||typeof n>"u")return 0;const r=this.originData.sheets.find(f=>f.name===e),c=r.uniqueInfo.find(f=>f.row===t&&f.col===n),l=(d=r==null?void 0:r.data)==null?void 0:d.get(`${t},${n}`),h=l==null?void 0:l.cellData;let m=h==null?void 0:h.v;return h!=null&&h.type&&(m=(T=l==null?void 0:l.source)!=null&&T.getValue?(p=l.source)==null?void 0:p.getValue():0),(c==null?void 0:c.value)||m||0}}class OperationLayerData{constructor(e){o(this,"body");o(this,"view",null);this.body=e.copy()}}class Message{constructor(){o(this,"userData",null);o(this,"type",null)}}const globalThis_$1=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_$1.target=null;class A{test(){try{console.log("console A")}catch(e){console.error("Error in class A test:",e)}}}class B extends A{constructor(){super()}test(){try{console.log("console B")}catch(e){console.error("Error in class B test:",e)}}}const a=class a{static recursiveDataReading(e,t,n,i){try{if(!e||!e.tree||!Array.isArray(e.tree))throw new Error("Invalid object structure for recursive reading");for(let s=0;s<e.tree.length;s++){const r=e.tree[s];r!=null&&(r.isFolder?this.recursiveDataReading(r,t,n,i):r.type==NodeType.Variable?t.push(r):r.type==NodeType.CalculationLayer?n.push(r):r instanceof a.BillboardLayer&&i.push(r))}}catch(s){console.error("Error in recursive data reading:",s)}}};o(a,"b",new B),o(a,"code",!1),o(a,"isNumber",MathUtils.isNumber),o(a,"mix",MathUtils.mix),o(a,"lerp",MathUtils.lerp),o(a,"cross",MathUtils.cross),o(a,"dot",MathUtils.dot),o(a,"distance",MathUtils.distance),o(a,"length",MathUtils.length),o(a,"clamp",MathUtils.clamp),o(a,"normalize",MathUtils.normalize),o(a,"MathUtils",MathUtils),o(a,"billBoardList",[]),o(a,"functionAddIndex",0),o(a,"visualVersionCompatibility",!1),o(a,"singletonInstance",null),o(a,"isStart",!1),o(a,"FXCentre",FXCentre),o(a,"NodeType",NodeType),o(a,"Folder",Folder),o(a,"Eve",EventManager),o(a,"CallCenter",CallCenter),o(a,"MessageList",MessageList),o(a,"VariableValue",VariableValue),o(a,"Call",Call),o(a,"SymbolBody",SymbolBody),o(a,"BasicBody",BasicBody),o(a,"OperationBody",OperationBody),o(a,"Player",Player),o(a,"BillboardLayer",BillboardLayer),o(a,"ChartsLayer",ChartsLayer),o(a,"Bookmark",Bookmark),o(a,"FormulaData",FormulaData),o(a,"MetadataData",MetadataData),o(a,"SheetData",SheetData),o(a,"OperationLayerData",OperationLayerData),o(a,"Message",Message),o(a,"noCache",!1),o(a,"enemyBody",null),o(a,"sceneFolder",null),o(a,"targetFolder",null),o(a,"isFolderDuplicationOfName",!1),o(a,"isBillboardLayerView",!0),o(a,"isBodyView",!0),o(a,"isGlobalOperations",!1),o(a,"isDragBody",!1),o(a,"stageMaskValue",{}),o(a,"stageGroup",null),o(a,"clickBody",null),o(a,"selectCellBody",null),o(a,"editBody",null),o(a,"selectBody",null),o(a,"stageStoragePool",[]),o(a,"targetStoragePool",a.stageStoragePool),o(a,"player",null),o(a,"isCrit",!1),o(a,"distribute",function(e,t){const n=t.reduce((i,s)=>i+s,0);return t.map(i=>e*i/n)}),o(a,"partitionCurve",function(e,t,n,i,s,r){const c=[],l=[];let h=s,m=r;h==null&&(h=.382),m==null&&(m=.618);let d=0;for(let T=1;T<=t;T++){const p=Math.pow(t,n),y=Math.pow(T,n)/p,g=T*(1e4*h)/t+y*(1e4*m);c.push(g),d+=g}for(let T=0;T<c.length;T++)if(i==null)l.push(c[T]/d*e);else switch(i){case 0:l.push(c[T]/d*e);break;case 1:l.push(Math.floor(c[T]/d*e));break;case 2:l.push(Math.floor(c[T]/d*e));break}return l}),o(a,"eval",function(e){return a.evaluateExpression(e)}),o(a,"recursionLibraryBody",function(e,t,n){if(t.tree==null)return null;for(let i=0;i<t.tree.length;i++){if(t.tree[i].absoluteAddress==n){e.push(t.tree[i]);return}a.recursionLibraryBody(e,t.tree[i],n)}return null}),o(a,"double",function(e,t){switch(t){case 0:return Math.round(e*1)/1;case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4;case 5:return Math.round(e*1e5)/1e5;case 6:return Math.round(e*1e6)/1e6;case 7:return Math.round(e*1e7)/1e7}return 0}),o(a,"getLibraryBody",function(e,t,n){for(let i=0;i<t.length;i++){if(t[i].absoluteAddress==null&&(t[i].absoluteAddress=a.getAbsoluteAddress(t[i])),t[i].absoluteAddress==n){e.push(t[i]);return}t[i].isFolder&&a.getLibraryBody(e,t[i].tree,n)}}),o(a,"mapToJSON",function(e){return e?JSON.stringify([...e].reduce((t,[n,i])=>{const s={...i},r=s.source;if(r){const c=a.createVarData(r.TID,r.name,r.value,r.type,r.macros,r.operator,r.enemyFlag,r.source,r.tag,r.statistics,r.upDateValue,r.demoteValue,r.funcType,r.isLogicalOpen,r.isDragging,r.currentStep,r.snNo,r.minValue,r.maxValue,r.step,r.logicalChildArray,r.selectedOutputInfo);s.source=c}return t[n]=s,t},{})):"{}"}),o(a,"addLibraryBody",function(e,t){var s;for(let r=0;r<t.length;r++){const c=t[r];let l=(s=c.sheetData)==null?void 0:s.originData;if(l&&(l={...l},l.sheets=[...l.sheets.map(h=>({...h,data:a.mapToJSON(h.data)}))]),c instanceof a.VariableValue){var n=a.createOperationLayerData(c.name,c.type,c.value,c,c.tag,c.isSystemShow,c.sheetData?JSON.stringify(l):null,c.childCell);n.id=c.id,e.push(n),a.saveBody(n.operationArray,a.seekSource(c.childBodyArray))}if(c instanceof a.Folder){var n=a.createFolderData(c.name,c.isFolder,c);n.id=c.id,e.push(n),a.addLibraryBody(n.operationArray,c.tree)}if(a.isBillboardLayerView){if(c instanceof a.BillboardLayer){var n=a.createBillboarData(c.name,c,c.monitored);n.id=c.id,e.push(n);for(var i=0;i<c.operationArray.length;i++){const m=c.operationArray[i],d=a.createOperationLayerData(m.body.name,m.body.type,m.body.value,m.body.source,m.body.tag,m.body.isSystemShow,null,null);d.id=m.body.id,n.operationArray.push(d)}for(var i=0;i<c.metadataArray.length;i++){const d=c.metadataArray[i],T=a.createBillboarMetadataData(d.body.name,d.body.type,d.body.value,d.body.source,d);T.id=d.body.id,n.metadataArray.push(T)}}if(c instanceof a.ChartsLayer){var n=a.createChartData(c);n.id=c.id,e.push(n)}}}}),o(a,"parseLibraryBody",function(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.type==NodeType.CalculationLayer){var n=[];a.getLibraryBody(n,a.targetFolder.tree,s.site),a.editBody=n[0],a.selectBody=a.editBody,a.targetStoragePool=a.editBody.childBodyArray,a.editBody.isSystemShow=s.isSystemShow,a.parseStageBody(s.operationArray)}else if(s.type==0||s.type==NodeType.Variable||s.type==2||s.type==3){var n=[];a.getLibraryBody(n,a.targetFolder.tree,s.site),a.editBody=n[0],a.selectBody=a.editBody,a.targetStoragePool=a.stageStoragePool,a.parseStageBody(s.operationArray)}else if(s.isFile==!0){var n=[];a.getLibraryBody(n,a.targetFolder.tree,s.site),a.editBody=n[0];const c=n[0];for(let l=0;l<s.operationArray.length;l++){const h=s.operationArray[l];if(h.type==NodeType.CalculationLayer){var n=[];a.getLibraryBody(n,a.targetFolder.tree,h.site),a.editBody=n[0],a.selectBody=n[0],a.targetStoragePool=n[0].childBodyArray,a.parseStageBody(h.operationArray),a.editBody=c,a.editBody.isSystemShow=h.isSystemShow}else h.isBoard==!0?(a.selectBody=a.editBody,h.index=l,a.Call.send(a.Eve.SHIFT_ADD_BOARD,h,null)):h.isXlsx==!0&&(a.selectBody=a.editBody,h.index=l,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,h,null));if(h.isFile==!0){var n=[];a.getLibraryBody(n,a.targetFolder.tree,h.site),a.editBody=n[0],a.parseLibraryBody(h.operationArray,!1)}}a.editBody=null}else s.isBoard==!0?(a.selectBody=a.editBody,a.billBoardList.push(s),a.Call.send(a.Eve.SHIFT_ADD_BOARD,s,null)):s.isXlsx==!0&&(a.selectBody=a.editBody,a.Call.send(a.Eve.SHIFT_ADD_CHARTS,s,null));t&&(a.selectBody=null)}}),o(a,"createLibraryBody",function(e,t,n,i){for(let l=0;l<e.length;l++){const h=e[l];if(h.isFile==!0){var s=new a.Folder(h.name);a.Call.send(a.Eve.CREATE_FILE_DATA,s,null),i!=null?(a.Call.send(a.Eve.ADD_DATABASE_DATA,[s,i],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[s,i],null)):(a.Call.send(a.Eve.ADD_DATABASE_DATA,[s,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[s,a.selectBody],null)),a.selectBody=s,a.selectBody.absoluteAddress=h.site;for(let m=0;m<h.operationArray.length;m++){const d=h.operationArray[m];if(d.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(d.name,null,5),a.editBody.tag=d.name.tag,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray;else if(d.type==0||d.type==NodeType.Variable||d.type==2||d.type==3){var r=d.name+"="+d.value,c=new a.VariableValue(r.split("=")[0],r.split("=")[1],1);d.type==NodeType.Variable&&(c.isAI=n||!1),a.editBody=c,a.editBody.tag=d.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,c,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}else if(d.type==NodeType.Sheet){var r=d.name,c=new a.VariableValue(r.split("=")[0],void 0,d.type);c.selectedOutputInfo=d!=null&&d.selectedOutputInfo?JSON.parse(d==null?void 0:d.selectedOutputInfo):null;const f=typeof d.sheetData=="string"?JSON.parse(d.sheetData):d.sheetData;f!=null&&f.sheets&&(f.sheets=f.sheets.map(y=>{const g=JSON.parse(y.data);return Object.values(g).forEach(b=>{if(b!=null&&b.source){const D=b.source,v=[];a.getLibraryBody(v,a.targetFolder.tree,a.getAbsoluteAddress(D));const x=v[0];b.source=x.copy()}}),{...y,data:new Map(Object.entries(g))}})),c.setSheetData(f),c.childCell=d.childCell,a.editBody=c,a.editBody.tag=d.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=d.site,a.targetStoragePool=a.editBody.childBodyArray}if(d.isFile==!0){var s=new a.Folder(d.name);a.Call.send(a.Eve.CREATE_FILE_DATA,s,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[s,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[s,a.selectBody],null),a.selectBody=s,a.selectBody.absoluteAddress=d.site,a.createLibraryBody(d.operationArray,!1,!1,s),a.selectBody=s.parentFolder}}a.selectBody=s.parentFolder}if(h.type==NodeType.CalculationLayer)a.editBody=new a.VariableValue(h.name,null,5),a.editBody.tag=h.tag,a.editBody.isSystemShow=h.isSystemShow,a.Call.send(a.Eve.CREATE_OPERATION_DATA,a.editBody,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray;else if(h.type==0||h.type==NodeType.Variable||h.type==2||h.type==3){var r=h.name+"="+h.value,c=new a.VariableValue(r.split("=")[0],r.split("=")[1],1);h.type==NodeType.Variable&&(c.isAI=n||!1),a.editBody=c,a.editBody.tag=h.tag,a.Call.send(a.Eve.CREATE_METADATE_DATA,c,null),a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray}else if(h.type==NodeType.Sheet){var r=h.name,c=new a.VariableValue(r.split("=")[0],void 0,h.type);c.selectedOutputInfo=h!=null&&h.selectedOutputInfo?JSON.parse(h==null?void 0:h.selectedOutputInfo):null;const T=typeof h.sheetData=="string"?JSON.parse(h.sheetData):h.sheetData;T!=null&&T.sheets&&(T.sheets=T.sheets.map(p=>{const f=JSON.parse(p.data);return Object.values(f).forEach(y=>{if(y!=null&&y.source){const g=y.source,b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(g));const D=b[0];y.source=D.copy()}}),{...p,data:new Map(Object.entries(f))}})),c.setSheetData(T),c.childCell=h.childCell,a.editBody=c,a.editBody.tag=h.tag,a.Call.send(a.Eve.ADD_DATABASE_DATA,[a.editBody,a.selectBody],null),a.Call.send(a.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[a.editBody,a.selectBody],null),a.editBody.absoluteAddress=h.site,a.targetStoragePool=a.editBody.childBodyArray}t&&(a.selectBody=null)}}),o(a,"getBody",function(e,t,n){const i=[];return a.recursionLibraryBody(i,e,t),n!=null&&i[0].body.setFunctionId(n),i[0]}),o(a,"evaluateExpression",function(e){const t=a.toRPN(e),n=[];for(const i of t)if(a.isNumber(i))n.push(Number(i));else{const s=n.pop(),r=n.pop();let c;if(r!==void 0&&s!==void 0)switch(i){case"+":c=r+s;break;case"-":c=r-s;break;case"*":c=r*s;break;case"/":c=r/s;break;case"%":c=r%s;break;case"^":c=Math.pow(r,s);break;case">":c=r>s;break;case"<":c=r<s;break;case">=":c=r>=s;break;case"<=":c=r<=s;break;case"==":c=r===s;break;case"!=":c=r!==s;break}n.push(c)}return n.pop()}),o(a,"toRPN",function(e){e=e+"",e=e.replace(/\s+/g,"");const t={"+":1,"-":1,"*":2,"/":2,"%":2,"^":3,">":4,"<":4,">=":4,"<=":4,"==":4,"!=":4},n=[],i=[];function s(m){n.push(m)}function r(){const m=i.pop();m&&s(m)}function c(m){return t.hasOwnProperty(m)}function l(m,d){return m==="-"&&d===0||m==="-"&&!a.isNumber(e[d-1])&&e[d-1]!==")"}for(let m=0;m<e.length;m++){const d=e[m];if(a.isNumber(d)||l(d,m)){let T=d,p=m+1;for(;p<e.length&&(a.isNumber(e[p])||e[p]===".");)T+=e[p],p++;s(T),m=p-1}else if(c(d)){for(var h=i[i.length-1];c(h)&&(t[d]<=t[h]&&d!=="^"||t[d]<t[h]&&d==="^");)r(),h=i[i.length-1];i.push(d)}else if(d==="(")i.push(d);else if(d===")"){for(var h=i[i.length-1];h!=="("&&h!==void 0;)r(),h=i[i.length-1];i.pop()}}for(;i.length>0;)r();return n}),o(a,"Rectangle",class{constructor(t,n){o(this,"width");o(this,"height");this.width=t,this.height=n}calculateArea(){return this.width*this.height}calculatePerimeter(){return 2*(this.width+this.height)}}),o(a,"recursionSyncBody",function(e){for(let t=0;t<e.length;t++)e[t].type==NodeType.CalculationLayer&&e[t].syncBody(),e[t].isFolder&&a.recursionSyncBody(e[t].tree)}),o(a,"clearCache",function(){a.clearCacheRecursion(a.sceneFolder)}),o(a,"clearCacheRecursion",function(e){for(let t=0;t<e.tree.length;t++){const n=e.tree[t];n.type==NodeType.CalculationLayer&&(n.cacheValue=null),n.isFolder==!0&&a.clearCacheRecursion(n)}}),o(a,"initDataBase",function(e){a.isBillboardLayerView=!1,new a.FXCentre,JSON.parse(e).stage.operationArray;const t=JSON.parse(e).library.operationArray;a.editBody=null,a.selectBody=null,a.createLibraryBody(t,!0),a.parseLibraryBody(t,!0)}),o(a,"parseAbsoluteAddress",function(e){return e.replace(/\./g,"")}),o(a,"recursionGetBillboard",function(e,t){if(t.tree==null)return null;for(let n=0;n<t.tree.length;n++)t.tree[n]instanceof a.BillboardLayer&&e.push(t.tree[n]),a.recursionGetBillboard(e,t.tree[n]);return null}),o(a,"saveBody",function(e,t){for(let c=0;c<t.length;c++){const l=t[c];if(l.type==NodeType.OperationBody){var n=0,i=0;l.view!=null&&(n=l.view.getX(),i=l.view.getY());const h=a.createBodyData(l.type,l.isFunction,l.isBindingOperation,n,i,l.isWeight,l.isAdvance,l.funcType);l.isBindingFormula&&(h.isFormula=!0,h.formulaName=l.formulaBody.name,h.formulaX=l.formulaBody.x,h.formulaY=l.formulaBody.y),h.id=l.id,e.push(h);for(var s=0;s<l.tree.length;s++){const m=l.tree[s],d=a.createVarData(m.TID,m.name,m.value,m.type,m.macros,m.operator,m.enemyFlag,m.source,m.tag,m.statistics,m.upDateValue,m.demoteValue,m.funcType,m.isLogicalOpen,m.isDragging,m.currentStep,m.snNo,m.minValue,m.maxValue,m.step,m.logicalChildArray,m.selectedOutputInfo);d.id=m.id,h.tree.push(d)}}else if(l.type==NodeType.SymbolBody){var n=0,i=0;l.view!=null&&(n=l.view.getX(),i=l.view.getY());const d=a.createSymbolData(l.type,l.operator,l.isFunctionId,l.isBindingOperation,n,i,l.isWeight,l.funcType);l.isBindingFormula&&(d.isFormula=!0,d.formulaName=l.formulaBody.name,d.formulaX=l.formulaBody.x,d.formulaY=l.formulaBody.y),d.id=l.id,e.push(d);for(var s=0;s<l.tree.length;s++){const p=l.tree[s];switch(p.type){case"OperationBody":var n=0,i=0;p.view!=null&&(n=p.view.getX(),i=p.view.getY());var r=a.createBodyData(p.type,p.isFunction,p.isBindingOperation,n,i,p.isWeight,p.isAdvance,p.funcType);r.id=p.id,d.tree.push(r);for(let g=0;g<p.tree.length;g++){const b=p.tree[g],D=a.createVarData(b.TID,b.name,b.value,b.type,b.macros,b.operator,b.enemyFlag,b.source,b.tag,b.statistics,b.upDateValue,b.demoteValue,b.funcType,b.isLogicalOpen,b.isDragging,b.currentStep,b.snNo,b.minValue,b.maxValue,b.step,b.logicalChildArray,b.selectedOutputInfo);D.id=b.id,r.tree.push(D)}break;case"SymbolBody":var n=0,i=0;p.view!=null&&(n=p.view.getX(),i=p.view.getY());var r=a.createSymbolData(p.type,p.operator,p.isFunctionId,p.isBindingOperation,n,i,p.isWeight,p.funcType);r.id=p.id,d.tree.push(r),a.recursionSeekBody(r.tree,p.tree);break}}}else if(l.type==NodeType.Bookmark){const h=a.createBookmarkData(l);h.id=l.id,e.push(h)}}}),o(a,"coordinateDetection",function(e){return e!=null?{x:e.getX(),y:e.getY()}:{x:0,y:0}}),o(a,"recursionSeekBody",function(e,t){for(let s=0;s<t.length;s++){const r=t[s];switch(r.type){case"OperationBody":var n=a.coordinateDetection(r.view),i=a.createBodyData(r.type,r.isFunction,r.isBindingOperation,n.x,n.y,r.isWeight,r.isAdvance,r.funcType);e.push(i);for(let c=0;c<r.tree.length;c++){const l=r.tree[c];i.tree.push(a.createVarData(l.TID,l.name,l.value,l.type,l.macros,l.operator,l.enemyFlag,l.source,l.tag,l.statistics,l.upDateValue,l.demoteValue,l.funcType,l.isLogicalOpen,l.isDragging,l.currentStep,l.snNo,l.minValue,l.maxValue,l.step,l.logicalChildArray,l.selectedOutputInfo))}break;case"SymbolBody":var n=a.coordinateDetection(r.view),i=a.createSymbolData(r.type,r.operator,r.isFunctionId,r.isBindingOperation,n.x,n.y,r.isWeight,r.funcType);e.push(i),a.recursionSeekBody(i.tree,r.tree);break}}}),o(a,"getAbsoluteAddress",function(e,t){if(t){var n=[];a.getStepData(e,n,t);for(var i="",s=0;s<n.length;s++)i+=n[s];return i}if(e.site!=null&&e.site!=null)return e.site;if(e.parentFolder==null)return e.source!=null?e.source.absoluteAddress:e.name;var n=[];a.getStepData(e,n,t);for(var i="",s=0;s<n.length;s++)i+=n[s];return i}),o(a,"copyHeadFun",function(e){return e.copyHead?!0:e.parentFolder!=null&&e.parentFolder.name!=null?a.copyHeadFun(e.parentFolder):!1}),o(a,"getStepData",function(e,t,n){t.unshift(e.name),e.parentFolder!=null&&e.parentFolder.name!=null&&a.getStepData(e.parentFolder,t,n)}),o(a,"getStepDataAll",function(e,t){t.unshift(e.name),e.parentFolder.name!=null&&a.getStepDataAll(e.parentFolder,t)}),o(a,"createVarData",function(e,t,n,i,s,r,c,l,h,m,d,T,p,f,y,g,b,D,v,x,V,E){const C={};return a.code,C.TID=e,C.name=t,C.value=n,C.type=i,C.macros=s,C.operator=r,C.enemy=c,C.tag=h,C.site=a.getAbsoluteAddress(l),C.statistics=m,C.upDateValue=d,C.demoteValue=T,C.funcType=p,C.isLogicalOpen=f,C.isDragging=y,C.currentStep=g,C.snNo=b,C.minValue=D,C.maxValue=v,C.step=x,C.logicalChildArray=[],C.selectedOutputInfo=typeof E=="object"?JSON.stringify(E):"",V&&V.length&&V.forEach(F=>{const L=a.createVarData(F.TID,F.name,F.value,F.type,F.macros,F.operator,F.enemyFlag,F.source,F.tag,F.statistics,F.upDateValue,F.demoteValue,F.funcType,F.isLogicalOpen,F.isDragging,F.currentStep,F.snNo,F.minValue,F.maxValue,F.step,F.logicalChildArray);C.logicalChildArray.push(L)}),C}),o(a,"createBodyData",function(e,t,n,i,s,r,c,l){const h={};return h.tree=[],h.type=e,h.isFunction=t,h.isBoundOutput=n,h.x=i,h.y=s,h.isWeight=r,h.isAdvance=c,h.funcType=l,h}),o(a,"createSymbolData",function(e,t,n,i,s,r,c,l){const h={};return h.tree=[],h.type=e,h.operator=t,h.isFunctionId=n,h.isBoundOutput=i,h.x=s,h.y=r,h.isWeight=c,h.funcType=l,h}),o(a,"createBookmarkData",function(e){const t={};return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.text=e.text,t.type=e.type,t}),o(a,"createChartData",function(e){const t={};if(t.name=e.name,t.minValue=e.minValue,t.maxValue=e.maxValue,t.intervalValue=e.intervalValue,t.operationlayer=[],t.metadataArray=[],t.isXlsx=!0,e.operationArray!=null)for(var n=0;n<e.operationArray.length;n++)t.operationlayer.push(a.getAbsoluteAddress(e.operationArray[n].source));(e.body!=null||e.metadata!=null)&&(t.metadata=a.getAbsoluteAddress(e.metadata.source));for(var n=0,i=e.metadataArray.length;n<i;n++){const r=e.metadataArray[n],c=r.source,l={site:a.getAbsoluteAddress(c)};r.minValue!=1&&(l.minValue=r.minValue),r.intervalValue!=1&&(l.intervalValue=r.intervalValue),t.metadataArray.push(l)}return t.site=a.getAbsoluteAddress(e),t}),o(a,"seekSource",function(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n];if(i.parent==null){if(t.length==0)t.push(i);else for(let s=0;s<t.length;s++)if(t[s]!=i){t.push(i);break}}}return t}),o(a,"createBillboarMetadataData",function(e,t,n,i,s){const r={};return r.name=e,r.type=t,r.value=n,r.site=a.getAbsoluteAddress(i),r.componentType=s.type,r.componentValue=s.body.value,r.componentMinValue=s.minValue,r.componentMaxValue=s.maxValue,r.componentIntervalValue=s.intervalValue,r.list=s.list,r}),o(a,"createOperationLayerData",function(e,t,n,i,s,r,c,l){const h={};return h.name=e,h.type=t,h.value=n,h.site=a.getAbsoluteAddress(i),h.tag=s,h.operationArray=[],t===NodeType.Sheet&&c&&(h.sheetData=c,h.childCell=l),h.isSystemShow=r,h}),o(a,"createBillboarData",function(e,t,n){const i={};return i.name=e,i.site=a.getAbsoluteAddress(t),i.isBoard=!0,i.operationArray=[],i.metadataArray=[],i.monitored=n,i}),o(a,"createFolderData",function(e,t,n){const i={};return i.name=e,i.isFile=t,i.operationArray=[],i.site=a.getAbsoluteAddress(n),i}),o(a,"getBout",function(e){if(e.tree.length>1){if(e.tree[0].getValue()!=0&&e.tree[1].getValue()!=0&&Number(e.tree[0].getValue())>Number(e.tree[1].getValue())){let t=Number(e.tree[0].getValue()),n=0;for(let r=1;r<e.tree.length;r++)n+=Number(e.treeItem.getValue());let i=0,s=0;for(;t>=n;)s+=n,t-=n,i++;return[i,s/i]}return[0,0]}return[0,0]}),o(a,"copy",function(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=typeof e[n]=="object"?a.copy(e[n]):e[n]);return t}),o(a,"getIsBoundOutput",function(e,t){return t!=null?!1:e.isBoundOutput!=null?e.isBoundOutput:e.isBindingOperation}),o(a,"coordinate",function(e,t){let n=1;return a.visualVersionCompatibility&&(n=.5),e.view!=null?e.parent==null?[0,0]:[e.view.getX()*n,e.view.getY()*n]:[e.x*n,e.y*n]}),o(a,"parseStageBody",function(e,t,n,i){let s=null;for(let T=0;T<e.length;T++){const p=e[T];if(n==null&&p.parent!=null)return;if(p.type==NodeType.OperationBody||p.type=="运算体类"){var r;if(p.isFunction){r=a.createOperationBody(a.coordinate(e[T],n)[0],a.coordinate(e[T],n)[1],1,p.isWeight,p.isAdvance,p.funcType),r.isBindingOperation=a.getIsBoundOutput(e[T],n),a.operationBindBody(r),s==null&&(s=r);for(var c=0;c<p.tree.length;c++){const f=p.tree[c];if(f.type==NodeType.Macro){var l=new a.VariableValue(f.name,null,f.type);l.TID=f.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(r,l);y.setMacros(a.amendMacros(f)),y.enemyFlag=f.enemy,y.funcType=f.funcType,y.funcType==null&&(y.funcType=0),y.statistics=f.statistics,y.upDateValue=f.upDateValue,y.demoteValue=f.demoteValue,a.symbolicLink(y,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,f.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(f.type)){var l=new a.VariableValue(f.name,f.value,f.type);l.TID=f.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let g=a.createFunctionBody(r,l);g.enemyFlag=f.enemy,g.funcType=f.funcType,g.funcType==null&&(g.funcType=0),f.type==NodeType.Sheet&&(g.selectedOutputInfo=f.selectedOutputInfo?JSON.parse(f.selectedOutputInfo):""),g.statistics=f.statistics,g.upDateValue=f.upDateValue,g.demoteValue=f.demoteValue,g.isLogicalOpen=f.isLogicalOpen,g.isDragging=f.isDragging,g.snNo=f.snNo,g.logicalNumberList=f.logicalNumberList,g.currentStep=f.currentStep,g.snNo=f.snNo,g.minValue=f.minValue,g.maxValue=f.maxValue,g.step=f.step,g.logicalChildArray=[],f.logicalChildArray.forEach(b=>{const D=[];a.getLibraryBody(D,a.targetFolder.tree,a.getAbsoluteAddress(b));const x=D[0].copy();x.enemyFlag=f.enemy,x.funcType=f.funcType,x.funcType==null&&(x.funcType=0),x.statistics=f.statistics,x.upDateValue=f.upDateValue,x.demoteValue=f.demoteValue,g.logicalChildArray.push(x)}),a.symbolicLink(g,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,f.operator,t],null)}else{var h=[];i?a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(f.source)):a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(f));let y=h[0],g=a.createVariableBody(r,y);g.enemyFlag=f.enemy,g.funcType=f.funcType,g.funcType==null&&(g.funcType=0),f.type==NodeType.Sheet&&(g.selectedOutputInfo=f.selectedOutputInfo?JSON.parse(f.selectedOutputInfo):""),g.statistics=f.statistics,g.upDateValue=f.upDateValue,g.demoteValue=f.demoteValue,a.symbolicLink(g,f.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,f.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}else{r=a.createOperationBody(a.coordinate(e[T],n)[0],a.coordinate(e[T],n)[1],0,p.isWeight,p.isAdvance,p.funcType),r.isBindingOperation=a.getIsBoundOutput(e[T],n),a.operationBindBody(r),s==null&&(s=r);for(var c=0;c<p.tree.length;c++){const y=p.tree[c];if(y.type==NodeType.Macro){var l=new a.VariableValue(y.name,null,y.type);l.TID=y.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let b=a.createFunctionBody(r,l);b.setMacros(a.amendMacros(y)),b.enemyFlag=y.enemy,b.funcType=y.funcType,b.funcType==null&&(b.funcType=0),b.statistics=y.statistics,b.upDateValue=y.upDateValue,b.demoteValue=y.demoteValue,a.symbolicLink(b,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[b,y.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(y.type)){var l=new a.VariableValue(y.name,y.value,y.type);l.TID=y.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let b=a.createFunctionBody(r,l);b.enemyFlag=y.enemy,b.funcType=y.funcType,b.funcType==null&&(b.funcType=0),y.type==NodeType.Sheet&&(b.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),b.statistics=y.statistics,b.upDateValue=y.upDateValue,b.demoteValue=y.demoteValue,b.isLogicalOpen=y.isLogicalOpen,b.isDragging=y.isDragging,b.snNo=y.snNo,b.logicalNumberList=y.logicalNumberList,b.currentStep=y.currentStep,b.snNo=y.snNo,b.minValue=y.minValue,b.maxValue=y.maxValue,b.step=y.step,b.logicalChildArray=[],y.logicalChildArray.forEach(D=>{const v=[];a.getLibraryBody(v,a.targetFolder.tree,a.getAbsoluteAddress(D));const V=v[0].copy();V.enemyFlag=y.enemy,V.funcType=y.funcType,V.funcType==null&&(V.funcType=0),V.statistics=y.statistics,V.upDateValue=y.upDateValue,V.demoteValue=y.demoteValue,b.logicalChildArray.push(V)}),a.symbolicLink(b,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[b,y.operator,t],null)}else{var h=[];i||y.source?a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(y.source)):a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(y));let b=h[0],D=a.createVariableBody(r,b);D.enemyFlag=y.enemy,D.funcType=y.funcType,D.funcType==null&&(D.funcType=0),y.type==NodeType.Sheet&&(D.selectedOutputInfo=y.selectedOutputInfo?JSON.parse(y.selectedOutputInfo):""),D.statistics=y.statistics,D.upDateValue=y.upDateValue,D.demoteValue=y.demoteValue,a.symbolicLink(D,y.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[D,y.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}if(p.isFormula){var m=new a.FormulaData(p.formulaName,p.formulaX,p.formulaY);m.body=r,m.body&&(m.body.isBindingFormula=!0),r.formulaBody=m,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[m,r.view,t],null)}}else if(p.type==NodeType.SymbolBody||p.type=="符号运算体类"){const f=a.createSymbolBody(null,null,p.operator,p.isFunctionId,p.isWeight,p.funcType);f.isBindingOperation=a.getIsBoundOutput(e[T],n),a.operationBindBody(f),s==null&&(s=f),f.view!=null&&(f.view.setX(a.coordinate(e[T],n)[0]),f.view.setY(a.coordinate(e[T],n)[1]));for(var c=0;c<p.tree.length;c++){const g=p.tree[c];if(g.type==NodeType.OperationBody||g.type=="运算体类")if(g.isFunction){var r=a.createOperationBody(a.coordinate(g,n)[0],a.coordinate(g,n)[1],1,g.isWeight,g.isAdvance,g.funcType);r.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(r),a.addBody(f,r,!1);for(var d=0;d<g.tree.length;d++){const D=g.tree[d];if(D.type==NodeType.Macro){var l=new a.VariableValue(D.name,null,4);l.TID=D.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let x=a.createFunctionBody(r,l);x.macros=a.amendMacros(D),x.enemyFlag=D.enemy,x.funcType=D.funcType,x.funcType==null&&(x.funcType=0),x.statistics=D.statistics,x.upDateValue=D.upDateValue,x.demoteValue=D.demoteValue,a.symbolicLink(x,D.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[x,D.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(D.type)){var l=new a.VariableValue(g.name,g.value,g.type);l.TID=g.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let x=a.createFunctionBody(r,l);x.enemyFlag=g.enemy,x.funcType=g.funcType,x.funcType==null&&(x.funcType=0),g.type==NodeType.Sheet&&(x.selectedOutputInfo=g.selectedOutputInfo?JSON.parse(g.selectedOutputInfo):""),x.statistics=g.statistics,x.upDateValue=g.upDateValue,x.demoteValue=g.demoteValue,x.isLogicalOpen=g.isLogicalOpen,x.isDragging=g.isDragging,x.snNo=g.snNo,x.logicalNumberList=g.logicalNumberList,x.currentStep=g.currentStep,x.snNo=g.snNo,x.minValue=g.minValue,x.maxValue=g.maxValue,x.step=g.step,x.logicalChildArray=[],g.logicalChildArray.forEach(V=>{const E=[];a.getLibraryBody(E,a.targetFolder.tree,a.getAbsoluteAddress(V));const F=E[0].copy();F.enemyFlag=g.enemy,F.funcType=g.funcType,F.funcType==null&&(F.funcType=0),F.statistics=g.statistics,F.upDateValue=g.upDateValue,F.demoteValue=g.demoteValue,x.logicalChildArray.push(F)}),a.symbolicLink(x,g.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[x,g.operator,t],null)}else{var h=[];i?a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(D.source)):a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(D));let x=h[0],V=a.createVariableBody(r,x);V.enemyFlag=D.enemy,V.funcType=D.funcType,V.funcType==null&&(V.funcType=0),D.type==NodeType.Sheet&&(V.selectedOutputInfo=D.selectedOutputInfo?JSON.parse(D.selectedOutputInfo):""),V.statistics=D.statistics,V.upDateValue=D.upDateValue,V.demoteValue=D.demoteValue,a.symbolicLink(V,D.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,D.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}else{var r=a.createOperationBody(a.coordinate(g,n)[0],a.coordinate(g,n)[1],0,g.isWeight,g.isAdvance,g.funcType);if(r.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(r),a.addBody(f,r,!1),g.tree==null)return null;for(var d=0;d<g.tree.length;d++){const v=g.tree[d];if(v.type==NodeType.Macro){var l=new a.VariableValue(v.name,null,v.type);l.TID=v.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let V=a.createFunctionBody(r,l);V.setMacros(a.amendMacros(v)),V.enemyFlag=v.enemy,V.funcType=v.funcType,V.funcType==null&&(V.funcType=0),V.statistics=v.statistics,V.upDateValue=v.upDateValue,V.demoteValue=v.demoteValue,a.symbolicLink(V,v.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,v.operator,t],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(v.type)){var l=new a.VariableValue(v.name,v.value,v.type);l.TID=v.TID,l.TID==null&&(l.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let V=a.createFunctionBody(r,l);V.enemyFlag=v.enemy,V.funcType=v.funcType,V.funcType==null&&(V.funcType=0),v.type==NodeType.Sheet&&(V.selectedOutputInfo=v.selectedOutputInfo?JSON.parse(v.selectedOutputInfo):""),V.statistics=v.statistics,V.upDateValue=v.upDateValue,V.demoteValue=v.demoteValue,V.isLogicalOpen=v.isLogicalOpen,V.isDragging=v.isDragging,V.snNo=v.snNo,V.logicalNumberList=v.logicalNumberList,V.currentStep=v.currentStep,V.snNo=v.snNo,V.minValue=v.minValue,V.maxValue=v.maxValue,V.step=v.step,V.logicalChildArray=[],v.logicalChildArray.forEach(E=>{const C=[];a.getLibraryBody(C,a.targetFolder.tree,a.getAbsoluteAddress(E));const L=C[0].copy();L.enemyFlag=v.enemy,L.funcType=v.funcType,L.funcType==null&&(L.funcType=0),L.statistics=v.statistics,L.upDateValue=v.upDateValue,L.demoteValue=v.demoteValue,V.logicalChildArray.push(L)}),a.symbolicLink(V,v.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[V,v.operator,t],null)}else{var h=[];i||v.source?a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(v.source)):a.getLibraryBody(h,a.targetFolder.tree,a.getAbsoluteAddress(v));let V=h[0],E=a.createVariableBody(r,V);E.enemyFlag=v.enemy,E.funcType=v.funcType,E.funcType==null&&(E.funcType=0),v.type==NodeType.Sheet&&(E.selectedOutputInfo=v.selectedOutputInfo?JSON.parse(v.selectedOutputInfo):""),E.statistics=v.statistics,E.upDateValue=v.upDateValue,E.demoteValue=v.demoteValue,a.symbolicLink(E,v.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[E,v.operator,t],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}else if(g.type==NodeType.SymbolBody||g.type=="符号运算体类"){var r=a.createSymbolBody(null,null,g.operator,g.isFunctionId,g.isWeight,g.funcType);r.isBindingOperation=a.getIsBoundOutput(g,n),a.operationBindBody(r),r.view!=null&&(r.view.setX(a.coordinate(g,n)[0]),r.view.setY(a.coordinate(g,n)[1])),a.loopGenerateBody(r,g.tree,t),a.addBody(f,r,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}}if(a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[f,t],null),p.isFormula){var m=new a.FormulaData(p.formulaName,p.formulaX,p.formulaY);m.body=f,m.body&&(m.body.isBindingFormula=!0),f.formulaBody=m,a.Call.send(a.Eve.SHIFT_ADD_FORMULA,[m,f.view,t],null)}}else if(p.type==NodeType.Bookmark){var r=a.createBookmark(p.x,p.y,p.width,p.height,p.text);a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[r,t],null)}}return s}),o(a,"amendMacros",function(e){return e.macros==null?e.macro:e.macros}),o(a,"fixedDecimal",function(e,t){switch(t){case 0:return Math.round(e);case 1:return Math.round(e*10)/10;case 2:return Math.round(e*100)/100;case 3:return Math.round(e*1e3)/1e3;case 4:return Math.round(e*1e4)/1e4}return 0}),o(a,"currencyConversion",function(e){const t=e%100,n=parseInt(String(e/100%100));let i=0;return e<1e5?i=parseInt(String(e/100/100%100)):i=parseInt(String(e/100/100)),[i,n,t]}),o(a,"replaceVariableBody",function(e,t,n){const i=t.copy();return e.replace(i,n),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,i],(function(s){}).bind(this)),i}),o(a,"createVariableBody",function(e,t){const n=t.copy();return e.addBody(n),a.Call.send(a.Eve.SHIFT_ADD_VARIABLEBODY,[e,n],(function(i){}).bind(this)),n}),o(a,"createFunctionBody",function(e,t){const n=t.copy();return e.addBody(n),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,n],(function(i){}).bind(this)),n}),o(a,"replaceFunctionBody",function(e,t,n){const i=t.copy();return e.replace(i,n),a.Call.send(a.Eve.SHIFT_ADD_FUNCTION,[e,i],(function(s){}).bind(this)),i}),o(a,"createOperationBody",function(e,t,n,i,s,r){const c=new a.OperationBody;c.isFunction=!!n,a.targetStoragePool.push(c),c.isWeight=i,c.isAdvance=s,c.funcType=r,(c.funcType==null||c.funcType==null)&&(c.funcType=0),c.x=e,c.y=t;let l=null;return a.Call.send(a.Eve.SHIFT_ADD_OPERATIONBODY,[e,t,n,c],(function(h){l=h,i&&l&&l.openWeight(),s&&l&&l.openAdvance()}).bind(this)),c}),o(a,"createBookmark",function(e,t,n,i,s){const r=new a.Bookmark;return r.x=e,r.y=t,r.width=n,r.id=++EventManager.IDINDEX,r.width==null&&(r.width=256),r.height=i,r.height==null&&(r.height=256),r.text=s,a.targetStoragePool.push(r),a.Call.send(a.Eve.SHIFT_ADD_BOOKMARK,[r],(function(c){}).bind(this)),r}),o(a,"createSymbolBody",function(e,t,n,i,s,r){const c=new a.SymbolBody;return c.isWeight=s,c.isFunctionId=i,c.funcType=r,(c.funcType==null||c.funcType==null)&&(c.funcType=0),c.operator=n,c.isFunctionId==null&&(c.isFunctionId=1),e!=null&&c.addBody(e),t!=null&&c.addBody(t),a.targetStoragePool.push(c),a.Call.send(a.Eve.SHIFT_ADD_SYMBOLBODY,[e,t,n,i,c],null),c}),o(a,"operationBindBody",function(e){e.isBindingOperation&&a.editBody!=null&&(a.editBody.body=e)}),o(a,"addBody",function(e,t,n){a.Call.send(a.Eve.ADD_OPERAND_DATA,[e,t,n],null)}),o(a,"symbolicLink",function(e,t){t!=null&&(t=="删除符号"||t=="删除运算体"||t=="导出公式"||t=="敌方标记"||(e.operator=t))}),o(a,"loopGenerateBody",function(e,t,n){for(let h=0;h<t.length;h++){const m=t[h];switch(m.type){case"OperationBody":if(m.isFunction){var i=a.createOperationBody(a.coordinate(t[h])[0],a.coordinate(t[h])[1],1,m.isWeight,m.isAdvance,m.funcType);i.isBindingOperation=a.getIsBoundOutput(t[h]),a.operationBindBody(i),a.addBody(e,i,!1);for(var s=0;s<m.tree.length;s++){const d=m.tree[s];if(d.type==NodeType.Macro){var r=new a.VariableValue(d.name,null,d.type);r.TID=d.TID,r.TID==null&&(r.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let T=a.createFunctionBody(i,r);T.macros=a.amendMacros(d),T.enemyFlag=d.enemy,T.funcType=d.funcType,T.funcType==null&&(T.funcType=0),T.statistics=d.statistics,T.upDateValue=d.upDateValue,T.demoteValue=d.demoteValue,a.symbolicLink(T,d.operator),a.clickBody=T,a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[T,d.operator,n],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(d.type)){var r=new a.VariableValue(d.name,d.value,d.type);r.TID=d.TID,r.TID==null&&(r.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let p=a.createFunctionBody(i,r);p.enemyFlag=d.enemy,p.funcType=d.funcType,p.funcType==null&&(p.funcType=0),d.type==NodeType.Sheet&&(p.selectedOutputInfo=d.selectedOutputInfo?JSON.parse(d.selectedOutputInfo):""),p.statistics=d.statistics,p.upDateValue=d.upDateValue,p.demoteValue=d.demoteValue,p.isLogicalOpen=d.isLogicalOpen,p.isDragging=d.isDragging,p.snNo=d.snNo,p.logicalNumberList=d.logicalNumberList,p.currentStep=d.currentStep,p.snNo=d.snNo,p.minValue=d.minValue,p.maxValue=d.maxValue,p.step=d.step,p.logicalChildArray=[],d.logicalChildArray.forEach(f=>{const y=[];a.getLibraryBody(y,a.targetFolder.tree,a.getAbsoluteAddress(f));const b=y[0].copy();b.enemyFlag=d.enemy,b.funcType=d.funcType,b.funcType==null&&(b.funcType=0),b.statistics=d.statistics,b.upDateValue=d.upDateValue,b.demoteValue=d.demoteValue,p.logicalChildArray.push(b)}),a.symbolicLink(p,d.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[p,d.operator,n],null)}else{var c=[];a.getLibraryBody(c,a.targetFolder.tree,a.getAbsoluteAddress(d));let T=c[0],p=a.createVariableBody(i,T);p.enemyFlag=d.enemy,p.funcType=d.funcType,p.funcType==null&&(p.funcType=0),d.type==NodeType.Sheet&&(p.selectedOutputInfo=d.selectedOutputInfo?JSON.parse(d.selectedOutputInfo):""),p.statistics=d.statistics,p.upDateValue=d.upDateValue,p.demoteValue=d.demoteValue,a.symbolicLink(p,d.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[p,d.operator,n],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[i,n],null)}else{var i=a.createOperationBody(a.coordinate(t[h])[0],a.coordinate(t[h])[1],0,m.isWeight,m.isAdvance,m.funcType);i.isBindingOperation=a.getIsBoundOutput(t[h]),a.operationBindBody(i),a.addBody(e,i,!1);for(var s=0;s<m.tree.length;s++){const p=m.tree[s];if(p.type==NodeType.Macro){var r=new a.VariableValue(p.name,null,p.type);r.TID=p.TID,r.TID==null&&(r.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(i,r);y.setMacros(a.amendMacros(p)),y.enemyFlag=p.enemy,y.funcType=p.funcType,y.funcType==null&&(y.funcType=0),y.statistics=p.statistics,y.upDateValue=p.upDateValue,y.demoteValue=p.demoteValue,a.symbolicLink(y,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,p.operator,n],null)}else if([NodeType.LogicalBasic,NodeType.LogicalBool,NodeType.LogicalSlider].includes(p.type)){var r=new a.VariableValue(p.name,p.value,p.type);r.TID=p.TID,r.TID==null&&(r.TID=new Date().getTime()+a.functionAddIndex,a.functionAddIndex++);let y=a.createFunctionBody(i,r);y.enemyFlag=p.enemy,y.funcType=p.funcType,y.funcType==null&&(y.funcType=0),p.type==NodeType.Sheet&&(y.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),y.statistics=p.statistics,y.upDateValue=p.upDateValue,y.demoteValue=p.demoteValue,y.isLogicalOpen=p.isLogicalOpen,y.isDragging=p.isDragging,y.snNo=p.snNo,y.logicalNumberList=p.logicalNumberList,y.currentStep=p.currentStep,y.snNo=p.snNo,y.minValue=p.minValue,y.maxValue=p.maxValue,y.step=p.step,y.logicalChildArray=[],p.logicalChildArray.forEach(g=>{const b=[];a.getLibraryBody(b,a.targetFolder.tree,a.getAbsoluteAddress(g));const v=b[0].copy();v.enemyFlag=p.enemy,v.funcType=p.funcType,v.funcType==null&&(v.funcType=0),v.statistics=p.statistics,v.upDateValue=p.upDateValue,v.demoteValue=p.demoteValue,y.logicalChildArray.push(v)}),a.symbolicLink(y,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[y,p.operator,n],null)}else{var c=[];a.getLibraryBody(c,a.targetFolder.tree,a.getAbsoluteAddress(p));let y=c[0],g=a.createVariableBody(i,y);g.enemyFlag=p.enemy,g.funcType=p.funcType,g.funcType==null&&(g.funcType=0),p.type==NodeType.Sheet&&(g.selectedOutputInfo=p.selectedOutputInfo?JSON.parse(p.selectedOutputInfo):""),g.statistics=p.statistics,g.upDateValue=p.upDateValue,g.demoteValue=p.demoteValue,a.symbolicLink(g,p.operator),a.Call.send(a.Eve.SHIFT_SHOW_VIEW,[g,p.operator,n],null)}}a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[i,n],null)}break;case"SymbolBody":var l=a.createSymbolBody(null,null,m.operator,m.isFunctionId,m.isWeight,m.funcType);l.isBindingOperation=a.getIsBoundOutput(t[h]),a.operationBindBody(l),l.view!=null&&(l.view.setX(a.coordinate(t[h])[0]),l.view.setY(a.coordinate(t[h])[1])),a.loopGenerateBody(l,m.tree,n),a.addBody(e,l,!1),a.Call.send(a.Eve.SHIFT_SHOW_VIEW_ON,[l,n],null);break}}}),o(a,"saveFXTree",function(e,t){if(e!=null)for(let n=0;n<e.length;n++){const i=e[n];if(i.type==NodeType.Macro){const s={TID:i.TID,name:i.name,code:i.macros};t.push(s)}else a.saveFXTree(i.tree,t)}}),o(a,"recursiveStorage",function(e,t){if(e.operationArray!=null)for(let n=0;n<e.operationArray.length;n++){const i=e.operationArray[n];if(i.tree!=null)for(let s=0;s<i.tree.length;s++){const r=i.tree[s];if(r.type==NodeType.Macro){const c={TID:r.TID,name:r.name,code:r.macros};t.push(c)}else a.saveFXTree(r.tree,t)}i.operationArray!=null&&a.recursiveStorage(i,t)}}),o(a,"init",function(){try{a.isStart===!1&&(a.isStart=!0,a.code=!0,new a.FXCentre)}catch(e){console.error("Error initializing FX system:",e),a.isStart=!1,a.code=!1}});let fx=a;const globalThis_=function(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{}}();globalThis_.fx=fx;globalThis_.seer=fx;const scriptRel="modulepreload",assetsURL=function(u,e){return new URL(u,e).href},seen={},__vitePreload=function u(e,t,n){let i=Promise.resolve();if(t&&t.length>0){const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));i=Promise.allSettled(t.map(h=>{if(h=assetsURL(h,n),h in seen)return;seen[h]=!0;const m=h.endsWith(".css"),d=m?'[rel="stylesheet"]':"";if(!!n)for(let f=r.length-1;f>=0;f--){const y=r[f];if(y.href===h&&(!m||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${d}`))return;const p=document.createElement("link");if(p.rel=m?"stylesheet":scriptRel,m||(p.as="script"),p.crossOrigin="",p.href=h,l&&p.setAttribute("nonce",l),document.head.appendChild(p),m)return new Promise((f,y)=>{p.addEventListener("load",f),p.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${h}`)))})}))}function s(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return i.then(r=>{for(const c of r||[])c.status==="rejected"&&s(c.reason);return e().catch(s)})},en={meta:{title:"SoonFx Engine - Interactive Battle Demo"},header:{title:"⚔️ Interactive Battle Simulation",subtitle:"Real-time combat data visualization and analysis powered by SoonFx Engine",langSwitch:"中文"},scenarios:{title:"🎮 Battle Scenarios",pve:{label:"📈 Level Progression (1-50)",desc:"Watch how stats scale across levels"},newbie:{label:"🌱 Newbie Village (Lv 1-10)",desc:"First steps in the adventure"},midgame:{label:"⚔️ Mid-Game Challenge (Lv 20-30)",desc:"Intermediate difficulty battles"},custom:{label:"🔧 Custom Simulation",desc:"Adjust stats and fight!"},tip:{label:"💡 Tip:",text:"Click on any data point in the charts to see detailed battle information for that level."}},charts:{hpByLevel:"❤️ Health Points (HP) by Level",damageByLevel:"💥 Attack Damage by Level",roundsByLevel:"⏱️ Battle Duration (Rounds) by Level",hpByRound:"❤️ Health Points (HP) by Round",damageByRound:"💥 Damage by Round",loading:"Running simulations...",details:{title:"📋 Battle Details",hpChange:"HP Change Over Rounds",damageStats:"Damage Statistics",waiting:"Waiting for simulation..."}},story:{pveGrowth:{title:"📊 Level Progression Analysis",desc:"Simulating 50 battles to show how character stats evolve from novice to master..."},newbie:{title:"🌱 The First Adventure",desc:"A young hero takes their first steps, facing level 1-10 slimes in the Newbie Village..."},midGame:{title:"⚔️ Rising Challenge",desc:"The hero has grown stronger (Lv 20-30) and now faces tougher enemies in the Dark Forest..."},custom:{title:"🔧 Custom Battle Simulation",desc:"Manually configure hero and enemy attributes to test specific combat scenarios."}},custom:{title:"⚙️ Battle Configuration",start:"Start Battle",stop:"Stop Battle",running:"Fighting...",simCount:"Simulations:",hero:"🦸 Hero",enemy:"👹 Enemy",level:"Level",hp:"HP",attack:"Attack",defense:"Defense",presets:{balanced:"⚖️ Balanced",heroStrong:"💪 Strong Hero",enemyStrong:"👹 Strong Enemy",tank:"🛡️ Tank Build",glass:"🗡️ Glass Cannon"},report:{title:"📊 Batch Simulation Report ({count} runs)",winRate:"Win Rate: {rate}%",avgRounds:"Avg Rounds: {rounds}",avgHeroHp:"Avg Hero Remaining HP: {hp}",losses:"Losses: {count}",minRounds:"Min Rounds: {rounds}",maxRounds:"Max Rounds: {rounds}"}},status:{running:"🔄 Running {scenario} simulation...",simulating:"🔄 Simulating battles... {current}/{total} ({percent}%)",stopping:"⏹️ Stopping battle...",stopped:"⏹️ Battle stopped",success:"✅ Simulation complete! Click on any chart point to see detailed battle data.",error:"❌ Simulation failed: {message}",cannotModifyLevel:"⚠️ Cannot modify level during battle!",battleDetails:{header:"========== Level {level} Battle Details ==========",duration:"Battle Duration: {rounds} rounds",hp:"Hero Final HP: {hp}",damage:"Average Damage: {damage}",footer:"========================================"}}},zhCN={meta:{title:"SoonFx 引擎 - 交互式战斗演示"},header:{title:"⚔️ 交互式战斗模拟",subtitle:"基于 SoonFx 引擎的实时战斗数据可视化与分析",langSwitch:"English"},scenarios:{title:"🎮 战斗场景",pve:{label:"📈 等级成长 (1-50)",desc:"观察属性如何随等级提升而变化"},newbie:{label:"🌱 新手村 (Lv 1-10)",desc:"冒险旅程的第一步"},midgame:{label:"⚔️ 中期挑战 (Lv 20-30)",desc:"面对更强大的敌人"},custom:{label:"🔧 自定义模拟",desc:"调整属性并战斗！"},tip:{label:"💡 提示:",text:"点击图表中的任意数据点查看该等级的详细战斗信息。"}},charts:{hpByLevel:"❤️ 生命值 (HP) 随等级变化",damageByLevel:"💥 攻击伤害随等级变化",roundsByLevel:"⏱️ 战斗回合数随等级变化",hpByRound:"❤️ 生命值 (HP) 随回合变化",damageByRound:"💥 伤害随回合变化",loading:"正在运行模拟...",details:{title:"📋 战斗详情",hpChange:"回合生命值变化",damageStats:"伤害统计",waiting:"等待模拟..."}},story:{pveGrowth:{title:"📊 等级成长分析",desc:"模拟 50 场战斗，展示角色属性如何从新手成长为大师..."},newbie:{title:"🌱 初次冒险",desc:"年轻的英雄迈出了第一步，在新手村面对 1-10 级的史莱姆..."},midGame:{title:"⚔️ 挑战升级",desc:"英雄变强了 (Lv 20-30)，现在要在黑暗森林中面对更棘手的敌人..."},custom:{title:"🔧 自定义战斗模拟",desc:"手动配置英雄和敌人的属性以测试特定的战斗场景。"}},custom:{title:"⚙️ 战斗配置",start:"开始战斗",stop:"停止战斗",running:"战斗中...",simCount:"模拟次数:",hero:"🦸 英雄",enemy:"👹 敌人",level:"等级",hp:"生命值",attack:"攻击力",defense:"防御力",presets:{balanced:"⚖️ 平衡",heroStrong:"💪 英雄强",enemyStrong:"👹 敌人强",tank:"🛡️ 坦克型",glass:"🗡️ 玻璃炮"},report:{title:"📊 批量模拟报告 (运行 {count} 次)",winRate:"胜率: {rate}%",avgRounds:"平均回合: {rounds}",avgHeroHp:"平均英雄剩余HP: {hp}",losses:"失败次数: {count}",minRounds:"最少回合: {rounds}",maxRounds:"最多回合: {rounds}"}},status:{running:"🔄 正在运行 {scenario} 模拟...",simulating:"🔄 正在模拟战斗... {current}/{total} ({percent}%)",stopping:"⏹️ 正在停止战斗...",stopped:"⏹️ 战斗已停止",success:"✅ 模拟完成！点击图表上的任意点查看详细战斗数据。",error:"❌ 模拟失败: {message}",cannotModifyLevel:"⚠️ 战斗中不能修改等级！",battleDetails:{header:"========== 等级 {level} 战斗详情 ==========",duration:"战斗持续: {rounds} 回合",hp:"英雄最终 HP: {hp}",damage:"平均伤害: {damage}",footer:"========================================"}}};class I18nService{constructor(){this.currentLocale="en",this.messages={en,"zh-CN":zhCN},this.listeners=[];const t=new URLSearchParams(window.location.search).get("lang");t==="zh-CN"||t==="zh"?this.currentLocale="zh-CN":t==="en"?this.currentLocale="en":this.currentLocale="en"}get locale(){return this.currentLocale}setLocale(e){this.currentLocale!==e&&(this.currentLocale=e,this.updateURL(),this.notifyListeners(),this.updatePage())}toggleLocale(){this.setLocale(this.currentLocale==="en"?"zh-CN":"en")}t(e,t){const n=e.split(".");let i=this.messages[this.currentLocale];for(const s of n)if(i&&typeof i=="object"&&s in i)i=i[s];else return e;return typeof i!="string"?e:t?Object.entries(t).reduce((s,[r,c])=>s.replace(`{${r}}`,String(c)),i):i}subscribe(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>e())}updateURL(){const e=new URL(window.location.href);e.searchParams.set("lang",this.currentLocale),window.history.replaceState({},"",e.toString())}updatePage(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=this.t(t))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=this.t(t))}),document.title=this.t("meta.title"),document.documentElement.lang=this.currentLocale}}const i18n=new I18nService;class ChartController{constructor(e){this.chartInstances={},this.pveBattleData=null,this.onPointClick=e,window.addEventListener("resize",()=>{Object.values(this.chartInstances).forEach(t=>{t.resize()})}),i18n.subscribe(()=>{this.pveBattleData&&this.updateChartTitles()})}async initCharts(){return Promise.resolve()}updateChartTitles(){}updateCharts(e,t){var l,h,m;if(!e||e.length===0)return;this.pveBattleData=e;const n=e.map(d=>`Lv ${d.level}`),i=e.map(d=>d.hp),s=e.map(d=>d.damage),r=e.map(d=>d.rounds),c=t!==null?e.findIndex(d=>d.level===t):-1;this.chartInstances.hpChart||((l=document.getElementById("hpPlaceholder"))==null||l.classList.add("hidden"),this.chartInstances.hpChart=this.createLineChart("hpChart","Health Points","rgb(75, 192, 192)")),this.updateChartData(this.chartInstances.hpChart,n,i,c,"rgb(75, 192, 192)",!1,i18n.t("charts.hpByLevel")),this.chartInstances.damageChart||((h=document.getElementById("damagePlaceholder"))==null||h.classList.add("hidden"),this.chartInstances.damageChart=this.createLineChart("damageChart","Attack Damage","rgb(255, 99, 132)")),this.updateChartData(this.chartInstances.damageChart,n,s,c,"rgb(255, 99, 132)",!1,i18n.t("charts.damageByLevel")),this.chartInstances.roundsChart||((m=document.getElementById("roundsPlaceholder"))==null||m.classList.add("hidden"),this.chartInstances.roundsChart=this.createLineChart("roundsChart","Battle Duration","rgb(153, 102, 255)")),this.updateChartData(this.chartInstances.roundsChart,n,r,c,"rgb(153, 102, 255)",!0,i18n.t("charts.roundsByLevel"))}clearCharts(){Object.values(this.chartInstances).forEach(e=>{e.dispose()}),this.chartInstances={}}updateChartsWithBattleRounds(e,t,n){var h,m;if(!e||e.length===0)return;const i=e.map(d=>`R${d.round}`),s=e.map(d=>d.heroHp),r=e.map(d=>d.enemyHp),c=e.map(d=>d.heroDamageDealt||0),l=e.map(d=>d.enemyDamageDealt||0);e.map(d=>d.heroHpPercent||0),e.map(d=>d.enemyHpPercent||0),(h=document.getElementById("hpPlaceholder"))==null||h.classList.add("hidden"),this.chartInstances.hpChart||(this.chartInstances.hpChart=this.createLineChart("hpChart","HP","rgb(75, 192, 192)")),this.updateDualLineChart(this.chartInstances.hpChart,i,s,r,t,n,"rgb(45, 105, 105)","rgb(255, 99, 132)"),(m=document.getElementById("damagePlaceholder"))==null||m.classList.add("hidden"),this.chartInstances.damageChart||(this.chartInstances.damageChart=this.createLineChart("damageChart","Damage","rgb(255, 99, 132)")),this.updateDualBarChart(this.chartInstances.damageChart,i,c,l,t,n)}updateDualLineChart(e,t,n,i,s,r,c,l){const h=e.getOption();if(h&&h.series&&h.series.length===2&&h.series[0].name===s&&h.series[1].name===r&&h.series[0].type==="line")e.setOption({xAxis:{data:t},series:[{data:n},{data:i}]});else{const d={animation:!0,animationDuration:300,animationEasing:"cubicOut",tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[s,r],textStyle:{color:"#f1f5f9",fontSize:10},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8",fontSize:10}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:s,type:"line",data:n,smooth:.3,lineStyle:{color:c,width:2},itemStyle:{color:c},areaStyle:{color:c.replace("rgb","rgba").replace(")",", 0.2)")},animation:!0,animationDuration:300,animationEasing:"cubicOut"},{name:r,type:"line",data:i,smooth:.3,lineStyle:{color:l,width:2},itemStyle:{color:l},areaStyle:{color:l.replace("rgb","rgba").replace(")",", 0.2)")},animation:!0,animationDuration:300,animationEasing:"cubicOut"}]};e.setOption(d)}}updateDualBarChart(e,t,n,i,s,r){const c=e.getOption();if(c&&c.series&&c.series.length===2&&c.series[0].name===s&&c.series[1].name===r&&c.series[0].type==="bar")e.setOption({xAxis:{data:t},series:[{data:n},{data:i}]});else{const h={animation:!0,animationDuration:300,animationEasing:"cubicOut",tooltip:{trigger:"axis",axisPointer:{type:"shadow"},confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[s,r],textStyle:{color:"#f1f5f9",fontSize:10},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8",fontSize:10}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:s,type:"bar",data:n,itemStyle:{color:"rgba(75, 192, 192, 0.8)"},animation:!0,animationDuration:300,animationEasing:"cubicOut"},{name:r,type:"bar",data:i,itemStyle:{color:"rgba(255, 99, 132, 0.8)"},animation:!0,animationDuration:300,animationEasing:"cubicOut"}]};e.setOption(h)}}createDetailCharts(e,t,n){this.createDetailHpChart(e,t,n),this.createDetailDamageChart(e,t,n)}createLineChart(e,t,n){const i=document.getElementById(e);if(!i)throw new Error(`Canvas container ${e} not found`);const s=init(i);return s.getZr().on("click",r=>{if(!this.pveBattleData)return;const c=[r.offsetX,r.offsetY];if(s.containPixel({seriesIndex:0},c)){const l=s.convertFromPixel({seriesIndex:0},c);if(l){const h=l[0];h>=0&&h<this.pveBattleData.length&&this.onPointClick(h)}}}),s}updateChartData(e,t,n,i,s,r=!1,c){const l={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"},borderColor:s},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",scale:r,minInterval:r?1:0,splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:c||"Value",type:"line",data:n.map((h,m)=>({value:h,itemStyle:{color:m===i?"rgb(255, 200, 0)":s,borderColor:m===i?"rgb(255, 200, 0)":s},symbolSize:m===i?8:3})),smooth:.3,lineStyle:{color:s,width:2},areaStyle:{color:new LinearGradient(0,0,0,1,[{offset:0,color:s.replace("rgb","rgba").replace(")",", 0.5)")},{offset:1,color:s.replace("rgb","rgba").replace(")",", 0.0)")}])}}]};e.setOption(l)}createDetailHpChart(e,t,n){const i=document.getElementById("detailHpChart");if(!i)return;this.chartInstances.detailHpChart&&this.chartInstances.detailHpChart.dispose();const s=e.map(m=>`R${m.round}`),r=e.map(m=>m.heroHp),c=e.map(m=>m.enemyHp),l=init(i);this.chartInstances.detailHpChart=l;const h={tooltip:{trigger:"axis",confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[`${t} HP`,`${n} HP`],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:s,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:`${t} HP`,type:"line",data:r,smooth:.3,lineStyle:{color:"rgb(75, 192, 192)"},itemStyle:{color:"rgb(75, 192, 192)"},areaStyle:{color:"rgba(75, 192, 192, 0.2)"}},{name:`${n} HP`,type:"line",data:c,smooth:.3,lineStyle:{color:"rgb(255, 99, 132)"},itemStyle:{color:"rgb(255, 99, 132)"},areaStyle:{color:"rgba(255, 99, 132, 0.2)"}}]};l.setOption(h)}createDetailDamageChart(e,t,n){const i=document.getElementById("detailDamageChart");if(!i)return;this.chartInstances.detailDamageChart&&this.chartInstances.detailDamageChart.dispose();const s=e.reduce((d,T)=>d+(T.heroDamageDealt||0),0),r=e.reduce((d,T)=>d+(T.enemyDamageDealt||0),0),c=parseFloat((s/e.length).toFixed(1)),l=parseFloat((r/e.length).toFixed(1)),h=init(i);this.chartInstances.detailDamageChart=h;const m={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},confine:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:[t,n],textStyle:{color:"#f1f5f9"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:["Total Damage","Avg Damage/Round"],axisLine:{show:!1},axisLabel:{color:"#94a3b8"}},yAxis:{type:"value",splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"#94a3b8"}},series:[{name:t,type:"bar",data:[s,c],itemStyle:{color:"rgba(75, 192, 192, 0.8)"}},{name:n,type:"bar",data:[r,l],itemStyle:{color:"rgba(255, 99, 132, 0.8)"}}]};h.setOption(m)}}class CharacterView{constructor(e){this.heroElement=null,this.enemyElement=null,this.heroHpBar=null,this.enemyHpBar=null,this.heroHpText=null,this.enemyHpText=null;const t=document.getElementById(e);if(!t)throw new Error(`Container with id "${e}" not found`);this.container=t}init(){this.container.innerHTML=`
            <div class="battle-arena">
                <div class="character-view hero-view" id="heroView">
                    <div class="character-sprite" id="heroSprite">
                        <div class="character-avatar">🦸</div>
                    </div>
                    <div class="character-info">
                        <div class="character-name" id="heroName">Hero</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar" id="heroHpBar">
                                <div class="hp-fill" id="heroHpFill"></div>
                            </div>
                            <div class="hp-text" id="heroHpText">1000/1000</div>
                        </div>
                        <div class="character-stats" id="heroStats">
                            <span>Lv.10</span>
                            <span>ATK: 100</span>
                        </div>
                    </div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="character-view enemy-view" id="enemyView">
                    <div class="character-sprite" id="enemySprite">
                        <div class="character-avatar">👹</div>
                    </div>
                    <div class="character-info">
                        <div class="character-name" id="enemyName">Enemy</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar" id="enemyHpBar">
                                <div class="hp-fill" id="enemyHpFill"></div>
                            </div>
                            <div class="hp-text" id="enemyHpText">1000/1000</div>
                        </div>
                        <div class="character-stats" id="enemyStats">
                            <span>Lv.10</span>
                            <span>ATK: 90</span>
                        </div>
                    </div>
                </div>
            </div>
        `,this.heroElement=document.getElementById("heroView"),this.enemyElement=document.getElementById("enemyView"),this.heroHpBar=document.getElementById("heroHpFill"),this.enemyHpBar=document.getElementById("enemyHpFill"),this.heroHpText=document.getElementById("heroHpText"),this.enemyHpText=document.getElementById("enemyHpText")}updateCharacters(e,t){const n=document.getElementById("heroName"),i=document.getElementById("enemyName"),s=document.getElementById("heroStats"),r=document.getElementById("enemyStats");n&&(n.textContent=e.name||"Hero"),i&&(i.textContent=t.name||"Enemy"),s&&(s.innerHTML=`
                <span>Lv.${e.level||1}</span>
                <span>ATK: ${e.attack||0}</span>
            `),r&&(r.innerHTML=`
                <span>Lv.${t.level||1}</span>
                <span>ATK: ${t.attack||0}</span>
            `),this.updateHp(e.maxHp||e.hp,e.maxHp||e.hp,"hero"),this.updateHp(t.maxHp||t.hp,t.maxHp||t.hp,"enemy")}updateHp(e,t,n){const i=n==="hero"?this.heroHpBar:this.enemyHpBar,s=n==="hero"?this.heroHpText:this.enemyHpText;if(i){const r=Math.max(0,Math.min(100,e/t*100));i.style.width=`${r}%`,r>60?i.style.backgroundColor="#10b981":r>30?i.style.backgroundColor="#f59e0b":i.style.backgroundColor="#ef4444"}s&&(s.textContent=`${Math.max(0,Math.round(e))}/${t}`)}async playLandingAnimation(){return new Promise(e=>{var t,n;this.heroElement&&(this.heroElement.style.opacity="0",this.heroElement.style.transform="translateY(-100px) scale(0.5)",this.heroElement.style.transition="none"),this.enemyElement&&(this.enemyElement.style.opacity="0",this.enemyElement.style.transform="translateY(-100px) scale(0.5)",this.enemyElement.style.transition="none"),(t=this.heroElement)==null||t.offsetHeight,(n=this.enemyElement)==null||n.offsetHeight,this.heroElement&&(this.heroElement.style.transition="all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)",this.heroElement.style.opacity="1",this.heroElement.style.transform="translateY(0) scale(1)"),setTimeout(()=>{this.enemyElement&&(this.enemyElement.style.transition="all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)",this.enemyElement.style.opacity="1",this.enemyElement.style.transform="translateY(0) scale(1)")},150),setTimeout(()=>{e()},800)})}async playAttackAnimation(e){return new Promise(t=>{const n=e==="hero"?this.heroElement:this.enemyElement,i=e==="hero"?this.enemyElement:this.heroElement;if(!n||!i){t();return}const s=n.querySelector(".character-sprite");if(!s){t();return}const r=s.style.transform||"";s.style.transition="transform 0.3s ease-out",s.style.transform=e==="hero"?"translateX(30px) scale(1.1)":"translateX(-30px) scale(1.1)",i.style.transition="all 0.1s",i.style.filter="brightness(1.5)",i.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform=r,i.style.filter="",i.style.transform="",setTimeout(()=>{t()},300)},300)})}async playHitAnimation(e,t){const n=e==="hero"?this.heroElement:this.enemyElement;if(!n)return;const i=document.createElement("div");i.className="damage-number",i.textContent=`-${Math.round(t)}`,i.style.position="absolute",i.style.color="#ef4444",i.style.fontSize="18px",i.style.fontWeight="bold",i.style.pointerEvents="none",i.style.zIndex="1000",i.style.textShadow="2px 2px 4px rgba(0,0,0,0.8)";const s=n.querySelector(".character-sprite");if(s){const r=s.getBoundingClientRect();i.style.left=`${r.left+r.width/2}px`,i.style.top=`${r.top}px`,document.body.appendChild(i),i.style.transition="all 0.8s ease-out",i.style.transform="translateY(-50px)",i.style.opacity="0",setTimeout(()=>{document.body.removeChild(i)},800)}n.style.transition="filter 0.2s",n.style.filter="brightness(1.5)",setTimeout(()=>{n.style.filter=""},200)}playVictoryAnimation(e){const t=e==="hero"?this.heroElement:this.enemyElement,n=e==="hero"?this.enemyElement:this.heroElement;t&&(t.style.transition="all 0.5s",t.style.transform="scale(1.1)",t.style.filter="brightness(1.2) drop-shadow(0 0 20px rgba(16, 185, 129, 0.8))"),n&&(n.style.transition="all 0.5s",n.style.opacity="0.5",n.style.filter="grayscale(100%)")}reset(){this.heroElement&&(this.heroElement.style.transform="",this.heroElement.style.opacity="",this.heroElement.style.filter=""),this.enemyElement&&(this.enemyElement.style.transform="",this.enemyElement.style.opacity="",this.enemyElement.style.filter="")}setVisible(e){this.container.style.display=e?"block":"none"}}class FxUtil{constructor(){this.playerList=[]}static getInstance(){return this._instance||(this._instance=new FxUtil),this._instance}getPlayerInstance(){let e=this._fxData[0],t=new Player;t.name=e.name,console.log(t.name);let n=t.getBillboard();return console.log(n),t.parameterInfoArray=e.parameterInfoArray,t}getEnemyInstance(e){let t=this._fxData[e],n=new Player;return n.name=t.name,n.parameterInfoArray=t.parameterInfoArray,n}getInstanceByName(e){let t=this._fxData.find(i=>i.name===e);if(!t)return console.warn(`未找到名称为 "${e}" 的角色配置`),null;let n=new Player;return n.name=t.name,n.parameterInfoArray=t.parameterInfoArray,n}loadConfig(e){new FXCentre;var t=e,n=typeof t=="string"?JSON.parse(t):t;n.stage.operationArray;var i=n.library.operationArray;fx.createLibraryBody(i,!0),this._fxPlayer=Player,this.playerList=[];let s=new fx.CallCenter;s.addEventListener(EventManager.SHIFT_ADD_BOARD,l=>{let h=new BillboardLayer(l.name);h.monitored=l.monitored;let m=h;for(var d=0;d<l.operationArray.length;d++){var T=[];fx.getLibraryBody(T,fx.targetFolder.tree,l.operationArray[d].site),fx.clickBody=T[0],m.pushOperationLayer(),fx.clickBody=null}for(var d=0;d<l.metadataArray.length;d++){var T=[];fx.getLibraryBody(T,fx.targetFolder.tree,l.metadataArray[d].site),fx.clickBody=T[0];let y=l.metadataArray[d];m.pushMetadata(y.componentType,y.componentMinValue,y.componentMaxValue,y.componentIntervalValue),fx.clickBody=null}fx.Call.send(fx.Eve.ADD_DATABASE_DATA,[m,fx.selectBody,l.index]),fx.Call.send(fx.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[m,fx.selectBody])}),s.addEventListener(EventManager.SHIFT_ADD_CHARTS,l=>{var h=new ChartsLayer(l.name);let m=h;for(var d=0;d<l.operationlayer.length;d++){var T=[];fx.getLibraryBody(T,fx.targetFolder.tree,l.operationlayer[d]),m.operationArray.push(T[0].copy())}var T=[];m.minValue=l.minValue,m.intervalValue=l.intervalValue,m.maxValue=l.maxValue,l.metadataArray||(l.metadataArray=[]),l.metadata&&(l.metadataArray=[{site:l.metadata,intervalValue:m.intervalValue,minValue:m.minValue}],l.metadata=null);for(var d=0;d<l.metadataArray.length;d++){var T=[],p=l.metadataArray[d];fx.getLibraryBody(T,fx.targetFolder.tree,p.site);var f=T[0].copy();f.intervalValue=p.intervalValue||1,f.minValue=p.minValue||1,m.metadataArray.push(f),m.metadata=f}Call.send(fx.Eve.ADD_DATABASE_DATA,[m,fx.selectBody,l.index]),fx.Call.send(fx.Eve.SHIFT_REFRESH_LIBRARY_COORDINATES,[m,fx.selectBody]),fx.clickBody=null}),fx.parseLibraryBody(i,!0),fx.recursionSyncBody(fx.targetFolder.tree);let r=n.entity.operationArray;this._fxData=r;let c=this.createPlayersFromEntityArray(r);console.log("-------------------"),c.forEach(l=>{let h=l.getFormula("攻击"),m=l.getFormula("生命"),d=l.getFormula("防御");console.log("name",l.name),console.log("attack",h),console.log("hp",m),console.log("defense",d)}),this.playerList=c}getDataByOccuAndLevel(e,t){this._fxPlayer.changePlayerLevelAndOccupation(t,e);let n=this._fxPlayer.getFormula("攻击1"),i=this._fxPlayer.getFormula("生命"),s=this._fxPlayer.getFormula("防御");return{attack:n,hp:i,defense:s}}getInstanceDataByNameAndOccuAndLevel(e,t,n){let i=this.playerList.find(l=>l.name===e);if(!i)throw new Error(`未找到名称为 "${e}" 的玩家`);i.changeLevelAndOccupation(n,t);let s=i.getFormula("攻击"),r=i.getFormula("生命"),c=i.getFormula("防御");return{attack:s,hp:r,defense:c}}createPlayersFromEntityArray(e){let t=[];for(var n=0;n<e.length;n++){let i=e[n],s=this.getInstanceByName(i.name);s?t.push(s):console.warn(`创建玩家实例失败: ${i.name}`)}return t}getSheetDataByPath(e){var s;let t=e.split("."),n=fx.targetFolder,i;for(let r=0;r<t.length;r++){let c;if(n.isFolder){if(c=n.tree.find(l=>l.name==t[r]),!c)throw new Error("getSheetDataByPath - 路径未找到: "+t[r])}else i=n;n=c,r==t.length-1&&(i=n)}return(s=i==null?void 0:i.sheetData)==null?void 0:s.originData}}window.FxUtil=FxUtil;class BattleLogger{constructor(e=!1){this.logs=[],this.battleData=[],this.silent=e}addLog(e){const n=`[${new Date().toLocaleTimeString("zh-CN")}] ${e}`;this.logs.push(n),this.silent||console.log(n)}addRoundData(e,t){this.battleData.push({round:e,timestamp:new Date().toISOString(),...t})}getLogs(){return[...this.logs]}getBattleData(){return[...this.battleData]}clear(){this.logs=[],this.battleData=[]}generateReport(){let e=`
========== 战斗报告 ==========
`;return e+=this.logs.join(`
`),e+=`

========== 战斗数据统计 ==========
`,e+=JSON.stringify(this.battleData,null,2),e+=`
================================
`,e}}const BattleLogger$1=Object.freeze(Object.defineProperty({__proto__:null,BattleLogger},Symbol.toStringTag,{value:"Module"}));class BattleEntity{constructor(e,t,n,i,s=1,r=1){this.name=e,this.maxHp=t,this.currentHp=t,this.attack=n,this.defense=i,this.level=s,this.occupation=r}isAlive(){return this.currentHp>0}takeDamage(e){const t=Math.max(1,e-this.defense);return this.currentHp=Math.max(0,this.currentHp-t),t}getStatus(){return`${this.name} [Lv.${this.level}] HP: ${this.currentHp}/${this.maxHp} | 攻击: ${this.attack} | 防御: ${this.defense}`}getHpPercentage(){return this.currentHp/this.maxHp*100}}const BattleEntity$1=Object.freeze(Object.defineProperty({__proto__:null,BattleEntity},Symbol.toStringTag,{value:"Module"}));class BattleSimulator{constructor(e,t,n){this.round=0,this.maxRounds=100,this.hero=e,this.enemy=t,this.logger=n}calculateDamage(e,t){let n=e.attack-t.defense;const i=.8+Math.random()*.4;return n=Math.floor(n*i),Math.max(1,n)}executeAttack(e,t){const n=this.calculateDamage(e,t),i=t.takeDamage(n);return this.logger.addLog(`  ${e.name} 攻击 ${t.name}，造成 ${i} 点伤害！（${t.name} 剩余血量: ${t.currentHp}/${t.maxHp}）`),i}battleRound(){this.round++,this.logger.addLog(`
----- 第 ${this.round} 回合 -----`),this.logger.addLog(`${this.hero.getStatus()}`),this.logger.addLog(`${this.enemy.getStatus()}`);const e={heroHp:this.hero.currentHp,heroHpPercent:this.hero.getHpPercentage(),enemyHp:this.enemy.currentHp,enemyHpPercent:this.enemy.getHpPercentage()},t=this.executeAttack(this.hero,this.enemy),n=()=>{e.enemyHp=this.enemy.currentHp,e.enemyHpPercent=this.enemy.getHpPercentage(),e.heroHp=this.hero.currentHp,e.heroHpPercent=this.hero.getHpPercentage()};if(!this.enemy.isAlive())return n(),this.logger.addLog(`
🎉 ${this.enemy.name} 被击败了！`),this.logger.addRoundData(this.round,{...e,heroDamageDealt:t,enemyDamageDealt:0,winner:this.hero.name,battleEnd:!0}),!0;const i=this.executeAttack(this.enemy,this.hero);return this.hero.isAlive()?(n(),this.logger.addRoundData(this.round,{...e,heroDamageDealt:t,enemyDamageDealt:i,battleEnd:!1}),!1):(this.logger.addLog(`
💀 ${this.hero.name} 被击败了！`),n(),this.logger.addRoundData(this.round,{...e,heroDamageDealt:t,enemyDamageDealt:i,winner:this.enemy.name,battleEnd:!0}),!0)}startBattle(){for(this.logger.addLog(`
========================================`),this.logger.addLog("⚔️  战斗开始！"),this.logger.addLog("========================================"),this.logger.addLog(`${this.hero.getStatus()}`),this.logger.addLog("VS"),this.logger.addLog(`${this.enemy.getStatus()}`),this.logger.addLog(`========================================
`);this.round<this.maxRounds&&!this.battleRound(););this.round>=this.maxRounds&&this.logger.addLog(`
⏱️  战斗超时，平局！`);const e=this.hero.isAlive()?this.hero.name:this.enemy.isAlive()?this.enemy.name:"平局";return this.logger.addLog(`
========================================`),this.logger.addLog("📊 战斗结束统计"),this.logger.addLog("========================================"),this.logger.addLog(`胜利者: ${e}`),this.logger.addLog(`总回合数: ${this.round}`),this.logger.addLog(`${this.hero.name} 最终状态: ${this.hero.getStatus()}`),this.logger.addLog(`${this.enemy.name} 最终状态: ${this.enemy.getStatus()}`),this.logger.addLog(`========================================
`),{winner:e,rounds:this.round,battleData:this.logger.getBattleData()}}}const BattleSimulator$1=Object.freeze(Object.defineProperty({__proto__:null,BattleSimulator},Symbol.toStringTag,{value:"Module"}));let fxInit=!1;async function initFx(){if(fxInit)return;const u=FxUtil.getInstance();try{const t=await(await fetch("./assets/fx.json")).json();u.loadConfig(t),fxInit=!0}catch(e){console.error("Failed to load fx.json",e)}}async function generatePVEDataRange(u,e=50,t=1,n){const i=[],s=t+e-1;await initFx();const r=FxUtil.getInstance();for(let c=t;c<=s;c++){if(n&&n())return console.log("PVE simulation stopped by user"),i;await new Promise(l=>requestAnimationFrame(()=>l(!0)));try{const l=new BattleLogger,h=r.getInstanceDataByNameAndOccuAndLevel("主角1",1,c),m=new BattleEntity("Hero",h.hp,h.attack,h.defense,c,1),d=r.getInstanceDataByNameAndOccuAndLevel("怪物1",1,c),T=new BattleEntity("Enemy",d.hp,d.attack,d.defense,c,1),f=new BattleSimulator(m,T,l).startBattle();let y=0,g=0;if(f.battleData&&f.battleData.length>0)for(const D of f.battleData)D.heroDamageDealt!==void 0&&(y+=D.heroDamageDealt,g++);const b=g>0?y/g:0;i.push({level:c,hp:m.currentHp,damage:b,rounds:f.rounds,battleData:f.battleData,heroName:"Hero",enemyName:"Enemy"}),u&&u(i,c,s)}catch(l){console.error(`Level ${c} battle simulation failed:`,l),i.push({level:c,hp:100,damage:20,rounds:10,battleData:[],heroName:"Hero",enemyName:"Enemy"}),u&&u(i,c,s)}}return i}const SimulationService=Object.freeze(Object.defineProperty({__proto__:null,generatePVEDataRange,initFx},Symbol.toStringTag,{value:"Module"})),SCENARIO_KEYS={"pve-growth":{title:"story.pveGrowth.title",desc:"story.pveGrowth.desc"},newbie:{title:"story.newbie.title",desc:"story.newbie.desc"},"mid-game":{title:"story.midGame.title",desc:"story.midGame.desc"},"custom-battle":{title:"story.custom.title",desc:"story.custom.desc"}},N=class N{constructor(){this.characterView=null,this.currentScenario="pve-growth",this.pveBattleData=null,this.currentLevel=null,this.isRunning=!1,this.shouldStop=!1,this.chartUpdateTimer=null,this.levelWarningToast=null,this.levelWarningTimer=null,this.chartController=new ChartController(e=>this.showBattleDetail(e));try{this.characterView=new CharacterView("characterViewContainer"),this.characterView.init()}catch{console.warn("CharacterView container not found, character view disabled")}}async init(){console.log("Battle simulation system initialized"),i18n.updatePage(),this.bindEvents(),this.redirectConsole(),await this.chartController.initCharts(),await this.selectScenario("custom-battle"),i18n.subscribe(()=>{this.updateStoryHeader(this.currentScenario),this.pveBattleData&&this.currentLevel})}bindEvents(){document.querySelectorAll(".scenario-btn").forEach(h=>{h.addEventListener("click",m=>{const T=m.currentTarget.dataset.scenario;T&&this.selectScenario(T)})});const e=document.getElementById("startCustomBattle");e&&e.addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),this.isRunning?(console.log("Stop Battle clicked"),this.stopBattle()):(console.log("Start Custom Battle clicked"),this.runCustomBattle())}),document.querySelectorAll(".preset-btn").forEach(h=>{h.addEventListener("click",m=>{const d=m.currentTarget,T=d.dataset.preset;T&&N.PRESETS[T]&&(this.applyPreset(T),document.querySelectorAll(".preset-btn").forEach(p=>p.classList.remove("active")),d.classList.add("active"))})});const t=document.getElementById("langSwitch");t&&t.addEventListener("click",()=>{i18n.toggleLocale()});const n=document.getElementById("heroLevel"),i=document.getElementById("enemyLevel"),s=document.getElementById("heroLevelValue"),r=document.getElementById("enemyLevelValue");let c=(n==null?void 0:n.value)||"10",l=(i==null?void 0:i.value)||"10";n&&n.addEventListener("input",()=>{if(this.isRunning){n.value=c,this.showLevelWarning();return}c=n.value,s&&(s.textContent=n.value),this.updateStatsDisplay()}),i&&i.addEventListener("input",()=>{if(this.isRunning){i.value=l,this.showLevelWarning();return}l=i.value,r&&(r.textContent=i.value),this.updateStatsDisplay()})}async updateStatsDisplay(){await initFx();const e=FxUtil.getInstance(),t=document.getElementById("heroLevel"),n=document.getElementById("enemyLevel"),i=document.getElementById("heroLevelValue"),s=document.getElementById("enemyLevelValue"),r=Math.max(1,Math.min(100,parseInt(t==null?void 0:t.value)||1)),c=Math.max(1,Math.min(100,parseInt(n==null?void 0:n.value)||1));i&&(i.textContent=String(r)),s&&(s.textContent=String(c));try{const l=e.getInstanceDataByNameAndOccuAndLevel("主角1",1,r),h=document.getElementById("heroHp"),m=document.getElementById("heroAtk");h&&(h.textContent=String(Math.round(l.hp))),m&&(m.textContent=String(Math.round(l.attack)));const d=e.getInstanceDataByNameAndOccuAndLevel("怪物1",1,c),T=document.getElementById("enemyHp"),p=document.getElementById("enemyAtk");T&&(T.textContent=String(Math.round(d.hp))),p&&(p.textContent=String(Math.round(d.attack))),this.characterView&&this.currentScenario==="custom-battle"&&this.characterView.updateCharacters({name:"Hero",level:r,hp:l.hp,maxHp:l.hp,attack:l.attack,defense:l.defense},{name:"Enemy Boss",level:c,hp:d.hp,maxHp:d.hp,attack:d.attack,defense:d.defense})}catch(l){console.error("Failed to update stats display:",l)}}redirectConsole(){const e=console.log;console.log=(...t)=>{e.apply(console,t),document.getElementById("output")}}updateStoryHeader(e){const t=SCENARIO_KEYS[e];if(t){const n=document.getElementById("storyTitle"),i=document.getElementById("storyDesc");n&&(n.textContent=i18n.t(t.title)),i&&(i.textContent=i18n.t(t.desc))}}async selectScenario(e){var l,h,m,d,T,p;if(this.isRunning){this.shouldStop=!0;let f=0;for(;this.isRunning&&f<40;)await new Promise(y=>setTimeout(y,50)),f++;this.isRunning&&(this.isRunning=!1,console.warn("Force stopped running task after timeout"))}this.shouldStop=!1;const t=document.getElementById("startCustomBattle");t&&(t.classList.remove("running"),t.querySelector(".label").textContent="⚔️ "+i18n.t("custom.start")),document.querySelectorAll(".scenario-btn").forEach(f=>{f.classList.remove("active"),f.dataset.scenario===e&&f.classList.add("active")}),this.currentScenario=e,this.updateStoryHeader(e);const n=document.getElementById("hpChartTitle"),i=document.getElementById("damageChartTitle"),s=document.getElementById("roundsChartTitle"),r=s==null?void 0:s.closest(".chart-card");e==="custom-battle"?(n&&n.setAttribute("data-i18n","charts.hpByRound"),i&&i.setAttribute("data-i18n","charts.damageByRound"),r&&(r.style.display="none")):(n&&n.setAttribute("data-i18n","charts.hpByLevel"),i&&i.setAttribute("data-i18n","charts.damageByLevel"),s&&s.setAttribute("data-i18n","charts.roundsByLevel"),r&&(r.style.display="block")),i18n.updatePage(),this.clearOutput(),this.chartController.clearCharts(),(l=document.getElementById("hpPlaceholder"))==null||l.classList.remove("hidden"),(h=document.getElementById("damagePlaceholder"))==null||h.classList.remove("hidden"),(m=document.getElementById("roundsPlaceholder"))==null||m.classList.remove("hidden");const c=document.getElementById("customConfigPanel");if(e==="custom-battle"){if(c&&(c.style.display="block"),(d=document.getElementById("hpPlaceholder"))==null||d.classList.add("hidden"),(T=document.getElementById("damagePlaceholder"))==null||T.classList.add("hidden"),(p=document.getElementById("roundsPlaceholder"))==null||p.classList.add("hidden"),this.characterView){this.characterView.setVisible(!0);const f=document.getElementById("characterViewContainer");f&&(f.style.display="block")}await this.updateStatsDisplay(),setTimeout(()=>{this.isRunning||this.runCustomBattle()},100)}else{if(c&&(c.style.display="none"),this.characterView){this.characterView.setVisible(!1);const f=document.getElementById("characterViewContainer");f&&(f.style.display="none")}await this.runScenario(e)}}async runScenario(e){if(e!=="custom-battle"){this.setStatus("loading",i18n.t("status.running",{scenario:e}));try{switch(e){case"pve-growth":await this.showPVEGrowthCurve(50);break;case"newbie":await this.showPVEGrowthCurve(10,1);break;case"mid-game":await this.showPVEGrowthCurve(30,20);break}this.setStatus("success",i18n.t("status.success"))}catch(t){console.error("Simulation error:",t),this.setStatus("error",i18n.t("status.error",{message:t.message}))}}}applyPreset(e){const t=N.PRESETS[e];if(!t)return;const n=document.getElementById("heroLevel"),i=document.getElementById("enemyLevel");n&&(n.value=String(t.hero.level)),i&&(i.value=String(t.enemy.level)),this.updateStatsDisplay()}async runCustomBattle(){if(console.log("runCustomBattle called, isRunning:",this.isRunning),this.isRunning)return;await initFx();const e=FxUtil.getInstance(),t=D=>{const v=document.getElementById(D),x=parseInt(v==null?void 0:v.value)||0,V=parseInt(v==null?void 0:v.min)||0,E=parseInt(v==null?void 0:v.max)||999999;return Math.max(V,Math.min(E,x))},n=t("heroLevel"),i=t("enemyLevel"),s=Math.max(1,Math.min(1e3,t("simCount")||1)),r=e.getInstanceDataByNameAndOccuAndLevel("主角1",1,n),c=e.getInstanceDataByNameAndOccuAndLevel("怪物1",1,i),l=Math.round(r.hp),h=Math.round(r.attack),m=Math.round(r.defense),d=Math.round(c.hp),T=Math.round(c.attack),p=Math.round(c.defense);if(console.log("Custom Battle Config:",{heroLevel:n,heroHp:l,heroAtk:h,heroDef:m,enemyLevel:i,enemyHp:d,enemyAtk:T,enemyDef:p,simCount:s}),l<=0||h<=0||d<=0||T<=0){this.setStatus("error","Invalid stats: HP and Attack must be > 0");return}this.isRunning=!0,this.setStatus("loading",i18n.t("status.running",{scenario:"Custom"})),this.clearOutput();const f=document.getElementById("startCustomBattle");if(f&&(f.classList.add("running"),f.querySelector(".label").textContent="⏹️ "+i18n.t("custom.stop")),this.characterView){this.characterView.setVisible(!0);const D=document.getElementById("characterViewContainer");D&&(D.style.display="block"),this.characterView.updateCharacters({name:"Hero",level:n,hp:l,maxHp:l,attack:h,defense:m},{name:"Enemy Boss",level:i,hp:d,maxHp:d,attack:T,defense:p}),this.characterView.reset(),await this.characterView.playLandingAnimation()}const y=document.getElementById("customProgress"),g=document.getElementById("progressBar"),b=document.getElementById("progressText");s>1&&y&&(y.style.display="block");try{const{BattleEntity:D}=await __vitePreload(async()=>{const{BattleEntity:S}=await Promise.resolve().then(()=>BattleEntity$1);return{BattleEntity:S}},void 0,import.meta.url),{BattleSimulator:v}=await __vitePreload(async()=>{const{BattleSimulator:S}=await Promise.resolve().then(()=>BattleSimulator$1);return{BattleSimulator:S}},void 0,import.meta.url),{BattleLogger:x}=await __vitePreload(async()=>{const{BattleLogger:S}=await Promise.resolve().then(()=>BattleLogger$1);return{BattleLogger:S}},void 0,import.meta.url);let V=0,E=0,C=0,F=1/0,L=0,I=null;const Y=50;for(let S=0;S<s;S++){if(this.shouldStop){console.log("Simulation stopped by user"),this.setStatus("success",i18n.t("status.stopped"));return}if(S>0&&S%Y===0&&(await new Promise(P=>requestAnimationFrame(P)),g&&b)){const P=Math.round(S/s*100);g.style.width=`${P}%`,b.textContent=`${S} / ${s} (${P}%)`}const H=S===s-1,W=new x(!H),M=new D("Hero",l,h,m,n),R=new D("Enemy Boss",d,T,p,i),$=new v(M,R,W);let w;if(s===1&&this.characterView){if(w=await this.playAnimatedBattle(M,R,$),this.shouldStop){console.log("Simulation stopped during battle animation"),this.setStatus("success",i18n.t("status.stopped"));return}}else w=$.startBattle();w.winner==="Hero"&&V++,E+=w.rounds,F=Math.min(F,w.rounds),L=Math.max(L,w.rounds);const U=w.battleData[w.battleData.length-1];C+=U?U.heroHp:0,H&&(I=w)}if(!I)throw new Error("Simulation failed");if(y&&(y.style.display="none",g&&(g.style.width="0%")),s>1){const S=document.getElementById("output");if(S){S.textContent="";const H=(V/s*100).toFixed(1),W=(E/s).toFixed(1),M=(C/s).toFixed(0),R=s-V,$=`
${i18n.t("custom.report.title",{count:s})}
────────────────────────────────
${i18n.t("custom.report.winRate",{rate:H})}
${i18n.t("custom.report.losses",{count:R})}
${i18n.t("custom.report.avgRounds",{rounds:W})}
${i18n.t("custom.report.minRounds",{rounds:F})}
${i18n.t("custom.report.maxRounds",{rounds:L})}
${i18n.t("custom.report.avgHeroHp",{hp:M})}
────────────────────────────────

${i18n.t("status.battleDetails.header",{level:n})}
${i18n.t("status.battleDetails.duration",{rounds:I.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(I.battleData[I.battleData.length-1].heroHp)})}
`;S.textContent=$}}const k={level:n,hp:I.battleData[I.battleData.length-1].heroHp,damage:I.battleData.reduce((S,H)=>S+H.heroDamageDealt,0)/I.rounds,rounds:I.rounds,battleData:I.battleData,heroName:"Hero",enemyName:"Enemy Boss"};if(this.pveBattleData=[k],this.chartController.updateChartsWithBattleRounds(I.battleData,k.heroName,k.enemyName),this.showCustomBattleDetail(k),this.characterView&&I){const S=I.battleData[I.battleData.length-1];S&&(this.characterView.updateHp(S.heroHp,l,"hero"),this.characterView.updateHp(S.enemyHp,d,"enemy"))}this.setStatus("success",i18n.t("status.success"))}catch(D){this.setStatus("error",D.message),y&&(y.style.display="none")}finally{this.isRunning=!1,this.shouldStop=!1;const D=document.getElementById("startCustomBattle");D&&(D.classList.remove("running"),D.querySelector(".label").textContent="⚔️ "+i18n.t("custom.start"));const v=document.getElementById("customProgress");v&&(v.style.display="none")}}async playAnimatedBattle(e,t,n){if(!this.characterView)return n.startBattle();const i=[];let s=0;const r=100;await initFx();const c=FxUtil.getInstance(),l=c.getInstanceDataByNameAndOccuAndLevel("主角1",1,e.level),h=c.getInstanceDataByNameAndOccuAndLevel("怪物1",1,t.level);e.attack=l.attack,e.defense=l.defense,e.maxHp=l.hp,e.currentHp=l.hp,t.attack=h.attack,t.defense=h.defense,t.maxHp=h.hp,t.currentHp=h.hp,this.characterView.updateHp(e.currentHp,e.maxHp,"hero"),this.characterView.updateHp(t.currentHp,t.maxHp,"enemy");const m=document.getElementById("detailChartsContainer");for(m&&(m.style.display="block");s<r;){if(this.shouldStop){console.log("Battle animation stopped by user");break}s++;const T=Math.floor(e.attack*(.8+Math.random()*.4)),p=t.takeDamage(T);if(await this.characterView.playAttackAnimation("hero"),this.shouldStop||(await this.characterView.playHitAnimation("enemy",p),this.shouldStop)||(this.characterView.updateHp(t.currentHp,t.maxHp,"enemy"),await new Promise(g=>setTimeout(g,200)),this.shouldStop))break;if(!t.isAlive()){i.push({round:s,heroHp:e.currentHp,heroHpPercent:e.currentHp/e.maxHp*100,enemyHp:0,enemyHpPercent:0,heroDamageDealt:p,enemyDamageDealt:0,winner:e.name,battleEnd:!0}),this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),this.chartController.updateChartsWithBattleRounds(i,"Hero","Enemy Boss"),this.characterView.playVictoryAnimation("hero");break}const f=Math.floor(t.attack*(.8+Math.random()*.4)),y=e.takeDamage(f);if(await this.characterView.playAttackAnimation("enemy"),this.shouldStop||(await this.characterView.playHitAnimation("hero",y),this.shouldStop)||(this.characterView.updateHp(e.currentHp,e.maxHp,"hero"),await new Promise(g=>setTimeout(g,200)),this.shouldStop))break;if(!e.isAlive()){i.push({round:s,heroHp:0,heroHpPercent:0,enemyHp:t.currentHp,enemyHpPercent:t.currentHp/t.maxHp*100,heroDamageDealt:p,enemyDamageDealt:y,winner:t.name,battleEnd:!0}),this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),this.chartController.updateChartsWithBattleRounds(i,"Hero","Enemy Boss"),this.characterView.playVictoryAnimation("enemy");break}i.push({round:s,heroHp:e.currentHp,heroHpPercent:e.currentHp/e.maxHp*100,enemyHp:t.currentHp,enemyHpPercent:t.currentHp/t.maxHp*100,heroDamageDealt:p,enemyDamageDealt:y,battleEnd:!1}),this.chartUpdateTimer!==null&&clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=window.setTimeout(()=>{this.chartController.updateChartsWithBattleRounds(i,"Hero","Enemy Boss"),this.chartUpdateTimer=null},50)}return this.chartUpdateTimer!==null&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),{winner:e.isAlive()?e.name:t.isAlive()?t.name:"平局",rounds:s,battleData:i}}showCustomBattleDetail(e){var i;if(!e.battleData||e.battleData.length===0){console.error("No detailed battle data available");return}this.currentLevel=e.level;const t=document.getElementById("detailChartsContainer");t&&(t.style.display="block"),this.chartController.createDetailCharts(e.battleData,e.heroName||"Hero",e.enemyName||"Enemy");const n=document.getElementById("output");if(n&&!((i=n.textContent)!=null&&i.includes("────"))){n.textContent="";const s=`
${i18n.t("status.battleDetails.header",{level:e.level})}
${i18n.t("status.battleDetails.duration",{rounds:e.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(e.hp)})}
${i18n.t("status.battleDetails.damage",{damage:Math.round(e.damage)})}
${i18n.t("status.battleDetails.footer")}
`;n.textContent=s}}async showPVEGrowthCurve(e,t=1){this.currentLevel=null;const n=document.getElementById("detailChartsContainer");n&&(n.style.display="none");const{generatePVEDataRange:i}=await __vitePreload(async()=>{const{generatePVEDataRange:r}=await Promise.resolve().then(()=>SimulationService);return{generatePVEDataRange:r}},void 0,import.meta.url),s=await i((r,c,l)=>{this.chartController.updateCharts(r,this.currentLevel),this.pveBattleData=r;const h=Math.round(c/l*100);this.setStatus("loading",i18n.t("status.simulating",{current:c,total:l,percent:h})),c===t&&r.length>0&&setTimeout(()=>{r[0]&&r[0].battleData&&this.showBattleDetail(0)},500)},e-t+1,t,()=>this.shouldStop);this.pveBattleData=s,console.log(`Growth curve generated with ${s.length} data points`)}showBattleDetail(e){if(!this.pveBattleData||!this.pveBattleData[e]){console.error("Battle data not found for index:",e);return}const t=this.pveBattleData[e];if(!t.battleData||t.battleData.length===0){console.error("No detailed battle data available");return}this.currentLevel=t.level,this.chartController.updateCharts(this.pveBattleData,this.currentLevel);const n=document.getElementById("detailChartsContainer");n&&(n.style.display="block"),this.chartController.createDetailCharts(t.battleData,t.heroName||"Hero",t.enemyName||"Enemy");const i=document.getElementById("output");if(i){i.textContent="";const s=`
${i18n.t("status.battleDetails.header",{level:t.level})}
${i18n.t("status.battleDetails.duration",{rounds:t.rounds})}
${i18n.t("status.battleDetails.hp",{hp:Math.round(t.hp)})}
${i18n.t("status.battleDetails.damage",{damage:Math.round(t.damage)})}
${i18n.t("status.battleDetails.footer")}
`;i.textContent=s}}stopBattle(){this.isRunning&&(this.shouldStop=!0,this.setStatus("loading",i18n.t("status.stopping")))}showLevelWarning(){const e=i18n.t("status.cannotModifyLevel");this.levelWarningTimer&&(clearTimeout(this.levelWarningTimer),this.levelWarningTimer=null),this.levelWarningToast||(this.levelWarningToast=document.createElement("div"),this.levelWarningToast.className="level-warning-toast",this.levelWarningToast.style.cssText=`
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%) translateY(-20px);
                background: rgba(245, 158, 11, 0.95);
                color: #1a1a2e;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                opacity: 0;
                transition: all 0.3s ease;
            `,document.body.appendChild(this.levelWarningToast)),this.levelWarningToast.textContent=e,requestAnimationFrame(()=>{this.levelWarningToast&&(this.levelWarningToast.style.opacity="1",this.levelWarningToast.style.transform="translateX(-50%) translateY(0)")}),this.levelWarningTimer=window.setTimeout(()=>{this.levelWarningToast&&(this.levelWarningToast.style.opacity="0",this.levelWarningToast.style.transform="translateX(-50%) translateY(-20px)")},2e3)}setStatus(e,t){const n=document.getElementById("status");n&&(n.className=`status ${e}`,n.textContent=t)}clearOutput(){const e=document.getElementById("output");e&&(e.textContent="",e.setAttribute("data-placeholder",i18n.t("charts.details.waiting"))),this.setStatus("","")}};N.PRESETS={balanced:{hero:{level:10,hp:1e3,atk:100,def:20},enemy:{level:10,hp:1e3,atk:100,def:20}},heroStrong:{hero:{level:15,hp:1500,atk:150,def:30},enemy:{level:10,hp:800,atk:80,def:15}},enemyStrong:{hero:{level:10,hp:800,atk:80,def:15},enemy:{level:15,hp:1500,atk:150,def:30}},tank:{hero:{level:10,hp:2e3,atk:60,def:50},enemy:{level:10,hp:800,atk:120,def:10}},glass:{hero:{level:10,hp:500,atk:200,def:5},enemy:{level:10,hp:1200,atk:80,def:25}}};let DemoApp=N;const app=new DemoApp;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>app.init()):app.init();
